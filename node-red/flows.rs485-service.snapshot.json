[
  {
    "id": "f1180e03d0981a44",
    "type": "tab",
    "label": "BMS-RS485-CAN-DEYE",
    "disabled": false,
    "info": "BMS der China Akkus auslenen, diese in einer Visu\r\ndarstellen.\r\n\r\nEs soll dann das CAN Protokoll f\u00fcr den Deye erzeugt werden.\r\n\r\nWas der Akku zuvor geschickt hatte Pylontech CAN Protokoll konnte erfolgreich entschl\u00fcsslt werden.\r\n\r\n",
    "env": []
  },
  {
    "id": "tab_deye_bms",
    "type": "tab",
    "label": "DEYE Virtual BMS",
    "disabled": false,
    "info": "RS485 -> Aggregat -> Pylontech CAN TX (DEYE)",
    "env": []
  },
  {
    "id": "tab-rs485-poller",
    "type": "tab",
    "label": "RS485 BMS Poller",
    "disabled": false,
    "info": "Polls Pylontech/Basen RS485 protocol (CID1=0x4A) and decodes 0x42/0x44/0x47/0x51 responses. Outputs: [0] per-pack status, [1] alarms, [2] system params/identity."
  },
  {
    "id": "tab_a3412f46",
    "type": "tab",
    "label": "RS485 BMS Dashboard",
    "disabled": false,
    "info": "RS485 Poller monitor dashboard"
  },
  {
    "id": "63d077e8ba67d",
    "type": "tab",
    "label": "BMS-Parser-Pack (Dashboard)",
    "disabled": false,
    "info": "",
    "env": []
  },
  {
    "id": "150517867e77a9f8",
    "type": "tab",
    "label": "BMS Pylontech (MQTT)",
    "disabled": false,
    "env": []
  },
  {
    "id": "tab_hostcheck_01",
    "type": "tab",
    "label": "Host-Check",
    "disabled": false,
    "info": ""
  },
  {
    "id": "70a7c9ffa7344fec",
    "type": "subflow",
    "name": "Check_Connection (edge + timeout)",
    "info": "Gibt true bei eingehenden Nachrichten und false, wenn f\u00fcr 'timeout_ms' nichts kam.",
    "category": "",
    "in": [
      {
        "x": 40,
        "y": 60,
        "wires": [
          {
            "id": "in_delay"
          }
        ]
      }
    ],
    "out": [
      {
        "x": 560,
        "y": 60,
        "wires": [
          {
            "id": "out_gate",
            "port": 0
          }
        ]
      }
    ],
    "env": [
      {
        "name": "timeout_ms",
        "type": "num",
        "value": 3000
      }
    ],
    "meta": {},
    "color": "#DDAA99"
  },
  {
    "id": "a6dfe781b0c66fb1",
    "type": "junction",
    "z": "f1180e03d0981a44",
    "x": 3080,
    "y": 1200,
    "wires": [
      [
        "0c477da36b682a9b",
        "ed7c8a242bcc748c",
        "d5b5260480ab1aa8",
        "0ff8efee137bc98d",
        "bd1cac6ed324982e",
        "606116cfa1f085ac",
        "31b68910f750709e",
        "5c9666a78afc39c9",
        "808c359d9b4a656c",
        "546f8764f287c8c6",
        "b27862c7a7c9fdef",
        "f34e8ecbab53b771",
        "618ce36e0c20cec3",
        "7b3d81503265c09e",
        "14e657ddf6151bf5"
      ]
    ]
  },
  {
    "id": "7b3d81503265c09e",
    "type": "junction",
    "z": "f1180e03d0981a44",
    "x": 3120,
    "y": 1740,
    "wires": [
      [
        "92fefe8ab713c6c7",
        "f10aba574a54e279",
        "53b6e517702a4b73",
        "f068f6263a8cd4f8",
        "78b3b0a6a0864748",
        "03ccd8a47ab977f7",
        "994b367c222963ba",
        "a55e47f86f37a874"
      ]
    ]
  },
  {
    "id": "68aa901df2a4a2e2",
    "type": "junction",
    "z": "f1180e03d0981a44",
    "x": 3200,
    "y": 2720,
    "wires": [
      [
        "39e79a788815ca5e",
        "f3137e9b5113f150",
        "847af786a41292cd",
        "af293b87fc6275b9",
        "849122be0779fbae",
        "015db1a0b95738e8",
        "9f997883b4977cbd",
        "9d363940f5cc1e93",
        "207f256f8c7a726b",
        "7e456112ca2b5183",
        "661ef78661f3cc78",
        "2f5e77251c78c81c",
        "26fc9edbe5d9608f",
        "c94d7ed1fd80ff2a",
        "d78801a917ddcd9a",
        "59c5f4d9ae403257"
      ]
    ]
  },
  {
    "id": "89a878efecce2149",
    "type": "junction",
    "z": "f1180e03d0981a44",
    "x": 3200,
    "y": 2320,
    "wires": [
      [
        "aa32b6de254242d7",
        "72c11ee8cd7dbdc6",
        "9556b98eda01ece5",
        "f3fa41405b236b96",
        "25d739c5b81598d3",
        "36accb4b3349a6e4"
      ]
    ]
  },
  {
    "id": "156efc838aaf1e8e",
    "type": "serial-port",
    "name": "RS485-1",
    "serialport": "/dev/ttyUSB0",
    "serialbaud": "9600",
    "databits": "8",
    "parity": "none",
    "stopbits": "1",
    "waitfor": "~",
    "dtr": "none",
    "rts": "none",
    "cts": "none",
    "dsr": "none",
    "newline": "500",
    "bin": "false",
    "out": "time",
    "addchar": "\\n",
    "responsetimeout": "1000"
  },
  {
    "id": "9cb0be1e.1c82a",
    "type": "mqtt-broker",
    "name": "MQTT_ioBroker",
    "broker": "192.168.2.137",
    "port": "1884",
    "clientid": "nodered_client_RPI5",
    "autoConnect": true,
    "usetls": false,
    "compatmode": false,
    "protocolVersion": "4",
    "keepalive": "60",
    "cleansession": true,
    "autoUnsubscribe": true,
    "birthTopic": "",
    "birthQos": "0",
    "birthPayload": "",
    "birthMsg": {},
    "closeTopic": "",
    "closeQos": "0",
    "closePayload": "",
    "closeMsg": {},
    "willTopic": "",
    "willQos": "0",
    "willPayload": "",
    "willMsg": {},
    "userProps": "",
    "sessionExpiry": ""
  },
  {
    "id": "1a2da74c7b80a463",
    "type": "mqtt-broker",
    "d": true,
    "name": "fhem-mqtt-Batterie",
    "broker": "192.168.178.2",
    "port": "1883",
    "clientid": "nodered-batterie",
    "autoConnect": true,
    "usetls": false,
    "protocolVersion": "4",
    "keepalive": "60",
    "cleansession": true,
    "birthTopic": "",
    "birthQos": "0",
    "birthPayload": "",
    "birthMsg": {},
    "closeTopic": "",
    "closeQos": "0",
    "closePayload": "",
    "closeMsg": {},
    "willTopic": "",
    "willQos": "0",
    "willPayload": "",
    "willMsg": {},
    "userProps": "",
    "sessionExpiry": ""
  },
  {
    "id": "f534d1e5074abc96",
    "type": "socketcan-config",
    "interface": "can0"
  },
  {
    "id": "6b91d07b08cc43cd",
    "type": "telegram bot",
    "botname": "iob_tiny_bot",
    "usernames": "Thomas,Smarthome",
    "chatids": "",
    "baseapiurl": "",
    "updatemode": "polling",
    "pollinterval": "300",
    "usesocks": false,
    "sockshost": "",
    "socksprotocol": "socks5",
    "socksport": "6667",
    "socksusername": "anonymous",
    "sockspassword": "",
    "bothost": "",
    "botpath": "",
    "localbotport": "8443",
    "publicbotport": "8443",
    "privatekey": "",
    "certificate": "",
    "useselfsignedcertificate": false,
    "sslterminated": false,
    "verboselogging": false
  },
  {
    "id": "de24865dc158b9bf",
    "type": "ui_tab",
    "name": "PV-Anlage",
    "icon": "dashboard",
    "order": 2,
    "disabled": false,
    "hidden": false
  },
  {
    "id": "6532adbb139ad0d4",
    "type": "ui_tab",
    "name": "Akku Gesamt",
    "icon": "dashboard",
    "order": 6,
    "disabled": false,
    "hidden": false
  },
  {
    "id": "bc442a4cdc4adb08",
    "type": "ui_tab",
    "name": "Graph",
    "icon": "dashboard",
    "order": 4,
    "disabled": false,
    "hidden": false
  },
  {
    "id": "c76e60bebc2623b5",
    "type": "ui_tab",
    "name": "Batterie",
    "icon": "dashboard",
    "order": 3,
    "disabled": false,
    "hidden": false
  },
  {
    "id": "fd28794b3466ba7c",
    "type": "ui_tab",
    "name": "Akku 2",
    "icon": "dashboard",
    "order": 5,
    "disabled": false,
    "hidden": false
  },
  {
    "id": "bd4a47aa1db3d7f6",
    "type": "ui_tab",
    "name": "Akku 3",
    "icon": "dashboard",
    "order": 7,
    "disabled": false,
    "hidden": false
  },
  {
    "id": "91b92b51a71a3d33",
    "type": "ui_group",
    "name": "Akku - CAN",
    "tab": "de24865dc158b9bf",
    "order": 1,
    "disp": true,
    "width": "14",
    "collapse": true,
    "className": ""
  },
  {
    "id": "5eddcc8a9a1c816c",
    "type": "ui_group",
    "name": "Akku 3 - RS485",
    "tab": "de24865dc158b9bf",
    "order": 3,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "051b393ae5b2d713",
    "type": "ui_group",
    "name": "Akku 2 - RS485",
    "tab": "de24865dc158b9bf",
    "order": 2,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "c89edcdec9811f6d",
    "type": "ui_group",
    "name": "Gauge ID 01",
    "tab": "6532adbb139ad0d4",
    "order": 2,
    "disp": true,
    "width": "14",
    "collapse": true,
    "className": ""
  },
  {
    "id": "de6cd84361a0e3c7",
    "type": "ui_group",
    "name": "Temperatur",
    "tab": "bc442a4cdc4adb08",
    "order": 2,
    "disp": true,
    "width": "16",
    "collapse": true
  },
  {
    "id": "8eb2d32010fffae1",
    "type": "ui_group",
    "name": "Cellen",
    "tab": "c76e60bebc2623b5",
    "order": 3,
    "disp": true,
    "width": 10,
    "collapse": false
  },
  {
    "id": "7f9db63ff2ff7de2",
    "type": "ui_group",
    "name": "Cell",
    "tab": "bc442a4cdc4adb08",
    "order": 1,
    "disp": true,
    "width": "16",
    "collapse": true
  },
  {
    "id": "5566955c13b1ed8c",
    "type": "ui_group",
    "name": "Temperatur",
    "tab": "c76e60bebc2623b5",
    "order": 2,
    "disp": true,
    "width": 8,
    "collapse": true
  },
  {
    "id": "07a3748f81b63862",
    "type": "ui_group",
    "name": "Gauge ID 02",
    "tab": "6532adbb139ad0d4",
    "order": 3,
    "disp": true,
    "width": "14",
    "collapse": true,
    "className": ""
  },
  {
    "id": "7f4586c8b01659db",
    "type": "ui_group",
    "name": "Akku 2",
    "tab": "fd28794b3466ba7c",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "5afd26883b0fb349",
    "type": "ui_group",
    "name": "Gauge ID 04",
    "tab": "6532adbb139ad0d4",
    "order": 4,
    "disp": true,
    "width": "14",
    "collapse": true,
    "className": ""
  },
  {
    "id": "0d4c236839cc0498",
    "type": "ui_group",
    "name": "Akku 3",
    "tab": "bd4a47aa1db3d7f6",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "d4cc1627f7e1cc1b",
    "type": "ui_group",
    "name": "Graphen",
    "tab": "6532adbb139ad0d4",
    "order": 5,
    "disp": true,
    "width": "14",
    "collapse": true,
    "className": ""
  },
  {
    "id": "85a144ff674258ec",
    "type": "ui_group",
    "name": "Tabelle",
    "tab": "6532adbb139ad0d4",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "375d0447b692f221",
    "type": "ui_group",
    "name": "Group 1",
    "tab": "fd28794b3466ba7c",
    "order": 2,
    "disp": true,
    "width": 6
  },
  {
    "id": "a04ea52b32ac5b7e",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 5,
    "width": 2,
    "height": 1
  },
  {
    "id": "0d62c0fe53f6bd19",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 7,
    "width": 2,
    "height": 1
  },
  {
    "id": "97d9124b3120e324",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 8,
    "width": 2,
    "height": 1
  },
  {
    "id": "63e6914d3ba78f9e",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 10,
    "width": 2,
    "height": 1
  },
  {
    "id": "5b36ee9906906dfb",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 12,
    "width": 2,
    "height": 1
  },
  {
    "id": "623e9c79a9fa9c4b",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 13,
    "width": 2,
    "height": 1
  },
  {
    "id": "e5999a6cd69c1808",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 15,
    "width": 5,
    "height": 1
  },
  {
    "id": "2e7cb5c1b0a89e18",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 16,
    "width": 5,
    "height": 1
  },
  {
    "id": "6f2a755b0ce78adc",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 17,
    "width": 5,
    "height": 1
  },
  {
    "id": "7a388da82dd95802",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 18,
    "width": 8,
    "height": 1
  },
  {
    "id": "255de61e5f20ef68",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 19,
    "width": 8,
    "height": 1
  },
  {
    "id": "294e72438cdd9294",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 22,
    "width": 8,
    "height": 1
  },
  {
    "id": "9315be434327f923",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 23,
    "width": 8,
    "height": 1
  },
  {
    "id": "7a81451e3c011a0a",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 24,
    "width": 8,
    "height": 1
  },
  {
    "id": "00d06c42d0c2a1ca",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 26,
    "width": 11,
    "height": 1
  },
  {
    "id": "ac9d768665837c06",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 27,
    "width": 11,
    "height": 1
  },
  {
    "id": "62610e541ed9c196",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 28,
    "width": 11,
    "height": 1
  },
  {
    "id": "b32ec01aa9a838fa",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "91b92b51a71a3d33",
    "order": 29,
    "width": 14,
    "height": 1
  },
  {
    "id": "3144442f1d0f7cb5",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "051b393ae5b2d713",
    "order": 3,
    "width": 12,
    "height": 1
  },
  {
    "id": "f2404f2d8675ae6f",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "8eb2d32010fffae1",
    "order": 34,
    "width": "8",
    "height": "1"
  },
  {
    "id": "65ed97f75b27e3af",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "8eb2d32010fffae1",
    "order": 36,
    "width": 6,
    "height": 1
  },
  {
    "id": "ac2b0f31227967f1",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "8eb2d32010fffae1",
    "order": 17,
    "width": "8",
    "height": "1"
  },
  {
    "id": "b218565dacb22070",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "8eb2d32010fffae1",
    "order": 37,
    "width": 2,
    "height": 1
  },
  {
    "id": "bd769c4c4b56145a",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "8eb2d32010fffae1",
    "order": 38,
    "width": 2,
    "height": 1
  },
  {
    "id": "13eedd9bd16039db",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "8eb2d32010fffae1",
    "order": 39,
    "width": 2,
    "height": 1
  },
  {
    "id": "f006565f4849920d",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "8eb2d32010fffae1",
    "order": 40,
    "width": 2,
    "height": 1
  },
  {
    "id": "55068975ec166f35",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "8eb2d32010fffae1",
    "order": 41,
    "width": 2,
    "height": 1
  },
  {
    "id": "78df15bd53276292",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "8eb2d32010fffae1",
    "order": 42,
    "width": 2,
    "height": 1
  },
  {
    "id": "af08316a39041f35",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "8eb2d32010fffae1",
    "order": 43,
    "width": 2,
    "height": 1
  },
  {
    "id": "fcca42860d959763",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "8eb2d32010fffae1",
    "order": 44,
    "width": 2,
    "height": 1
  },
  {
    "id": "9a2379e3c8db02a0",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "7f4586c8b01659db",
    "order": 20,
    "width": 4,
    "height": 1
  },
  {
    "id": "9d69178224826443",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "7f4586c8b01659db",
    "order": 21,
    "width": 4,
    "height": 1
  },
  {
    "id": "83289cb2411771cb",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "375d0447b692f221",
    "order": 1,
    "width": 1,
    "height": 1
  },
  {
    "id": "4842c355fdbba27d",
    "type": "ui_base",
    "theme": {
      "name": "theme-dark",
      "lightTheme": {
        "default": "#0094CE",
        "baseColor": "#0094CE",
        "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif",
        "edited": true,
        "reset": false
      },
      "darkTheme": {
        "default": "#097479",
        "baseColor": "#097479",
        "baseFont": "Copperplate,Copperplate Gothic Light,fantasy",
        "edited": true,
        "reset": false
      },
      "customTheme": {
        "name": "Untitled Theme 1",
        "default": "#4B7930",
        "baseColor": "#4B7930",
        "baseFont": "-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"
      },
      "themeState": {
        "base-color": {
          "default": "#097479",
          "value": "#097479",
          "edited": false
        },
        "page-titlebar-backgroundColor": {
          "value": "#097479",
          "edited": false
        },
        "page-backgroundColor": {
          "value": "#111111",
          "edited": false
        },
        "page-sidebar-backgroundColor": {
          "value": "#333333",
          "edited": false
        },
        "group-textColor": {
          "value": "#0eb8c0",
          "edited": false
        },
        "group-borderColor": {
          "value": "#555555",
          "edited": false
        },
        "group-backgroundColor": {
          "value": "#333333",
          "edited": false
        },
        "widget-textColor": {
          "value": "#eeeeee",
          "edited": false
        },
        "widget-backgroundColor": {
          "value": "#097479",
          "edited": false
        },
        "widget-borderColor": {
          "value": "#333333",
          "edited": false
        },
        "base-font": {
          "value": "Copperplate,Copperplate Gothic Light,fantasy"
        }
      },
      "angularTheme": {
        "primary": "indigo",
        "accents": "blue",
        "warn": "red",
        "background": "grey",
        "palette": "light"
      }
    },
    "site": {
      "name": "Node-RED Dashboard",
      "hideToolbar": "false",
      "allowSwipe": "false",
      "lockMenu": "false",
      "allowTempTheme": "true",
      "dateFormat": "DD.MM.YYYY",
      "sizes": {
        "sx": 48,
        "sy": 48,
        "gx": 6,
        "gy": 6,
        "cx": 6,
        "cy": 6,
        "px": 0,
        "py": 0
      }
    }
  },
  {
    "id": "ui_tab_bms",
    "type": "ui_tab",
    "z": "tab_deye_bms",
    "name": "BMS",
    "icon": "battery",
    "disabled": false,
    "hidden": false
  },
  {
    "id": "ui_grp_controls",
    "type": "ui_group",
    "z": "tab_deye_bms",
    "name": "Steuerung",
    "tab": "ui_tab_bms",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "ui_grp_status",
    "type": "ui_group",
    "z": "tab_deye_bms",
    "name": "Status",
    "tab": "ui_tab_bms",
    "order": 2,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "58ae8274682138ef",
    "type": "ui_tab",
    "name": "CAN BUS",
    "icon": "dashboard",
    "disabled": false,
    "hidden": false
  },
  {
    "id": "e06592d12e8c6fde",
    "type": "ui_group",
    "name": "Standard",
    "tab": "58ae8274682138ef",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "78dfb8f94bb374d3",
    "type": "ui_spacer",
    "z": "f1180e03d0981a44",
    "name": "spacer",
    "group": "e06592d12e8c6fde",
    "order": 8,
    "width": "12",
    "height": "1"
  },
  {
    "id": "0f560273f6120429",
    "type": "ui_group",
    "name": "Charts",
    "tab": "58ae8274682138ef",
    "order": 2,
    "disp": true,
    "width": "12",
    "collapse": true,
    "className": ""
  },
  {
    "id": "cfg-serial",
    "type": "serial-port",
    "serialport": "/dev/ttyUSB0",
    "serialbaud": "115200",
    "databits": "8",
    "parity": "none",
    "stopbits": "1",
    "dtr": "none",
    "rts": "none",
    "cts": "none",
    "dsr": "none",
    "newline": "\\r",
    "bin": "false",
    "out": "char",
    "addchar": false,
    "responsetimeout": "1000"
  },
  {
    "id": "uitab_c908c6e8",
    "type": "ui_tab",
    "z": "tab_a3412f46",
    "name": "RS485 Monitor",
    "icon": "dashboard",
    "disabled": false,
    "hidden": false
  },
  {
    "id": "grp1_b4146321",
    "type": "ui_group",
    "z": "tab_a3412f46",
    "name": "\u00dcbersicht",
    "tab": "uitab_c908c6e8",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "grp2_379a7d9d",
    "type": "ui_group",
    "z": "tab_a3412f46",
    "name": "Pack-Auswahl",
    "tab": "uitab_c908c6e8",
    "order": 2,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "grp3_5b115d66",
    "type": "ui_group",
    "z": "tab_a3412f46",
    "name": "Zellen & Temperaturen",
    "tab": "uitab_c908c6e8",
    "order": 3,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "grp4_f79d1046",
    "type": "ui_group",
    "z": "tab_a3412f46",
    "name": "Verlauf / History",
    "tab": "uitab_c908c6e8",
    "order": 4,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "grp5_c1450fb3",
    "type": "ui_group",
    "z": "tab_a3412f46",
    "name": "Parameter / Limits",
    "tab": "uitab_c908c6e8",
    "order": 5,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "grp6_8fca39a9",
    "type": "ui_group",
    "z": "tab_a3412f46",
    "name": "Packs (\u00dcbersicht)",
    "tab": "uitab_c908c6e8",
    "order": 6,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "bddb4292bba741cc",
    "type": "ui_tab",
    "name": "BMS Dashboard",
    "icon": "dashboard",
    "order": 1,
    "disabled": false,
    "hidden": false
  },
  {
    "id": "8f0bc36ddf984bc3",
    "type": "ui_group",
    "name": "RS485 Status",
    "tab": "bddb4292bba741cc",
    "order": 1,
    "disp": true,
    "width": "14",
    "collapse": false
  },
  {
    "id": "e84b0c9db90f42a7",
    "type": "ui_group",
    "name": "CAN Status",
    "tab": "bddb4292bba741cc",
    "order": 2,
    "disp": true,
    "width": "14",
    "collapse": false
  },
  {
    "id": "4c520c778e3d4c7d",
    "type": "mqtt-broker",
    "name": "MQTT (configure me)",
    "broker": "127.0.0.1",
    "port": "1883",
    "clientid": "",
    "usetls": false,
    "compatmode": false,
    "keepalive": "60",
    "cleansession": true,
    "birthTopic": "",
    "birthQos": "0",
    "birthPayload": "",
    "closeTopic": "",
    "closePayload": "",
    "willTopic": "",
    "willQos": "0",
    "willPayload": ""
  },
  {
    "id": "b7eb16a85eb740ab",
    "type": "mqtt-broker",
    "name": "SET ME (MQTT)",
    "broker": "localhost",
    "port": "1883",
    "clientid": "",
    "usetls": false,
    "protocolVersion": "4",
    "keepalive": "60",
    "cleansession": true,
    "birthTopic": "",
    "birthQos": "0",
    "birthRetain": "false",
    "birthPayload": "",
    "willTopic": "",
    "willQos": "0",
    "willRetain": "false",
    "willPayload": ""
  },
  {
    "id": "09a1cacdb6714957",
    "type": "ui_tab",
    "d": true,
    "name": "BMS EXT",
    "icon": "dashboard",
    "order": 10,
    "disabled": false,
    "hidden": false
  },
  {
    "id": "25ff7d415cbb45f5",
    "type": "ui_group",
    "name": "Status",
    "tab": "09a1cacdb6714957",
    "order": 1,
    "disp": true,
    "width": 12,
    "collapse": false
  },
  {
    "id": "1c87e0fe22fa4afe",
    "type": "ui_group",
    "name": "Trends",
    "tab": "09a1cacdb6714957",
    "order": 2,
    "disp": true,
    "width": 12,
    "collapse": false
  },
  {
    "id": "289cb7de0a894411",
    "type": "ui_group",
    "name": "Limits & Control",
    "tab": "09a1cacdb6714957",
    "order": 3,
    "disp": true,
    "width": 12,
    "collapse": false
  },
  {
    "id": "63d077e8ba63a",
    "type": "ui_tab",
    "name": "BMS Parser",
    "icon": "dashboard",
    "disabled": false
  },
  {
    "id": "63d077e8ba730",
    "type": "ui_group",
    "name": "Overview",
    "tab": "63d077e8ba63a",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d077e8ba4ad",
    "type": "ui_group",
    "name": "Trends",
    "tab": "63d077e8ba63a",
    "order": 2,
    "disp": true,
    "width": "24",
    "collapse": false
  },
  {
    "id": "63d077e8ba4bd",
    "type": "ui_group",
    "name": "Limits & Commands",
    "tab": "63d077e8ba63a",
    "order": 3,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d077e8ba7f0",
    "type": "mqtt-broker",
    "name": "SET ME (MQTT)",
    "broker": "localhost",
    "port": "1883",
    "clientid": "",
    "usetls": false,
    "protocolVersion": "4",
    "keepalive": "60",
    "cleansession": true,
    "birthTopic": "",
    "birthQos": "0",
    "birthPayload": "",
    "birthMsg": {},
    "closeTopic": "",
    "closeQos": "0",
    "closePayload": "",
    "closeMsg": {},
    "willTopic": "",
    "willQos": "0",
    "willPayload": "",
    "willMsg": {},
    "sessionExpiry": ""
  },
  {
    "id": "63d07bbe2eaa6",
    "type": "serial-port",
    "serialport": "/dev/ttyUSB0",
    "serialbaud": "9600",
    "databits": "8",
    "parity": "none",
    "stopbits": "1",
    "newline": "",
    "bin": "false",
    "out": "time",
    "addchar": "",
    "responsetimeout": "10000"
  },
  {
    "id": "63d07bbe2ea52",
    "type": "influxdb",
    "hostname": "127.0.0.1",
    "port": "8086",
    "protocol": "http",
    "database": "bms",
    "name": "InfluxDB (set me)",
    "usetls": false,
    "tls": "",
    "influxdbVersion": "1.x",
    "url": "",
    "rejectUnauthorized": true
  },
  {
    "id": "63d07bbe2e7ef",
    "type": "ui_group",
    "name": "Status",
    "tab": "",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d07bbe2e97d",
    "type": "ui_group",
    "name": "Trends",
    "tab": "",
    "order": 2,
    "disp": true,
    "width": "24",
    "collapse": false
  },
  {
    "id": "63d07bbe2e943",
    "type": "ui_group",
    "name": "Alarms",
    "tab": "",
    "order": 3,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d07bbe2ea72",
    "type": "ui_group",
    "name": "Control",
    "tab": "",
    "order": 4,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d07d39ad695",
    "type": "serial-port",
    "serialport": "/dev/ttyUSB0",
    "serialbaud": "9600",
    "databits": "8",
    "parity": "none",
    "stopbits": "1",
    "newline": "",
    "bin": "false",
    "out": "time",
    "addchar": "",
    "responsetimeout": "10000"
  },
  {
    "id": "63d07d39ad67f",
    "type": "influxdb",
    "hostname": "127.0.0.1",
    "port": "8086",
    "protocol": "http",
    "database": "bms",
    "name": "InfluxDB (set me)",
    "usetls": false,
    "tls": "",
    "influxdbVersion": "1.x",
    "url": "",
    "rejectUnauthorized": true
  },
  {
    "id": "63d07d39ad9b5",
    "type": "ui_group",
    "name": "Status",
    "tab": "",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d07d39ad9c3",
    "type": "ui_group",
    "name": "Trends",
    "tab": "",
    "order": 2,
    "disp": true,
    "width": "24",
    "collapse": false
  },
  {
    "id": "63d07d39ad718",
    "type": "ui_group",
    "name": "Alarms",
    "tab": "",
    "order": 3,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d07d39ada11",
    "type": "ui_group",
    "name": "Control",
    "tab": "",
    "order": 4,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d08013e5b9a",
    "type": "serial-port",
    "serialport": "/dev/ttyUSB0",
    "serialbaud": "9600",
    "databits": "8",
    "parity": "none",
    "stopbits": "1",
    "newline": "",
    "bin": "false",
    "out": "time",
    "addchar": "",
    "responsetimeout": "10000"
  },
  {
    "id": "63d08013e5c56",
    "type": "influxdb",
    "hostname": "127.0.0.1",
    "port": "8086",
    "protocol": "http",
    "database": "bms",
    "name": "InfluxDB (set me)",
    "usetls": false,
    "tls": "",
    "influxdbVersion": "1.x",
    "url": "",
    "rejectUnauthorized": true
  },
  {
    "id": "63d08013e5b1c",
    "type": "ui_group",
    "name": "Status",
    "tab": "",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d08013e5d4d",
    "type": "ui_group",
    "name": "Trends",
    "tab": "",
    "order": 2,
    "disp": true,
    "width": "24",
    "collapse": false
  },
  {
    "id": "63d08013e5ebf",
    "type": "ui_group",
    "name": "Alarms",
    "tab": "",
    "order": 3,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d08013e5d9c",
    "type": "ui_group",
    "name": "Control",
    "tab": "",
    "order": 4,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d08013e5ece",
    "type": "ui_group",
    "name": "Other CAN IDs",
    "tab": "",
    "order": 5,
    "disp": true,
    "width": "24",
    "collapse": false
  },
  {
    "id": "63d081e0b618c",
    "type": "influxdb",
    "hostname": "127.0.0.1",
    "port": "8086",
    "protocol": "http",
    "database": "bms",
    "name": "InfluxDB (set me)",
    "usetls": false,
    "tls": "",
    "influxdbVersion": "1.x",
    "url": "",
    "rejectUnauthorized": true
  },
  {
    "id": "63d081e0b5f8b",
    "type": "ui_group",
    "name": "Overview",
    "tab": "",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d081e0b6238",
    "type": "ui_group",
    "name": "Trends",
    "tab": "",
    "order": 2,
    "disp": true,
    "width": "24",
    "collapse": false
  },
  {
    "id": "63d081e0b6241",
    "type": "ui_group",
    "name": "Alarms",
    "tab": "",
    "order": 3,
    "disp": true,
    "width": "24",
    "collapse": false
  },
  {
    "id": "63d081e0b5f5c",
    "type": "ui_group",
    "name": "IDs",
    "tab": "",
    "order": 4,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d083920abf7",
    "type": "influxdb",
    "hostname": "127.0.0.1",
    "port": "8086",
    "protocol": "http",
    "database": "bms",
    "name": "InfluxDB (set me)",
    "usetls": false,
    "tls": "",
    "influxdbVersion": "1.x",
    "url": "",
    "rejectUnauthorized": true
  },
  {
    "id": "63d083920abd4",
    "type": "ui_group",
    "name": "Overview",
    "tab": "",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d083920accc",
    "type": "ui_group",
    "name": "Trends",
    "tab": "",
    "order": 2,
    "disp": true,
    "width": "24",
    "collapse": false
  },
  {
    "id": "63d083920aa78",
    "type": "ui_group",
    "name": "Alarms",
    "tab": "",
    "order": 3,
    "disp": true,
    "width": "24",
    "collapse": false
  },
  {
    "id": "63d083920ac32",
    "type": "ui_group",
    "name": "IDs",
    "tab": "",
    "order": 4,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d083920ab6f",
    "type": "ui_group",
    "name": "Bus TX",
    "tab": "",
    "order": 5,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d084d042cc2",
    "type": "influxdb",
    "hostname": "127.0.0.1",
    "port": "8086",
    "protocol": "http",
    "database": "bms",
    "name": "InfluxDB (set me)",
    "usetls": false,
    "tls": "",
    "influxdbVersion": "1.x",
    "url": "",
    "rejectUnauthorized": true
  },
  {
    "id": "63d084d042f8a",
    "type": "ui_tab",
    "name": "Pylontech",
    "icon": "dashboard",
    "disabled": false,
    "hidden": false
  },
  {
    "id": "63d084d042e03",
    "type": "ui_group",
    "name": "Overview",
    "tab": "63d084d042f8a",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d084d042ffa",
    "type": "ui_group",
    "name": "Trends",
    "tab": "63d084d042f8a",
    "order": 2,
    "disp": true,
    "width": "24",
    "collapse": false
  },
  {
    "id": "63d084d042ddd",
    "type": "ui_group",
    "name": "Alarms",
    "tab": "63d084d042f8a",
    "order": 3,
    "disp": true,
    "width": "24",
    "collapse": false
  },
  {
    "id": "63d084d042ff2",
    "type": "ui_group",
    "name": "IDs",
    "tab": "63d084d042f8a",
    "order": 4,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "63d084d042eab",
    "type": "ui_group",
    "name": "TX (socketcan-in semantics)",
    "tab": "63d084d042f8a",
    "order": 5,
    "disp": true,
    "width": "12",
    "collapse": false
  },
  {
    "id": "d1441bc3af7f5dde",
    "type": "influxdb",
    "hostname": "127.0.0.1",
    "port": "8086",
    "protocol": "http",
    "database": "bms",
    "name": "InfluxDB (set me)",
    "usetls": false,
    "tls": "",
    "influxdbVersion": "1.x",
    "url": "",
    "rejectUnauthorized": true
  },
  {
    "id": "b963b52373eab1bf",
    "type": "ui_group",
    "name": "\u00dcbersicht",
    "tab": "ui_tab_bms",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "cd91fd62716cd110",
    "type": "ui_group",
    "name": "Trends",
    "tab": "ui_tab_bms",
    "order": 2,
    "disp": true,
    "width": "12",
    "collapse": true,
    "className": ""
  },
  {
    "id": "c4ebe5b96811d749",
    "type": "ui_group",
    "name": "Alarme",
    "tab": "ui_tab_bms",
    "order": 3,
    "disp": true,
    "width": "12",
    "collapse": true,
    "className": ""
  },
  {
    "id": "10919e9a9aebe48a",
    "type": "ui_group",
    "name": "Telegramme",
    "tab": "ui_tab_bms",
    "order": 4,
    "disp": true,
    "width": "12",
    "collapse": true,
    "className": ""
  },
  {
    "id": "2444f8dc7ec4c282",
    "type": "mqtt-broker",
    "name": "MQTT (set me)",
    "broker": "127.0.0.1",
    "port": "1883",
    "clientid": "",
    "usetls": false,
    "protocolVersion": "4",
    "keepalive": "60",
    "cleansession": true
  },
  {
    "id": "5a5eaca93e0c9353",
    "type": "ui_group",
    "name": "Group 6",
    "tab": "",
    "order": 6,
    "disp": true,
    "width": 6
  },
  {
    "id": "2f52a9418389a41c",
    "type": "ui_group",
    "name": "ui_grp_raw",
    "tab": "bddb4292bba741cc",
    "order": null,
    "disp": true,
    "width": 6
  },
  {
    "id": "in_delay",
    "type": "change",
    "z": "70a7c9ffa7344fec",
    "name": "-> true",
    "rules": [
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "true",
        "tot": "bool"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 200,
    "y": 60,
    "wires": [
      [
        "c49c481e8b234b6a"
      ]
    ]
  },
  {
    "id": "c49c481e8b234b6a",
    "type": "trigger",
    "z": "70a7c9ffa7344fec",
    "name": "timeout -> false",
    "op1": "",
    "op2": "false",
    "op1type": "nul",
    "op2type": "bool",
    "duration": "0.001",
    "extend": true,
    "overrideDelay": true,
    "units": "s",
    "reset": "",
    "bytopic": "all",
    "topic": "topic",
    "outputs": 1,
    "x": 380,
    "y": 60,
    "wires": [
      [
        "out_gate"
      ]
    ]
  },
  {
    "id": "out_gate",
    "type": "gate",
    "z": "70a7c9ffa7344fec",
    "name": "pass",
    "controlTopic": "control",
    "defaultState": "open",
    "openCmd": "open",
    "closeCmd": "close",
    "toggleCmd": "toggle",
    "defaultCmd": "default",
    "x": 510,
    "y": 60,
    "wires": [
      []
    ]
  },
  {
    "id": "1",
    "type": "inject",
    "z": "f1180e03d0981a44",
    "name": "Eingehende Nachricht",
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 960,
    "y": 1680,
    "wires": [
      []
    ]
  },
  {
    "id": "e94f56cf69debc6b",
    "type": "switch",
    "z": "f1180e03d0981a44",
    "d": false,
    "name": "",
    "property": "payload",
    "propertyType": "msg",
    "rules": [
      {
        "t": "cont",
        "v": "~22014A",
        "vt": "str"
      },
      {
        "t": "cont",
        "v": "~22014A",
        "vt": "str"
      },
      {
        "t": "cont",
        "v": "~22034A",
        "vt": "str"
      },
      {
        "t": "cont",
        "v": "",
        "vt": "str"
      }
    ],
    "checkall": "true",
    "repair": false,
    "outputs": 4,
    "x": 470,
    "y": 200,
    "wires": [
      [
        "12a38056d825cf97",
        "65ca6450e2ad6b77",
        "2d305672db6afcd6"
      ],
      [
        "2d305672db6afcd6",
        "332567cb789debb2",
        "b8f4268f.9a5d9",
        "7f92d83edbbed863"
      ],
      [
        "adcb338384f27174",
        "34ae9d8909688e4a",
        "b8be7f2b15aa05c7",
        "6fa342791a5ee608"
      ],
      []
    ]
  },
  {
    "id": "adcb338384f27174",
    "type": "function",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "Cellen 01-16",
    "func": "var hex_string = msg.payload.toString(); // Stellen Sie sicher, dass msg.payload eine Zeichenfolge ist\nvar CellsVoltage = []; // Initialisieren Sie CellsVoltage als Array\nvar Voltagesum = 0, Voltagemax = 0, Voltagemin = 0, Voltagediff = 0;\n\nvar start1 = 56;\nvar pairs1 = [];\nvar index1 = start1;\n\n// Erste Schleife\nfor (var i = start1; i < start1 + 8; i += 4) {\n    var hex_pair = hex_string.substr(i, 4);\n    var decimal = parseInt(hex_pair, 16) / 1000;\n    pairs1.push(decimal);\n}\n\nvar start2 = 71;\nvar pairs2 = [];\nvar index2 = start2;\n\n// Zweite Schleife\nfor (var j = start2; j < start2 + 56; j += 4) {\n    hex_pair = hex_string.substr(j, 4);\n    decimal = parseInt(hex_pair, 16) / 1000;\n    pairs2.push(decimal);\n}\n\n// Kombinieren der beiden Arrays\nvar combinedArray = pairs1.concat(pairs2);\n\n// F\u00fcgen Sie die kombinierten Arrays zu CellsVoltage hinzu oder aktualisieren Sie sie\nif (!Array.isArray(msg.payload.CellsVoltage)) {\n    // Wenn CellsVoltage nicht als Array definiert ist, initialisieren Sie es mit den kombinierten Array-Daten\n    CellsVoltage = combinedArray;\n} else {\n    // Wenn CellsVoltage bereits als Array definiert ist, aktualisieren Sie es mit den kombinierten Array-Daten\n    CellsVoltage = msg.payload.CellsVoltage.concat(combinedArray);\n}\n\n// \u00dcberpr\u00fcfen, ob CellsVoltage definiert und ein Array ist\nif (Array.isArray(CellsVoltage)) {\n    // Finden des h\u00f6chsten und niedrigsten Werts im Array\n    var max = findMax(CellsVoltage);\n    var min = findMin(CellsVoltage);\n\n    // Berechnen der Differenz zwischen dem h\u00f6chsten und niedrigsten Wert\n    var diff = max - min;\n\n    // Summieren der Werte im Array\n    var sum = CellsVoltage.reduce(function (accumulator, currentValue) {\n        return accumulator + currentValue;\n    }, 0);\n\n    // Erstellen der Nachricht mit den Ergebnissen\n    var message = {\n        payload: {\n            CellsVoltage: CellsVoltage,\n            Voltagesum: sum.toFixed(3),\n            Voltagemax: max.toFixed(3),\n            Voltagemin: min.toFixed(3),    \n            Voltagediff: diff.toFixed(3),\n        }\n    };\n\n    // Senden der Nachricht mit den Ergebnissen\n    node.send(message);\n} else {\n    // Handle den Fall, wenn CellsVoltage nicht definiert ist oder kein Array ist\n    node.error(\"CellsVoltage ist nicht definiert oder kein Array.\");\n}\n\n// Funktion zum Finden des h\u00f6chsten Werts\nfunction findMax(array) {\n    return array.reduce(function (max, current) {\n        return current > max ? current : max;\n    }, -Infinity);\n}\n\n// Funktion zum Finden des niedrigsten Werts\nfunction findMin(array) {\n    return array.reduce(function (min, current) {\n        return current < min ? current : min;\n    }, Infinity);\n}\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 770,
    "y": 540,
    "wires": [
      [
        "e60c7f5e85c7b90f",
        "c612f40dd49bfb8c",
        "3b7d73b1c1991e6c",
        "c980fdb0032b31eb",
        "6c6a1e7c97cfe8d6",
        "d12a574a06b807ae",
        "36d06f4eda391bc4",
        "7c923a9c0733106e",
        "7c1a49d5d1e23ebd",
        "3325e19cde1f2f79",
        "d8b77f8b2144c5f4",
        "7a50f217b206338b",
        "84dfd7582a505da5",
        "851b5ef0cd34a56e",
        "3328f6a52d3f1536",
        "40a6874a6fdf905f",
        "788d5029fbf2c690",
        "e2275cc9fb97a201",
        "c88829f2c4df77a7",
        "ac2422523c6f54b3"
      ]
    ]
  },
  {
    "id": "12a38056d825cf97",
    "type": "function",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "Cellen 01-16",
    "func": "var hex_string = msg.payload.toString(); // Stellen Sie sicher, dass msg.payload eine Zeichenfolge ist\nvar CellsVoltage = []; // Initialisieren Sie CellsVoltage als Array\nvar Voltagesum = 0, Voltagemax = 0, Voltagemin = 0, Voltagediff = 0;\n\nvar start1 = 25;\nvar pairs1 = [];\nvar index1 = start1;\n\n// Erste Schleife\nfor (var i = start1; i < start1 + 8; i += 4) {\n    var hex_pair = hex_string.substr(i, 4);\n    var decimal = parseInt(hex_pair, 16) / 1000;\n    pairs1.push(decimal);\n}\n\nvar start2 = 71;\nvar pairs2 = [];\nvar index2 = start2;\n\n// Zweite Schleife\nfor (var j = start2; j < start2 + 56; j += 4) {\n    hex_pair = hex_string.substr(j, 4);\n    decimal = parseInt(hex_pair, 16) / 1000;\n    pairs2.push(decimal);\n}\n\n// Kombinieren der beiden Arrays\nvar combinedArray = pairs1.concat(pairs2);\n\n// F\u00fcgen Sie die kombinierten Arrays zu CellsVoltage hinzu oder aktualisieren Sie sie\nif (!Array.isArray(msg.payload.CellsVoltage)) {\n    // Wenn CellsVoltage nicht als Array definiert ist, initialisieren Sie es mit den kombinierten Array-Daten\n    CellsVoltage = combinedArray;\n} else {\n    // Wenn CellsVoltage bereits als Array definiert ist, aktualisieren Sie es mit den kombinierten Array-Daten\n    CellsVoltage = msg.payload.CellsVoltage.concat(combinedArray);\n}\n\n// \u00dcberpr\u00fcfen, ob CellsVoltage definiert und ein Array ist\nif (Array.isArray(CellsVoltage)) {\n    // Finden des h\u00f6chsten und niedrigsten Werts im Array\n    var max = findMax(CellsVoltage);\n    var min = findMin(CellsVoltage);\n\n    // Berechnen der Differenz zwischen dem h\u00f6chsten und niedrigsten Wert\n    var diff = max - min;\n\n    // Summieren der Werte im Array\n    var sum = CellsVoltage.reduce(function (accumulator, currentValue) {\n        return accumulator + currentValue;\n    }, 0);\n\n    // Erstellen der Nachricht mit den Ergebnissen\n    var message = {\n        payload: {\n            CellsVoltage: CellsVoltage,\n            Voltagesum: sum.toFixed(3),\n            Voltagemax: max.toFixed(3),\n            Voltagemin: min.toFixed(3),    \n            Voltagediff: diff.toFixed(3),\n        }\n    };\n\n    // Senden der Nachricht mit den Ergebnissen\n    node.send(message);\n} else {\n    // Handle den Fall, wenn CellsVoltage nicht definiert ist oder kein Array ist\n    node.error(\"CellsVoltage ist nicht definiert oder kein Array.\");\n}\n\n// Funktion zum Finden des h\u00f6chsten Werts\nfunction findMax(array) {\n    return array.reduce(function (max, current) {\n        return current > max ? current : max;\n    }, -Infinity);\n}\n\n// Funktion zum Finden des niedrigsten Werts\nfunction findMin(array) {\n    return array.reduce(function (min, current) {\n        return current < min ? current : min;\n    }, Infinity);\n}\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 770,
    "y": 100,
    "wires": [
      []
    ]
  },
  {
    "id": "65ca6450e2ad6b77",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "debug 12",
    "active": false,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "false",
    "statusVal": "",
    "statusType": "auto",
    "x": 780,
    "y": 140,
    "wires": []
  },
  {
    "id": "eb9d2e6df008efe3",
    "type": "serial in",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "",
    "serial": "156efc838aaf1e8e",
    "x": 260,
    "y": 60,
    "wires": [
      [
        "e94f56cf69debc6b"
      ]
    ]
  },
  {
    "id": "2b23f0ce4c2d4e46",
    "type": "serial request",
    "z": "f1180e03d0981a44",
    "d": false,
    "name": "Battery",
    "serial": "156efc838aaf1e8e",
    "x": 260,
    "y": 220,
    "wires": [
      [
        "e94f56cf69debc6b",
        "8b83d96e53bcea1e"
      ]
    ]
  },
  {
    "id": "66e419facf0a12c3",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "name": "debug 13",
    "active": false,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 1180,
    "y": 1260,
    "wires": []
  },
  {
    "id": "6460eec2bff555d0",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "CAN-Telegramme zerlegen",
    "func": "// Den Payload aus der Nachricht extrahieren\nvar payload = msg.payload;\n\n// \u00dcberpr\u00fcfen, ob der Payload ein g\u00fcltiges JSON-Objekt ist\nif (typeof payload === 'object' && payload !== null) {\n    // Extrahieren der Werte\n    var timestamp = payload.timestamp;\n    var ext = payload.ext;\n    var canid = payload.canid.toString(16);\n    var dlc = payload.dlc;\n    var rtr = payload.rtr;\n    var data = payload.data;\n// Variable zur Steuerung des Loggens\n    var loggingEnabled = false;  // \u00c4ndere den Wert dieser Variable nach Bedarf\n\n    if (loggingEnabled) {\n    // Ausgabe der Werte in der Konsole (kann je nach Bedarf angepasst werden)\n    console.log(' Log Ausgabe Funktion - CAN-Telegramme zerlegen.');\n   console.log('Timestamp:', timestamp);\n    console.log('EXT:', ext);\n    console.log('CAN ID:', canid);\n    console.log('DLC:', dlc);\n    console.log('RTR:', rtr);\n    console.log('Data:', data);\n    }\n    \n    // Hier k\u00f6nnen Sie die Werte weiterverarbeiten oder in den n\u00e4chsten Node senden\n    // ...\n\n    // Senden der Werte in der Nachricht zur\u00fcck\n    msg.payload = {\n    //    timestamp: timestamp,\n    //    ext: ext,\n        canid: canid,\n        dlc: dlc,\n    //    rtr: rtr,\n        data: data\n    };\n\n    return msg;\n} else {\n    // Fehlerbehandlung, wenn der Payload kein g\u00fcltiges JSON-Objekt ist\n    console.error('Ung\u00fcltiger Payload:', payload);\n    return null;\n}\n",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 540,
    "y": 1380,
    "wires": [
      [
        "ca6a7243bfcf3d59"
      ]
    ]
  },
  {
    "id": "440ecc404e0f509d",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "CAN_356",
    "func": "// Den Payload aus der Nachricht extrahieren\nvar payload = msg.payload;\n\n// \u00dcberpr\u00fcfen, ob der Payload ein g\u00fcltiges JSON-Objekt ist\nif (typeof payload === 'object' && payload !== null) {\n    // Extrahieren der Werte\n    var canid = parseInt(payload.canid);\n    var dlc = payload.dlc;\n    var data = payload.data;\n\n    // Konvertieren und zusammenf\u00fcgen der Bytes\n    var voltage = ((data[1] << 8 | data[0]) * 0.01).toFixed(2); // Byte 0 & 1, 16 bits signed int, Unit: 0.01V\n    var current = ((data[3] << 8 | data[2]) * 0.1).toFixed(2);  // Byte 2 & 3, 16 bits signed int, Unit: 0.1A\n    var temperature = (data[5] << 8 | data[4]) * 0.1;  // Byte 4 & 5, 16 bits signed int, Unit: 0.1\u00b0C\n\n// Variable zur Steuerung des Loggens\n    var loggingEnabled = false;  // \u00c4ndere den Wert dieser Variable nach Bedarf\n\n    if (loggingEnabled) {\n    // Ausgabe der Werte in der Konsole (kann je nach Bedarf angepasst werden)\n    console.log('CAN ID:', canid);\n    //console.log('DLC:', dlc);\n    console.log('Voltage:', voltage, 'V');\n    console.log('Current:', current, 'A');\n    console.log('Temperature:', temperature, '\u00b0C');\n    }\n\n    // Hier k\u00f6nnen Sie die Werte weiterverarbeiten oder in den n\u00e4chsten Node senden\n    // ...\n\n    // Senden der Werte in der Nachricht zur\u00fcck\n    msg.payload = {\n        canid: canid,\n    //    dlc: dlc,\n        voltage: voltage,\n        current: current,\n        temperature: temperature\n    };\n\n    return msg;\n} else {\n    // Fehlerbehandlung, wenn der Payload kein g\u00fcltiges JSON-Objekt ist\n    console.error('Ung\u00fcltiger Payload:', payload);\n    return null;\n}\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 920,
    "y": 1300,
    "wires": [
      [
        "66e419facf0a12c3",
        "8d8a5dd9328d916c",
        "90b41cd6b7d97973",
        "0426835812dcb2bc",
        "2a784e3b.f8cc4a",
        "6df4e8ef809ee3dd"
      ]
    ]
  },
  {
    "id": "ca6a7243bfcf3d59",
    "type": "switch",
    "z": "f1180e03d0981a44",
    "name": "",
    "property": "msg.payload.canid",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "356",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "351",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "355",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "35c",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "359",
        "vt": "str"
      }
    ],
    "checkall": "true",
    "repair": false,
    "outputs": 5,
    "x": 750,
    "y": 1380,
    "wires": [
      [
        "440ecc404e0f509d"
      ],
      [
        "ce7560a2fdef2585"
      ],
      [
        "7c2ea735e6e97326"
      ],
      [
        "82b0056cb5f1ab35"
      ],
      [
        "bec2f8ce59c3d53d",
        "3d53b845d1f5c1af"
      ]
    ]
  },
  {
    "id": "ce7560a2fdef2585",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "CAN_351",
    "func": "// Den Payload aus der Nachricht extrahieren\nvar payload = msg.payload;\n\n// \u00dcberpr\u00fcfen, ob der Payload ein g\u00fcltiges JSON-Objekt ist\nif (typeof payload === 'object' && payload !== null) {\n    // Extrahieren der Werte\n    var canid = parseInt(payload.canid);\n    var dlc = payload.dlc;\n    var data = payload.data;\n\n    // Konvertieren und zusammenf\u00fcgen der Bytes\n    var voltage = (data[1] << 8 | data[0]) * 0.1; // Byte 0 & 1, 16 bits signed int, Unit: 0.01V\n    var charge_current = (data[3] << 8 | data[2]) * 0.1;  // Byte 2 & 3, 16 bits signed int, Unit: 0.1A\n    var discharge_current = (data[5] << 8 | data[4]) * 0.1;  // Byte 2 & 3, 16 bits signed int, Unit: 0.1A\n\n// Variable zur Steuerung des Loggens\n    var loggingEnabled = false;  // \u00c4ndere den Wert dieser Variable nach Bedarf\n\n    if (loggingEnabled) {\n    // Ausgabe der Werte in der Konsole (kann je nach Bedarf angepasst werden)\n    console.log('CAN ID:', canid);\n    //console.log('DLC:', dlc);\n    console.log('Batt Charge Voltage Limit:', voltage, 'V');\n    console.log('Batt Charge Current Limit:', charge_current, 'A');\n    console.log('Batt Discharge Current Limit:', discharge_current, 'A');\n    }\n    // Hier k\u00f6nnen Sie die Werte weiterverarbeiten oder in den n\u00e4chsten Node senden\n    // ...\n\n    // Senden der Werte in der Nachricht zur\u00fcck\n    msg.payload = {\n        canid: canid,\n    //    dlc: dlc,\n        voltage: voltage,\n        charge_current: charge_current,\n        discharge_current: discharge_current\n    };\n\n    return msg;\n} else {\n    // Fehlerbehandlung, wenn der Payload kein g\u00fcltiges JSON-Objekt ist\n    console.error('Ung\u00fcltiger Payload:', payload);\n    return null;\n}\n",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 920,
    "y": 1340,
    "wires": [
      [
        "66e419facf0a12c3",
        "f8a14959ecd5a227",
        "2a784e3b.f8cc4a",
        "f3237c0c5a7809b2",
        "4dce4a253045d14f",
        "324233698f6018ca"
      ]
    ]
  },
  {
    "id": "7c2ea735e6e97326",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "CAN_355",
    "func": "// Den Payload aus der Nachricht extrahieren\nvar payload = msg.payload;\n\n// \u00dcberpr\u00fcfen, ob der Payload ein g\u00fcltiges JSON-Objekt ist\nif (typeof payload === 'object' && payload !== null) {\n    // Extrahieren der Werte\n    var canid = parseInt(payload.canid);\n    var dlc = payload.dlc;\n    var data = payload.data;\n\n    // Konvertieren und zusammenf\u00fcgen der Bytes\n    var SOC = (data[1] << 8 | data[0]) * 1; // Byte 0 & 1, 16 bits signed int, Unit: 0.01V\n    var SOH = (data[3] << 8 | data[2]) * 1;  // Byte 2 & 3, 16 bits signed int, Unit: 0.1A\n  \n// Variable zur Steuerung des Loggens\n    var loggingEnabled = false;  // \u00c4ndere den Wert dieser Variable nach Bedarf\n\n    if (loggingEnabled) {\n    // Ausgabe der Werte in der Konsole (kann je nach Bedarf angepasst werden)\n    console.log('CAN ID:', canid);\n    //console.log('DLC:', dlc);\n    console.log('Batt SOC:', SOC, '%');\n    console.log('Batt SOH:', SOH, '%');\n    }\n\n    // Hier k\u00f6nnen Sie die Werte weiterverarbeiten oder in den n\u00e4chsten Node senden\n    // ...\n\n    // Senden der Werte in der Nachricht zur\u00fcck\n    msg.payload = {\n        canid: canid,\n    //    dlc: dlc,\n        SOC: SOC,\n        SOH: SOH\n    };\n\n    return msg;\n} else {\n    // Fehlerbehandlung, wenn der Payload kein g\u00fcltiges JSON-Objekt ist\n    console.error('Ung\u00fcltiger Payload:', payload);\n    return null;\n}\n",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 920,
    "y": 1380,
    "wires": [
      [
        "66e419facf0a12c3",
        "fb4463fc2e646063",
        "192c99be6f328185",
        "59c7ff7b5f65d81e",
        "2a784e3b.f8cc4a"
      ]
    ]
  },
  {
    "id": "82b0056cb5f1ab35",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "CAN_35C",
    "func": "// Den Payload aus der Nachricht extrahieren\nvar payload = msg.payload;\n\n// \u00dcberpr\u00fcfen, ob der Payload ein g\u00fcltiges JSON-Objekt ist\nif (typeof payload === 'object' && payload !== null) {\n    // Extrahieren der Werte\n    var canid = parseInt(payload.canid);\n    var dlc = payload.dlc;\n    var data = payload.data;\n\n    // Zerlegen von Byte 0 in Bits 0-7\n    var byte0 = data[0];\n    var bit0 = (byte0 & 0b00000001) !== 0;  // Bit 0\n    var bit1 = (byte0 & 0b00000010) !== 0;  // Bit 1\n    var bit2 = (byte0 & 0b00000100) !== 0;  // Bit 2 \n    var bit3 = (byte0 & 0b00001000) !== 0;  // Bit 3 Request full charge\n    var bit4 = (byte0 & 0b00010000) !== 0;  // Bit 4 Request force charge II\n    var bit5 = (byte0 & 0b00100000) !== 0;  // Bit 5 Request force charge I\n    var bit6 = (byte0 & 0b01000000) !== 0;  // Bit 6 Discharge enable\n    var bit7 = (byte0 & 0b10000000) !== 0;  // Bit 7 Charge enable\n    \n// *For US2000B: Please use bit 5, the SOC range is: 15~19%. Bit 4 is NULL.\n// *For US2000B-Plus: Bit 5 the SOC range is 5~10%,\n// Bit 4 the SOC range is 9~13%.\n// Bit 5 is designed for inverter allows battery to shut down, and able to wake battery up to charge it.\n// Bit 4 is designed for inverter doesn`t want battery to shut down, able to charge battery before shut down to\n// avoid low energy. We suggest inverter to use this bit,\n// In this case, inverter itself should set a threshold of SOC: after force charge, only when battery SOC is higher\n// than this threshold then inverter will allow discharge, to avoid force charge and discharge status change\n// frequently.\n// **Request full charge:\n// Reason: when battery is not full charged for long time, the accumulative error of SOC calculation will be too\n// high and may not able to be charged or discharged as expected capacity.\n// Logic: if SOC never higher than 97% in 30 days, will set this flag to 1. And when the SOC is \u2265 97%, the flag\n// will be 0.\n// How to: we suggest inverter to charge the battery by grid when this flag is 1\n\n\n// Variable zur Steuerung des Loggens\n    var loggingEnabled = false;  // \u00c4ndere den Wert dieser Variable nach Bedarf\n\n    if (loggingEnabled) {\n    // Ausgabe der Werte in der Konsole (kann je nach Bedarf angepasst werden)\n    console.log('CAN ID:', canid);\n    //console.log('DLC:', dlc);\n    console.log('Batt Request full charge:', bit3, 'Logic');\n    console.log('Batt Request force charge II:', bit4, 'Logic');\n    console.log('Batt Request force charge I:', bit5, 'Logic');\n    console.log('Batt Discharge enable:', bit6, 'Logic');\n    console.log('Batt Charge enable:', bit7, 'Logic');\n    }\n    \n    // Hier k\u00f6nnen Sie die Werte weiterverarbeiten oder in den n\u00e4chsten Node senden\n    // ...\n\n    // Senden der Werte in der Nachricht zur\u00fcck\n    msg.payload = {\n        canid: canid,\n    //    dlc: dlc,\n        bit3: bit3,\n        bit4: bit4,\n        bit5: bit5,\n        bit6: bit6,\n        bit7: bit7\n    };\n\n    return msg;\n} else {\n    // Fehlerbehandlung, wenn der Payload kein g\u00fcltiges JSON-Objekt ist\n    console.error('Ung\u00fcltiger Payload:', payload);\n    return null;\n}\n",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 920,
    "y": 1420,
    "wires": [
      [
        "66e419facf0a12c3",
        "1ce96306f3e12063",
        "2a784e3b.f8cc4a"
      ]
    ]
  },
  {
    "id": "bec2f8ce59c3d53d",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "CAN_359",
    "func": "// Den Payload aus der Nachricht extrahieren\nvar payload = msg.payload;\n\n// \u00dcberpr\u00fcfen, ob der Payload ein g\u00fcltiges JSON-Objekt ist\nif (typeof payload === 'object' && payload !== null) {\n    // Extrahieren der Werte\n    var canid = parseInt(payload.canid);\n    var dlc = payload.dlc;\n    var data = payload.data;\n\n    // Zerlegen von Byte 0 in Bits 0-7\n    var byte0 = data[0];\n    var by0bit0 = (byte0 & 0b00000001) !== 0;  // Bit 0 \n    var by0bit1 = (byte0 & 0b00000010) !== 0;  // Bit 1 Cell or module over voltage\n    var by0bit2 = (byte0 & 0b00000100) !== 0;  // Bit 2 Cell or module under voltage \n    var by0bit3 = (byte0 & 0b00001000) !== 0;  // Bit 3 Cell or module over Temp\n    var by0bit4 = (byte0 & 0b00010000) !== 0;  // Bit 4 Cell or module under Temp\n    var by0bit5 = (byte0 & 0b00100000) !== 0;  // Bit 5 \n    var by0bit6 = (byte0 & 0b01000000) !== 0;  // Bit 6 \n    var by0bit7 = (byte0 & 0b10000000) !== 0;  // Bit 7 Discharge over Current\n    \n    var byte1 = data[1];\n    var by1bit0 = (byte0 & 0b00000001) !== 0;  // Bit 0 Charge over Current\n    var by1bit1 = (byte0 & 0b00000010) !== 0;  // Bit 1\n    var by1bit2 = (byte0 & 0b00000100) !== 0;  // Bit 2 \n    var by1bit3 = (byte0 & 0b00001000) !== 0;  // Bit 3 System error\n    var by1bit4 = (byte0 & 0b00010000) !== 0;  // Bit 4 \n    var by1bit5 = (byte0 & 0b00100000) !== 0;  // Bit 5 \n    var by1bit6 = (byte0 & 0b01000000) !== 0;  // Bit 6 \n    var by1bit7 = (byte0 & 0b10000000) !== 0;  // Bit 7 \n    \n    var byte2 = data[2];\n    var by2bit0 = (byte0 & 0b00000001) !== 0;  // Bit 0 \n    var by2bit1 = (byte0 & 0b00000010) !== 0;  // Bit 1 Cell or module high voltage\n    var by2bit2 = (byte0 & 0b00000100) !== 0;  // Bit 2 Cell or module low voltage\n    var by2bit3 = (byte0 & 0b00001000) !== 0;  // Bit 3 Cell High Temp \n    var by2bit4 = (byte0 & 0b00010000) !== 0;  // Bit 4 Cell Low Temp \n    var by2bit5 = (byte0 & 0b00100000) !== 0;  // Bit 5 \n    var by2bit6 = (byte0 & 0b01000000) !== 0;  // Bit 6 \n    var by2bit7 = (byte0 & 0b10000000) !== 0;  // Bit 7 Discharge High Current\n    \n    var byte3 = data[3];\n    var by3bit0 = (byte0 & 0b00000001) !== 0;  // Bit 0 Charge high Current\n    var by3bit1 = (byte0 & 0b00000010) !== 0;  // Bit 1\n    var by3bit2 = (byte0 & 0b00000100) !== 0;  // Bit 2 \n    var by3bit3 = (byte0 & 0b00001000) !== 0;  // Bit 3 Internal Communication failure\n    var by3bit4 = (byte0 & 0b00010000) !== 0;  // Bit 4 \n    var by3bit5 = (byte0 & 0b00100000) !== 0;  // Bit 5 \n    var by3bit6 = (byte0 & 0b01000000) !== 0;  // Bit 6 \n    var by3bit7 = (byte0 & 0b10000000) !== 0;  // Bit 7 \n\n    var byte4 = parseInt(data[4]); // Module numbers 8 bits unsigned char\n    \n    var byte5 = data[5]; // \u201cP\u201d 0x50\n    var byte6 = data[6]; // \u201cN\u201d 0x4E\n\n// Variable zur Steuerung des Loggens\n    var loggingEnabled = false;  // \u00c4ndere den Wert dieser Variable nach Bedarf\n\n    if (loggingEnabled) {\n\n    // Ausgabe der Werte in der Konsole (kann je nach Bedarf angepasst werden)\n    console.log('CAN ID:', canid);\n    //console.log('DLC:', dlc);\n    console.log('Protection - Table 1 - Byte 0');\n    console.log('Bit 0 :', by0bit0);\n    console.log('Cell or module over voltage:', by0bit1);\n    console.log('Cell or module under voltage:', by0bit2);\n    console.log('Cell or module over Temp:', by0bit3);\n    console.log('Cell or module under Temp:', by0bit4);\n    console.log('Bit 5:', by0bit5);\n    console.log('Bit 6:', by0bit6);\n    console.log('Discharge over Current:', by0bit7);\n    console.log('Protection - Table 2 - Byte 1');  \n    console.log('Charge over Current:', by1bit0);\n    console.log('Bit 1:', by1bit1);\n    console.log('Bit 2:', by1bit2);\n    console.log('System error:', by1bit3);\n    console.log('Bit 4:', by1bit4);\n    console.log('Bit 5:', by1bit5);\n    console.log('Bit 6:', by1bit6);\n    console.log('Bit 7:', by1bit7);\n    console.log('Alarm - Table 3 - Byte 2');    \n    console.log('Bit 0:', by2bit0);\n    console.log('Cell or module high voltage:', by2bit1);\n    console.log('Cell or module low voltage:', by2bit2);\n    console.log('Cell High Temp:', by2bit3);\n    console.log('Cell Low Temp:', by2bit4);\n    console.log('Bit 5:', by2bit5);\n    console.log('Bit 6:', by2bit6);\n    console.log('Discharge High Current:', by2bit7);\n    console.log('Alarm - Table 4 - Byte 4');\n    console.log('Charge high Current:', by3bit0);\n    console.log('Bit 1:', by3bit1);\n    console.log('Bit 2:', by3bit2);\n    console.log('Internal Communication failure:', by3bit3);\n    console.log('Bit 4:', by3bit4);\n    console.log('Bit 5:', by3bit5);\n    console.log('Bit 6:', by3bit6);\n    console.log('Bit 7:', by3bit7);\n    \n    console.log('Module numbers:', byte4);\n    console.log('Byte 5:', byte5);\n    console.log('Byte 6:', byte6);\n    }\n    // Hier k\u00f6nnen Sie die Werte weiterverarbeiten oder in den n\u00e4chsten Node senden\n    // ...\n\n    // Senden der Werte in der Nachricht zur\u00fcck\n    msg.payload = {\n        canid: canid,\n    //    dlc: dlc,\n        by0bit0: by0bit0,\n        by0bit1: by0bit1,\n        by0bit2: by0bit2,\n        by0bit3: by0bit3,\n        by0bit4: by0bit4,\n        by0bit5: by0bit5,\n        by0bit6: by0bit6,\n        by0bit7: by0bit7,\n        by1bit0: by1bit0,\n        by1bit1: by1bit1,\n        by1bit2: by1bit2,\n        by1bit3: by1bit3,\n        by1bit4: by1bit4,\n        by1bit5: by1bit5,\n        by1bit6: by1bit6,\n        by1bit7: by1bit7,\n        by2bit0: by2bit0,\n        by2bit1: by2bit1,\n        by2bit2: by2bit2,\n        by2bit3: by2bit3,\n        by2bit4: by2bit4,\n        by2bit5: by2bit5,\n        by2bit6: by2bit6,\n        by2bit7: by2bit7,\n        by3bit0: by3bit0,\n        by3bit1: by3bit1,\n        by3bit2: by3bit2,\n        by3bit3: by3bit3,\n        by3bit4: by3bit4,\n        by3bit5: by3bit5,\n        by3bit6: by3bit6,\n        by3bit7: by3bit7,\n        byte4: byte4,\n        byte5: byte5,\n        byte6: byte6\n    };\n\n    return msg;\n} else {\n    // Fehlerbehandlung, wenn der Payload kein g\u00fcltiges JSON-Objekt ist\n    console.error('Ung\u00fcltiger Payload:', payload);\n    return null;\n}\n",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 920,
    "y": 1460,
    "wires": [
      [
        "66e419facf0a12c3",
        "2a784e3b.f8cc4a",
        "6448a0e4aa5a893a"
      ]
    ]
  },
  {
    "id": "0c9aa23a46bec0ff",
    "type": "comment",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "",
    "info": "Hier wird die CAN Schnittstelle vom Waveshield CAN HAT angesprochen und das CAN-BUS Telegramm ausgewertet, was der Akku-Pack dem PV-Inverter schickt.",
    "x": 220,
    "y": 380,
    "wires": []
  },
  {
    "id": "8c39694a471afa61",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "name": "debug 14",
    "active": false,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "false",
    "statusVal": "",
    "statusType": "auto",
    "x": 1600,
    "y": 1660,
    "wires": []
  },
  {
    "id": "1df1c87baeb56883",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "name": "debug 15",
    "active": false,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "false",
    "statusVal": "",
    "statusType": "auto",
    "x": 1400,
    "y": 1700,
    "wires": []
  },
  {
    "id": "2a784e3b.f8cc4a",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Verarbeite payload",
    "func": "// Initialisiere leere Payload-Variablen f\u00fcr jede relevante canid\nvar payload_351, payload_355, payload_356, payload_359, payload_35c;\n\n// \u00dcberpr\u00fcfe den Input-Wert\nvar inputValue = msg.payload.content;\n\n// \u00dcberpr\u00fcfe, ob der Input-Wert \"Battery\" ist\nif (inputValue === \"Battery\") {\n    // Sammle die relevanten Nachrichten f\u00fcr jede canid\n    if (msg.payload.canid == 351) {\n        payload_351 = msg.payload;\n    } else if (msg.payload.canid == 355) {\n        payload_355 = msg.payload;\n    } else if (msg.payload.canid == 356) {\n        payload_356 = msg.payload;\n    } else if (msg.payload.canid == 359) {\n        payload_359 = msg.payload;\n    }\n\n\n    // Wenn alle relevanten Nachrichten gesammelt wurden, erstelle die Antwortnachricht\n    if (payload_351 && payload_355 && payload_356 && payload_359) {\n        var responseData = 'Daten erstellt basierend auf Eingabe';\n\n        // Sende die Antwort zur\u00fcck mit allen gesammelten Nachrichten und der Beschreibung\n        msg.payload = {\n            chatId: 741143260,\n            type: \"message\",\n            content: responseData,\n            data: {\n                payload_351: payload_351,\n                payload_355: payload_355,\n                payload_356: payload_356,\n                payload_359: payload_359,\n            }\n        };\n        return msg.payload;\n    }\n} else {\n    // Optional: Wenn der Wert nicht \"Battery\" ist, kannst du eine andere Aktion durchf\u00fchren oder die Nachricht ignorieren\n    return null;\n}",
    "outputs": 2,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1230,
    "y": 1600,
    "wires": [
      [],
      []
    ]
  },
  {
    "id": "4927f36cc8178032",
    "type": "inject",
    "z": "f1180e03d0981a44",
    "name": "",
    "props": [
      {
        "p": "payload"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "Battery",
    "payloadType": "str",
    "x": 1010,
    "y": 1720,
    "wires": [
      [
        "22dc4f86e33e616c"
      ]
    ]
  },
  {
    "id": "22dc4f86e33e616c",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "function 2",
    "func": "// Initialisiere leere Payload-Variablen f\u00fcr jede relevante canid\nvar payload_351, payload_355, payload_356, payload_359, payload_35c;\n\n// \u00dcberpr\u00fcfe den Input-Wert\nvar inputValue = msg.payload.content;\n\n// \u00dcberpr\u00fcfe, ob der Input-Wert \"Battery\" ist\nif (msg.payload && msg.payload.canid === 0x351) {\n    console.log(\"Nachricht f\u00fcr canid 0x351 gefunden.\");\n    payload_351 = msg.payload;\n} else if (msg.payload && msg.payload.canid === 853) {\n    console.log(\"Nachricht f\u00fcr canid 0x355 gefunden.\");\n    payload_355 = msg.payload;\n} else if (msg.payload && msg.payload.canid === 854) {\n    console.log(\"Nachricht f\u00fcr canid 0x356 gefunden.\");\n    payload_356 = msg.payload;\n} else if (msg.payload && msg.payload.canid === 857) {\n    console.log(\"Nachricht f\u00fcr canid 0x359 gefunden.\");\n    payload_359 = msg.payload;\n} else if (msg.payload && msg.payload.canid === 860) {\n    console.log(\"Nachricht f\u00fcr canid 0x35c gefunden.\");\n    payload_35c = msg.payload;\n}\n\n// \u00dcberpr\u00fcfen der vorhandenen payloads\nconsole.log(\"payload_351: \" + JSON.stringify(payload_351));\nconsole.log(\"payload_355: \" + JSON.stringify(payload_355));\nconsole.log(\"payload_356: \" + JSON.stringify(payload_356));\nconsole.log(\"payload_359: \" + JSON.stringify(payload_359));\n\n// \u00dcberpr\u00fcfen, ob alle relevanten payloads vorhanden sind\nif (payload_351 && payload_355 && payload_356 && payload_359) {\n    console.log(\"Alle relevanten Nachrichten gesammelt. Erstelle Antwortnachricht.\");\n    var responseData = 'Daten erstellt basierend auf Eingabe';\n\n    // Konvertiere die Daten in einen lesbaren Text\n    var textData = \"Daten basierend auf Eingabe:\\n\\n\";\n    textData += \"payload_351: \" + JSON.stringify(payload_351) + \"\\n\";\n    textData += \"payload_355: \" + JSON.stringify(payload_355) + \"\\n\";\n    textData += \"payload_356: \" + JSON.stringify(payload_356) + \"\\n\";\n    textData += \"payload_359: \" + JSON.stringify(payload_359) + \"\\n\";\n\nif (inputValue === \"Battery\") {\n        // Sende die Antwort als Textnachricht\n        msg.payload = {\n            chatId: 741143260,\n            type: \"message\",\n            content: textData\n        };\n        return msg;\n    }\n} else {\n    //console.log(\"Input-Wert ist nicht 'Battery'. Ignoriere die Nachricht.\");\n    // Optional: Wenn der Wert nicht \"Battery\" ist, kannst du eine andere Aktion durchf\u00fchren oder die Nachricht ignorieren\n    return null;\n}\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1200,
    "y": 1660,
    "wires": [
      [
        "8bca20052e0a2b2e",
        "1df1c87baeb56883"
      ]
    ]
  },
  {
    "id": "860e5b13c0421877",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Check_Connection",
    "func": "var timer;\n\nif (msg.payload !== undefined && msg.payload !== null) {\n    clearTimeout(timer); // Zur\u00fccksetzen des Timers, wenn ein g\u00fcltiges Payload empfangen wird\n    return { payload: true };\n} else {\n    // Starten eines Timers, um nach 5 Sekunden automatisch \"false\" zur\u00fcckzugeben\n    timer = setTimeout(function() {\n        return { payload: false };\n    }, 5000); // Timer auf 5000 Millisekunden (5 Sekunden) einstellen\n}\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 510,
    "y": 1240,
    "wires": [
      [
        "1d4d4916a28b8912"
      ]
    ]
  },
  {
    "id": "2e4d8a1e.f3c1c6",
    "type": "inject",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "",
    "props": [
      {
        "p": "payload",
        "v": "[3.395,3.392,3.292,3.293,3.292,3.291,3.292,3.292,3.292,3.293,3.292,3.292,3.293,3.293,3.291,3.293]",
        "vt": "json"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 320,
    "y": 420,
    "wires": [
      []
    ]
  },
  {
    "id": "2d305672db6afcd6",
    "type": "function",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "Cellen 01-16",
    "func": "var hex_string = msg.payload.toString(); // Stellen Sie sicher, dass msg.payload eine Zeichenfolge ist\nvar CellsVoltage = []; // Initialisieren Sie CellsVoltage als Array\nvar Voltagesum = 0, Voltagemax = 0, Voltagemin = 0, Voltagediff = 0;\n\nvar start1 = 27;\nvar pairs1 = [];\nvar index1 = start1;\n\n// Erste Schleife\nfor (var i = start1; i < start1  + 64; j += 4) {\n    hex_pair = hex_string.substr(i, 4);\n    decimal = parseInt(hex_pair, 16) / 1000;\n    //pairs2.push(decimal);\n}\n\n\n\nvar start2 = 26;\nvar pairs2 = [];\nvar index2 = start2;\n\n// Zweite Schleife\nfor (var j = start2; j < start2 + 56; j += 4) {\n    hex_pair = hex_string.substr(j, 4);\n    decimal = parseInt(hex_pair, 16) / 1000;\n    //pairs2.push(decimal);\n}\n\n// Kombinieren der beiden Arrays\nvar combinedArray = pairs1 //.concat(pairs2);\n\n// F\u00fcgen Sie die kombinierten Arrays zu CellsVoltage hinzu oder aktualisieren Sie sie\nif (!Array.isArray(msg.payload.CellsVoltage)) {\n    // Wenn CellsVoltage nicht als Array definiert ist, initialisieren Sie es mit den kombinierten Array-Daten\n    CellsVoltage = combinedArray;\n} else {\n    // Wenn CellsVoltage bereits als Array definiert ist, aktualisieren Sie es mit den kombinierten Array-Daten\n    CellsVoltage = msg.payload.CellsVoltage.concat(combinedArray);\n}\n\n// \u00dcberpr\u00fcfen, ob CellsVoltage definiert und ein Array ist\nif (Array.isArray(CellsVoltage)) {\n    // Finden des h\u00f6chsten und niedrigsten Werts im Array\n    var max = findMax(CellsVoltage);\n    var min = findMin(CellsVoltage);\n\n    // Berechnen der Differenz zwischen dem h\u00f6chsten und niedrigsten Wert\n    var diff = max - min;\n\n    // Summieren der Werte im Array\n    var sum = CellsVoltage.reduce(function (accumulator, currentValue) {\n        return accumulator + currentValue;\n    }, 0);\n\n    // Erstellen der Nachricht mit den Ergebnissen\n    var message = {\n        payload: {\n            CellsVoltage: CellsVoltage,\n            Voltagesum: sum.toFixed(3),\n            Voltagemax: max.toFixed(3),\n            Voltagemin: min.toFixed(3),    \n            Voltagediff: diff.toFixed(3),\n        }\n    };\n\n    // Senden der Nachricht mit den Ergebnissen\n    node.send(message);\n} else {\n    // Handle den Fall, wenn CellsVoltage nicht definiert ist oder kein Array ist\n    node.error(\"CellsVoltage ist nicht definiert oder kein Array.\");\n}\n\n// Funktion zum Finden des h\u00f6chsten Werts\nfunction findMax(array) {\n    return array.reduce(function (max, current) {\n        return current > max ? current : max;\n    }, -Infinity);\n}\n\n// Funktion zum Finden des niedrigsten Werts\nfunction findMin(array) {\n    return array.reduce(function (min, current) {\n        return current < min ? current : min;\n    }, Infinity);\n}\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 770,
    "y": 300,
    "wires": [
      [
        "1b1536c34840150e",
        "f64c5617c32d4275",
        "f2ede2181fd21d29",
        "c9c149cac8329ed6",
        "912b734eed741039",
        "14fa317d9fe0ef5e",
        "17d3c56ddce1ccd3",
        "3cf617dcb3771d54",
        "841bfdb145d74273",
        "b7dd6b81a67db833",
        "832da047c65f31ff",
        "8fc63af0b7f7b4ed",
        "eae64878babef39b",
        "901a76c40402e5bc",
        "371f1d82f3fbe6da",
        "989ffb4fcc549942",
        "20c50e8e698cb76a",
        "758e0b4212c2ca6c",
        "fd427fca52c47f7f",
        "86916d256e50271f"
      ]
    ]
  },
  {
    "id": "34ae9d8909688e4a",
    "type": "function",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "Check_Connection",
    "func": "// Globale Variable, um den letzten Zeitstempel zu speichern\nvar lastPayloadTime = Date.now();\n\n// Hauptfunktionslogik\nif (msg.payload !== undefined && msg.payload !== null) {\n    lastPayloadTime = Date.now(); // Aktualisiere den Zeitstempel, wenn ein g\u00fcltiger Payload empfangen wird\n    return { payload: true };\n} else {\n    // \u00dcberpr\u00fcfe, ob seit dem letzten g\u00fcltigen Payload mehr als 5 Sekunden vergangen sind\n    if (Date.now() - lastPayloadTime > 5000) {\n        return { payload: false };\n    }\n}\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 750,
    "y": 500,
    "wires": [
      [
        "e8ed04af9bc673b4"
      ]
    ]
  },
  {
    "id": "332567cb789debb2",
    "type": "function",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "Check_Connection",
    "func": "// Globale Variable, um den letzten Zeitstempel zu speichern\nvar lastPayloadTime = Date.now();\n\n// Hauptfunktionslogik\nif (msg.payload !== undefined && msg.payload !== null) {\n    lastPayloadTime = Date.now(); // Aktualisiere den Zeitstempel, wenn ein g\u00fcltiger Payload empfangen wird\n    return { payload: true };\n} else {\n    // \u00dcberpr\u00fcfe, ob seit dem letzten g\u00fcltigen Payload mehr als 5 Sekunden vergangen sind\n    if (Date.now() - lastPayloadTime > 5000) {\n        return { payload: false };\n    }\n}\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 750,
    "y": 260,
    "wires": [
      [
        "c27d0a7f2b0a570d"
      ]
    ]
  },
  {
    "id": "b8f4268f.9a5d9",
    "type": "trigger",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "Stop Timer",
    "op1": "",
    "op2": "false",
    "op1type": "nul",
    "op2type": "bool",
    "duration": "1",
    "extend": false,
    "overrideDelay": false,
    "units": "s",
    "reset": "true",
    "bytopic": "all",
    "topic": "topic",
    "outputs": 1,
    "x": 770,
    "y": 220,
    "wires": [
      [
        "c27d0a7f2b0a570d"
      ]
    ]
  },
  {
    "id": "b8be7f2b15aa05c7",
    "type": "trigger",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "Stop Timer",
    "op1": "",
    "op2": "false",
    "op1type": "nul",
    "op2type": "bool",
    "duration": "1",
    "extend": false,
    "overrideDelay": false,
    "units": "s",
    "reset": "true",
    "bytopic": "all",
    "topic": "topic",
    "outputs": 1,
    "x": 770,
    "y": 460,
    "wires": [
      [
        "e8ed04af9bc673b4"
      ]
    ]
  },
  {
    "id": "938d30ec3e1c05fd",
    "type": "trigger",
    "z": "f1180e03d0981a44",
    "name": "Stop Timer",
    "op1": "",
    "op2": "false",
    "op1type": "nul",
    "op2type": "bool",
    "duration": "1",
    "extend": false,
    "overrideDelay": false,
    "units": "s",
    "reset": "true",
    "bytopic": "all",
    "topic": "topic",
    "outputs": 1,
    "x": 530,
    "y": 1200,
    "wires": [
      [
        "1d4d4916a28b8912"
      ]
    ]
  },
  {
    "id": "6448a0e4aa5a893a",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "HTML - Daten als Tabelle Red Green",
    "func": "// HTML-Tabelle als Text\nvar htmlTable = `\n<table border=\"1\">\n    <tr>\n        <th>Key</th>\n        <th>Value</th>\n    </tr>\n    <tr>\n        <td>canid</td>\n        <td>${msg.payload.canid}</td>\n    </tr>\n    <tr>\n        <td>Cell or module over voltage:</td>\n        <td style=\"color: ${msg.payload.by0bit1 ? 'lime' : 'red'};\">${msg.payload.by0bit1}</td>\n    </tr>\n    <tr>\n        <td>Cell or module under voltage:</td>\n        <td style=\"color: ${msg.payload.by0bit2 ? 'lime' : 'red'};\">${msg.payload.by0bit2}</td>\n    </tr>\n    <tr>\n        <td>Cell or module over Temp:</td>\n        <td style=\"color: ${msg.payload.by0bit3 ? 'lime' : 'red'};\">${msg.payload.by0bit3}</td>\n    </tr>\n    <tr>\n        <td>Cell or module under Temp:</td>\n        <td style=\"color: ${msg.payload.by0bit4 ? 'lime' : 'red'};\">${msg.payload.by0bit4}</td>\n    </tr>\n    <tr>\n        <td>Discharge over Current:</td>\n        <td style=\"color: ${msg.payload.by0bit7 ? 'lime' : 'red'};\">${msg.payload.by0bit7}</td>\n    </tr>\n    <tr>\n        <td>Charge over Current:</td>\n        <td style=\"color: ${msg.payload.by1bit0 ? 'lime' : 'red'};\">${msg.payload.by1bit0}</td>\n    </tr>\n    <tr>\n        <td>System error:</td>\n        <td style=\"color: ${msg.payload.by1bit3 ? 'lime' : 'red'};\">${msg.payload.by1bit3}</td>\n    </tr>\n    <tr>\n        <td>Cell or module high voltage:</td>\n        <td style=\"color: ${msg.payload.by2bit1 ? 'lime' : 'red'};\">${msg.payload.by2bit1}</td>\n    </tr>\n    <tr>\n        <td>Cell or module low voltage:</td>\n        <td style=\"color: ${msg.payload.by2bit2 ? 'lime' : 'red'};\">${msg.payload.by2bit2}</td>\n    </tr>\n    <tr>\n        <td>Cell High Temp:</td>\n        <td style=\"color: ${msg.payload.by2bit3 ? 'lime' : 'red'};\">${msg.payload.by2bit3}</td>\n    </tr>\n    <tr>\n        <td>Cell Low Temp:</td>\n        <td style=\"color: ${msg.payload.by2bit4 ? 'lime' : 'red'};\">${msg.payload.by2bit4}</td>\n    </tr>\n    <tr>\n        <td>Discharge High Current:</td>\n        <td style=\"color: ${msg.payload.by2bit7 ? 'lime' : 'red'};\">${msg.payload.by2bit7}</td>\n    </tr>\n    <tr>\n        <td>Charge high Current:</td>\n        <td style=\"color: ${msg.payload.by3bit0 ? 'lime' : 'red'};\">${msg.payload.by3bit0}</td>\n    </tr>\n    <tr>\n        <td>Internal Communication failure:</td>\n        <td style=\"color: ${msg.payload.by3bit3 ? 'lime' : 'red'};\">${msg.payload.by3bit3}</td>\n    </tr>\n    <tr>\n        <td>Module numbers:</td>\n        <td>${msg.payload.byte4}</td>\n    </tr>\n    <tr>\n        <td>byte5</td>\n        <td>${msg.payload.byte5}</td>\n    </tr>\n    <tr>\n        <td>byte6</td>\n        <td>${msg.payload.byte6}</td>\n    </tr>\n</table>\n`;\n\n// R\u00fcckgabe des HTML-Codes\nreturn { payload: htmlTable };\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1270,
    "y": 1460,
    "wires": [
      [
        "289aa0e0143f3f80"
      ]
    ]
  },
  {
    "id": "3d53b845d1f5c1af",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "CAN_359_to_Table",
    "func": "// Den Payload aus der Nachricht extrahieren\nvar payload = msg.payload;\n\n// \u00dcberpr\u00fcfen, ob der Payload ein g\u00fcltiges JSON-Objekt ist\nif (payload && payload.data) {\n    // Extrahieren der Werte\n    var data = payload.data;\n\n    // Zerlegen von Byte 0 in Bits 0-7\n    var byte0 = data[0];\n    var by0bit0 = (byte0 & 0b00000001) !== 0;  // Bit 0 \n    var by0bit1 = (byte0 & 0b00000010) !== 0;  // Bit 1 Cell or module over voltage\n    var by0bit2 = (byte0 & 0b00000100) !== 0;  // Bit 2 Cell or module under voltage \n    var by0bit3 = (byte0 & 0b00001000) !== 0;  // Bit 3 Cell or module over Temp\n    var by0bit4 = (byte0 & 0b00010000) !== 0;  // Bit 4 Cell or module under Temp\n    var by0bit5 = (byte0 & 0b00100000) !== 0;  // Bit 5 \n    var by0bit6 = (byte0 & 0b01000000) !== 0;  // Bit 6 \n    var by0bit7 = (byte0 & 0b10000000) !== 0;  // Bit 7 Discharge over Current\n    \n    var byte1 = data[1];\n    var by1bit0 = (byte0 & 0b00000001) !== 0;  // Bit 0 Charge over Current\n    var by1bit1 = (byte0 & 0b00000010) !== 0;  // Bit 1\n    var by1bit2 = (byte0 & 0b00000100) !== 0;  // Bit 2 \n    var by1bit3 = (byte0 & 0b00001000) !== 0;  // Bit 3 System error\n    var by1bit4 = (byte0 & 0b00010000) !== 0;  // Bit 4 \n    var by1bit5 = (byte0 & 0b00100000) !== 0;  // Bit 5 \n    var by1bit6 = (byte0 & 0b01000000) !== 0;  // Bit 6 \n    var by1bit7 = (byte0 & 0b10000000) !== 0;  // Bit 7 \n    \n    var byte2 = data[2];\n    var by2bit0 = (byte0 & 0b00000001) !== 0;  // Bit 0 \n    var by2bit1 = (byte0 & 0b00000010) !== 0;  // Bit 1 Cell or module high voltage\n    var by2bit2 = (byte0 & 0b00000100) !== 0;  // Bit 2 Cell or module low voltage\n    var by2bit3 = (byte0 & 0b00001000) !== 0;  // Bit 3 Cell High Temp \n    var by2bit4 = (byte0 & 0b00010000) !== 0;  // Bit 4 Cell Low Temp \n    var by2bit5 = (byte0 & 0b00100000) !== 0;  // Bit 5 \n    var by2bit6 = (byte0 & 0b01000000) !== 0;  // Bit 6 \n    var by2bit7 = (byte0 & 0b10000000) !== 0;  // Bit 7 Discharge High Current\n    \n    var byte3 = data[3];\n    var by3bit0 = (byte0 & 0b00000001) !== 0;  // Bit 0 Charge high Current\n    var by3bit1 = (byte0 & 0b00000010) !== 0;  // Bit 1\n    var by3bit2 = (byte0 & 0b00000100) !== 0;  // Bit 2 \n    var by3bit3 = (byte0 & 0b00001000) !== 0;  // Bit 3 Internal Communication failure\n    var by3bit4 = (byte0 & 0b00010000) !== 0;  // Bit 4 \n    var by3bit5 = (byte0 & 0b00100000) !== 0;  // Bit 5 \n    var by3bit6 = (byte0 & 0b01000000) !== 0;  // Bit 6 \n    var by3bit7 = (byte0 & 0b10000000) !== 0;  // Bit 7 \n\n    var byte4 = parseInt(data[4]); // Module numbers 8 bits unsigned char\n    \n    var byte5 = data[5]; // \u201cP\u201d 0x50\n    var byte6 = data[6]; // \u201cN\u201d 0x4E\n    var canid = payload.canid;\n\n    var AlarmColor =[\"white\"];\n\nvar payload = [\n    {\n        \"Name\": \"Cell or module over voltage\",\n        \"Boolean\": by0bit1,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 0 Bit 1\",\n        \"Color\": AlarmColor[0]\n    },\n\t    {\n        \"Name\": \"Cell or module unde voltage\",\n        \"Boolean\": by0bit2,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 0 Bit 2\",\n        \"Color\": AlarmColor[1]\n    },\n\t    {\n        \"Name\": \"Cell or module over Temp\",\n        \"Boolean\": by0bit3,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 0 Bit 3\",\n        \"Color\": AlarmColor[2]\n    },\n\t    {\n        \"Name\": \"Cell or module under Temp\",\n        \"Boolean\": by0bit4,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 0 Bit 4\",\n        \"Color\": AlarmColor[3]\n    },\n\t    {\n        \"Name\": \"Discharge over Current\",\n        \"Boolean\": by0bit7,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 0 Bit 7\",\n        \"Color\": AlarmColor[4]\n    },\n\t    {\n        \"Name\": \"Charge over Current\",\n        \"Boolean\": by1bit0,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 1 Bit 0\",\n        \"Color\": AlarmColor[5]\n    },\n\t    {\n        \"Name\": \"System error\",\n        \"Boolean\": by1bit3,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 1 Bit 3\",\n        \"Color\": AlarmColor[6]\n    },\n\t    {\n        \"Name\": \"Cell or module high voltage\",\n        \"Boolean\": by2bit1,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 2 Bit 1\",\n        \"Color\": AlarmColor[7]\n    },\n\t    {\n        \"Name\": \"Cell or module low voltage\",\n        \"Boolean\": by2bit2,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 2 Bit 2\",\n        \"Color\": AlarmColor[8]\n    },\n\t    {\n        \"Name\": \"Cell High Temp\",\n        \"Boolean\": by2bit3,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 2 Bit 3\",\n        \"Color\": AlarmColor[9]\n    },\n\t    {\n        \"Name\": \"Cell Low Temp\",\n        \"Boolean\": by2bit4,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 2 Bit 4\",\n        \"Color\": AlarmColor[10]\n    },\n\t    {\n        \"Name\": \"Discharge High Current\",\n        \"Boolean\": by2bit7,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 2 Bit 7\",\n        \"Color\": AlarmColor[11]\n    },\n\t    {\n        \"Name\": \"Charge High Current\",\n        \"Boolean\": by3bit0,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 3 Bit 0\",\n        \"Color\": AlarmColor[12]\n    },\n\t    {\n        \"Name\": \"Internal Communication failure\",\n        \"Boolean\": by3bit3,\n        \"Real\": \"\",\n        \"Prog\":\"\",\n        \"Adresse\" : \"Byte 3 Bit 3\",\n        \"Color\": AlarmColor[13]\n    },\n\t\n];\n\n\n\n\n    // R\u00fcckgabe des Ergebnisobjekts\n    msg.payload = payload ;\n    return msg;\n} else {\n    // Behandlung, wenn keine g\u00fcltigen Daten im Payload gefunden werden\n    return null;\n}\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 890,
    "y": 1500,
    "wires": [
      [
        "63ebf8046e63f148"
      ]
    ]
  },
  {
    "id": "6fa342791a5ee608",
    "type": "function",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "RS485_Akku_3_to_Table",
    "func": "var hex_string = msg.payload;\nvar CellsVoltage = [];\nvar Voltagesum = 0, Voltagemax = 0, Voltagemin = 0, Voltagediff = 0;\n\nvar start1 = 56;\nvar pairs1 = [];\nvar index1 = start1;\n\n// Erste Schleife\nfor (var i = start1; i < start1 + 8; i += 4) {\n    var hex_pair = hex_string.substr(i, 4);\n    var decimal = parseInt(hex_pair, 16) / 1000;\n    pairs1.push(decimal);\n}\n\nvar start2 = 71;\nvar pairs2 = [];\nvar index2 = start2;\n\n// Zweite Schleife\nfor (var j = start2; j < start2 + 56; j += 4) {\n    hex_pair = hex_string.substr(j, 4);\n    decimal = parseInt(hex_pair, 16) / 1000;\n    pairs2.push(decimal);\n}\n\n// Kombinieren der beiden Arrays\nvar combinedArray = pairs1.concat(pairs2);\n\n// Finden des h\u00f6chsten und niedrigsten Werts im Array\nvar max = findMax(combinedArray);\nvar min = findMin(combinedArray);\n\n// Berechnen der Differenz zwischen dem h\u00f6chsten und niedrigsten Wert\nvar diff = max - min;\n\n// Summieren der Werte im Array\nvar sum = combinedArray.reduce(function (accumulator, currentValue) {\n    return accumulator + currentValue;\n}, 0);\n\n// \u00dcberpr\u00fcfen, ob der Payload ein g\u00fcltiges JSON-Objekt ist\n\n    var payload = [];\n    var offset = 1;\n    var AlarmColor = [\"white\"]; // Annahme, dass AlarmColor ein Array von Farben ist\n\n    for (var i = 0; i < combinedArray.length; i++) {\n        payload.push({\n            \"Name\": \"Cell \" + (offset + i),\n            \"Boolean\": \"\",\n            \"Real\": combinedArray[i] + \" V\",\n            \"Prog\": \"\",\n            \"Adresse\": \"\",\n            \"Color\": AlarmColor[i]\n        });\n    }\n\n   // Hinzuf\u00fcgen von max, min, diff und sum zum Payload-Array\n    payload.push({\n        \"Name\": \"Cell Max V\",\n        \"Real\": max + \" V\",\n        \"Color\": \"\", // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\n        // F\u00fcgen Sie weitere Eigenschaften hinzu, wenn Sie m\u00f6chten\n    });\n    payload.push({\n        \"Name\": \"Cell Min V\",\n        \"Real\": min + \" V\",\n        \"Color\": \"\", // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\n        // F\u00fcgen Sie weitere Eigenschaften hinzu, wenn Sie m\u00f6chten\n    });\n    payload.push({\n        \"Name\": \"Cell Diff V\",\n        \"Real\": diff.toFixed(3) + \" V\",\n        \"Color\": \"\", // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\n        // F\u00fcgen Sie weitere Eigenschaften hinzu, wenn Sie m\u00f6chten\n    });\n    payload.push({\n        \"Name\": \"Akku System Spannung\",\n        \"Real\": sum.toFixed(2) + \" V\",\n        \"Color\": \"\", // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\n        // F\u00fcgen Sie weitere Eigenschaften hinzu, wenn Sie m\u00f6chten\n    });\n\n\n    // R\u00fcckgabe des Ergebnisobjekts\n    msg.payload = payload;\n    return msg;\n\n\n// Funktion zum Finden des h\u00f6chsten Werts\nfunction findMax(array) {\n    return array.reduce(function (max, current) {\n        return current > max ? current : max;\n    }, -Infinity);\n}\n\n// Funktion zum Finden des niedrigsten Werts\nfunction findMin(array) {\n    return array.reduce(function (min, current) {\n        return current < min ? current : min;\n    }, Infinity);\n}\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 730,
    "y": 580,
    "wires": [
      [
        "a4a353662ea30b7b"
      ]
    ]
  },
  {
    "id": "7f92d83edbbed863",
    "type": "function",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "RS485_Akku_3_to_Table",
    "func": "var hex_string = msg.payload;\nvar CellsVoltage = [];\nvar Voltagesum = 0, Voltagemax = 0, Voltagemin = 0, Voltagediff = 0;\n\nvar start1 = 56;\nvar pairs1 = [];\nvar index1 = start1;\n\n// Erste Schleife\nfor (var i = start1; i < start1 + 8; i += 4) {\n    var hex_pair = hex_string.substr(i, 4);\n    var decimal = parseInt(hex_pair, 16) / 1000;\n    pairs1.push(decimal);\n}\n\nvar start2 = 71;\nvar pairs2 = [];\nvar index2 = start2;\n\n// Zweite Schleife\nfor (var j = start2; j < start2 + 56; j += 4) {\n    hex_pair = hex_string.substr(j, 4);\n    decimal = parseInt(hex_pair, 16) / 1000;\n    pairs2.push(decimal);\n}\n\n// Kombinieren der beiden Arrays\nvar combinedArray = pairs1.concat(pairs2);\n\n// Finden des h\u00f6chsten und niedrigsten Werts im Array\nvar max = findMax(combinedArray);\nvar min = findMin(combinedArray);\n\n// Berechnen der Differenz zwischen dem h\u00f6chsten und niedrigsten Wert\nvar diff = max - min;\n\n// Summieren der Werte im Array\nvar sum = combinedArray.reduce(function (accumulator, currentValue) {\n    return accumulator + currentValue;\n}, 0);\n\n// \u00dcberpr\u00fcfen, ob der Payload ein g\u00fcltiges JSON-Objekt ist\n\n    var payload = [];\n    var offset = 1;\n    var AlarmColor = [\"white\"]; // Annahme, dass AlarmColor ein Array von Farben ist\n\n    for (var i = 0; i < combinedArray.length; i++) {\n        payload.push({\n            \"Name\": \"Cell \" + (offset + i),\n            \"Boolean\": \"\",\n            \"Real\": combinedArray[i] + \" V\",\n            \"Prog\": \"\",\n            \"Adresse\": \"\",\n            \"Color\": AlarmColor[i]\n        });\n    }\n\n   // Hinzuf\u00fcgen von max, min, diff und sum zum Payload-Array\n    payload.push({\n        \"Name\": \"Cell Max V\",\n        \"Real\": max + \" V\",\n        \"Color\": \"\", // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\n        // F\u00fcgen Sie weitere Eigenschaften hinzu, wenn Sie m\u00f6chten\n    });\n    payload.push({\n        \"Name\": \"Cell Min V\",\n        \"Real\": min + \" V\",\n        \"Color\": \"\", // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\n        // F\u00fcgen Sie weitere Eigenschaften hinzu, wenn Sie m\u00f6chten\n    });\n    payload.push({\n        \"Name\": \"Cell Diff V\",\n        \"Real\": diff.toFixed(3) + \" V\",\n        \"Color\": \"\", // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\n        // F\u00fcgen Sie weitere Eigenschaften hinzu, wenn Sie m\u00f6chten\n    });\n    payload.push({\n        \"Name\": \"Akku System Spannung\",\n        \"Real\": sum.toFixed(2) + \" V\",\n        \"Color\": \"\", // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\n        // F\u00fcgen Sie weitere Eigenschaften hinzu, wenn Sie m\u00f6chten\n    });\n\n\n    // R\u00fcckgabe des Ergebnisobjekts\n    msg.payload = payload;\n    return msg;\n\n\n// Funktion zum Finden des h\u00f6chsten Werts\nfunction findMax(array) {\n    return array.reduce(function (max, current) {\n        return current > max ? current : max;\n    }, -Infinity);\n}\n\n// Funktion zum Finden des niedrigsten Werts\nfunction findMin(array) {\n    return array.reduce(function (min, current) {\n        return current < min ? current : min;\n    }, Infinity);\n}\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 810,
    "y": 180,
    "wires": [
      [
        "4ebc9cd4d2d8e38f"
      ]
    ]
  },
  {
    "id": "228b2631cb02bd1e",
    "type": "trigger",
    "z": "f1180e03d0981a44",
    "name": "",
    "op1": "",
    "op2": "",
    "op1type": "str",
    "op2type": "nul",
    "duration": "1",
    "extend": false,
    "overrideDelay": false,
    "units": "s",
    "reset": "",
    "bytopic": "all",
    "topic": "topic",
    "outputs": 1,
    "x": 80,
    "y": 320,
    "wires": [
      []
    ]
  },
  {
    "id": "55e20e9eddc4298d",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "request",
    "func": "// Node-RED Function\n\n// Adresse aus msg.addr (\"01\"/\"02\") als Byte holen\nconst addr = parseInt((msg.addr || \"01\"), 16) & 0xFF;\n\n// Frame ohne Checksumme/EOI als Bytes\nconst frame = [\n  0x7E,       // SOI '~'\n  0x22,       // VER\n  addr,       // ADR\n  0x4A, 0x42, // CID1, CID2\n  0xE0, 0x02, // LEN1, LEN2\n  0x01        // INFO\n];\n\n// Checksumme: Summe \u00fcber VER..INFO (also ohne SOI)\n// -> Zweierkomplement auf 16 Bit\nlet sum = 0;\nfor (let i = 1; i < frame.length; i++) sum = (sum + frame[i]) & 0xFFFF;\nconst chk = (0x10000 - sum) & 0xFFFF;\nconst chkHi = (chk >> 8) & 0xFF;\nconst chkLo = chk & 0xFF;\n\n// Kompletten Frame zusammenbauen: + CHKSUM(2B) + CR(0x0D)\nconst full = frame.concat([chkHi, chkLo, 0x0D]);\n\n// Als Buffer senden (z. B. an Serial/TCP node)\nmsg.payload = Buffer.from(full);\nreturn msg;\n",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 2000,
    "y": 200,
    "wires": [
      [
        "ffa7294519283db8"
      ]
    ]
  },
  {
    "id": "e4c6eab7e6bf02fb",
    "type": "inject",
    "z": "f1180e03d0981a44",
    "name": "5s",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "5",
    "crontab": "",
    "once": true,
    "onceDelay": "2",
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 1700,
    "y": 200,
    "wires": [
      [
        "b638412e1afff784",
        "55e20e9eddc4298d"
      ]
    ]
  },
  {
    "id": "27e007d91a0a5907",
    "type": "serial request",
    "z": "f1180e03d0981a44",
    "name": "",
    "serial": "156efc838aaf1e8e",
    "x": 2220,
    "y": 200,
    "wires": [
      [
        "f8145543165efbfa",
        "a656c2787175c3c2",
        "bb6e3a511691bda3",
        "03f5edbc1e60937b",
        "db9907582ae9d30d",
        "8b83d96e53bcea1e"
      ]
    ]
  },
  {
    "id": "f8145543165efbfa",
    "type": "function",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "extract",
    "func": "/*\n          ~               = SOI\n 01       22              = Ver = 22\n 03       01              = ADDR\n 05       4A              = CID1\n 07       00\n 09       E0C6            = Length + length checksum\n 13       00\n 15       2704            = SOC 99.88 (/100)\n 19       1533            = Pack voltage 54.27V (/100)\n 23       10              = 16 cells\n 25       0D44            = cell voltages, 3396mV\n 29       0D57            = 3415 mV\n        0D2D\n        0D14\n        0D11\n        0D13\n        0D6F\n        0D22\n        0D70\n        0D70\n        0D6D\n        0D34\n        0D33\n        0D0F\n        0D5C\n        0D55            = cell 16 voltage\n        010E            = 27 deg C (/10)\n        00FA            = 25 deg C (/10)\n        010E            = 27 deg C (/10)\n 101    04\n 103    0104\n 107    0104\n 111    0104\n 115    00FA\n 119    0000            = Current ?\n        0000\n        0064\n        01\n        30D4            = 125 Ahr total capacity\n        30C6            = 124.86 Ahr available\n        0005            = 5 cycles\n        0000\n        0000\n        0000\n        0000\n        0023            = 35\n        0000000000000000000000000000000000000000000000\nD563            = checksum\n*/\nif (msg.status != \"OK\")  return; // no data\n// check RTN code for valid (==\"00\")\nif (msg.payload.substr(7, 2) != \"00\") return; // no data\nmsg.D = msg.payload  // save original data\n\n/* it appears that sometimes we get results for different battery, maybe\n because of a timeout on previous call? Either way, we can use the data\n  as long as it is valid\n*/\n\nmsg.addr = msg.D.substr(3, 2)\n\n// Checksum validation\nvar C = 0;\nfor (let index = 1; index < msg.D.length-5; index++) {\n       const c = msg.D.charCodeAt(index);\n       C += c;\n}\nC = (~C & 0xffff) + 1\n\nvar rxC = parseInt(msg.D.substr(msg.D.length-5, 4), 16)\nmsg.valid = (C == rxC)\nif (!msg.valid) return;  // return with no data if invalid\n\nmsg.payload = {}\n\nmsg.payload.soc = parseInt(msg.D.substr(15, 4), 16) / 100\nmsg.payload.voltage = parseInt(msg.D.substr(19, 4), 16) / 100\n// Parse current\nvar a = parseInt(msg.D.substr(119, 4), 16)\nif ((a & 0x8000) > 0) a = a - 0x10000; // need to handle negative hex number for current\nmsg.payload.current = a/100;\n//\nmsg.payload.cellcount = parseInt(msg.D.substr(23,2),16)\nmsg.payload.cellvoltage  = []\nfor (let index = 0; index < msg.payload.cellcount; index++) \n{\n       msg.payload.cellvoltage[index] = parseInt(msg.D.substr(25+4*index, 4), 16)         \n}\nreturn msg;",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 2330,
    "y": 120,
    "wires": [
      [
        "20d6187b0ca54f23",
        "881298dbb5cbde7d",
        "4bce1e75aa3e1ec3",
        "d635251aa96ea3e4"
      ]
    ]
  },
  {
    "id": "543c882c1445fd6b",
    "type": "mqtt out",
    "z": "f1180e03d0981a44",
    "name": "MQTT_iobroker",
    "topic": "Akkusystem",
    "qos": "1",
    "retain": "true",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "9cb0be1e.1c82a",
    "x": 3180,
    "y": 60,
    "wires": []
  },
  {
    "id": "20d6187b0ca54f23",
    "type": "split",
    "z": "f1180e03d0981a44",
    "name": "",
    "splt": "\\n",
    "spltType": "str",
    "arraySplt": 1,
    "arraySpltType": "len",
    "stream": false,
    "addname": "key",
    "x": 2500,
    "y": 120,
    "wires": [
      [
        "0d3c361e7457f3dd"
      ]
    ]
  },
  {
    "id": "cbfcb50ba7fb9c05",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "name": "debug make key",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "true",
    "targetType": "full",
    "statusVal": "",
    "statusType": "auto",
    "x": 2860,
    "y": 20,
    "wires": []
  },
  {
    "id": "0d3c361e7457f3dd",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "make key",
    "func": "msg.topic = \"NRED/Power/battery/china/\" + msg.addr + \"/\" + msg.key\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 2640,
    "y": 120,
    "wires": [
      [
        "cbfcb50ba7fb9c05"
      ]
    ]
  },
  {
    "id": "18ca73d82778335b",
    "type": "rbe",
    "z": "f1180e03d0981a44",
    "name": "",
    "func": "rbe",
    "gap": "",
    "start": "",
    "inout": "out",
    "septopics": true,
    "property": "payload",
    "topi": "topic",
    "x": 3010,
    "y": 60,
    "wires": [
      [
        "543c882c1445fd6b"
      ]
    ]
  },
  {
    "id": "b638412e1afff784",
    "type": "change",
    "z": "f1180e03d0981a44",
    "name": "addr=00",
    "rules": [
      {
        "t": "set",
        "p": "addr",
        "pt": "msg",
        "to": "01",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1840,
    "y": 140,
    "wires": [
      [
        "55e20e9eddc4298d"
      ]
    ]
  },
  {
    "id": "4318df0e32735bc7",
    "type": "comment",
    "z": "f1180e03d0981a44",
    "name": "loop for 2nd battery",
    "info": "",
    "x": 1990,
    "y": 340,
    "wires": []
  },
  {
    "id": "7c444284a4f544a7",
    "type": "function",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "Cellen 01-16 Alter Code",
    "func": "var hex_string = msg.payload;\nvar CellsVoltage = [];\nvar Voltagesum = 0, Voltagemax = 0, Voltagemin = 0, Voltagediff = 0;\n\nvar start1 = 56;\nvar pairs1 = [];\nvar index1 = start1;\n\n// Erste Schleife\nfor (var i = start1; i < start1 + 8; i += 4) {\n    var hex_pair = hex_string.substr(i, 4);\n    var decimal = parseInt(hex_pair, 16) / 1000;\n    pairs1.push(decimal);\n}\n\nvar start2 = 71;\nvar pairs2 = [];\nvar index2 = start2;\n\n// Zweite Schleife\nfor (var j = start2; j < start2 + 56; j += 4) {\n    hex_pair = hex_string.substr(j, 4);\n    decimal = parseInt(hex_pair, 16) / 1000;\n    pairs2.push(decimal);\n}\n\n// Kombinieren der beiden Arrays\nvar combinedArray = pairs1.concat(pairs2);\n\n// \u00dcberpr\u00fcfen, ob CellsVoltage definiert und ein Array ist\n    // Setzen von CellsVoltage auf das kombinierte Array\n    msg.payload.CellsVoltage = combinedArray;\n\n    // Finden des h\u00f6chsten und niedrigsten Werts im Array\n    var max = findMax(combinedArray);\n    var min = findMin(combinedArray);\n\n    // Berechnen der Differenz zwischen dem h\u00f6chsten und niedrigsten Wert\n    var diff = max - min;\n\n    // Summieren der Werte im Array\n    var sum = combinedArray.reduce(function (accumulator, currentValue) {\n        return accumulator + currentValue;\n    }, 0);\n\n    // Erstellen der Nachricht mit den Ergebnissen\n    var message = {\n        payload: {\n            CellsVoltage: combinedArray,\n            Voltagesum: sum.toFixed(3),\n            Voltagemax: max.toFixed(3),\n            Voltagemin: min.toFixed(3),    \n            Voltagediff: diff.toFixed(3),\n        }\n    };\n\n    // Senden der Nachricht mit den Ergebnissen\n    node.send(message);\n\n    // Handle den Fall, wenn CellsVoltage nicht definiert ist oder kein Array ist\n   // node.error(\"CellsVoltage ist nicht definiert oder kein Array.\");\n\n\n// Funktion zum Finden des h\u00f6chsten Werts\nfunction findMax(array) {\n    return array.reduce(function (max, current) {\n        return current > max ? current : max;\n    }, -Infinity);\n}\n\n// Funktion zum Finden des niedrigsten Werts\nfunction findMin(array) {\n    return array.reduce(function (min, current) {\n        return current < min ? current : min;\n    }, Infinity);\n}\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 770,
    "y": 360,
    "wires": [
      []
    ]
  },
  {
    "id": "8b04580a12a57c0d",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "SoC",
    "func": "msg.topic = \"NRED/Power/battery/china/\"\nvar soc = msg.payload.substr(15, 4);\nmsg.payload = (parseInt(soc, 16)/100);\nreturn msg;",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 220,
    "wires": [
      [
        "f51430e6d64a0e25",
        "715ebcb0457beae2"
      ]
    ]
  },
  {
    "id": "f51430e6d64a0e25",
    "type": "mqtt out",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "fhem-mqtt",
    "topic": "",
    "qos": "1",
    "retain": "",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "1a2da74c7b80a463",
    "x": 4120,
    "y": 180,
    "wires": []
  },
  {
    "id": "7da658a91bee09cc",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Batterie V",
    "func": "msg.topic = \"48V_Batterie/Battery_Voltage\"\nvar batv = msg.payload.substr(19, 4);\nmsg.payload = (parseInt(batv, 16)/100);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3600,
    "y": 260,
    "wires": [
      [
        "2f5f7a6c4a97017b",
        "f51430e6d64a0e25",
        "9cfba1a9aed618ab"
      ]
    ]
  },
  {
    "id": "95d78f9fb75953ea",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Strom A",
    "func": "msg.topic = \"48V_Batterie/Battery_Current\"\nvar bata = msg.payload.substr(119, 4);\nmsg.payload = ((parseInt(bata, 16)/100));\n\nif (msg.payload > 200) { msg.payload = ((parseInt(bata, 16) -65535)/ 100);}\n\nreturn msg;\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3600,
    "y": 340,
    "wires": [
      [
        "8f7c9c4753b4c32c",
        "f51430e6d64a0e25"
      ]
    ]
  },
  {
    "id": "c546f6999f6151c6",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Temp_3",
    "func": "msg.topic = \"48V_Batterie/Temp_3\"\nvar t3 = msg.payload.substr(97, 4);\nmsg.payload = (parseInt(t3, 16)/10);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3600,
    "y": 420,
    "wires": [
      [
        "f51430e6d64a0e25",
        "48b910018243843f",
        "13714da377426e1b"
      ]
    ]
  },
  {
    "id": "b04c35910ba9f39b",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Temp_1",
    "func": "msg.topic = \"48V_Batterie/Temp_1\"\nvar t1 = msg.payload.substr(89, 4);\nmsg.payload = (parseInt(t1, 16)/10);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3600,
    "y": 380,
    "wires": [
      [
        "f51430e6d64a0e25",
        "48b910018243843f",
        "0cbdccf5edb83978"
      ]
    ]
  },
  {
    "id": "c52dc84cd76b4da1",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Capacity Ah",
    "func": "msg.topic = \"48V_Batterie/Battery_Capacity\"\nvar batc = msg.payload.substr(137, 4);\nmsg.payload = (parseInt(batc, 16)/100);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3610,
    "y": 300,
    "wires": [
      [
        "f51430e6d64a0e25",
        "45c1bc85ebcd11e3"
      ]
    ]
  },
  {
    "id": "37a73166ce3dbb8f",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C1",
    "func": "msg.topic = \"48V_Batterie/Battery_C1\"\nvar c1 = msg.payload.substr(25, 4);\nmsg.payload = (parseInt(c1, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 460,
    "wires": [
      [
        "d5e746fb98036922",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "fd29380af6bd47ad",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C2",
    "func": "msg.topic = \"48V_Batterie/Battery_C2\"\nvar c2 = msg.payload.substr(29, 4);\nmsg.payload = (parseInt(c2, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 500,
    "wires": [
      [
        "0cb806b3448d1104",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "7ece0de2ab11659a",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C3",
    "func": "msg.topic = \"48V_Batterie/Battery_C3\"\nvar c3 = msg.payload.substr(33, 4);\nmsg.payload = (parseInt(c3, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 540,
    "wires": [
      [
        "9913d6344ec0b3ab",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "ef13de8234c172a5",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C4",
    "func": "msg.topic = \"48V_Batterie/Battery_C4\"\nvar c4 = msg.payload.substr(37, 4);\nmsg.payload = (parseInt(c4, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 580,
    "wires": [
      [
        "283c28e44d974a8d",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "3455cd4c384c58f1",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C5",
    "func": "msg.topic = \"48V_Batterie/Battery_C5\"\nvar c5 = msg.payload.substr(41, 4);\nmsg.payload = (parseInt(c5, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 620,
    "wires": [
      [
        "d21091c4f321109a",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "396027670261bc24",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C6",
    "func": "msg.topic = \"48V_Batterie/Battery_C6\"\nvar c6 = msg.payload.substr(45, 4);\nmsg.payload = (parseInt(c6, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 660,
    "wires": [
      [
        "4837521a834b2901",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "833d581c90925d40",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C7",
    "func": "msg.topic = \"48V_Batterie/Battery_C7\"\nvar c7 = msg.payload.substr(49, 4);\nmsg.payload = (parseInt(c7, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 700,
    "wires": [
      [
        "05a0bfc1b9a0d839",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "86d23f74fb87e02e",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C8",
    "func": "msg.topic = \"48V_Batterie/Battery_C8\"\nvar c8 = msg.payload.substr(53, 4);\nmsg.payload = (parseInt(c8, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 740,
    "wires": [
      [
        "f9d97a455c54e3fd",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "30f5ba564c6359fa",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C9",
    "func": "msg.topic = \"48V_Batterie/Battery_C9\"\nvar c9 = msg.payload.substr(57, 4);\nmsg.payload = (parseInt(c9, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 780,
    "wires": [
      [
        "352abfc5c20170db",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "51198c0e4b2076a9",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C10",
    "func": "msg.topic = \"48V_Batterie/Battery_C10\"\nvar c10 = msg.payload.substr(61, 4);\nmsg.payload = (parseInt(c10, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 820,
    "wires": [
      [
        "081be171a80974a9",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "0e2168180c2a46ee",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C11",
    "func": "msg.topic = \"48V_Batterie/Battery_C11\"\nvar c11 = msg.payload.substr(65, 4);\nmsg.payload = (parseInt(c11, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 860,
    "wires": [
      [
        "a5164a9ca8544131",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "533c4dc776c8a6cf",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C12",
    "func": "msg.topic = \"48V_Batterie/Battery_C12\"\nvar c12 = msg.payload.substr(69, 4);\nmsg.payload = (parseInt(c12, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 900,
    "wires": [
      [
        "511e4f27f6f65e73",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "c7ff5617dd117027",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C13",
    "func": "msg.topic = \"48V_Batterie/Battery_C13\"\nvar c13 = msg.payload.substr(73, 4);\nmsg.payload = (parseInt(c13, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 940,
    "wires": [
      [
        "d2a1b808707e3864",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "38e226d83ef0c789",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C14",
    "func": "msg.topic = \"48V_Batterie/Battery_C14\"\nvar c14 = msg.payload.substr(77, 4);\nmsg.payload = (parseInt(c14, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 980,
    "wires": [
      [
        "1cf426565b35b7d7",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "1ec07e278dddbf3d",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C15",
    "func": "msg.topic = \"48V_Batterie/Battery_C15\"\nvar c15 = msg.payload.substr(81, 4);\nmsg.payload = (parseInt(c15, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1020,
    "wires": [
      [
        "8c970b41e1ceea67",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "8d1f9a3872ab7960",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C16",
    "func": "msg.topic = \"48V_Batterie/Battery_C16\"\nvar c16 = msg.payload.substr(85, 4);\nmsg.payload = (parseInt(c16, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1060,
    "wires": [
      [
        "924382b5da43d88e",
        "a3733b8c427957a5"
      ]
    ]
  },
  {
    "id": "ffa7294519283db8",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Update Addr",
    "func": "  if (msg.addr === \"00\") {\n        msg.addr = \"01\";\n    } else if (msg.addr === \"01\") {\n        msg.addr = \"02\";\n    } else if (msg.addr === \"02\") {\n        msg.addr = \"04\";\n    } else if (msg.addr === \"04\") {\n        msg.addr = \"01\";\n    }\n    return msg;",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1990,
    "y": 280,
    "wires": [
      [
        "55e20e9eddc4298d"
      ]
    ]
  },
  {
    "id": "a656c2787175c3c2",
    "type": "switch",
    "z": "f1180e03d0981a44",
    "name": "Akku Switch",
    "property": "payload",
    "propertyType": "msg",
    "rules": [
      {
        "t": "cont",
        "v": "~22014A",
        "vt": "str"
      },
      {
        "t": "cont",
        "v": "~22024A",
        "vt": "str"
      },
      {
        "t": "cont",
        "v": "~22044A",
        "vt": "str"
      },
      {
        "t": "cont",
        "v": "",
        "vt": "str"
      }
    ],
    "checkall": "true",
    "repair": false,
    "outputs": 4,
    "x": 3030,
    "y": 720,
    "wires": [
      [
        "8b04580a12a57c0d",
        "7da658a91bee09cc",
        "c52dc84cd76b4da1",
        "95d78f9fb75953ea",
        "b04c35910ba9f39b",
        "c546f6999f6151c6",
        "37a73166ce3dbb8f",
        "fd29380af6bd47ad",
        "7ece0de2ab11659a",
        "ef13de8234c172a5",
        "3455cd4c384c58f1",
        "396027670261bc24",
        "833d581c90925d40",
        "86d23f74fb87e02e",
        "30f5ba564c6359fa",
        "51198c0e4b2076a9",
        "0e2168180c2a46ee",
        "533c4dc776c8a6cf",
        "c7ff5617dd117027",
        "38e226d83ef0c789",
        "1ec07e278dddbf3d",
        "8d1f9a3872ab7960"
      ],
      [
        "a6dfe781b0c66fb1"
      ],
      [
        "62f8a763b9801cec"
      ],
      []
    ]
  },
  {
    "id": "0c477da36b682a9b",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "SoC",
    "func": "msg.topic = \"NRED/Power/battery/china/\"\nvar soc = msg.payload.substr(15, 4);\nmsg.payload = (parseInt(soc, 16)/100);\nreturn msg;",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1200,
    "wires": [
      [
        "167f56f1d0b9af26",
        "8d17c9c03032cc21"
      ]
    ]
  },
  {
    "id": "167f56f1d0b9af26",
    "type": "mqtt out",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "fhem-mqtt",
    "topic": "",
    "qos": "1",
    "retain": "",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "1a2da74c7b80a463",
    "x": 4120,
    "y": 1160,
    "wires": []
  },
  {
    "id": "ed7c8a242bcc748c",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Batterie V",
    "func": "msg.topic = \"48V_Batterie/Battery_Voltage\"\nvar batv = msg.payload.substr(19, 4);\nmsg.payload = (parseInt(batv, 16)/100);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3600,
    "y": 1240,
    "wires": [
      [
        "5ddbaac16a786fb7",
        "167f56f1d0b9af26",
        "728d3476f77229e5"
      ]
    ]
  },
  {
    "id": "d5b5260480ab1aa8",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Strom A",
    "func": "msg.topic = \"48V_Batterie/Battery_Current\"\nvar bata = msg.payload.substr(119, 4);\nmsg.payload = ((parseInt(bata, 16)/100));\n\nif (msg.payload > 200) { msg.payload = ((parseInt(bata, 16) -65535)/ 100);}\n\nreturn msg;\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3600,
    "y": 1320,
    "wires": [
      [
        "a28d207b2b12369e",
        "167f56f1d0b9af26"
      ]
    ]
  },
  {
    "id": "bd1cac6ed324982e",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Temp_3",
    "func": "msg.topic = \"48V_Batterie/Temp_3\"\nvar t3 = msg.payload.substr(97, 4);\nmsg.payload = (parseInt(t3, 16)/10);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3600,
    "y": 1400,
    "wires": [
      [
        "167f56f1d0b9af26",
        "72e540713a05632e",
        "d3f5107ab051aadb"
      ]
    ]
  },
  {
    "id": "0ff8efee137bc98d",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Temp_1",
    "func": "msg.topic = \"48V_Batterie/Temp_1\"\nvar t1 = msg.payload.substr(89, 4);\nmsg.payload = (parseInt(t1, 16)/10);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3600,
    "y": 1360,
    "wires": [
      [
        "167f56f1d0b9af26",
        "72e540713a05632e",
        "d74a9787e10e8c49"
      ]
    ]
  },
  {
    "id": "14e657ddf6151bf5",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Capacity Ah",
    "func": "msg.topic = \"48V_Batterie/Battery_Capacity\"\nvar batc = msg.payload.substr(137, 4);\nmsg.payload = (parseInt(batc, 16)/100);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3610,
    "y": 1280,
    "wires": [
      [
        "167f56f1d0b9af26",
        "6df33de7f00c19b2"
      ]
    ]
  },
  {
    "id": "606116cfa1f085ac",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C1",
    "func": "msg.topic = \"48V_Batterie/Battery_C1\"\nvar c1 = msg.payload.substr(25, 4);\nmsg.payload = (parseInt(c1, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1440,
    "wires": [
      [
        "c747b95e961beedd",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "31b68910f750709e",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C2",
    "func": "msg.topic = \"48V_Batterie/Battery_C2\"\nvar c2 = msg.payload.substr(29, 4);\nmsg.payload = (parseInt(c2, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1480,
    "wires": [
      [
        "bf1b165217910643",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "5c9666a78afc39c9",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C3",
    "func": "msg.topic = \"48V_Batterie/Battery_C3\"\nvar c3 = msg.payload.substr(33, 4);\nmsg.payload = (parseInt(c3, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1520,
    "wires": [
      [
        "3be2a6873c0dd6d7",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "808c359d9b4a656c",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C4",
    "func": "msg.topic = \"48V_Batterie/Battery_C4\"\nvar c4 = msg.payload.substr(37, 4);\nmsg.payload = (parseInt(c4, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1560,
    "wires": [
      [
        "c4f39147df3e1480",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "546f8764f287c8c6",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C5",
    "func": "msg.topic = \"48V_Batterie/Battery_C5\"\nvar c5 = msg.payload.substr(41, 4);\nmsg.payload = (parseInt(c5, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1600,
    "wires": [
      [
        "0802e24110554cdf",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "b27862c7a7c9fdef",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C6",
    "func": "msg.topic = \"48V_Batterie/Battery_C6\"\nvar c6 = msg.payload.substr(45, 4);\nmsg.payload = (parseInt(c6, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1640,
    "wires": [
      [
        "3642ec607d213afe",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "f34e8ecbab53b771",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C7",
    "func": "msg.topic = \"48V_Batterie/Battery_C7\"\nvar c7 = msg.payload.substr(49, 4);\nmsg.payload = (parseInt(c7, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1680,
    "wires": [
      [
        "3b7566dc3347c13e",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "618ce36e0c20cec3",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C8",
    "func": "msg.topic = \"48V_Batterie/Battery_C8\"\nvar c8 = msg.payload.substr(53, 4);\nmsg.payload = (parseInt(c8, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1720,
    "wires": [
      [
        "98f5def88b09813e",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "a55e47f86f37a874",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C9",
    "func": "msg.topic = \"48V_Batterie/Battery_C9\"\nvar c9 = msg.payload.substr(57, 4);\nmsg.payload = (parseInt(c9, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1760,
    "wires": [
      [
        "d2010e6a4d8b4a6e",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "994b367c222963ba",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C10",
    "func": "msg.topic = \"48V_Batterie/Battery_C10\"\nvar c10 = msg.payload.substr(61, 4);\nmsg.payload = (parseInt(c10, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1800,
    "wires": [
      [
        "d4937ca49b850d3c",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "03ccd8a47ab977f7",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C11",
    "func": "msg.topic = \"48V_Batterie/Battery_C11\"\nvar c11 = msg.payload.substr(65, 4);\nmsg.payload = (parseInt(c11, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1840,
    "wires": [
      [
        "a02b5616e6b9e39a",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "78b3b0a6a0864748",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C12",
    "func": "msg.topic = \"48V_Batterie/Battery_C12\"\nvar c12 = msg.payload.substr(69, 4);\nmsg.payload = (parseInt(c12, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1880,
    "wires": [
      [
        "bb57b2b0038fa0eb",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "f068f6263a8cd4f8",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C13",
    "func": "msg.topic = \"48V_Batterie/Battery_C13\"\nvar c13 = msg.payload.substr(73, 4);\nmsg.payload = (parseInt(c13, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1920,
    "wires": [
      [
        "b81739d1aeda3de0",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "53b6e517702a4b73",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C14",
    "func": "msg.topic = \"48V_Batterie/Battery_C14\"\nvar c14 = msg.payload.substr(77, 4);\nmsg.payload = (parseInt(c14, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 1960,
    "wires": [
      [
        "9367d205e222796a",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "f10aba574a54e279",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C15",
    "func": "msg.topic = \"48V_Batterie/Battery_C15\"\nvar c15 = msg.payload.substr(81, 4);\nmsg.payload = (parseInt(c15, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2000,
    "wires": [
      [
        "4eb34926acb163a6",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "92fefe8ab713c6c7",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C16",
    "func": "msg.topic = \"48V_Batterie/Battery_C16\"\nvar c16 = msg.payload.substr(85, 4);\nmsg.payload = (parseInt(c16, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2040,
    "wires": [
      [
        "ee9b46cd1ae250d1",
        "fc7590f53dfa2ccf"
      ]
    ]
  },
  {
    "id": "36accb4b3349a6e4",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "SoC",
    "func": "msg.topic = \"NRED/Power/battery/china/\"\nvar soc = msg.payload.substr(15, 4);\nmsg.payload = (parseInt(soc, 16)/100);\nreturn msg;",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2200,
    "wires": [
      [
        "429bb84da9f83ec0",
        "aff95817337d489f"
      ]
    ]
  },
  {
    "id": "429bb84da9f83ec0",
    "type": "mqtt out",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "fhem-mqtt",
    "topic": "",
    "qos": "1",
    "retain": "",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "1a2da74c7b80a463",
    "x": 4120,
    "y": 2160,
    "wires": []
  },
  {
    "id": "25d739c5b81598d3",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Batterie V",
    "func": "msg.topic = \"48V_Batterie/Battery_Voltage\"\nvar batv = msg.payload.substr(19, 4);\nmsg.payload = (parseInt(batv, 16)/100);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3600,
    "y": 2240,
    "wires": [
      [
        "7c2df1dc53c1a009",
        "429bb84da9f83ec0",
        "6e96784cb7ef5011"
      ]
    ]
  },
  {
    "id": "9556b98eda01ece5",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Strom A",
    "func": "msg.topic = \"48V_Batterie/Battery_Current\"\nvar bata = msg.payload.substr(119, 4);\nmsg.payload = ((parseInt(bata, 16)/100));\n\nif (msg.payload > 200) { msg.payload = ((parseInt(bata, 16) -65535)/ 100);}\n\nreturn msg;\n\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3600,
    "y": 2320,
    "wires": [
      [
        "2fbb075d516d42e7",
        "429bb84da9f83ec0"
      ]
    ]
  },
  {
    "id": "aa32b6de254242d7",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Temp_3",
    "func": "msg.topic = \"48V_Batterie/Temp_3\"\nvar t3 = msg.payload.substr(97, 4);\nmsg.payload = (parseInt(t3, 16)/10);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3600,
    "y": 2400,
    "wires": [
      [
        "429bb84da9f83ec0",
        "b1fc8d03cb9a154a",
        "f50a4445758d39fb"
      ]
    ]
  },
  {
    "id": "72c11ee8cd7dbdc6",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Temp_1",
    "func": "msg.topic = \"48V_Batterie/Temp_1\"\nvar t1 = msg.payload.substr(89, 4);\nmsg.payload = (parseInt(t1, 16)/10);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3600,
    "y": 2360,
    "wires": [
      [
        "429bb84da9f83ec0",
        "b1fc8d03cb9a154a",
        "72fb2ee7b3770fdd"
      ]
    ]
  },
  {
    "id": "f3fa41405b236b96",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Capacity Ah",
    "func": "msg.topic = \"48V_Batterie/Battery_Capacity\"\nvar batc = msg.payload.substr(137, 4);\nmsg.payload = (parseInt(batc, 16)/100);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3610,
    "y": 2280,
    "wires": [
      [
        "429bb84da9f83ec0",
        "1a69e6b9fb760e28"
      ]
    ]
  },
  {
    "id": "59c5f4d9ae403257",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C1",
    "func": "msg.topic = \"48V_Batterie/Battery_C1\"\nvar c1 = msg.payload.substr(25, 4);\nmsg.payload = (parseInt(c1, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2440,
    "wires": [
      [
        "5bc37085f5c0fec3",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "d78801a917ddcd9a",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C2",
    "func": "msg.topic = \"48V_Batterie/Battery_C2\"\nvar c2 = msg.payload.substr(29, 4);\nmsg.payload = (parseInt(c2, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2480,
    "wires": [
      [
        "86e0633a23c4c327",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "c94d7ed1fd80ff2a",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C3",
    "func": "msg.topic = \"48V_Batterie/Battery_C3\"\nvar c3 = msg.payload.substr(33, 4);\nmsg.payload = (parseInt(c3, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2520,
    "wires": [
      [
        "e5fc66e9f212878e",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "26fc9edbe5d9608f",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C4",
    "func": "msg.topic = \"48V_Batterie/Battery_C4\"\nvar c4 = msg.payload.substr(37, 4);\nmsg.payload = (parseInt(c4, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2560,
    "wires": [
      [
        "ed3af2ac2a8d0a90",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "2f5e77251c78c81c",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C5",
    "func": "msg.topic = \"48V_Batterie/Battery_C5\"\nvar c5 = msg.payload.substr(41, 4);\nmsg.payload = (parseInt(c5, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2600,
    "wires": [
      [
        "6a8eb68ca744e709",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "661ef78661f3cc78",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C6",
    "func": "msg.topic = \"48V_Batterie/Battery_C6\"\nvar c6 = msg.payload.substr(45, 4);\nmsg.payload = (parseInt(c6, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2640,
    "wires": [
      [
        "071c3b5eb55b289b",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "7e456112ca2b5183",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C7",
    "func": "msg.topic = \"48V_Batterie/Battery_C7\"\nvar c7 = msg.payload.substr(49, 4);\nmsg.payload = (parseInt(c7, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2680,
    "wires": [
      [
        "33f07c2ec5b9fa40",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "207f256f8c7a726b",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C8",
    "func": "msg.topic = \"48V_Batterie/Battery_C8\"\nvar c8 = msg.payload.substr(53, 4);\nmsg.payload = (parseInt(c8, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2720,
    "wires": [
      [
        "a89d15c8a972e9d4",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "9d363940f5cc1e93",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C9",
    "func": "msg.topic = \"48V_Batterie/Battery_C9\"\nvar c9 = msg.payload.substr(57, 4);\nmsg.payload = (parseInt(c9, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2760,
    "wires": [
      [
        "b0289d447a189d73",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "9f997883b4977cbd",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C10",
    "func": "msg.topic = \"48V_Batterie/Battery_C10\"\nvar c10 = msg.payload.substr(61, 4);\nmsg.payload = (parseInt(c10, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2800,
    "wires": [
      [
        "64459461311eac5c",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "015db1a0b95738e8",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C11",
    "func": "msg.topic = \"48V_Batterie/Battery_C11\"\nvar c11 = msg.payload.substr(65, 4);\nmsg.payload = (parseInt(c11, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2840,
    "wires": [
      [
        "2f8fcc46dc99c51d",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "849122be0779fbae",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C12",
    "func": "msg.topic = \"48V_Batterie/Battery_C12\"\nvar c12 = msg.payload.substr(69, 4);\nmsg.payload = (parseInt(c12, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2880,
    "wires": [
      [
        "66847d76f9d5ff72",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "af293b87fc6275b9",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C13",
    "func": "msg.topic = \"48V_Batterie/Battery_C13\"\nvar c13 = msg.payload.substr(73, 4);\nmsg.payload = (parseInt(c13, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2920,
    "wires": [
      [
        "5cf9032035821116",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "847af786a41292cd",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C14",
    "func": "msg.topic = \"48V_Batterie/Battery_C14\"\nvar c14 = msg.payload.substr(77, 4);\nmsg.payload = (parseInt(c14, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 2960,
    "wires": [
      [
        "202ec7fd3217ebd3",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "f3137e9b5113f150",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C15",
    "func": "msg.topic = \"48V_Batterie/Battery_C15\"\nvar c15 = msg.payload.substr(81, 4);\nmsg.payload = (parseInt(c15, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 3000,
    "wires": [
      [
        "30f69b6dd741e11b",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "39e79a788815ca5e",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "C16",
    "func": "msg.topic = \"48V_Batterie/Battery_C16\"\nvar c16 = msg.payload.substr(85, 4);\nmsg.payload = (parseInt(c16, 16)/1000);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3590,
    "y": 3040,
    "wires": [
      [
        "fe35fc73d863398f",
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "62f8a763b9801cec",
    "type": "link out",
    "z": "f1180e03d0981a44",
    "name": "link out 2",
    "mode": "link",
    "links": [
      "6f62871535a31e30"
    ],
    "x": 3165,
    "y": 1020,
    "wires": []
  },
  {
    "id": "6f62871535a31e30",
    "type": "link in",
    "z": "f1180e03d0981a44",
    "name": "link in 1",
    "links": [
      "62f8a763b9801cec"
    ],
    "x": 3045,
    "y": 2480,
    "wires": [
      [
        "89a878efecce2149",
        "68aa901df2a4a2e2"
      ]
    ]
  },
  {
    "id": "881298dbb5cbde7d",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "F_payload_2_tbl",
    "func": "var payload = msg.payload;\nvar addr = msg.addr;\nvar cellVoltages = payload.cellvoltage;\nvar result = [];\n\n// Logik f\u00fcr die Alarmfarben implementieren und AlarmColor Array definieren\nvar AlarmColor = [];\nfor (var i = 0; i < cellVoltages.length; i++) {\n    var voltage = cellVoltages[i];\n    if (voltage > 3550) {\n        AlarmColor.push(\"Red\");\n    } else if (voltage > 3450) {\n        AlarmColor.push(\"Yellow\");\n    } else {\n        AlarmColor.push(\"Green\");\n    }\n}\n\n// Schleife durch die Zellspannungen und f\u00fcge sie dem Ergebnisarray hinzu\nfor (var i = 0; i < cellVoltages.length; i++) {\n    result.push({\n        \"Name\": \"Cell \" + (i + 1),\n        \"Real\": cellVoltages[i],\n        \"Color\": AlarmColor[i] // F\u00fcgen Sie die Farbe je nach Bedarf hinzu\n    });\n}\n\n// Berechne max, min, diff und sum der Zellspannungen\nvar voltages = cellVoltages.map(function(cell) { return cell;});\nvar max = Math.max.apply(Math, voltages);\nvar min = Math.min.apply(Math, voltages);\nvar diff = max - min;\nvar sum = voltages.reduce(function(acc, val) { return acc + val; }, 0);\n\n// F\u00fcgen Sie die Ergebnisse dem Ergebnisarray hinzu, wobei die Einheiten korrekt angepasst werden\nresult.push({\n    \"Name\": \"Cell Max V\",\n    \"Real\": max / 1000,\n    \"Color\": \"\" // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\n});\nresult.push({\n    \"Name\": \"Cell Min V\",\n    \"Real\": min / 1000,\n    \"Color\": \"\" // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\n});\nresult.push({\n    \"Name\": \"Cell Diff V\",\n    \"Real\": (diff / 1000).toFixed(3),\n    \"Color\": \"\" // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\n});\nresult.push({\n    \"Name\": \"Akku System Spannung\",\n    \"Real\": (sum / 1000).toFixed(2),\n    \"Color\": \"\" // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\n});\nresult.push({\n    \"Name\": \"Akku Addresse\",\n    \"Real\": addr,\n    \"Color\": \"\" // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\n});\n\n// Setzen Sie das Ergebnisarray als Payload\nmsg.payload = result;\nreturn msg;\n",
    "outputs": 1,
    "timeout": 0,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 2550,
    "y": 180,
    "wires": [
      [
        "d28f2ad43a5050fc",
        "18ca73d82778335b"
      ]
    ],
    "info": "Der folgende Code ist eine JavaScript-Funktion,\r\ndie eine Nachricht (msg) verarbeitet,\r\ndie ein Payload-Objekt enth\u00e4lt.\r\nDie Funktion extrahiert die Zellspannungsdaten aus dem Payload und f\u00fchrt \r\nverschiedene Berechnungen durch, um Informationen wie maximale Spannung,\r\nminimale Spannung, Differenz der Spannungen und Summe der Spannungen zu erhalten.\r\nBasierend auf diesen Berechnungen werden auch Alarmfarben f\u00fcr jede Zelle zugewiesen.\r\nDie Funktion erstellt dann ein Ergebnisarray, das die Zellinformationen sowie\r\ndie berechneten Werte enth\u00e4lt und setzt dieses Array als Payload der Nachricht.\r\n\r\n\r\n\r\n\r\nUrsprungscode:\r\n\r\n// Extrahieren der relevanten Daten aus der Nachricht\r\nvar payload = msg.payload;\r\nvar addr = msg.addr;\r\nvar cellVoltages = payload.cellvoltage;\r\nvar result = [];\r\n\r\n// Logik f\u00fcr die Alarmfarben implementieren und AlarmColor Array definieren\r\nvar AlarmColor = [];\r\nfor (var i = 0; i < cellVoltages.length; i++) {\r\n    var voltage = cellVoltages[i];\r\n    if (voltage > 3550) {\r\n        AlarmColor.push(\"Red\");\r\n    } else if (voltage > 3450) {\r\n        AlarmColor.push(\"Yellow\");\r\n    } else {\r\n        AlarmColor.push(\"Green\");\r\n    }\r\n}\r\n\r\n// Schleife durch die Zellspannungen und f\u00fcge sie dem Ergebnisarray hinzu\r\nfor (var i = 0; i < cellVoltages.length; i++) {\r\n    result.push({\r\n        \"Name\": \"Cell \" + (i + 1),\r\n        \"Real\": cellVoltages[i],\r\n        \"Color\": AlarmColor[i] // F\u00fcgen Sie die Farbe je nach Bedarf hinzu\r\n    });\r\n}\r\n\r\n// Berechnen von max, min, diff und sum der Zellspannungen\r\nvar voltages = cellVoltages.map(function(cell) { return cell; });\r\nvar max = Math.max.apply(Math, voltages);\r\nvar min = Math.min.apply(Math, voltages);\r\nvar diff = max - min;\r\nvar sum = voltages.reduce(function(acc, val) { return acc + val; }, 0);\r\n\r\n// Ergebnisse dem Ergebnisarray hinzuf\u00fcgen, wobei die Einheiten korrekt angepasst werden\r\nresult.push({\r\n    \"Name\": \"Cell Max V\",\r\n    \"Real\": max / 1000,\r\n    \"Color\": \"\" // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\r\n});\r\nresult.push({\r\n    \"Name\": \"Cell Min V\",\r\n    \"Real\": min / 1000,\r\n    \"Color\": \"\" // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\r\n});\r\nresult.push({\r\n    \"Name\": \"Cell Diff V\",\r\n    \"Real\": (diff / 1000).toFixed(3),\r\n    \"Color\": \"\" // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\r\n});\r\nresult.push({\r\n    \"Name\": \"Akku System Spannung\",\r\n    \"Real\": (sum / 1000).toFixed(2),\r\n    \"Color\": \"\" // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\r\n});\r\nresult.push({\r\n    \"Name\": \"Akku Addresse\",\r\n    \"Real\": addr,\r\n    \"Color\": \"\" // Sie k\u00f6nnen die Farbe je nach Bedarf setzen\r\n});\r\n\r\n// Ergebnisarray als Payload setzen und Nachricht zur\u00fcckgeben\r\nmsg.payload = result;\r\nreturn msg;\r\n"
  },
  {
    "id": "4bce1e75aa3e1ec3",
    "type": "trigger",
    "z": "f1180e03d0981a44",
    "name": "Stop Timer",
    "op1": "",
    "op2": "false",
    "op1type": "nul",
    "op2type": "bool",
    "duration": "500",
    "extend": false,
    "overrideDelay": false,
    "units": "ms",
    "reset": "true",
    "bytopic": "all",
    "topic": "topic",
    "outputs": 1,
    "x": 3910,
    "y": 120,
    "wires": [
      [
        "edba1e3110f25533"
      ]
    ]
  },
  {
    "id": "d635251aa96ea3e4",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Check_Connection",
    "func": "var timer;\n\nif (msg.payload !== undefined && msg.payload !== null) {\n    clearTimeout(timer); // Zur\u00fccksetzen des Timers, wenn ein g\u00fcltiges Payload empfangen wird\n    return { payload: true };\n} else {\n    // Starten eines Timers, um nach 5 Sekunden automatisch \"false\" zur\u00fcckzugeben\n    timer = setTimeout(function() {\n        return { payload: false };\n    }, 500); // Timer auf 5000 Millisekunden (5 Sekunden) einstellen\n}\n",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3890,
    "y": 160,
    "wires": [
      [
        "edba1e3110f25533"
      ]
    ]
  },
  {
    "id": "63ebf8046e63f148",
    "type": "ui_table",
    "z": "f1180e03d0981a44",
    "group": "91b92b51a71a3d33",
    "name": "Alarm Table CAN",
    "order": 2,
    "width": 14,
    "height": 10,
    "columns": [
      {
        "field": "Name",
        "title": "Beschreibung",
        "width": "",
        "align": "left",
        "formatter": "html",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Color",
        "title": "Color State",
        "width": "",
        "align": "left",
        "formatter": "color",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Boolean",
        "title": "True False",
        "width": "40",
        "align": "center",
        "formatter": "tickCross",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Real",
        "title": "Wert",
        "width": "5%",
        "align": "left",
        "formatter": "color",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Prog",
        "title": "%",
        "width": "80",
        "align": "left",
        "formatter": "progress",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Adresse",
        "title": "Adresse",
        "width": "",
        "align": "left",
        "formatter": "plaintext",
        "formatterParams": {
          "target": "_blank"
        }
      }
    ],
    "outputs": 0,
    "cts": false,
    "x": 1210,
    "y": 1500,
    "wires": []
  },
  {
    "id": "a4a353662ea30b7b",
    "type": "ui_table",
    "z": "f1180e03d0981a44",
    "group": "5eddcc8a9a1c816c",
    "name": "Akku 3 Status",
    "order": 2,
    "width": 12,
    "height": 13,
    "columns": [
      {
        "field": "Name",
        "title": "Beschreibung",
        "width": "",
        "align": "left",
        "formatter": "html",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Color",
        "title": "Color State",
        "width": "40",
        "align": "left",
        "formatter": "color",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Real",
        "title": "Wert",
        "width": "80",
        "align": "left",
        "formatter": "plaintext",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Prog",
        "title": "%",
        "width": "80",
        "align": "left",
        "formatter": "progress",
        "formatterParams": {
          "target": "_blank"
        }
      }
    ],
    "outputs": 0,
    "cts": false,
    "x": 1140,
    "y": 820,
    "wires": []
  },
  {
    "id": "4ebc9cd4d2d8e38f",
    "type": "ui_table",
    "z": "f1180e03d0981a44",
    "group": "051b393ae5b2d713",
    "name": "Akku 2 Status",
    "order": 2,
    "width": 12,
    "height": 13,
    "columns": [
      {
        "field": "Name",
        "title": "Beschreibung",
        "width": "",
        "align": "left",
        "formatter": "html",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Color",
        "title": "Color State",
        "width": "40",
        "align": "left",
        "formatter": "color",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Real",
        "title": "Wert",
        "width": "80",
        "align": "left",
        "formatter": "plaintext",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Prog",
        "title": "%",
        "width": "80",
        "align": "left",
        "formatter": "progress",
        "formatterParams": {
          "target": "_blank"
        }
      }
    ],
    "outputs": 0,
    "cts": false,
    "x": 1140,
    "y": 340,
    "wires": []
  },
  {
    "id": "d28f2ad43a5050fc",
    "type": "ui_table",
    "z": "f1180e03d0981a44",
    "group": "85a144ff674258ec",
    "name": "Akku Status",
    "order": 2,
    "width": 12,
    "height": 13,
    "columns": [
      {
        "field": "Name",
        "title": "Beschreibung",
        "width": "",
        "align": "left",
        "formatter": "html",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Color",
        "title": "Color",
        "width": "40",
        "align": "left",
        "formatter": "color",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Real",
        "title": "Wert",
        "width": "80",
        "align": "left",
        "formatter": "plaintext",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "Prog",
        "title": "%",
        "width": "80",
        "align": "left",
        "formatter": "progress",
        "formatterParams": {
          "target": "_blank"
        }
      }
    ],
    "outputs": 0,
    "cts": false,
    "x": 2790,
    "y": 220,
    "wires": []
  },
  {
    "id": "5d8cf45b6befe0b1",
    "type": "socketcan-out",
    "z": "f1180e03d0981a44",
    "name": "socketcan-out",
    "config": "f534d1e5074abc96",
    "x": 90,
    "y": 1380,
    "wires": [
      [
        "6460eec2bff555d0",
        "860e5b13c0421877",
        "938d30ec3e1c05fd",
        "ff1683d9a4b76ff9",
        "9e55c8257ade3bcb"
      ]
    ]
  },
  {
    "id": "bf78179902e921de",
    "type": "telegram receiver",
    "z": "f1180e03d0981a44",
    "name": "Empf\u00e4nger",
    "bot": "6b91d07b08cc43cd",
    "saveDataDir": "",
    "filterCommands": false,
    "x": 1000,
    "y": 1640,
    "wires": [
      [
        "22dc4f86e33e616c",
        "2a784e3b.f8cc4a"
      ],
      []
    ]
  },
  {
    "id": "8bca20052e0a2b2e",
    "type": "telegram sender",
    "z": "f1180e03d0981a44",
    "name": "Telegram Sender",
    "bot": "6b91d07b08cc43cd",
    "haserroroutput": false,
    "outputs": 1,
    "x": 1430,
    "y": 1660,
    "wires": [
      [
        "8c39694a471afa61"
      ]
    ]
  },
  {
    "id": "5afb7455c55f664c",
    "type": "telegram control",
    "z": "f1180e03d0981a44",
    "name": "",
    "bot": "6b91d07b08cc43cd",
    "outputs": 1,
    "checkconnection": false,
    "hostname": "",
    "interval": 10,
    "timeout": 1,
    "x": 730,
    "y": 1680,
    "wires": [
      []
    ]
  },
  {
    "id": "1d4d4916a28b8912",
    "type": "ui_led",
    "z": "f1180e03d0981a44",
    "order": 1,
    "group": "91b92b51a71a3d33",
    "width": 0,
    "height": 0,
    "label": "CAN Connect",
    "labelPlacement": "left",
    "labelAlignment": "left",
    "colorForValue": [
      {
        "color": "#ff0000",
        "value": "false",
        "valueType": "bool"
      },
      {
        "color": "#008000",
        "value": "true",
        "valueType": "bool"
      }
    ],
    "allowColorForValueInMessage": false,
    "shape": "square",
    "showGlow": true,
    "name": "",
    "x": 690,
    "y": 1240,
    "wires": []
  },
  {
    "id": "e8ed04af9bc673b4",
    "type": "ui_led",
    "z": "f1180e03d0981a44",
    "order": 1,
    "group": "5eddcc8a9a1c816c",
    "width": 12,
    "height": 1,
    "label": "Akku ID 3 Connect",
    "labelPlacement": "left",
    "labelAlignment": "center",
    "colorForValue": [
      {
        "color": "#ff0000",
        "value": "false",
        "valueType": "bool"
      },
      {
        "color": "#008000",
        "value": "true",
        "valueType": "bool"
      }
    ],
    "allowColorForValueInMessage": false,
    "shape": "square",
    "showGlow": true,
    "name": "",
    "x": 930,
    "y": 500,
    "wires": []
  },
  {
    "id": "c27d0a7f2b0a570d",
    "type": "ui_led",
    "z": "f1180e03d0981a44",
    "order": 1,
    "group": "051b393ae5b2d713",
    "width": 12,
    "height": 1,
    "label": "Akku ID 2 Connect",
    "labelPlacement": "left",
    "labelAlignment": "center",
    "colorForValue": [
      {
        "color": "#ff0000",
        "value": "false",
        "valueType": "bool"
      },
      {
        "color": "#008000",
        "value": "true",
        "valueType": "bool"
      }
    ],
    "allowColorForValueInMessage": false,
    "shape": "square",
    "showGlow": true,
    "name": "",
    "x": 930,
    "y": 260,
    "wires": []
  },
  {
    "id": "edba1e3110f25533",
    "type": "ui_led",
    "z": "f1180e03d0981a44",
    "order": 1,
    "group": "85a144ff674258ec",
    "width": 12,
    "height": 1,
    "label": "RS 485 Connect",
    "labelPlacement": "left",
    "labelAlignment": "center",
    "colorForValue": [
      {
        "color": "#ff0000",
        "value": "false",
        "valueType": "bool"
      },
      {
        "color": "#008000",
        "value": "true",
        "valueType": "bool"
      }
    ],
    "allowColorForValueInMessage": false,
    "shape": "square",
    "showGlow": true,
    "name": "",
    "x": 4110,
    "y": 140,
    "wires": []
  },
  {
    "id": "8d8a5dd9328d916c",
    "type": "ui_text",
    "z": "f1180e03d0981a44",
    "group": "91b92b51a71a3d33",
    "order": 31,
    "width": 0,
    "height": 0,
    "name": "",
    "label": "CAN ID 356 ",
    "format": "{{msg.payload}}",
    "layout": "col-center",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": 16,
    "color": "#000000",
    "x": 1190,
    "y": 1300,
    "wires": []
  },
  {
    "id": "f8a14959ecd5a227",
    "type": "ui_text",
    "z": "f1180e03d0981a44",
    "group": "91b92b51a71a3d33",
    "order": 32,
    "width": 0,
    "height": 0,
    "name": "",
    "label": "CAN ID 351",
    "format": "{{msg.payload}}",
    "layout": "col-center",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": 16,
    "color": "#000000",
    "x": 1190,
    "y": 1340,
    "wires": []
  },
  {
    "id": "fb4463fc2e646063",
    "type": "ui_text",
    "z": "f1180e03d0981a44",
    "group": "91b92b51a71a3d33",
    "order": 33,
    "width": 0,
    "height": 0,
    "name": "",
    "label": "CAN ID 355",
    "format": "{{msg.payload}}",
    "layout": "col-center",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": 16,
    "color": "#000000",
    "x": 1190,
    "y": 1380,
    "wires": []
  },
  {
    "id": "1ce96306f3e12063",
    "type": "ui_text",
    "z": "f1180e03d0981a44",
    "group": "91b92b51a71a3d33",
    "order": 30,
    "width": 0,
    "height": 0,
    "name": "",
    "label": "CAN ID 35C",
    "format": "{{msg.payload}}",
    "layout": "col-center",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": 16,
    "color": "#000000",
    "x": 1190,
    "y": 1420,
    "wires": []
  },
  {
    "id": "48b910018243843f",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "name": "Temp",
    "group": "de6cd84361a0e3c7",
    "order": 2,
    "width": 0,
    "height": 0,
    "label": "Temp",
    "chartType": "line",
    "legend": "true",
    "xformat": "dd HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "15",
    "ymax": "40",
    "removeOlder": "3",
    "removeOlderPoints": "",
    "removeOlderUnit": "86400",
    "cutout": 0,
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#ff0000",
      "#0000ff",
      "#ff7f0e",
      "#2ca02c",
      "#98df8a",
      "#d62728",
      "#ff9896",
      "#9467bd",
      "#c5b0d5"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "x": 3990,
    "y": 400,
    "wires": [
      []
    ]
  },
  {
    "id": "a3733b8c427957a5",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "Cell",
    "group": "7f9db63ff2ff7de2",
    "order": 1,
    "width": 0,
    "height": 0,
    "label": "Cell Overview",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "3.0",
    "ymax": "3.8",
    "removeOlder": "3",
    "removeOlderPoints": "",
    "removeOlderUnit": "86400",
    "cutout": 0,
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#1f77b4",
      "#aec7e8",
      "#ff7f0e",
      "#2ca02c",
      "#98df8a",
      "#d62728",
      "#ff9896",
      "#9467bd",
      "#c5b0d5"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 4110,
    "y": 1100,
    "wires": [
      []
    ]
  },
  {
    "id": "72e540713a05632e",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "name": "Temp",
    "group": "7f4586c8b01659db",
    "order": 26,
    "width": 0,
    "height": 0,
    "label": "Temp",
    "chartType": "line",
    "legend": "true",
    "xformat": "dd HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "15",
    "ymax": "40",
    "removeOlder": "3",
    "removeOlderPoints": "",
    "removeOlderUnit": "86400",
    "cutout": 0,
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#ff0000",
      "#0000ff",
      "#ff7f0e",
      "#2ca02c",
      "#98df8a",
      "#d62728",
      "#ff9896",
      "#9467bd",
      "#c5b0d5"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 3990,
    "y": 1380,
    "wires": [
      []
    ]
  },
  {
    "id": "fc7590f53dfa2ccf",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "Cell",
    "group": "7f4586c8b01659db",
    "order": 25,
    "width": 0,
    "height": 0,
    "label": "Cell Overview",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "3.0",
    "ymax": "3.8",
    "removeOlder": "3",
    "removeOlderPoints": "",
    "removeOlderUnit": "86400",
    "cutout": 0,
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#1f77b4",
      "#aec7e8",
      "#ff7f0e",
      "#2ca02c",
      "#98df8a",
      "#d62728",
      "#ff9896",
      "#9467bd",
      "#c5b0d5"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 4110,
    "y": 2080,
    "wires": [
      []
    ]
  },
  {
    "id": "b1fc8d03cb9a154a",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "name": "Temp",
    "group": "0d4c236839cc0498",
    "order": 2,
    "width": 0,
    "height": 0,
    "label": "Temp",
    "chartType": "line",
    "legend": "true",
    "xformat": "dd HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "15",
    "ymax": "40",
    "removeOlder": "3",
    "removeOlderPoints": "",
    "removeOlderUnit": "86400",
    "cutout": 0,
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#ff0000",
      "#0000ff",
      "#ff7f0e",
      "#2ca02c",
      "#98df8a",
      "#d62728",
      "#ff9896",
      "#9467bd",
      "#c5b0d5"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 3990,
    "y": 2380,
    "wires": [
      []
    ]
  },
  {
    "id": "90f92dc69e34c4a8",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "Cell",
    "group": "0d4c236839cc0498",
    "order": 1,
    "width": 0,
    "height": 0,
    "label": "Cell Overview",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "3.1",
    "ymax": "3.5",
    "removeOlder": "24",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": 0,
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#1f77b4",
      "#aec7e8",
      "#ff7f0e",
      "#2ca02c",
      "#98df8a",
      "#d62728",
      "#ff9896",
      "#9467bd",
      "#c5b0d5"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 4110,
    "y": 3080,
    "wires": [
      []
    ]
  },
  {
    "id": "6e96784cb7ef5011",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "name": "Temp",
    "group": "d4cc1627f7e1cc1b",
    "order": 3,
    "width": "13",
    "height": "5",
    "label": "Voltage",
    "chartType": "line",
    "legend": "true",
    "xformat": "dd HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "46",
    "ymax": "58.4",
    "removeOlder": "3",
    "removeOlderPoints": "",
    "removeOlderUnit": "86400",
    "cutout": 0,
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#ff0000",
      "#0000ff",
      "#ff7f0e",
      "#2ca02c",
      "#98df8a",
      "#d62728",
      "#ff9896",
      "#9467bd",
      "#c5b0d5"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 4270,
    "y": 2260,
    "wires": [
      []
    ]
  },
  {
    "id": "728d3476f77229e5",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "name": "Temp",
    "group": "d4cc1627f7e1cc1b",
    "order": 2,
    "width": "13",
    "height": "5",
    "label": "Voltage",
    "chartType": "line",
    "legend": "true",
    "xformat": "dd HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "46",
    "ymax": "58.4",
    "removeOlder": "3",
    "removeOlderPoints": "",
    "removeOlderUnit": "86400",
    "cutout": 0,
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#ff0000",
      "#0000ff",
      "#ff7f0e",
      "#2ca02c",
      "#98df8a",
      "#d62728",
      "#ff9896",
      "#9467bd",
      "#c5b0d5"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 4270,
    "y": 1240,
    "wires": [
      []
    ]
  },
  {
    "id": "9cfba1a9aed618ab",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "name": "Temp",
    "group": "d4cc1627f7e1cc1b",
    "order": 1,
    "width": "12",
    "height": "5",
    "label": "Voltage - 01",
    "chartType": "line",
    "legend": "true",
    "xformat": "dd HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "46",
    "ymax": "58.4",
    "removeOlder": "3",
    "removeOlderPoints": "",
    "removeOlderUnit": "86400",
    "cutout": 0,
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#ff0000",
      "#0000ff",
      "#ff7f0e",
      "#2ca02c",
      "#98df8a",
      "#d62728",
      "#ff9896",
      "#9467bd",
      "#c5b0d5"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 4270,
    "y": 260,
    "wires": [
      []
    ]
  },
  {
    "id": "0426835812dcb2bc",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "91b92b51a71a3d33",
    "order": 4,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Spannung",
    "label": "V",
    "format": "{{msg.payload.voltage}}",
    "min": "44.8",
    "max": "57.6",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "diff": false,
    "className": "",
    "x": 1370,
    "y": 1300,
    "wires": []
  },
  {
    "id": "90b41cd6b7d97973",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "91b92b51a71a3d33",
    "order": 6,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Lade-/Entladestrom",
    "label": "A",
    "format": "{{msg.payload.current}}",
    "min": "-165",
    "max": "165",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "diff": false,
    "className": "",
    "x": 1550,
    "y": 1300,
    "wires": []
  },
  {
    "id": "192c99be6f328185",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "91b92b51a71a3d33",
    "order": 11,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "SOC",
    "label": "%",
    "format": "{{msg.payload.SOC}}",
    "min": "0",
    "max": "100",
    "colors": [
      "#ca3800",
      "#e6e600",
      "#67f21c"
    ],
    "seg1": "20",
    "seg2": "50",
    "diff": false,
    "className": "",
    "x": 1370,
    "y": 1380,
    "wires": []
  },
  {
    "id": "59c7ff7b5f65d81e",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "91b92b51a71a3d33",
    "order": 9,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "SOH",
    "label": "%",
    "format": "{{msg.payload.SOH}}",
    "min": "0",
    "max": "100",
    "colors": [
      "#ca3800",
      "#e6e600",
      "#67f21c"
    ],
    "seg1": "20",
    "seg2": "90",
    "diff": false,
    "className": "",
    "x": 1490,
    "y": 1380,
    "wires": []
  },
  {
    "id": "6df4e8ef809ee3dd",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "91b92b51a71a3d33",
    "order": 14,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Temp",
    "label": "\u00b0C",
    "format": "{{msg.payload.temperature}}",
    "min": "0",
    "max": "40",
    "colors": [
      "#ca3800",
      "#e6e600",
      "#67f21c"
    ],
    "seg1": "20",
    "seg2": "90",
    "diff": false,
    "className": "",
    "x": 1710,
    "y": 1300,
    "wires": []
  },
  {
    "id": "f3237c0c5a7809b2",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "91b92b51a71a3d33",
    "order": 21,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Max Ladespannung",
    "label": "V",
    "format": "{{msg.payload.voltage}}",
    "min": "44.8",
    "max": "57.6",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "diff": false,
    "className": "",
    "x": 1390,
    "y": 1340,
    "wires": []
  },
  {
    "id": "4dce4a253045d14f",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "91b92b51a71a3d33",
    "order": 20,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Max Ladesstrom",
    "label": "A",
    "format": "{{msg.payload.charge_current}}",
    "min": "0",
    "max": "240",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "diff": false,
    "className": "",
    "x": 1580,
    "y": 1340,
    "wires": []
  },
  {
    "id": "324233698f6018ca",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "91b92b51a71a3d33",
    "order": 25,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Max Entadesstrom",
    "label": "A",
    "format": "{{msg.payload.discharge_current}}",
    "min": "0",
    "max": "240",
    "colors": [
      "#6aaf6a",
      "#69cd6a",
      "#6aaf6a"
    ],
    "seg1": "",
    "seg2": "",
    "diff": false,
    "className": "",
    "x": 1770,
    "y": 1340,
    "wires": []
  },
  {
    "id": "e60c7f5e85c7b90f",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 3,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 1",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[0]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1110,
    "y": 620,
    "wires": []
  },
  {
    "id": "c612f40dd49bfb8c",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 4,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 2",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[1]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1110,
    "y": 660,
    "wires": []
  },
  {
    "id": "3b7d73b1c1991e6c",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 5,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 3",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[2]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1110,
    "y": 700,
    "wires": []
  },
  {
    "id": "c980fdb0032b31eb",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 6,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 4",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[3]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1110,
    "y": 740,
    "wires": []
  },
  {
    "id": "6c6a1e7c97cfe8d6",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 7,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 5",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[4]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1230,
    "y": 620,
    "wires": []
  },
  {
    "id": "d12a574a06b807ae",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 8,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 6",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[5]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1230,
    "y": 660,
    "wires": []
  },
  {
    "id": "36d06f4eda391bc4",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 9,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 7",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[6]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1230,
    "y": 700,
    "wires": []
  },
  {
    "id": "7c923a9c0733106e",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 10,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 8",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[7]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1230,
    "y": 740,
    "wires": []
  },
  {
    "id": "7c1a49d5d1e23ebd",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 11,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 9",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[8]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1350,
    "y": 620,
    "wires": []
  },
  {
    "id": "3325e19cde1f2f79",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 12,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 10",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[9]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1360,
    "y": 660,
    "wires": []
  },
  {
    "id": "d8b77f8b2144c5f4",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 13,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 11",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[10]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1350,
    "y": 700,
    "wires": []
  },
  {
    "id": "7a50f217b206338b",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 14,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 12",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[11]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1360,
    "y": 740,
    "wires": []
  },
  {
    "id": "84dfd7582a505da5",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 15,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 13",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[12]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1500,
    "y": 620,
    "wires": []
  },
  {
    "id": "851b5ef0cd34a56e",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 16,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 14",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[13]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1500,
    "y": 660,
    "wires": []
  },
  {
    "id": "3328f6a52d3f1536",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 17,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 15",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[14]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1500,
    "y": 700,
    "wires": []
  },
  {
    "id": "40a6874a6fdf905f",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 18,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 16",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[15]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1500,
    "y": 740,
    "wires": []
  },
  {
    "id": "788d5029fbf2c690",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 19,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cells Sum",
    "label": "V",
    "format": "{{msg.payload.Voltagesum}}",
    "min": "44.8",
    "max": "57.6",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "diff": false,
    "className": "",
    "x": 1130,
    "y": 780,
    "wires": []
  },
  {
    "id": "e2275cc9fb97a201",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 20,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell max",
    "label": "V",
    "format": "{{msg.payload.Voltagemax}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1280,
    "y": 780,
    "wires": []
  },
  {
    "id": "c88829f2c4df77a7",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 22,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell min",
    "label": "V",
    "format": "{{msg.payload.Voltagemin}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1420,
    "y": 780,
    "wires": []
  },
  {
    "id": "ac2422523c6f54b3",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "5eddcc8a9a1c816c",
    "order": 21,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell Diff",
    "label": "V",
    "format": "{{msg.payload.Voltagediff}}",
    "min": "0",
    "max": "0.3",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "0.12",
    "seg2": "0.165",
    "diff": false,
    "className": "",
    "x": 1560,
    "y": 780,
    "wires": []
  },
  {
    "id": "1b1536c34840150e",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 4,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 1",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[0]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1110,
    "y": 380,
    "wires": []
  },
  {
    "id": "f64c5617c32d4275",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 5,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 2",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[1]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1110,
    "y": 420,
    "wires": []
  },
  {
    "id": "f2ede2181fd21d29",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 6,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 3",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[2]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1110,
    "y": 460,
    "wires": []
  },
  {
    "id": "c9c149cac8329ed6",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 7,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 4",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[3]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1110,
    "y": 500,
    "wires": []
  },
  {
    "id": "912b734eed741039",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 8,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 5",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[4]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1230,
    "y": 380,
    "wires": []
  },
  {
    "id": "14fa317d9fe0ef5e",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 9,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 6",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[5]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1230,
    "y": 420,
    "wires": []
  },
  {
    "id": "17d3c56ddce1ccd3",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 10,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 7",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[6]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1230,
    "y": 460,
    "wires": []
  },
  {
    "id": "3cf617dcb3771d54",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 11,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 8",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[7]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1230,
    "y": 500,
    "wires": []
  },
  {
    "id": "841bfdb145d74273",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 12,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 9",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[8]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1350,
    "y": 380,
    "wires": []
  },
  {
    "id": "b7dd6b81a67db833",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 13,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 10",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[9]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1360,
    "y": 420,
    "wires": []
  },
  {
    "id": "832da047c65f31ff",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 14,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 11",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[10]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1350,
    "y": 460,
    "wires": []
  },
  {
    "id": "8fc63af0b7f7b4ed",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 15,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 12",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[11]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1360,
    "y": 500,
    "wires": []
  },
  {
    "id": "eae64878babef39b",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 16,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 13",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[12]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1500,
    "y": 380,
    "wires": []
  },
  {
    "id": "901a76c40402e5bc",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 17,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 14",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[13]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1500,
    "y": 420,
    "wires": []
  },
  {
    "id": "371f1d82f3fbe6da",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 18,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 15",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[14]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1500,
    "y": 460,
    "wires": []
  },
  {
    "id": "989ffb4fcc549942",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 19,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell 16",
    "label": "V",
    "format": "{{msg.payload.CellsVoltage[15]}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1500,
    "y": 500,
    "wires": []
  },
  {
    "id": "20c50e8e698cb76a",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 20,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cells Sum",
    "label": "V",
    "format": "{{msg.payload.Voltagesum}}",
    "min": "44.8",
    "max": "57.6",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "diff": false,
    "className": "",
    "x": 1130,
    "y": 540,
    "wires": []
  },
  {
    "id": "758e0b4212c2ca6c",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 21,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell max",
    "label": "V",
    "format": "{{msg.payload.Voltagemax}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1280,
    "y": 540,
    "wires": []
  },
  {
    "id": "fd427fca52c47f7f",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 23,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell min",
    "label": "V",
    "format": "{{msg.payload.Voltagemin}}",
    "min": "0",
    "max": "3.85",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "3.45",
    "seg2": "3.65",
    "diff": false,
    "className": "",
    "x": 1420,
    "y": 540,
    "wires": []
  },
  {
    "id": "86916d256e50271f",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "051b393ae5b2d713",
    "order": 22,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Cell Diff",
    "label": "V",
    "format": "{{msg.payload.Voltagediff}}",
    "min": "0",
    "max": "0.3",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "0.12",
    "seg2": "0.165",
    "diff": false,
    "className": "",
    "x": 1560,
    "y": 540,
    "wires": []
  },
  {
    "id": "2f5f7a6c4a97017b",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Spannung",
    "group": "c89edcdec9811f6d",
    "order": 1,
    "width": "3",
    "height": 4,
    "gtype": "gage",
    "title": "Spannung - 01",
    "label": "V",
    "format": "{{value}}",
    "min": "48",
    "max": "56",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "51",
    "seg2": "55",
    "diff": false,
    "className": "",
    "x": 4130,
    "y": 260,
    "wires": []
  },
  {
    "id": "715ebcb0457beae2",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "SoC",
    "group": "c89edcdec9811f6d",
    "order": 4,
    "width": "3",
    "height": 4,
    "gtype": "gage",
    "title": "SOC - 01",
    "label": "%",
    "format": "{{value}}",
    "min": 0,
    "max": "100",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ffff00"
    ],
    "seg1": "20",
    "seg2": "90",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 220,
    "wires": []
  },
  {
    "id": "8f7c9c4753b4c32c",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Strom",
    "group": "c89edcdec9811f6d",
    "order": 3,
    "width": "3",
    "height": "4",
    "gtype": "gage",
    "title": "Strom - 01",
    "label": "A",
    "format": "{{value}}",
    "min": "-100",
    "max": "100",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "0",
    "seg2": "0",
    "diff": true,
    "className": "",
    "x": 4110,
    "y": 340,
    "wires": []
  },
  {
    "id": "45c1bc85ebcd11e3",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Kapazit\u00e4t",
    "group": "c89edcdec9811f6d",
    "order": 2,
    "width": "3",
    "height": 4,
    "gtype": "gage",
    "title": "Kapazit\u00e4t - 01",
    "label": "Ah",
    "format": "{{value}}",
    "min": "0",
    "max": "130",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "20",
    "seg2": "125",
    "diff": false,
    "className": "",
    "x": 4120,
    "y": 300,
    "wires": []
  },
  {
    "id": "d5e746fb98036922",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C1",
    "group": "8eb2d32010fffae1",
    "order": 1,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C1",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 460,
    "wires": []
  },
  {
    "id": "0cb806b3448d1104",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C2",
    "group": "8eb2d32010fffae1",
    "order": 2,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C2",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 500,
    "wires": []
  },
  {
    "id": "9913d6344ec0b3ab",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C3",
    "group": "8eb2d32010fffae1",
    "order": 3,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C3",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 540,
    "wires": []
  },
  {
    "id": "283c28e44d974a8d",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C4",
    "group": "8eb2d32010fffae1",
    "order": 4,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C4",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 580,
    "wires": []
  },
  {
    "id": "d21091c4f321109a",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C5",
    "group": "8eb2d32010fffae1",
    "order": 5,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C5",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 620,
    "wires": []
  },
  {
    "id": "4837521a834b2901",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C6",
    "group": "8eb2d32010fffae1",
    "order": 6,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C6",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 660,
    "wires": []
  },
  {
    "id": "05a0bfc1b9a0d839",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C7",
    "group": "8eb2d32010fffae1",
    "order": 7,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C7",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 700,
    "wires": []
  },
  {
    "id": "f9d97a455c54e3fd",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C8",
    "group": "8eb2d32010fffae1",
    "order": 8,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C8",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 740,
    "wires": []
  },
  {
    "id": "352abfc5c20170db",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C9",
    "group": "8eb2d32010fffae1",
    "order": 9,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C9",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 780,
    "wires": []
  },
  {
    "id": "081be171a80974a9",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C10",
    "group": "8eb2d32010fffae1",
    "order": 10,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C10",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 820,
    "wires": []
  },
  {
    "id": "a5164a9ca8544131",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C11",
    "group": "8eb2d32010fffae1",
    "order": 11,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C11",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 860,
    "wires": []
  },
  {
    "id": "511e4f27f6f65e73",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C12",
    "group": "8eb2d32010fffae1",
    "order": 12,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C12",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 900,
    "wires": []
  },
  {
    "id": "d2a1b808707e3864",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C13",
    "group": "8eb2d32010fffae1",
    "order": 13,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C13",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 940,
    "wires": []
  },
  {
    "id": "1cf426565b35b7d7",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C14",
    "group": "8eb2d32010fffae1",
    "order": 14,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C14",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 980,
    "wires": []
  },
  {
    "id": "8c970b41e1ceea67",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C15",
    "group": "8eb2d32010fffae1",
    "order": 15,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C15",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "x": 4110,
    "y": 1020,
    "wires": []
  },
  {
    "id": "924382b5da43d88e",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C16",
    "group": "8eb2d32010fffae1",
    "order": 17,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C16",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1060,
    "wires": []
  },
  {
    "id": "13714da377426e1b",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "BMS Temp",
    "group": "5566955c13b1ed8c",
    "order": 1,
    "width": 4,
    "height": 4,
    "gtype": "gage",
    "title": "BMS",
    "label": "C",
    "format": "{{value}}",
    "min": "20",
    "max": "50",
    "colors": [
      "#0000ff",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "25",
    "seg2": "40",
    "x": 4130,
    "y": 420,
    "wires": []
  },
  {
    "id": "0cbdccf5edb83978",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Case Temp",
    "group": "5566955c13b1ed8c",
    "order": 2,
    "width": 4,
    "height": 4,
    "gtype": "gage",
    "title": "Case",
    "label": "C",
    "format": "{{value}}",
    "min": "20",
    "max": "40",
    "colors": [
      "#0000ff",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "25",
    "seg2": "35",
    "x": 4130,
    "y": 380,
    "wires": []
  },
  {
    "id": "5ddbaac16a786fb7",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Spannung",
    "group": "07a3748f81b63862",
    "order": 1,
    "width": "3",
    "height": 4,
    "gtype": "gage",
    "title": "Spannung",
    "label": "V",
    "format": "{{value}}",
    "min": "48",
    "max": "57",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "51",
    "seg2": "55.2",
    "diff": false,
    "className": "",
    "x": 4130,
    "y": 1240,
    "wires": []
  },
  {
    "id": "8d17c9c03032cc21",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "SoC",
    "group": "07a3748f81b63862",
    "order": 4,
    "width": "3",
    "height": 4,
    "gtype": "gage",
    "title": "SOC",
    "label": "%",
    "format": "{{value}}",
    "min": 0,
    "max": "100",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ffff00"
    ],
    "seg1": "20",
    "seg2": "90",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1200,
    "wires": []
  },
  {
    "id": "a28d207b2b12369e",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Strom",
    "group": "07a3748f81b63862",
    "order": 3,
    "width": "3",
    "height": 4,
    "gtype": "gage",
    "title": "Strom",
    "label": "A",
    "format": "{{value}}",
    "min": "-100",
    "max": "100",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "0",
    "seg2": "0",
    "diff": true,
    "className": "",
    "x": 4110,
    "y": 1320,
    "wires": []
  },
  {
    "id": "6df33de7f00c19b2",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Kapazit\u00e4t",
    "group": "07a3748f81b63862",
    "order": 2,
    "width": "3",
    "height": 4,
    "gtype": "gage",
    "title": "Kapazit\u00e4t",
    "label": "Ah",
    "format": "{{value}}",
    "min": "0",
    "max": "130",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "20",
    "seg2": "125",
    "diff": false,
    "className": "",
    "x": 4120,
    "y": 1280,
    "wires": []
  },
  {
    "id": "c747b95e961beedd",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C1",
    "group": "7f4586c8b01659db",
    "order": 4,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C1",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1440,
    "wires": []
  },
  {
    "id": "bf1b165217910643",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C2",
    "group": "7f4586c8b01659db",
    "order": 5,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C2",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1480,
    "wires": []
  },
  {
    "id": "3be2a6873c0dd6d7",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C3",
    "group": "7f4586c8b01659db",
    "order": 6,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C3",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1520,
    "wires": []
  },
  {
    "id": "c4f39147df3e1480",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C4",
    "group": "7f4586c8b01659db",
    "order": 7,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C4",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1560,
    "wires": []
  },
  {
    "id": "0802e24110554cdf",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C5",
    "group": "7f4586c8b01659db",
    "order": 8,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C5",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1600,
    "wires": []
  },
  {
    "id": "3642ec607d213afe",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C6",
    "group": "7f4586c8b01659db",
    "order": 9,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C6",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1640,
    "wires": []
  },
  {
    "id": "3b7566dc3347c13e",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C7",
    "group": "7f4586c8b01659db",
    "order": 10,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C7",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1680,
    "wires": []
  },
  {
    "id": "98f5def88b09813e",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C8",
    "group": "7f4586c8b01659db",
    "order": 11,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C8",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1720,
    "wires": []
  },
  {
    "id": "d2010e6a4d8b4a6e",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C9",
    "group": "7f4586c8b01659db",
    "order": 12,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C9",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1760,
    "wires": []
  },
  {
    "id": "d4937ca49b850d3c",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C10",
    "group": "7f4586c8b01659db",
    "order": 13,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C10",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1800,
    "wires": []
  },
  {
    "id": "a02b5616e6b9e39a",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C11",
    "group": "7f4586c8b01659db",
    "order": 14,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C11",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1840,
    "wires": []
  },
  {
    "id": "bb57b2b0038fa0eb",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C12",
    "group": "7f4586c8b01659db",
    "order": 15,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C12",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1880,
    "wires": []
  },
  {
    "id": "b81739d1aeda3de0",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C13",
    "group": "7f4586c8b01659db",
    "order": 16,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C13",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1920,
    "wires": []
  },
  {
    "id": "9367d205e222796a",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C14",
    "group": "7f4586c8b01659db",
    "order": 17,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C14",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 1960,
    "wires": []
  },
  {
    "id": "4eb34926acb163a6",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C15",
    "group": "7f4586c8b01659db",
    "order": 18,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C15",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2000,
    "wires": []
  },
  {
    "id": "ee9b46cd1ae250d1",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C16",
    "group": "7f4586c8b01659db",
    "order": 19,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C16",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2040,
    "wires": []
  },
  {
    "id": "d3f5107ab051aadb",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "BMS Temp",
    "group": "7f4586c8b01659db",
    "order": 24,
    "width": 4,
    "height": 4,
    "gtype": "gage",
    "title": "BMS",
    "label": "C",
    "format": "{{value}}",
    "min": "20",
    "max": "50",
    "colors": [
      "#0000ff",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "25",
    "seg2": "40",
    "diff": false,
    "className": "",
    "x": 4130,
    "y": 1400,
    "wires": []
  },
  {
    "id": "d74a9787e10e8c49",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Case Temp",
    "group": "7f4586c8b01659db",
    "order": 22,
    "width": 4,
    "height": 4,
    "gtype": "gage",
    "title": "Case",
    "label": "C",
    "format": "{{value}}",
    "min": "20",
    "max": "40",
    "colors": [
      "#0000ff",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "25",
    "seg2": "35",
    "diff": false,
    "className": "",
    "x": 4130,
    "y": 1360,
    "wires": []
  },
  {
    "id": "7c2df1dc53c1a009",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Spannung",
    "group": "5afd26883b0fb349",
    "order": 1,
    "width": "3",
    "height": 4,
    "gtype": "gage",
    "title": "Spannung",
    "label": "V",
    "format": "{{value}}",
    "min": "48",
    "max": "57",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "51",
    "seg2": "55",
    "diff": false,
    "className": "",
    "x": 4130,
    "y": 2240,
    "wires": []
  },
  {
    "id": "aff95817337d489f",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "SoC",
    "group": "5afd26883b0fb349",
    "order": 4,
    "width": "3",
    "height": 4,
    "gtype": "gage",
    "title": "SOC",
    "label": "%",
    "format": "{{value}}",
    "min": 0,
    "max": "100",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ffff00"
    ],
    "seg1": "20",
    "seg2": "90",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2200,
    "wires": []
  },
  {
    "id": "2fbb075d516d42e7",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Strom",
    "group": "5afd26883b0fb349",
    "order": 3,
    "width": "3",
    "height": 4,
    "gtype": "gage",
    "title": "Strom",
    "label": "A",
    "format": "{{value}}",
    "min": "-100",
    "max": "100",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "0",
    "seg2": "0",
    "diff": true,
    "className": "",
    "x": 4110,
    "y": 2320,
    "wires": []
  },
  {
    "id": "1a69e6b9fb760e28",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Kapazit\u00e4t",
    "group": "5afd26883b0fb349",
    "order": 2,
    "width": "3",
    "height": 4,
    "gtype": "gage",
    "title": "Kapazit\u00e4t",
    "label": "Ah",
    "format": "{{value}}",
    "min": "0",
    "max": "130",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "20",
    "seg2": "125",
    "diff": false,
    "className": "",
    "x": 4120,
    "y": 2280,
    "wires": []
  },
  {
    "id": "5bc37085f5c0fec3",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C1",
    "group": "0d4c236839cc0498",
    "order": 21,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C1",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2440,
    "wires": []
  },
  {
    "id": "86e0633a23c4c327",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C2",
    "group": "0d4c236839cc0498",
    "order": 22,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C2",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2480,
    "wires": []
  },
  {
    "id": "e5fc66e9f212878e",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C3",
    "group": "0d4c236839cc0498",
    "order": 23,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C3",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2520,
    "wires": []
  },
  {
    "id": "ed3af2ac2a8d0a90",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C4",
    "group": "0d4c236839cc0498",
    "order": 24,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C4",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2560,
    "wires": []
  },
  {
    "id": "6a8eb68ca744e709",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C5",
    "group": "0d4c236839cc0498",
    "order": 27,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C5",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2600,
    "wires": []
  },
  {
    "id": "071c3b5eb55b289b",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C6",
    "group": "0d4c236839cc0498",
    "order": 28,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C6",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2640,
    "wires": []
  },
  {
    "id": "33f07c2ec5b9fa40",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C7",
    "group": "0d4c236839cc0498",
    "order": 29,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C7",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2680,
    "wires": []
  },
  {
    "id": "a89d15c8a972e9d4",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C8",
    "group": "0d4c236839cc0498",
    "order": 30,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C8",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2720,
    "wires": []
  },
  {
    "id": "b0289d447a189d73",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C9",
    "group": "0d4c236839cc0498",
    "order": 33,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C9",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2760,
    "wires": []
  },
  {
    "id": "64459461311eac5c",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C10",
    "group": "0d4c236839cc0498",
    "order": 34,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C10",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2800,
    "wires": []
  },
  {
    "id": "2f8fcc46dc99c51d",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C11",
    "group": "0d4c236839cc0498",
    "order": 35,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C11",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2840,
    "wires": []
  },
  {
    "id": "66847d76f9d5ff72",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C12",
    "group": "0d4c236839cc0498",
    "order": 36,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C12",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2880,
    "wires": []
  },
  {
    "id": "5cf9032035821116",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C13",
    "group": "0d4c236839cc0498",
    "order": 39,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C13",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2920,
    "wires": []
  },
  {
    "id": "202ec7fd3217ebd3",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C14",
    "group": "0d4c236839cc0498",
    "order": 40,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C14",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 2960,
    "wires": []
  },
  {
    "id": "30f69b6dd741e11b",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C15",
    "group": "0d4c236839cc0498",
    "order": 41,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C15",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 3000,
    "wires": []
  },
  {
    "id": "fe35fc73d863398f",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "C16",
    "group": "0d4c236839cc0498",
    "order": 42,
    "width": 2,
    "height": 2,
    "gtype": "gage",
    "title": "C16",
    "label": "V",
    "format": "{{value}}",
    "min": "2.6",
    "max": "3.6",
    "colors": [
      "#ff0000",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "3.1",
    "seg2": "3.4",
    "diff": false,
    "className": "",
    "x": 4110,
    "y": 3040,
    "wires": []
  },
  {
    "id": "f50a4445758d39fb",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "BMS Temp",
    "group": "0d4c236839cc0498",
    "order": 3,
    "width": 4,
    "height": 4,
    "gtype": "gage",
    "title": "BMS",
    "label": "C",
    "format": "{{value}}",
    "min": "20",
    "max": "50",
    "colors": [
      "#0000ff",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "25",
    "seg2": "40",
    "diff": false,
    "className": "",
    "x": 4130,
    "y": 2400,
    "wires": []
  },
  {
    "id": "72fb2ee7b3770fdd",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Case Temp",
    "group": "0d4c236839cc0498",
    "order": 4,
    "width": 4,
    "height": 4,
    "gtype": "gage",
    "title": "Case",
    "label": "C",
    "format": "{{value}}",
    "min": "20",
    "max": "40",
    "colors": [
      "#0000ff",
      "#00ff00",
      "#ff0000"
    ],
    "seg1": "25",
    "seg2": "35",
    "diff": false,
    "className": "",
    "x": 4130,
    "y": 2360,
    "wires": []
  },
  {
    "id": "289aa0e0143f3f80",
    "type": "ui_template",
    "z": "f1180e03d0981a44",
    "group": "91b92b51a71a3d33",
    "name": "HTML tbl",
    "order": 3,
    "width": 6,
    "height": 11,
    "format": "<div ng-bind-html=\"msg.payload | trusted\"></div>",
    "storeOutMessages": true,
    "fwdInMessages": true,
    "resendOnRefresh": false,
    "templateScope": "local",
    "className": "color",
    "x": 1540,
    "y": 1460,
    "wires": [
      []
    ]
  },
  {
    "id": "3b580e5d016664fc",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "function 3",
    "func": "// Pr\u00fcfen ob msg.payload existiert und ein String ist\nif (typeof msg.payload === \"string\" && msg.payload.length > 20) {\n    // Weiterleiten\n    return msg;\n} else {\n    // Nachricht verwerfen (geht ins Leere)\n    return null;\n}\n",
    "outputs": 1,
    "timeout": 0,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 2180,
    "y": 320,
    "wires": [
      []
    ]
  },
  {
    "id": "7ae0f5eb91e330a0",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "name": "debug RS485 Function 4",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 2590,
    "y": 40,
    "wires": []
  },
  {
    "id": "b316243ca856eab7",
    "type": "inject",
    "z": "f1180e03d0981a44",
    "name": "",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 2000,
    "y": 580,
    "wires": [
      []
    ]
  },
  {
    "id": "bb6e3a511691bda3",
    "type": "function",
    "z": "f1180e03d0981a44",
    "d": true,
    "name": "function 4",
    "func": "/**\n * BMS Telegram Decoder f\u00fcr Node-RED\n * Dekodiert Telegramme von einem Akku Battery Management System\n */\n\n// Konstanten f\u00fcr bessere Wartbarkeit\nconst OFFSETS = {\n    VER: 1,\n    ADDR: 3,\n    CID1: 5,\n    RTN: 7,\n    LENGTH: 9,\n    SOC: 15,\n    VOLTAGE: 19,\n    CELL_COUNT: 23,\n    CELL_VOLTAGES: 25,\n    CURRENT: 119,\n    CAPACITY_TOTAL: 131,\n    CAPACITY_AVAILABLE: 135,\n    CYCLES: 139\n};\n\nconst FIELD_LENGTHS = {\n    BYTE: 2,\n    WORD: 4,\n    CHECKSUM: 4\n};\n\n/**\n * Extrahiert einen Hex-Wert aus dem Telegramm\n * @param {string} data - Das Telegramm\n * @param {number} offset - Start-Position\n * @param {number} length - L\u00e4nge in Zeichen\n * @returns {number} Der dekodierte Wert\n */\nfunction parseHex(data, offset, length) {\n    return parseInt(data.substr(offset, length), 16);\n}\n\n/**\n * Extrahiert einen signierten 16-bit Wert\n * @param {string} data - Das Telegramm\n * @param {number} offset - Start-Position\n * @returns {number} Der dekodierte signierte Wert\n */\nfunction parseSigned16(data, offset) {\n    let value = parseHex(data, offset, FIELD_LENGTHS.WORD);\n    if ((value & 0x8000) > 0) {\n        value = value - 0x10000;\n    }\n    return value;\n}\n\n/**\n * Berechnet die Checksumme f\u00fcr das Telegramm\n * @param {string} data - Das Telegramm\n * @returns {number} Die berechnete Checksumme\n */\nfunction calculateChecksum(data) {\n    let checksum = 0;\n    for (let i = 1; i < data.length - 5; i++) {\n        checksum += data.charCodeAt(i);\n    }\n    return (~checksum & 0xffff) + 1;\n}\n\n/**\n * Extrahiert Temperaturwerte aus dem Telegramm\n * @param {string} data - Das Telegramm\n * @param {number} cellCount - Anzahl der Zellen\n * @returns {array} Array mit Temperaturwerten in \u00b0C\n */\nfunction parseTemperatures(data, cellCount) {\n    const temps = [];\n    const tempOffset = OFFSETS.CELL_VOLTAGES + (cellCount * FIELD_LENGTHS.WORD);\n    \n    // Typischerweise gibt es 3-4 Temperatursensoren\n    for (let i = 0; i < 4; i++) {\n        const offset = tempOffset + (i * FIELD_LENGTHS.WORD);\n        if (offset + FIELD_LENGTHS.WORD <= data.length - 5) {\n            const tempRaw = parseHex(data, offset, FIELD_LENGTHS.WORD);\n            if (tempRaw > 0) { // 0 bedeutet kein Sensor\n                temps.push(tempRaw / 10);\n            }\n        }\n    }\n    return temps;\n}\n\n/**\n * Hauptfunktion zur Dekodierung\n */\nfunction decodeBMSTelegram(msg) {\n    // Fr\u00fche Validierung\n    if (!msg.status || msg.status !== \"OK\") {\n        node.warn(\"Invalid status: \" + msg.status);\n        return null;\n    }\n    \n    if (!msg.payload || msg.payload.length < 50) {\n        node.warn(\"Telegram too short\");\n        return null;\n    }\n    \n    // RTN Code pr\u00fcfen (00 = OK)\n    const rtnCode = msg.payload.substr(OFFSETS.RTN, 2);\n    if (rtnCode !== \"00\") {\n        node.warn(\"RTN code indicates error: \" + rtnCode);\n        return null;\n    }\n    \n    const data = msg.payload;\n    \n    // Checksumme validieren\n    const calculatedChecksum = calculateChecksum(data);\n    const receivedChecksum = parseHex(data, data.length - 5, FIELD_LENGTHS.CHECKSUM);\n    \n    if (calculatedChecksum !== receivedChecksum) {\n        node.warn(`Checksum mismatch! Calculated: ${calculatedChecksum.toString(16)}, Received: ${receivedChecksum.toString(16)}`);\n        return null;\n    }\n    \n    // Daten extrahieren\n    const result = {\n        // Metadaten\n        raw: data,\n        addr: data.substr(OFFSETS.ADDR, 2),\n        version: parseHex(data, OFFSETS.VER, 2),\n        valid: true,\n        timestamp: new Date().toISOString(),\n        \n        // Hauptdaten\n        soc: parseHex(data, OFFSETS.SOC, FIELD_LENGTHS.WORD) / 100,\n        voltage: parseHex(data, OFFSETS.VOLTAGE, FIELD_LENGTHS.WORD) / 100,\n        current: parseSigned16(data, OFFSETS.CURRENT) / 100,\n        cellcount: parseHex(data, OFFSETS.CELL_COUNT, FIELD_LENGTHS.BYTE)\n    };\n    \n    // Zellspannungen in mV\n    result.cellvoltage = [];\n    result.cellvoltage_V = []; // Zus\u00e4tzlich in Volt\n    for (let i = 0; i < result.cellcount; i++) {\n        const offset = OFFSETS.CELL_VOLTAGES + (i * FIELD_LENGTHS.WORD);\n        const voltage_mV = parseHex(data, offset, FIELD_LENGTHS.WORD);\n        result.cellvoltage.push(voltage_mV);\n        result.cellvoltage_V.push(voltage_mV / 1000);\n    }\n    \n    // Min/Max/Delta Zellspannungen berechnen\n    if (result.cellvoltage.length > 0) {\n        result.cellvoltage_min = Math.min(...result.cellvoltage);\n        result.cellvoltage_max = Math.max(...result.cellvoltage);\n        result.cellvoltage_delta = result.cellvoltage_max - result.cellvoltage_min;\n        result.cellvoltage_avg = result.cellvoltage.reduce((a, b) => a + b, 0) / result.cellvoltage.length;\n    }\n    \n    // Temperaturen parsen\n    result.temperatures = parseTemperatures(data, result.cellcount);\n    \n    // Kapazit\u00e4t und Zyklen (falls vorhanden)\n    try {\n        const capacityOffset = OFFSETS.CAPACITY_TOTAL;\n        if (data.length > capacityOffset + FIELD_LENGTHS.WORD) {\n            result.capacity_total = parseHex(data, capacityOffset, FIELD_LENGTHS.WORD) / 100;\n            result.capacity_available = parseHex(data, OFFSETS.CAPACITY_AVAILABLE, FIELD_LENGTHS.WORD) / 100;\n            result.cycles = parseHex(data, OFFSETS.CYCLES, FIELD_LENGTHS.WORD);\n        }\n    } catch (e) {\n        // Kapazit\u00e4tsdaten nicht immer vorhanden\n    }\n    \n    // Leistung berechnen\n    result.power = result.voltage * result.current;\n    \n    // Status-Flags\n    result.charging = result.current > 0;\n    result.discharging = result.current < 0;\n    result.idle = Math.abs(result.current) < 0.1;\n    \n    return result;\n}\n\n// Hauptausf\u00fchrung\ntry {\n    const decoded = decodeBMSTelegram(msg);\n    \n    if (decoded) {\n        msg.payload = decoded;\n        msg.D = decoded.raw; // Originalkompatibilit\u00e4t\n        msg.addr = decoded.addr;\n        msg.valid = decoded.valid;\n        \n        // Debug-Ausgabe (optional)\n        if (msg.debug) {\n            node.warn(`BMS Decoded: SOC=${decoded.soc}%, V=${decoded.voltage}V, I=${decoded.current}A, P=${decoded.power}W`);\n        }\n        \n        return msg;\n    }\n} catch (error) {\n    node.error(\"Error decoding BMS telegram: \" + error.message);\n    msg.error = error.message;\n    return msg;\n}\n\n// Keine g\u00fcltigen Daten\nreturn null;",
    "outputs": 1,
    "timeout": 0,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 2320,
    "y": 80,
    "wires": [
      [
        "881298dbb5cbde7d",
        "20d6187b0ca54f23",
        "7ae0f5eb91e330a0"
      ]
    ]
  },
  {
    "id": "03f5edbc1e60937b",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "BMS Telegram Decoder",
    "func": "/**\n * BMS Serial Sniffer Decoder \u2013 3 Ausg\u00e4nge + Flotten-Aggregation\n * Out1: Statusdaten (bms/status)\n * Out2: Alerts/Warnings (bms/alerts)\n * Out3: Statistiken (bms/stats)\n */\n\nconst CONFIG = {\n  // Logging\n  DEBUG_MODE: false,       // detaillierte Debug-Ausgaben\n  SHOW_REQUESTS: false,    // detaillierte Request-Logs (nur mit DEBUG_MODE sinnvoll)\n  LOG_BASE: false,          // Basis-Logs immer (Found/Paired/No data/Processing/Buffer size)\n\n  // Paarung\n  BUFFER_TIMEOUT: 120,     // ms zwischen Request/Response im gleichen Buffer-Tick\n\n  // Zell-Checks\n  CELL_VOLTAGE_MIN_MV: 2000,\n  CELL_VOLTAGE_MAX_MV: 4300,\n  CELL_BALANCE_WARNING_MV: 50,\n\n  // Betriebsmodus\n  CURRENT_DEADBAND_A: 0.1,\n\n  // Watchdog\n  ENABLE_WATCHDOG: true,\n  WATCHDOG_MS: 180000,      // -> an euren Pollzyklus anpassen\n\n  // MQTT-Punkte exportieren\n  EXPORT_MQTT_POINTS: true,\n  MQTT_BASE: \"bms\",\n\n  // Aggregation\n  ENABLE_AGGREGATE: true,\n  AGGREGATE_TTL_MS: 120000, // Datensatz gilt so lange als \"frisch\"\n  // Optional: Kapazit\u00e4ten je Adresse (f\u00fcr SoC-Gewichtung); Standard = 1\n  BMS_CAPACITY_AH: {\n     \"01\": 120,\n     \"32\": 120,\n     \"03\": 120\n  }\n};\n\n// Runtime-Overrides aus Flow-Context (optional)\nconst rb = flow.get('BMS_LOG_BASE');\nif (typeof rb === 'boolean') CONFIG.LOG_BASE = rb;\n\nconst rd = flow.get('BMS_DEBUG_MODE');\nif (typeof rd === 'boolean') CONFIG.DEBUG_MODE = rd;\n\nconst rr = flow.get('BMS_SHOW_REQUESTS');\nif (typeof rr === 'boolean') CONFIG.SHOW_REQUESTS = rr;\n\n// ------------------------- Helfer -------------------------\nfunction logBase(s) { if (CONFIG.LOG_BASE) node.warn(s); }\nfunction logDebug(s){ if (CONFIG.DEBUG_MODE) node.warn(s); }\n\nfunction cleanInput(str) {\n  let s;\n  if (Buffer.isBuffer(str)) s = str.toString(\"utf8\");\n  else s = String(str || \"\");\n  if (s.endsWith(\"\\r\")) s = s.slice(0, -1);\n  s = s.replace(/\\s+/g, \"\");\n  return s;\n}\nfunction byteToCharIndex(byteIndex, hasTilde) {\n  const offset = hasTilde ? 1 : 0;\n  return offset + 2 * (byteIndex - 1);\n}\nfunction calculateChecksumASCII(frameStr) {\n  const s = frameStr;\n  if (!s || s[0] !== \"~\" || s.length < 6) return null;\n  const body = s.slice(1, -4);\n  let sum = 0;\n  for (let i = 0; i < body.length; i++) sum += body.charCodeAt(i);\n  return ((~sum & 0xffff) + 1) & 0xffff;\n}\nfunction readU16BE(hexStr, charIndex) {\n  return parseInt(hexStr.substr(charIndex, 4), 16) & 0xffff;\n}\nfunction readI16BE(hexStr, charIndex) {\n  let v = readU16BE(hexStr, charIndex);\n  if (v & 0x8000) v = v - 0x10000;\n  return v;\n}\nfunction scaleSOC(raw) {\n  if (raw <= 100)  return raw;\n  if (raw <= 1000) return raw / 10;\n  return raw / 100;\n}\nfunction clamp(val, lo, hi) {\n  return Math.max(lo, Math.min(hi, val));\n}\nfunction findCellBlock(data, startChar, endChar) {\n  let best = { startChar: null, values: [] };\n  for (let pos = startChar; pos + 4 <= endChar; pos += 2) {\n    let vals = [], p = pos;\n    while (p + 4 <= endChar) {\n      const mv = parseInt(data.substr(p, 4), 16);\n      if (mv >= CONFIG.CELL_VOLTAGE_MIN_MV && mv <= CONFIG.CELL_VOLTAGE_MAX_MV) {\n        vals.push(mv); p += 4;\n      } else break;\n    }\n    if (vals.length > best.values.length) best = { startChar: pos, values: vals };\n  }\n  return (best.values.length >= 8) ? best : { startChar: null, values: [] };\n}\n\n// MQTT-Punkte flach erzeugen\nfunction buildMqttPoints(res, baseOverride) {\n  const base = baseOverride || `${CONFIG.MQTT_BASE}/${res.addr}`;\n  const points = {};\n  points[`${base}/soc`]     = +res.soc;\n  points[`${base}/voltage`] = +res.voltage;\n  points[`${base}/current`] = +res.current;\n  points[`${base}/power`]   = +res.power;\n  points[`${base}/mode`]    = String(res.mode);\n  if (typeof res.cell_delta === \"number\") points[`${base}/cell_delta`] = res.cell_delta;\n  if (Array.isArray(res.cells)) {\n    res.cells.forEach((mv, i) => {\n      points[`${base}/cells/${i+1}`]   = mv;\n      points[`${base}/cells_v/${i+1}`] = +(mv/1000).toFixed(3);\n    });\n  }\n  if (Array.isArray(res.temps)) {\n    res.temps.forEach((t, i) => { points[`${base}/temps/${i+1}`] = t; });\n  }\n  return points;\n}\n\n// -------------------- Telegramm-Erkennung --------------------\nfunction parseTelegramBuffer(bufferText) {\n  const telegrams = [];\n  let s = bufferText;\n  while (s.length > 0) {\n    const start = s.indexOf(\"~\");\n    if (start === -1) break;\n    if (start > 0) s = s.substr(start);\n    const next = s.indexOf(\"~\", 1);\n    let frame;\n    if (next === -1) { frame = s; s = \"\"; }\n    else { frame = s.substr(0, next); s = s.substr(next); }\n    if (frame.length >= 10) {\n      const info = analyzeTelegram(frame);\n      if (info) telegrams.push(info);\n    }\n  }\n  return telegrams;\n}\nfunction analyzeTelegram(frame) {\n  if (!frame || frame[0] !== \"~\" || frame.length < 10) return null;\n  const typeCode = frame.substr(7, 2);   // Byte #4\n  const addr     = frame.substr(3, 2);   // Byte #2\n  const cid1     = frame.substr(5, 2);   // Byte #3\n  const type = (typeCode === \"84\") ? \"REQUEST\" : (typeCode === \"85\") ? \"RESPONSE\" : \"UNKNOWN\";\n  return { raw: frame, length: frame.length, addr, command: cid1, type, typeCode, timestamp: Date.now() };\n}\nfunction findPairs(telegrams) {\n  const pairs = [], unpaired = [];\n  for (let i = 0; i < telegrams.length; i++) {\n    const t = telegrams[i];\n    if (t.type === \"REQUEST\") {\n      const response = telegrams.find((r, idx) =>\n        idx > i && r.type === \"RESPONSE\" && r.addr === t.addr &&\n        (r.timestamp - t.timestamp) <= CONFIG.BUFFER_TIMEOUT\n      );\n      if (response) pairs.push({ request: t, response, addr: t.addr, roundtrip: response.timestamp - t.timestamp });\n      else unpaired.push(t);\n    } else if (t.type === \"RESPONSE\") {\n      const already = pairs.some(p => p.response === t);\n      if (already) continue;\n      const req = telegrams.find((r, idx) => idx < i && r.type === \"REQUEST\" && r.addr === t.addr);\n      if (req && !pairs.some(p => p.request === req)) {\n        pairs.push({ request: req, response: t, addr: t.addr, roundtrip: t.timestamp - req.timestamp });\n      } else {\n        pairs.push({ request: null, response: t, addr: t.addr, roundtrip: 0 });\n      }\n    }\n  }\n  return { pairs, unpaired };\n}\n\n// ---------------------- Decoder 0x4A85 ----------------------\nfunction decodeBMSResponse(telegram) {\n  const data = telegram.raw;\n  const res = { timestamp: new Date().toISOString(), addr: telegram.addr, raw_length: data.length };\n\n  const calc = calculateChecksumASCII(data);\n  const rx   = parseInt(data.substr(data.length - 4, 4), 16);\n  if (calc !== rx) { res.error = `Checksum error (calc=${calc?.toString(16)}, rx=${rx.toString(16)})`; return res; }\n\n  if (data.substr(1, 2).toUpperCase() !== \"22\") { res.error = \"Unsupported VER\"; return res; }\n  if (data.substr(5, 2).toUpperCase() !== \"4A\" || data.substr(7, 2).toUpperCase() !== \"85\") { res.error = \"Not a 0x4A85 response\"; return res; }\n\n  const hasTilde = true;\n  const CURR_CH = byteToCharIndex(8,  hasTilde);\n  const VOLT_CH = byteToCharIndex(10, hasTilde);\n\n  const voltRaw = readU16BE(data, VOLT_CH);\n  const currRaw = readI16BE(data, CURR_CH);\n  res.voltage = +(voltRaw / 100.0).toFixed(2);\n  res.current = +(currRaw / 100.0).toFixed(2);\n  res.power   = +(res.voltage * res.current).toFixed(2);\n  res.mode    = (res.current >  CONFIG.CURRENT_DEADBAND_A) ? \"CHARGING\"\n              : (res.current < -CONFIG.CURRENT_DEADBAND_A) ? \"DISCHARGING\" : \"IDLE\";\n\n  // SOC suchen (Bytes 12..15, max. 4 Kandidaten)\n  const SOC_SCAN_START_CH = byteToCharIndex(12, hasTilde);\n  const SOC_SCAN_CANDIDATES = 4;\n  let soc = null, socChar = null;\n  for (let k = 0; k < SOC_SCAN_CANDIDATES; k++) {\n    const ch = SOC_SCAN_START_CH + 4 * k;\n    if (ch + 4 > data.length - 4) break;\n    const raw = readU16BE(data, ch);\n    const cand = scaleSOC(raw);\n    if (cand >= 0 && cand <= 100) { soc = cand; socChar = ch; break; }\n  }\n  if (soc == null) soc = 0;\n  res.soc = +clamp(soc, 0, 100).toFixed(2);\n\n  // Zellspannungen: l\u00e4ngsten plausiblen Lauf finden\n  const endBeforeChk = data.length - 4;\n  const scanAnchor   = (socChar != null ? socChar : VOLT_CH);\n  const scanStart    = Math.min(endBeforeChk, scanAnchor + 12);\n  const { startChar: cellsStartChar, values: cells } = findCellBlock(data, scanStart, endBeforeChk);\n\n  // Temperaturen hinter Zellblock (/10 \u00b0C)\n  const temps = [];\n  if (cells.length) {\n    let tPos = cellsStartChar + 4 * cells.length;\n    while (tPos + 4 <= endBeforeChk && temps.length < 8) {\n      const tv = readU16BE(data, tPos);\n      const degC = tv / 10.0;\n      if (degC < -40 || degC > 120) break;\n      temps.push(+degC.toFixed(1));\n      tPos += 4;\n    }\n  }\n\n  res.cellcount = cells.length;\n  res.cells = cells;\n  res.cells_v = cells.map(mv => +(mv / 1000).toFixed(3));\n  if (cells.length) {\n    res.cell_min   = Math.min(...cells);\n    res.cell_max   = Math.max(...cells);\n    res.cell_delta = res.cell_max - res.cell_min;\n    res.cell_avg   = Math.round(cells.reduce((a,b)=>a+b,0) / cells.length);\n  }\n  if (temps.length) res.temps = temps;\n\n  if (cells.length && res.cell_delta > CONFIG.CELL_BALANCE_WARNING_MV) {\n    res.status = \"WARNING\"; res.message = `Cell imbalance: ${res.cell_delta}mV`;\n  } else res.status = \"OK\";\n\n  if (CONFIG.EXPORT_MQTT_POINTS) res.mqtt_points = buildMqttPoints(res);\n\n  logDebug(`[Cells] found ${cells.length} starting at char ${cellsStartChar}`);\n  return res;\n}\n\n// --------------------- Aggregation (Flotte) ---------------------\nfunction updateAggregateStore(results) {\n  const now = Date.now();\n  const ttl = CONFIG.AGGREGATE_TTL_MS;\n  let store = context.get(\"bms_store\") || {}; // {addr: {ts, data}}\n  for (const r of results) {\n    if (!r.error) store[r.addr] = { ts: now, data: r };\n  }\n  // aktive Datens\u00e4tze filtern\n  const activeAddrs = Object.keys(store).filter(a => now - store[a].ts <= ttl);\n  const active = activeAddrs.map(a => store[a].data);\n  // alte entfernen (optional)\n  Object.keys(store).forEach(a => { if (now - store[a].ts > ttl) delete store[a]; });\n  context.set(\"bms_store\", store);\n  return { activeAddrs, active };\n}\n\nfunction computeAggregate(active, capacities) {\n  if (!active || !active.length) return null;\n  const n = active.length;\n\n  // Gewichtetes SoC\n  let wSum = 0, wTot = 0;\n  for (const r of active) {\n    const w = (capacities && capacities[r.addr]) ? capacities[r.addr] : 1;\n    if (typeof r.soc === \"number\") { wSum += r.soc * w; wTot += w; }\n  }\n  const aggSoc = wTot ? +(wSum / wTot).toFixed(2) : 0;\n\n  // Spannung/Str\u00f6me/Leistung\n  const avgV = +(active.reduce((a,r)=>a + (r.voltage||0), 0) / n).toFixed(2);\n  const sumI = +(active.reduce((a,r)=>a + (r.current||0), 0)).toFixed(2);\n  const sumP = +(active.reduce((a,r)=>a + ((r.power!=null)? r.power : (r.voltage||0)*(r.current||0)), 0)).toFixed(2);\n  const mode = (sumI > CONFIG.CURRENT_DEADBAND_A) ? \"CHARGING\"\n             : (sumI < -CONFIG.CURRENT_DEADBAND_A) ? \"DISCHARGING\" : \"IDLE\";\n\n  // Zellen global\n  let cellsAll = [];\n  active.forEach(r => { if (Array.isArray(r.cells) && r.cells.length) cellsAll = cellsAll.concat(r.cells); });\n  let cell_min, cell_max, cell_delta;\n  if (cellsAll.length) {\n    cell_min = Math.min(...cellsAll);\n    cell_max = Math.max(...cellsAll);\n    cell_delta = cell_max - cell_min;\n  }\n\n  // Temperaturen\n  let tempsAll = [];\n  active.forEach(r => { if (Array.isArray(r.temps) && r.temps.length) tempsAll = tempsAll.concat(r.temps); });\n  const temp_avg = tempsAll.length ? +(tempsAll.reduce((a,t)=>a+t,0)/tempsAll.length).toFixed(1) : undefined;\n  const temp_max = tempsAll.length ? Math.max(...tempsAll) : undefined;\n\n  const agg = {\n    addr: \"master\",\n    timestamp: new Date().toISOString(),\n    addrs: active.map(r=>r.addr),\n    count: n,\n    soc: aggSoc,\n    voltage: avgV,\n    current: sumI,\n    power: sumP,\n    mode,\n    cell_min, cell_max, cell_delta,\n    temp_avg, temp_max,\n    status: (cell_delta != null && cell_delta > CONFIG.CELL_BALANCE_WARNING_MV) ? \"WARNING\" : \"OK\"\n  };\n\n  if (CONFIG.EXPORT_MQTT_POINTS) {\n    agg.mqtt_points = buildMqttPoints(agg, `${CONFIG.MQTT_BASE}/master`);\n  }\n  return agg;\n}\n\n// =============================== HAUPTLAUF ===============================\nlogBase(\"=====================================\");\nlogBase(\"[BMS Sniffer] Processing serial data\");\n\nif (msg.payload == null) {\n  node.error(\"[BMS Sniffer] No valid data\");\n  return [null, null, null];\n}\nconst raw = cleanInput(msg.payload);\nlogBase(`[BMS Sniffer] Buffer size: ${raw.length} chars`);\n\nif (!raw || raw.indexOf(\"~\") === -1) {\n  logBase(\"[BMS Sniffer] No valid data decoded\");\n  node.status({ fill: \"grey\", shape: \"ring\", text: \"No data\" });\n  if (CONFIG.ENABLE_WATCHDOG) {\n    const now = Date.now();\n    const lastOk = context.get(\"lastOkTs\") || 0;\n    if (now - lastOk > CONFIG.WATCHDOG_MS) {\n      const alert = { topic: \"bms/alerts\", payload: { type: \"watchdog\", message: \"No valid data\", since_ms: now - lastOk, ts: now } };\n      return [null, alert, null];\n    }\n  }\n  return [null, null, null];\n}\n\nconst telegrams = parseTelegramBuffer(raw);\nlogBase(`[BMS Sniffer] Found ${telegrams.length} telegrams`);\nlogDebug(telegrams.map((t,i)=>`  ${i+1}. ${t.type} from ${t.addr}: ${t.length} chars`).join(\"\\n\"));\n\nconst { pairs, unpaired } = findPairs(telegrams);\nlogBase(`[BMS Sniffer] Paired: ${pairs.length}, Unpaired: ${unpaired.length}`);\nif (CONFIG.SHOW_REQUESTS && CONFIG.DEBUG_MODE) {\n  const onlyReq = telegrams.filter(t => t.type === \"REQUEST\");\n  onlyReq.forEach(t => logDebug(`  - REQUEST from ${t.addr}: ${t.length} chars`));\n}\nif (unpaired.length > 0) {\n  logDebug(`[BMS Sniffer] ${unpaired.length} unpaired telegrams:`);\n  unpaired.forEach(t => logDebug(`  - ${t.type} from ${t.addr}`));\n}\n\nconst results = [];\npairs.forEach((pair, idx) => {\n  if (CONFIG.DEBUG_MODE) {\n    if (pair.request && pair.response) logDebug(`[Pair ${idx + 1}] Addr ${pair.addr}: REQ ${pair.request.length}b -> RES ${pair.response.length}b (${pair.roundtrip}ms)`);\n    else logDebug(`[Pair ${idx + 1}] Addr ${pair.addr}: RES only ${pair.response.length}b`);\n  }\n  const r = pair.response; if (!r || r.type !== \"RESPONSE\") return;\n  const decoded = decodeBMSResponse({ raw: r.raw, addr: r.addr });\n  decoded.pair_index = idx;\n  if (pair.request) { decoded.request_length = pair.request.length; decoded.roundtrip = pair.roundtrip; }\n  results.push(decoded);\n  if (!decoded.error) {\n    const cellsInfo = decoded.cellcount ? `Cells: ${decoded.cellcount} (\u0394${decoded.cell_delta ?? 0}mV)` : `Cells: 0`;\n    logDebug(`[BMS ${decoded.addr}] SOC: ${decoded.soc.toFixed(1)}% | ${decoded.voltage.toFixed(1)}V | ${decoded.current.toFixed(1)}A | ${decoded.mode} | ${cellsInfo}`);\n  } else {\n    logDebug(`[BMS ${decoded.addr}] Error: ${decoded.error}`);\n  }\n});\n\nif (results.length === 0) {\n  logBase(\"[BMS Sniffer] No valid data decoded\");\n  node.status({ fill: \"grey\", shape: \"ring\", text: \"No data\" });\n  if (CONFIG.ENABLE_WATCHDOG) {\n    const now = Date.now();\n    const lastOk = context.get(\"lastOkTs\") || 0;\n    if (now - lastOk > CONFIG.WATCHDOG_MS) {\n      const alert = { topic: \"bms/alerts\", payload: { type: \"watchdog\", message: \"No valid data\", since_ms: now - lastOk, ts: now } };\n      return [null, alert, null];\n    }\n  }\n  return [null, null, null];\n}\n\n// Es gibt valide Daten -> Watchdog zur\u00fccksetzen\ncontext.set(\"lastOkTs\", Date.now());\n\n// --------- Aggregation aktualisieren ---------\nlet aggregate = null;\nif (CONFIG.ENABLE_AGGREGATE) {\n  const { activeAddrs, active } = updateAggregateStore(results);\n  aggregate = computeAggregate(active, CONFIG.BMS_CAPACITY_AH);\n  if (aggregate) {\n    logBase(`[Aggregate] ${aggregate.count} active BMS: I=${aggregate.current}A, SoC=${aggregate.soc}%`);\n  } else {\n    logBase(\"[Aggregate] no active BMS within TTL\");\n  }\n}\n\n// -------------------- Ausgaben bauen --------------------\nlet outStatus;\nif (results.length === 1) {\n  outStatus = { topic: \"bms/status\", payload: results[0], multi_bms: false };\n} else {\n  outStatus = { topic: \"bms/status\", payload: results, multi_bms: true, bms_count: results.length };\n}\n// Aggregat zus\u00e4tzlich mitgeben (ohne Output-Layout zu brechen)\nif (aggregate) outStatus.aggregate = aggregate;\n\n// Node-Status\nconst hasError = results.some(r => r.error);\nconst hasWarn  = results.some(r => r.status === \"WARNING\") || (aggregate && aggregate.status === \"WARNING\");\nif (hasError) node.status({ fill: \"red\",    shape: \"dot\",  text: `${results.length} BMS (errors)` });\nelse if (hasWarn) node.status({ fill: \"yellow\", shape: \"dot\", text: `${results.length} BMS (warnings)` });\nelse node.status({ fill: \"green\", shape: \"dot\", text: results.map(r => `${Math.round(r.soc)}%`).join(\", \") });\n\n// Alerts (Einzel + Aggregat)\nconst alerts = [];\nalerts.push(...results.filter(r => r.error || r.status === \"WARNING\"));\nif (aggregate && aggregate.status === \"WARNING\") alerts.push({ type: \"aggregate\", ...aggregate });\nconst outAlerts = alerts.length ? { topic: \"bms/alerts\", payload: alerts } : null;\n\n// Stats\nconst outStats = {\n  topic: \"bms/stats\",\n  payload: {\n    timestamp: Date.now(),\n    bms_count: Array.isArray(outStatus.payload) ? outStatus.payload.length : 1,\n    telegrams: telegrams.length,\n    data: results.map(r => ({\n      addr: r.addr, soc: r.soc, voltage: r.voltage,\n      current: r.current, power: r.power, mode: r.mode, cell_delta: r.cell_delta\n    })),\n    aggregate: aggregate || null\n  }\n};\n\nreturn [outStatus, outAlerts, outStats];\n",
    "outputs": 3,
    "timeout": 0,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 2770,
    "y": 320,
    "wires": [
      [
        "0ef1181489466358"
      ],
      [
        "92532db0a1c33d3d"
      ],
      [
        "bb6d8373a38fc0ec"
      ]
    ]
  },
  {
    "id": "0ef1181489466358",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "name": "debug 16",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "false",
    "statusVal": "",
    "statusType": "auto",
    "x": 3020,
    "y": 280,
    "wires": []
  },
  {
    "id": "92532db0a1c33d3d",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "name": "debug 17",
    "active": false,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "false",
    "statusVal": "",
    "statusType": "auto",
    "x": 3060,
    "y": 320,
    "wires": []
  },
  {
    "id": "bb6d8373a38fc0ec",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "name": "debug 18",
    "active": false,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "false",
    "statusVal": "",
    "statusType": "auto",
    "x": 3060,
    "y": 380,
    "wires": []
  },
  {
    "id": "ff1683d9a4b76ff9",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "function 5",
    "func": "/**\n * CAN-BMS Parser \u2013 erweitert & korrekt f\u00fcr PYLONTECH\n * Out1: Aggregat/Snapshot   Out2: Raw (optional)   Out3: Warnings/Errors\n */\n\nconst CONFIG = {\n  DEBUG_MODE: false,\n  LOG_RAW_FRAMES: false,\n  LOG_UNKNOWN_IDS: true,\n\n  BMS_TYPE: \"AUTO\",              // AUTO, PYLONTECH (fokus), SEPLOS, BYD, GENERIC\n  USE_CONTEXT_STORAGE: true,\n  CONTEXT_KEY: \"can_bms_state\",\n\n  FRAME_TIMEOUT_MS: 5000,        // max Alter eines Frames im Snapshot\n  SNAPSHOT_REQUIRED: [0x355,0x356,0x351], // Mindestmenge; 0x370 optional\n  CURRENT_DEADBAND_A: 0.3,\n  CELL_DELTA_WARN_MV: 100,\n  LOW_SOC_WARN_PCT: 10\n};\n\n// Runtime-Overrides (optional via flow.set)\nconst dbg = flow.get('CAN_DEBUG_MODE');\nif (typeof dbg === 'boolean') CONFIG.DEBUG_MODE = dbg;\nconst bmsOverride = flow.get('CAN_BMS_TYPE');\nif (bmsOverride) CONFIG.BMS_TYPE = bmsOverride;\n\nfunction dlog(s){ if (CONFIG.DEBUG_MODE) node.warn(\"[CAN-BMS] \" + s); }\nfunction hex(buf){ return Array.from(buf).map(x=>x.toString(16).padStart(2,'0')).join('').toUpperCase(); }\nfunction u16le(b,i){ return b[i] | (b[i+1]<<8); }\nfunction i16le(b,i){ let v=u16le(b,i); return (v&0x8000)? v-0x10000 : v; }\nfunction toBuf(data){\n  if (Buffer.isBuffer(data)) return data;\n  if (Array.isArray(data))   return Buffer.from(data);\n  if (typeof data === 'string') return Buffer.from(data.replace(/\\s+/g,''), 'hex');\n  throw new Error(\"Invalid data\");\n}\nfunction modeFromCurrent(a, dead=CONFIG.CURRENT_DEADBAND_A){\n  if (typeof a !== 'number') return \"IDLE\";\n  if (a >  dead) return \"CHARGING\";\n  if (a < -dead) return \"DISCHARGING\";\n  return \"IDLE\";\n}\nfunction now(){ return Date.now(); }\n\n// ---------- State handling ----------\nfunction fresh(){\n  return {\n    ts_last: 0,\n    frames: {},       // id -> {ts, data: {\u2026}}\n    last_snapshot: null\n  };\n}\nfunction getState(){\n  if (!CONFIG.USE_CONTEXT_STORAGE) return fresh();\n  return context.get(CONFIG.CONTEXT_KEY) || fresh();\n}\nfunction setState(st){\n  if (!CONFIG.USE_CONTEXT_STORAGE) return;\n  context.set(CONFIG.CONTEXT_KEY, st);\n}\n\n// ---------- BMS type detection ----------\nfunction detectType(canId){\n  if (canId>=0x350 && canId<=0x37F) return \"PYLONTECH\";\n  if (canId>=0x100 && canId<=0x10F) return \"GENERIC\";\n  if (canId>=0x2F0 && canId<=0x2FF) return \"BYD\";\n  return null;\n}\n\n// ---------- Parsers ----------\nconst Parsers = {\n  PYLONTECH: {\n    0x351: (b) => {\n      if (b.length < 6) return null;\n      return {\n        charge_voltage: +(u16le(b,0)/10).toFixed(1),     // 0.1 V\n        max_charge_a:   +(i16le(b,2)/10).toFixed(1),     // 0.1 A\n        max_discharge_a:+(i16le(b,4)/10).toFixed(1)      // 0.1 A\n      };\n    },\n    0x355: (b) => {\n      if (b.length < 4) return null;\n      return {\n        soc: u16le(b,0),          // %\n        soh: u16le(b,2)           // %\n      };\n    },\n    0x356: (b) => {\n      if (b.length < 6) return null;\n      return {\n        voltage: +(i16le(b,0)/100).toFixed(2), // 0.01 V\n        current: +(i16le(b,2)/10).toFixed(1),  // 0.1 A\n        temp:    +(i16le(b,4)/10).toFixed(1)   // 0.1 \u00b0C\n      };\n    },\n    0x35C: (b) => {\n      // Flags variieren \u2013 wir geben Bits explizit aus\n      const bits = (byte)=>({\n        b0:!!(byte&1), b1:!!(byte&2), b2:!!(byte&4), b3:!!(byte&8),\n        b4:!!(byte&16), b5:!!(byte&32), b6:!!(byte&64), b7:!!(byte&128)\n      });\n      const out = { flags_raw: hex(b) };\n      out.flags0 = bits(b[0]||0);\n      out.flags1 = bits(b[1]||0);\n      // konservative Ableitungen:\n      out.charge_allowed    = true;  // endg\u00fcltig aus Limits bestimmen\n      out.discharge_allowed = true;\n      return out;\n    },\n    0x370: (b) => {\n      // Struktur: [0..1]=temp_max(0.1\u00b0C), [2..3]=temp_min(0.1\u00b0C),\n      //           [4..5]=cell_max_mv,      [6..7]=cell_min_mv  (LE)\n      const out = {};\n      if (b.length >= 2)  out.temp_max = +(u16le(b,0) / 10).toFixed(1);\n      if (b.length >= 4)  out.temp_min = +(u16le(b,2) / 10).toFixed(1);\n      if (b.length >= 6)  out.cell_max_mv = u16le(b,4);\n      if (b.length >= 8)  out.cell_min_mv = u16le(b,6);\n      if (out.cell_max_mv != null && out.cell_min_mv != null) {\n        out.cell_delta_mv = out.cell_max_mv - out.cell_min_mv;\n      }\n      return out;\n    },\n    0x35E: (b) => {\n      return { manufacturer: b.toString('ascii').replace(/\\0/g,'').trim() };\n    },\n    0x359: (b) => {\n      // einfache Alarm-Map (erste zwei Bytes)\n      const alarms = [];\n      const x0=b[0]||0, x1=b[1]||0;\n      if (x0 & 0x01) alarms.push(\"Cell Overvoltage\");\n      if (x0 & 0x02) alarms.push(\"Cell Undervoltage\");\n      if (x0 & 0x04) alarms.push(\"Over Temperature\");\n      if (x0 & 0x08) alarms.push(\"Under Temperature\");\n      if (x0 & 0x10) alarms.push(\"Over Current Discharge\");\n      if (x0 & 0x20) alarms.push(\"Over Current Charge\");\n      if (x1 & 0x01) alarms.push(\"BMS Internal Error\");\n      if (x1 & 0x02) alarms.push(\"Cell Imbalance\");\n      return { alarm_raw: hex(b), alarms };\n    },\n    0x305: (b) => ({ heartbeat: hex(b) })\n  },\n\n  // Platzhalter \u2013 sp\u00e4ter verfeinern\n  SEPLOS: {\n    0x351: (b)=>{ if (b.length<6) return null;\n      return { voltage:+(u16le(b,0)/100).toFixed(2), current:+((i16le(b,2)-30000)/10).toFixed(1), soc:u16le(b,4)/100 };\n    },\n    0x355: (b)=>{ if (b.length<6) return null;\n      return { soc:u16le(b,0)/100, soh:u16le(b,2)/100, cycles:u16le(b,4) };\n    },\n    0x356: (b)=>{ if (b.length<4) return null;\n      const max=u16le(b,0), min=u16le(b,2);\n      return { cell_max_mv:max, cell_min_mv:min, cell_delta_mv:max-min };\n    }\n  },\n\n  GENERIC: {}\n};\n\n// ---------- Snapshot builder ----------\nfunction buildSnapshot(st){\n  const nowTs = now();\n  // Verf\u00fcgbarkeit pr\u00fcfen\n  for (const id of CONFIG.SNAPSHOT_REQUIRED){\n    const fr = st.frames[id];\n    if (!fr || (nowTs - fr.ts) > CONFIG.FRAME_TIMEOUT_MS) return null;\n  }\n\n  // Werte zusammenf\u00fchren (neueste)\n  const snap = { ts: nowTs, source: \"pylontech\", ids: {} };\n  function mergeFrom(id){\n    const fr = st.frames[id]; if (!fr) return;\n    Object.assign(snap, fr.data); snap.ids[id]=fr.ts;\n  }\n  [0x355,0x356,0x351,0x370,0x35C,0x35E,0x359,0x305].forEach(mergeFrom);\n\n  // Abgeleitete Felder\n  if (typeof snap.voltage==='number' && typeof snap.current==='number'){\n    snap.power = +(snap.voltage * snap.current).toFixed(2);\n    snap.mode = modeFromCurrent(snap.current);\n  }\n  // charge/discharge allowed konservativ (Limits > 0)\n  if (typeof snap.max_charge_a === 'number'){\n    snap.charge_allowed = snap.max_charge_a > 0.0;\n  }\n  if (typeof snap.max_discharge_a === 'number'){\n    snap.discharge_allowed = snap.max_discharge_a > 0.0;\n  }\n\n  // Status\n  let status = \"OK\";\n  if (Array.isArray(snap.alarms) && snap.alarms.length) status = \"ALARM\";\n  else if (typeof snap.cell_delta_mv==='number' && snap.cell_delta_mv > CONFIG.CELL_DELTA_WARN_MV) status = \"WARNING\";\n  else if (typeof snap.soc==='number' && snap.soc < CONFIG.LOW_SOC_WARN_PCT) status = \"LOW_SOC\";\n  snap.status = status;\n\n  return snap;\n}\n\n// ---------- Main ----------\nif (!msg.payload || typeof msg.payload !== 'object') {\n  return [null, CONFIG.LOG_RAW_FRAMES ? {topic:\"can/bms/raw\",payload:msg.payload} : null, { error:\"Invalid payload\", ts: now() }];\n}\n\n// Normalisiere Eing\u00e4nge (kompatibel zu socketcan-out)\nlet canId = msg.payload.canid ?? msg.payload.can_id ?? msg.payload.id;\nif (typeof canId === 'string') { try { canId = parseInt(canId,16); } catch(e){} }\nlet dataBuf;\ntry { dataBuf = toBuf(msg.payload.data); } catch(e){\n  return [null, CONFIG.LOG_RAW_FRAMES?{topic:\"can/bms/raw\",payload:msg.payload}:null, { error:\"Invalid CAN data\", detail:e.message, ts: now() }];\n}\nif (!(Number.isFinite(canId))) {\n  return [null, CONFIG.LOG_RAW_FRAMES?{topic:\"can/bms/raw\",payload:msg.payload}:null, { error:\"Missing/invalid CAN ID\", ts: now() }];\n}\n\n// Raw log\nconst raw = {\n  timestamp: msg.payload.timestamp || now(),\n  can_id: \"0x\"+canId.toString(16),\n  dlc: msg.payload.dlc ?? dataBuf.length,\n  data_hex: hex(dataBuf),\n  ext: !!msg.payload.ext,\n  rtr: !!msg.payload.rtr\n};\nif (CONFIG.LOG_RAW_FRAMES) dlog(`RAW ${raw.can_id}#${raw.data_hex}`);\n\n// BMS-Typ bestimmen\nlet type = CONFIG.BMS_TYPE;\nif (type === \"AUTO\") type = detectType(canId) || \"GENERIC\";\n\n// Frame parsen\nconst parsers = Parsers[type] || {};\nconst parser = parsers[canId];\nif (!parser) {\n  if (CONFIG.LOG_UNKNOWN_IDS) node.warn(`[CAN-BMS] Unknown CAN ID 0x${canId.toString(16)} for ${type}`);\n  return [null, CONFIG.LOG_RAW_FRAMES?{topic:\"can/bms/raw\",payload:raw}:null, { warning:\"Unknown CAN ID\", id: raw.can_id, ts: now() }];\n}\n\nlet data;\ntry {\n  data = parser(dataBuf);\n  if (!data) data = {}; // leere, aber g\u00fcltige\n} catch(e){\n  node.error(`[CAN-BMS] Parse error 0x${canId.toString(16)}: ${e.message}`);\n  return [null, CONFIG.LOG_RAW_FRAMES?{topic:\"can/bms/raw\",payload:raw}:null, { error:\"Parse error\", id: raw.can_id, detail:e.message, ts: now() }];\n}\n\n// State aktualisieren\nlet st = getState();\nst.ts_last = now();\nst.frames[canId] = { ts: st.ts_last, data };\nsetState(st);\n\n// ggf. BMS_TYPE fixieren, wenn Hersteller kommt\nif (canId === 0x35E && data.manufacturer && /pylon/i.test(data.manufacturer)) {\n  flow.set('CAN_BMS_TYPE','PYLONTECH');\n}\n\n// Snapshot bauen (falls vollst\u00e4ndig)\nconst snap = buildSnapshot(st);\n\n// Node-Status & Outputs\nif (snap) {\n  const fill = snap.status === \"ALARM\" ? \"red\" : (snap.status===\"WARNING\" || snap.status===\"LOW_SOC\" ? \"yellow\" : \"green\");\n  const socStr = (typeof snap.soc==='number') ? `${Math.round(snap.soc)}%` : \"--\";\n  const info = [socStr, snap.mode, (snap.current!=null? `${snap.current.toFixed(1)}A` : \"\")].filter(Boolean).join(\" \");\n  node.status({ fill, shape:\"dot\", text: info });\n\n  // Out1: Snapshot (kompakt + mqtt_friendly Flatten)\nconst flat = {\n  manufacturer: snap.manufacturer,\n  soc: snap.soc, soh: snap.soh,\n  voltage: snap.voltage, current: snap.current, power: snap.power,\n\n  // NEU: Temperatur-Grenzen aus 0x370\n  temp: snap.temp,          // aus 0x356 (Pack-Temp)\n  temp_max: snap.temp_max,  // aus 0x370\n  temp_min: snap.temp_min,  // aus 0x370\n\n  charge_voltage: snap.charge_voltage,\n  max_charge_a: snap.max_charge_a,\n  max_discharge_a: snap.max_discharge_a,\n  charge_allowed: snap.charge_allowed,\n  discharge_allowed: snap.discharge_allowed,\n\n  cell_min_mv: snap.cell_min_mv,\n  cell_max_mv: snap.cell_max_mv,\n  cell_delta_mv: snap.cell_delta_mv,\n  status: snap.status, mode: snap.mode\n};\n\n  const out1 = {\n    topic: \"can/bms/status\",\n    payload: {\n      ts: snap.ts,\n      data: snap,                // detailiert\n      mqtt_friendly: flat        // flache Struktur\n    }\n  };\n  const out2 = CONFIG.LOG_RAW_FRAMES ? { topic:\"can/bms/raw\", payload: raw } : null;\n  return [out1, out2, null];\n\n} else {\n  node.status({ fill:\"blue\", shape:\"ring\", text:\"Collecting frames...\" });\n  const out1 = { topic:\"can/bms/frame\", payload:{ id: raw.can_id, parsed: data, ts: st.ts_last } };\n  const out2 = CONFIG.LOG_RAW_FRAMES ? { topic:\"can/bms/raw\", payload: raw } : null;\n  return [out1, out2, null];\n}\n",
    "outputs": 3,
    "timeout": 0,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 440,
    "y": 1460,
    "wires": [
      [
        "abdbabb5adb2407a",
        "fn_fanout",
        "ui_warntext",
        "lbl_warn"
      ],
      [
        "da3c5f8b29887f1c"
      ],
      [
        "86710cc632253ebd"
      ]
    ]
  },
  {
    "id": "abdbabb5adb2407a",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "name": "debug 19",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "false",
    "statusVal": "",
    "statusType": "auto",
    "x": 640,
    "y": 1440,
    "wires": []
  },
  {
    "id": "da3c5f8b29887f1c",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "name": "debug 20",
    "active": false,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "false",
    "statusVal": "",
    "statusType": "auto",
    "x": 640,
    "y": 1480,
    "wires": []
  },
  {
    "id": "86710cc632253ebd",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "name": "debug 21",
    "active": false,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "false",
    "statusVal": "",
    "statusType": "auto",
    "x": 640,
    "y": 1520,
    "wires": []
  },
  {
    "id": "bac0e6e0fe91f4e0",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "name": "debug 22",
    "active": false,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "false",
    "statusVal": "",
    "statusType": "auto",
    "x": 640,
    "y": 1560,
    "wires": []
  },
  {
    "id": "9ac4d3d17fbfe82a",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "BMS TX Command",
    "func": "/**\n * BMS TX Command Builder\n * Baut Frames: \"~22\" + ADDR + CID1 + CID2 + LEN + INFO + CHKSUM + \"\\r\"\n * Checksumme = ASCII-Summe \u00fcber alles NACH \"~\" bis VOR 4-hex CRC, Zweierkomplement (16 bit), Uppercase HEX (4 Zeichen)\n *\n * Erwartet:\n *   msg.cmd = {\n *     addr:   \"01\" | 1,            // 0..63; Hex-String oder Zahl\n *     cid1:   \"4A\",                // optional, Default \"4A\"\n *     cid2:   \"42\" | \"84\" | \"A0\"..., // 2-hex\n *     info:   \"01\" | \"0102...\" | \"\" (Hex-String, ohne Leerzeichen; optional),\n *     len:    \"E002\" (optional, falls du die 2-Byte-L\u00e4ngenfelds komplett selbst vorgibst),\n *     len_prefix: \"E0\"|\"F0\",       // optional; nur benutzt wenn len NICHT gesetzt ist; Default \"E0\"\n *   }\n *\n * Ausgabe:\n *   msg.payload = vollst\u00e4ndiger Frame als String (inkl. CR am Ende)\n *   msg.topic   = \"bms/cmd\"\n *\n * Sicherheit:\n *   F\u00fcr \"Write/Param\"-Kommandos (z.B. CID2 B0/8B etc.) ist eine einfache Schutzschranke drin:\n *   Setze msg.confirm = true, sonst verweigert der Node das Senden.\n */\n\nfunction toHex2(v) {\n  if (typeof v === \"string\") {\n    const s = v.replace(/\\s+/g,\"\").toUpperCase();\n    if (/^[0-9A-F]{2}$/.test(s)) return s;\n    if (/^[0-9A-F]{1}$/.test(s)) return (\"0\"+s);\n  }\n  if (typeof v === \"number\" && isFinite(v)) {\n    const n = Math.max(0, Math.min(255, v|0));\n    return n.toString(16).toUpperCase().padStart(2,\"0\");\n  }\n  throw new Error(\"toHex2: invalid value\");\n}\n\nfunction sanitizeHex(str) {\n  if (str == null) return \"\";\n  const s = String(str).replace(/\\s+/g,\"\").toUpperCase();\n  if (s.length % 2 !== 0) throw new Error(\"Hex length must be even\");\n  if (!/^[0-9A-F]*$/.test(s)) throw new Error(\"Non-hex chars in info/len\");\n  return s;\n}\n\n// ASCII-Zweierkomplement \u00fcber alles NACH \"~\" bis VOR CRC\nfunction checksumAscii(frameNoCrc) {\n  let sum = 0;\n  for (let i = 1; i < frameNoCrc.length; i++) { // i=1: nach \"~\"\n    sum += frameNoCrc.charCodeAt(i);\n  }\n  const c = ((~sum & 0xFFFF) + 1) & 0xFFFF;\n  return c.toString(16).toUpperCase().padStart(4,\"0\");\n}\n\n// --- Start ---\nif (!msg || !msg.cmd) {\n  node.error(\"No msg.cmd provided\");\n  return null;\n}\n\nconst cmd = msg.cmd;\n\n// Schutzschranke f\u00fcr potenzielle Set/Write-CIDs (du kannst die Liste erweitern)\nconst writeLike = new Set([\"8B\",\"B0\",\"A1\",\"B1\"]);\nif (writeLike.has(String(cmd.cid2||\"\").toUpperCase()) && !msg.confirm) {\n  node.error(\"Write/Param command refused (set msg.confirm=true to allow)\");\n  return null;\n}\n\n// Felder aufbereiten\nconst addr = toHex2(cmd.addr);\nconst cid1 = cmd.cid1 ? sanitizeHex(cmd.cid1) : \"4A\";\nif (cid1.length !== 2) throw new Error(\"cid1 must be 1 byte\");\n\nconst cid2 = sanitizeHex(cmd.cid2);\nif (cid2.length !== 2) throw new Error(\"cid2 must be 1 byte\");\n\nconst info = sanitizeHex(cmd.info || \"\");\n\n// LEN-Feld:\n// In deinen Beispielen gibt es ein 2-Byte-L\u00e4ngenfeld, dessen oberes Byte ein Prefix (z.B. \"E0\"/\"F0\") + evtl. Pr\u00fcfnibble tr\u00e4gt.\n// Da das Hersteller-Schema je CID variieren kann, lassen wir beides zu:\n//   a) Wenn msg.cmd.len gesetzt ist -> 1:1 \u00fcbernehmen\n//   b) Sonst: einfache Heuristik: LEN = (len_prefix || \"E0\") + <INFO_LEN_BYTE>\nlet lenField;\nif (cmd.len) {\n  lenField = sanitizeHex(cmd.len);\n  if (lenField.length !== 4) throw new Error(\"len must be 2 bytes (4 hex chars)\");\n} else {\n  const lenPrefix = sanitizeHex(cmd.len_prefix || \"E0\");\n  if (lenPrefix.length !== 2) throw new Error(\"len_prefix must be 1 byte\");\n  const infoLenByte = (info.length/2) & 0xFF;       // 1-Byte L\u00e4nge\n  lenField = lenPrefix + toHex2(infoLenByte);\n}\n\n// Frame ohne CRC bauen\nlet frame = \"~22\" + addr + cid1 + cid2 + lenField + info;\n\n// CRC berechnen & anh\u00e4ngen\nconst crc = checksumAscii(frame + \"0000\"); // \"0000\" nur Platzhalter-Gedanke; wir summieren ohnehin bis VOR CRC\nframe = frame + crc + \"\\r\";\n\n// Ausgeben\nmsg.topic = \"bms/cmd\";\nmsg.payload = frame;\nreturn msg;\n",
    "outputs": 1,
    "timeout": 0,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 310,
    "y": 1600,
    "wires": [
      []
    ]
  },
  {
    "id": "c35db6472c9071c3",
    "type": "socketcan-in",
    "z": "f1180e03d0981a44",
    "name": "socketcan-in",
    "config": "f534d1e5074abc96",
    "x": 150,
    "y": 1240,
    "wires": []
  },
  {
    "id": "9e55c8257ade3bcb",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "function 6",
    "func": "// Pylontech CAN Decoder (f\u00fcr socketcan-out RX)\n// Erwartet msg.payload = { id, data } (data: Buffer oder Byte-Array)\n// Liefert konsolidierte Werte je Pack in msg.payload\n\nfunction u16le(b, i){ return b[i] | (b[i+1]<<8); }\nfunction i16le(b, i){ let v = u16le(b,i); return (v & 0x8000) ? v-0x10000 : v; }\nfunction hex(buf){ return Array.from(buf).map(x=>x.toString(16).padStart(2,\"0\")).join(\"\").toUpperCase(); }\n\nlet p = msg.payload || {};\nlet id = typeof p.id === 'string' ? parseInt(p.id,16) : p.id;\nlet data = Buffer.isBuffer(p.data) ? p.data : Buffer.from(p.data||[]);\nif (typeof id !== 'number' || data.length === 0) return null;\n\nlet state = context.get('pt') || {\n  mfr: null, soc: null, soh: null,\n  voltage: null, current: null, temp: null,\n  charge_voltage: null, max_charge_a: null, max_discharge_a: null,\n  flags: null, status359: null,\n  cell_min_mv: null, cell_max_mv: null\n};\n\nswitch (id) {\n  case 0x35E: // Manufacturer (ASCII)\n    state.mfr = data.toString('ascii').trim();\n    break;\n\n  case 0x355: // SoC/SoH (u16 LE, %)\n    if (data.length >= 4) {\n      state.soc = u16le(data,0);  // %\n      state.soh = u16le(data,2);  // %\n    }\n    break;\n\n  case 0x356: // Voltage/Current/Temp (i16 LE)\n    if (data.length >= 6) {\n      // h\u00e4ufige Skalierung: V:0.01V, I:0.1A, T:0.1\u00b0C\n      state.voltage = +(i16le(data,0)/100).toFixed(2);\n      state.current = +(i16le(data,2)/10).toFixed(1);\n      state.temp    = +(i16le(data,4)/10).toFixed(1);\n    }\n    break;\n\n  case 0x351: // Charge Voltage + Limits (LE)\n    if (data.length >= 6) {\n      state.charge_voltage = +(u16le(data,0)/10).toFixed(1);   // 0.1 V\n      state.max_charge_a   = +(i16le(data,2)/10).toFixed(1);   // 0.1 A\n      state.max_discharge_a= +(i16le(data,4)/10).toFixed(1);   // 0.1 A\n    }\n    break;\n\n  case 0x35C: // Flags (Enable/Status)\n    // Hersteller-spezifisch; hier roh und als Bits:\n    state.flags = {\n      raw: hex(data),\n      b0: (data[0]>>0)&1, b1: (data[0]>>1)&1, b6: (data[0]>>6)&1, b7:(data[0]>>7)&1\n    };\n    break;\n\n  case 0x359: // Status/Alarme (OEM-spezifisch)\n    state.status359 = hex(data);\n    break;\n\n  case 0x370: // h\u00e4ufig Min/Max Cell mV, plus weitere Felder\n    // konservativ: letzte 4 Bytes als Max/Min mV interpretieren\n    if (data.length >= 8) {\n      const a = u16le(data,4); // z.B. max mV\n      const b = u16le(data,6); // z.B. min mV\n      // manchmal vertauscht \u2013 wir normalisieren:\n      state.cell_min_mv = Math.min(a,b);\n      state.cell_max_mv = Math.max(a,b);\n    }\n    break;\n\n  case 0x305: // Heartbeat/Reserved \u2013 wir loggen nur roh\n    // noop\n    break;\n\n  default:\n    // andere IDs ignorieren/optional loggen\n    break;\n}\n\ncontext.set('pt', state);\n\n// Konsolidiertes Payload erzeugen\nlet out = {\n  ts: Date.now(),\n  mfr: state.mfr,\n  soc: state.soc, soh: state.soh,\n  voltage: state.voltage, current: state.current, temp: state.temp,\n  charge_voltage: state.charge_voltage,\n  max_charge_a: state.max_charge_a, max_discharge_a: state.max_discharge_a,\n  flags: state.flags,\n  status359: state.status359,\n  cell_min_mv: state.cell_min_mv, cell_max_mv: state.cell_max_mv,\n  cell_delta_mv: (state.cell_min_mv!=null && state.cell_max_mv!=null) ? (state.cell_max_mv - state.cell_min_mv) : null\n};\n\n// Nur ausgeben, wenn irgendwas Sinnvolles drin ist\nmsg.topic = \"can/pylontech/status\";\nmsg.payload = out;\nreturn msg;\n",
    "outputs": 1,
    "timeout": 0,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 480,
    "y": 1560,
    "wires": [
      [
        "bac0e6e0fe91f4e0"
      ]
    ]
  },
  {
    "id": "link_in_status",
    "type": "link in",
    "z": "f1180e03d0981a44",
    "name": "BMS_STATUS_IN (from Parser Out1)",
    "links": [],
    "x": 270,
    "y": 1900,
    "wires": [
      [
        "fn_fanout"
      ]
    ]
  },
  {
    "id": "link_in_raw",
    "type": "link in",
    "z": "f1180e03d0981a44",
    "name": "CAN_RAW_IN (from Parser Out2)",
    "links": [],
    "x": 260,
    "y": 2520,
    "wires": [
      [
        "fn_rawbuf"
      ]
    ]
  },
  {
    "id": "link_in_warn",
    "type": "link in",
    "z": "f1180e03d0981a44",
    "name": "BMS_WARN_IN (from Parser Out3)",
    "links": [],
    "x": 285,
    "y": 2080,
    "wires": [
      [
        "ui_warntext"
      ]
    ]
  },
  {
    "id": "fn_fanout",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Snapshot \u2192 UI Fanout",
    "func": "// Erwartet msg.payload.data (Snapshot) oder msg.payload.mqtt_friendly\nconst root = msg.payload || {};\nconst snap = root.data || root;\nconst flat = root.mqtt_friendly || {};\n\nconst soc = Number(snap.soc ?? flat.soc ?? 0);\nconst soh = Number(snap.soh ?? flat.soh ?? 0);\nconst u   = Number(snap.voltage ?? flat.voltage ?? 0);\nconst i   = Number(snap.current ?? flat.current ?? 0);\nconst pwr = Number(snap.power ?? flat.power ?? (u*i));\nconst t   = Number(snap.temp ?? flat.temp ?? 0);\nconst tmax= Number(snap.temp_max ?? flat.temp_max ?? t);\nconst tmin= Number(snap.temp_min ?? flat.temp_min ?? t);\nconst cmin= Number(snap.cell_min_mv ?? flat.cell_min_mv ?? 0);\nconst cmax= Number(snap.cell_max_mv ?? flat.cell_max_mv ?? 0);\nconst cdel= Number(snap.cell_delta_mv ?? flat.cell_delta_mv ?? (cmax-cmin));\nconst vchg= Number(snap.charge_voltage ?? flat.charge_voltage ?? 0);\nconst ichg= Number(snap.max_charge_a ?? flat.max_charge_a ?? 0);\nconst idis= Number(snap.max_discharge_a ?? flat.max_discharge_a ?? 0);\nconst chga= !!(snap.charge_allowed ?? flat.charge_allowed ?? (ichg>0));\nconst disa= !!(snap.discharge_allowed ?? flat.discharge_allowed ?? (idis>0));\nconst mode= String(snap.mode ?? flat.mode ?? '');\nconst stat= String(snap.status ?? flat.status ?? '');\nconst mfr = String(snap.manufacturer ?? flat.manufacturer ?? '');\nconst alarms = Array.isArray(snap.alarms) ? snap.alarms : (Array.isArray(root.alarms)? root.alarms : []);\nconst ts = Number(snap.ts || Date.now());\n\nfunction led(color, on){ return { payload: !!on, color }; }\nfunction txt(s){ return { payload: s }; }\nfunction gauge(n){ return { payload: n }; }\nfunction chart(topic, val){ return { topic, payload: Number(val) }; }\n\n// Outputs: 1 SoC gauge, 2 Voltage gauge, 3 Current gauge, 4 Temp gauge, 5 Power gauge,\n// 6 Mode text, 7 Status text, 8 Status LED, 9 ChargeAllowed LED, 10 DischargeAllowed LED,\n// 11 CellMin text, 12 CellMax text, 13 CellDelta gauge,\n// 14 Chart SoC, 15 Chart U/I (U topic=Voltage, I topic=Current), 16 Chart Power, 17 Chart Temps (Pack/Max/Min), 18 Chart CellDelta,\n// 19 Manufacturer text, 20 Limits text, 21 Alarms text\n\nconst out = [];\nout[0]  = gauge(soc);\nout[1]  = gauge(u);\nout[2]  = gauge(i);\nout[3]  = gauge(t);\nout[4]  = gauge(pwr);\nout[5]  = txt(mode);\nout[6]  = txt(`${stat} | SOH ${soh}%`);\n// Status LED Farbe\nconst statColor = stat==='ALARM' ? 'red' : (stat==='WARNING' || stat==='LOW_SOC') ? 'yellow' : 'green';\nout[7]  = led(statColor, true);\nout[8]  = led(chga? 'green':'grey', chga);\nout[9]  = led(disa? 'green':'grey', disa);\nout[10] = txt(`${(cmin/1000).toFixed(3)} V`);\nout[11] = txt(`${(cmax/1000).toFixed(3)} V`);\nout[12] = gauge(cdel);\n// Charts (mit Timestamp)\nout[13] = chart('SoC', soc, ts);\nout[14] = [ chart('Voltage', u, ts), chart('Current', i, ts) ];\nout[15] = chart('Power', pwr, ts);\nout[16] = [ chart('PackTemp', t, ts), chart('TempMax', tmax, ts), chart('TempMin', tmin, ts) ];\nout[17] = chart('CellDelta', cdel, ts);\nout[18] = txt(mfr);\nout[19] = txt(`Vchg ${vchg.toFixed? vchg.toFixed(1): vchg} V | Ichg ${ichg} A | Idis ${idis} A`);\nout[20] = txt(alarms.length ? alarms.join(', ') : '\u2014');\nreturn out;",
    "outputs": 21,
    "timeout": "",
    "noerr": 14,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 520,
    "y": 1900,
    "wires": [
      [
        "ui_g_soc"
      ],
      [
        "ui_g_u"
      ],
      [
        "ui_g_i"
      ],
      [
        "ui_g_t"
      ],
      [
        "ui_g_p"
      ],
      [
        "ui_txt_mode"
      ],
      [
        "ui_txt_status"
      ],
      [
        "ui_led_status"
      ],
      [
        "ui_led_chg"
      ],
      [
        "ui_led_dis"
      ],
      [
        "ui_txt_cmin"
      ],
      [
        "ui_txt_cmax"
      ],
      [
        "ui_g_cdelta"
      ],
      [
        "ui_chart_soc"
      ],
      [
        "ui_chart_ui"
      ],
      [
        "ui_chart_power",
        "b16d72aab231b212"
      ],
      [
        "ui_chart_temp"
      ],
      [
        "ui_chart_cdelta"
      ],
      [
        "ui_txt_mfr"
      ],
      [
        "ui_txt_limits"
      ],
      []
    ]
  },
  {
    "id": "ui_g_soc",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "SoC %",
    "group": "e06592d12e8c6fde",
    "order": 12,
    "width": 4,
    "height": 3,
    "gtype": "gage",
    "title": "SoC",
    "label": "%",
    "format": "{{value}}",
    "min": 0,
    "max": 100,
    "colors": [
      "#ff0000",
      "#f7c600",
      "#00b500"
    ],
    "seg1": 20,
    "seg2": 80,
    "diff": false,
    "className": "",
    "x": 1780,
    "y": 1720,
    "wires": []
  },
  {
    "id": "ui_g_u",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Voltage",
    "group": "e06592d12e8c6fde",
    "order": 9,
    "width": 4,
    "height": 3,
    "gtype": "gage",
    "title": "Spannung",
    "label": "V",
    "format": "{{value | number:2}}",
    "min": 40,
    "max": 60,
    "colors": [
      "#ca3838",
      "#1e88e5",
      "#1de9b6"
    ],
    "seg1": 48,
    "seg2": 58,
    "diff": false,
    "className": "",
    "x": 1780,
    "y": 1760,
    "wires": []
  },
  {
    "id": "ui_g_i",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Current",
    "group": "e06592d12e8c6fde",
    "order": 10,
    "width": 4,
    "height": 3,
    "gtype": "gage",
    "title": "Strom",
    "label": "A",
    "format": "{{value | number:1}}",
    "min": -300,
    "max": 300,
    "colors": [
      "#039be5",
      "#f7c600",
      "#ef6c00"
    ],
    "seg1": -50,
    "seg2": 50,
    "diff": false,
    "className": "",
    "x": 1780,
    "y": 1800,
    "wires": []
  },
  {
    "id": "ui_g_t",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Temp",
    "group": "e06592d12e8c6fde",
    "order": 16,
    "width": 4,
    "height": 3,
    "gtype": "gage",
    "title": "Pack-Temp",
    "label": "\u00b0C",
    "format": "{{value | number:1}}",
    "min": -10,
    "max": 70,
    "colors": [
      "#64b5f6",
      "#ffee58",
      "#ef5350"
    ],
    "seg1": 35,
    "seg2": 45,
    "diff": false,
    "className": "",
    "x": 1770,
    "y": 1840,
    "wires": []
  },
  {
    "id": "ui_g_p",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "Power",
    "group": "e06592d12e8c6fde",
    "order": 11,
    "width": 4,
    "height": 3,
    "gtype": "gage",
    "title": "Leistung",
    "label": "W",
    "format": "{{value | number:0}}",
    "min": -20000,
    "max": 20000,
    "colors": [
      "#1976d2",
      "#9e9e9e",
      "#d32f2f"
    ],
    "seg1": -2000,
    "seg2": 2000,
    "diff": false,
    "className": "",
    "x": 1770,
    "y": 1880,
    "wires": []
  },
  {
    "id": "ui_txt_mode",
    "type": "ui_text",
    "z": "f1180e03d0981a44",
    "group": "e06592d12e8c6fde",
    "order": 6,
    "width": 4,
    "height": 1,
    "name": "Mode",
    "label": "Modus",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": "",
    "color": "#000000",
    "x": 1770,
    "y": 1920,
    "wires": []
  },
  {
    "id": "ui_txt_status",
    "type": "ui_text",
    "z": "f1180e03d0981a44",
    "group": "e06592d12e8c6fde",
    "order": 7,
    "width": 4,
    "height": 1,
    "name": "Status",
    "label": "Status",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": "",
    "color": "#000000",
    "x": 1770,
    "y": 1960,
    "wires": []
  },
  {
    "id": "ui_led_status",
    "type": "ui_led",
    "z": "f1180e03d0981a44",
    "order": 2,
    "group": "e06592d12e8c6fde",
    "width": "5",
    "height": 1,
    "label": "Gesamt",
    "labelPlacement": "left",
    "labelAlignment": "center",
    "colorForValue": [
      {
        "color": "#ff0000",
        "value": "false",
        "valueType": "bool"
      },
      {
        "color": "#008000",
        "value": "true",
        "valueType": "bool"
      }
    ],
    "allowColorForValueInMessage": false,
    "shape": "circle",
    "showGlow": true,
    "name": "LED Status",
    "x": 830,
    "y": 2100,
    "wires": []
  },
  {
    "id": "ui_led_chg",
    "type": "ui_led",
    "z": "f1180e03d0981a44",
    "order": 4,
    "group": "e06592d12e8c6fde",
    "width": 2,
    "height": 1,
    "label": "Charge allowed",
    "colorForValue": [
      {
        "color": "#ff0000",
        "value": "false",
        "valueType": "bool"
      },
      {
        "color": "#008000",
        "value": "true",
        "valueType": "bool"
      }
    ],
    "allowColorForValueInMessage": false,
    "shape": "circle",
    "showGlow": true,
    "name": "LED Charge",
    "x": 990,
    "y": 2100,
    "wires": []
  },
  {
    "id": "ui_led_dis",
    "type": "ui_led",
    "z": "f1180e03d0981a44",
    "order": 3,
    "group": "e06592d12e8c6fde",
    "width": 2,
    "height": 1,
    "label": "Discharge allowed",
    "colorForValue": [
      {
        "color": "#ff0000",
        "value": "false",
        "valueType": "bool"
      },
      {
        "color": "#008000",
        "value": "true",
        "valueType": "bool"
      }
    ],
    "allowColorForValueInMessage": false,
    "shape": "circle",
    "showGlow": true,
    "name": "LED Disch",
    "x": 1150,
    "y": 2100,
    "wires": []
  },
  {
    "id": "ui_txt_mfr",
    "type": "ui_text",
    "z": "f1180e03d0981a44",
    "group": "e06592d12e8c6fde",
    "order": 1,
    "width": 4,
    "height": 1,
    "name": "Manufacturer",
    "label": "Hersteller",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": "",
    "color": "#000000",
    "x": 830,
    "y": 2220,
    "wires": []
  },
  {
    "id": "ui_txt_limits",
    "type": "ui_text",
    "z": "f1180e03d0981a44",
    "group": "e06592d12e8c6fde",
    "order": 5,
    "width": 12,
    "height": 1,
    "name": "Limits",
    "label": "Limits",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": "",
    "color": "#000000",
    "x": 810,
    "y": 2260,
    "wires": []
  },
  {
    "id": "ui_txt_cmin",
    "type": "ui_text",
    "z": "f1180e03d0981a44",
    "group": "e06592d12e8c6fde",
    "order": 14,
    "width": 4,
    "height": 1,
    "name": "Cell min",
    "label": "Zelle min",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": "",
    "color": "#000000",
    "x": 820,
    "y": 2140,
    "wires": []
  },
  {
    "id": "ui_txt_cmax",
    "type": "ui_text",
    "z": "f1180e03d0981a44",
    "group": "e06592d12e8c6fde",
    "order": 13,
    "width": 4,
    "height": 1,
    "name": "Cell max",
    "label": "Zelle max",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": "",
    "color": "#000000",
    "x": 960,
    "y": 2140,
    "wires": []
  },
  {
    "id": "ui_g_cdelta",
    "type": "ui_gauge",
    "z": "f1180e03d0981a44",
    "name": "\u0394Zelle (mV)",
    "group": "e06592d12e8c6fde",
    "order": 15,
    "width": 4,
    "height": 3,
    "gtype": "gage",
    "title": "\u0394 mV",
    "label": "mV",
    "format": "{{value}}",
    "min": 0,
    "max": 200,
    "colors": [
      "#43a047",
      "#fdd835",
      "#e53935"
    ],
    "seg1": 30,
    "seg2": 100,
    "diff": false,
    "className": "",
    "x": 1110,
    "y": 2140,
    "wires": []
  },
  {
    "id": "ui_chart_soc",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "name": "SoC Verlauf",
    "group": "0f560273f6120429",
    "order": 3,
    "width": 6,
    "height": 4,
    "label": "SoC %",
    "chartType": "line",
    "legend": "false",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "0",
    "ymax": "100",
    "removeOlder": "6",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": 0,
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#1de9b6",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 830,
    "y": 2180,
    "wires": [
      []
    ]
  },
  {
    "id": "ui_chart_ui",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "name": "U / I Verlauf",
    "group": "0f560273f6120429",
    "order": 2,
    "width": 6,
    "height": 4,
    "label": "U (V) / I (A)",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "auto",
    "ymax": "auto",
    "removeOlder": "6",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": "",
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#42a5f5",
      "#ef6c00",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000"
    ],
    "outputs": 1,
    "useDifferentColor": true,
    "className": "",
    "x": 990,
    "y": 2180,
    "wires": [
      []
    ]
  },
  {
    "id": "ui_chart_power",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "name": "Power Verlauf",
    "group": "0f560273f6120429",
    "order": 5,
    "width": "0",
    "height": "0",
    "label": "Leistung (W)",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "auto",
    "ymax": "auto",
    "removeOlder": "6",
    "removeOlderPoints": "",
    "removeOlderUnit": "60",
    "cutout": "",
    "useOneColor": true,
    "useUTC": false,
    "colors": [
      "#9ccc65",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 1160,
    "y": 2180,
    "wires": [
      []
    ]
  },
  {
    "id": "ui_chart_temp",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "name": "Temp Verlauf",
    "group": "0f560273f6120429",
    "order": 4,
    "width": 6,
    "height": 4,
    "label": "Temp (Pack/Max/Min)",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "auto",
    "ymax": "auto",
    "removeOlder": "6",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": "",
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#66bb6a",
      "#ef5350",
      "#42a5f5",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000"
    ],
    "outputs": 1,
    "useDifferentColor": true,
    "className": "",
    "x": 1330,
    "y": 2180,
    "wires": [
      []
    ]
  },
  {
    "id": "ui_chart_cdelta",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "name": "\u0394 mV Verlauf",
    "group": "0f560273f6120429",
    "order": 6,
    "width": 6,
    "height": 4,
    "label": "Zell \u0394 (mV)",
    "chartType": "line",
    "legend": "false",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "0",
    "ymax": "200",
    "removeOlder": "6",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": "",
    "useOneColor": true,
    "useUTC": false,
    "colors": [
      "#ab47bc",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 1490,
    "y": 2180,
    "wires": [
      []
    ]
  },
  {
    "id": "lbl_warn",
    "type": "ui_text",
    "z": "f1180e03d0981a44",
    "group": "e06592d12e8c6fde",
    "order": 17,
    "width": 12,
    "height": 1,
    "name": "Warn/Err label",
    "label": "Warnungen/Fehler",
    "format": "",
    "layout": "row-spread",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": "",
    "color": "#000000",
    "x": 510,
    "y": 2140,
    "wires": []
  },
  {
    "id": "ui_warntext",
    "type": "ui_text",
    "z": "f1180e03d0981a44",
    "group": "e06592d12e8c6fde",
    "order": 18,
    "width": 12,
    "height": 1,
    "name": "Warn/Err Text",
    "label": "",
    "format": "{{(msg.payload.error||msg.payload.warning||'').toString()}}",
    "layout": "row-spread",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": "",
    "color": "#000000",
    "x": 510,
    "y": 2080,
    "wires": []
  },
  {
    "id": "ui_table_raw",
    "type": "ui_table",
    "z": "f1180e03d0981a44",
    "group": "2f52a9418389a41c",
    "name": "CAN Frames",
    "order": 1,
    "width": 12,
    "height": 8,
    "columns": [
      {
        "field": "time",
        "title": "Zeit",
        "width": "20%"
      },
      {
        "field": "id",
        "title": "ID",
        "width": "15%"
      },
      {
        "field": "dlc",
        "title": "DLC",
        "width": "10%"
      },
      {
        "field": "data",
        "title": "HEX",
        "width": "55%"
      }
    ],
    "outputs": 0,
    "cts": false,
    "x": 870,
    "y": 2520,
    "wires": []
  },
  {
    "id": "btn_clear_raw",
    "type": "ui_button",
    "z": "f1180e03d0981a44",
    "name": "Clear Raw",
    "group": "2f52a9418389a41c",
    "order": 2,
    "width": 2,
    "height": 1,
    "passthru": false,
    "label": "Clear",
    "tooltip": "Raw-Tabelle leeren",
    "color": "",
    "bgcolor": "",
    "icon": "fa-trash",
    "payload": "clear",
    "payloadType": "str",
    "topic": "",
    "x": 330,
    "y": 2560,
    "wires": [
      [
        "fn_rawbuf"
      ]
    ]
  },
  {
    "id": "delay_raw",
    "type": "delay",
    "z": "f1180e03d0981a44",
    "name": "Rate limit 10/s",
    "pauseType": "rate",
    "timeout": "5",
    "timeoutUnits": "seconds",
    "rate": "10",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": true,
    "outputs": 1,
    "x": 480,
    "y": 2520,
    "wires": [
      [
        "fn_rawbuf"
      ]
    ]
  },
  {
    "id": "fn_rawbuf",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "Raw Buffer (\u2264200)",
    "func": "// Unterst\u00fctzt Parser Out2 (payload={timestamp, can_id, dlc, data_hex,...})\n// oder SocketCAN direkt (payload={id,data,dlc,timestamp})\nlet buf = flow.get('raw_buf') || [];\nif (msg.payload === 'clear'){ buf = []; flow.set('raw_buf', buf); return [{payload: buf}]; }\nconst p = msg.payload || {};\nlet t, id, dlc, datahex;\nif (p.can_id){ id = p.can_id; dlc = p.dlc; datahex = p.data_hex; t = p.timestamp; }\nelse if (p.id!=null && p.data!=null){ id = '0x'+(typeof p.id==='number'? p.id.toString(16): p.id); dlc = p.dlc ?? (Buffer.isBuffer(p.data)? p.data.length : (Array.isArray(p.data)? p.data.length : String(p.data).length/2)); datahex = Buffer.isBuffer(p.data)? p.data.toString('hex').toUpperCase() : (Array.isArray(p.data)? Buffer.from(p.data).toString('hex').toUpperCase() : String(p.data).toUpperCase()); t = p.timestamp; }\nelse { return null; }\nconst time = t ? (new Date(t).toLocaleTimeString('de-DE', {hour12:false})) : (new Date().toLocaleTimeString('de-DE',{hour12:false}));\nbuf.push({ time, id, dlc, data: datahex });\nif (buf.length>200) buf.shift();\nflow.set('raw_buf', buf);\nreturn [{ payload: buf }];",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "libs": [],
    "x": 630,
    "y": 2520,
    "wires": [
      [
        "ui_table_raw"
      ]
    ]
  },
  {
    "id": "b16d72aab231b212",
    "type": "ui_chart",
    "z": "f1180e03d0981a44",
    "name": "",
    "group": "0f560273f6120429",
    "order": 1,
    "width": 0,
    "height": 0,
    "label": "chart",
    "chartType": "line",
    "legend": "false",
    "xformat": "auto",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "",
    "ymax": "",
    "removeOlder": 1,
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": 0,
    "useOneColor": false,
    "useUTC": true,
    "colors": [
      "#1f77b4",
      "#aec7e8",
      "#ff7f0e",
      "#2ca02c",
      "#98df8a",
      "#d62728",
      "#ff9896",
      "#9467bd",
      "#c5b0d5"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 1170,
    "y": 2220,
    "wires": [
      []
    ]
  },
  {
    "id": "db9907582ae9d30d",
    "type": "debug",
    "z": "f1180e03d0981a44",
    "name": "debug 23",
    "active": true,
    "tosidebar": true,
    "console": true,
    "tostatus": true,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "payload",
    "statusType": "auto",
    "x": 2370,
    "y": 440,
    "wires": []
  },
  {
    "id": "8b83d96e53bcea1e",
    "type": "link out",
    "z": "f1180e03d0981a44",
    "name": "link out 3 -RS485-1",
    "mode": "link",
    "links": [
      "66e1934504a3cc37"
    ],
    "x": 2315,
    "y": 380,
    "wires": []
  },
  {
    "id": "08349c8549bc7f16",
    "type": "link in",
    "z": "f1180e03d0981a44",
    "name": "link in 3",
    "links": [
      "5cb9ca8a3a09bc35"
    ],
    "x": 2095,
    "y": 100,
    "wires": [
      [
        "2b23f0ce4c2d4e46"
      ]
    ]
  },
  {
    "id": "inject_once_defaults",
    "type": "inject",
    "z": "tab_deye_bms",
    "name": "Init Defaults",
    "props": [
      {
        "p": "payload"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": true,
    "onceDelay": 0.5,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 150,
    "y": 80,
    "wires": [
      [
        "fn_init_defaults"
      ]
    ]
  },
  {
    "id": "fn_init_defaults",
    "type": "function",
    "z": "tab_deye_bms",
    "name": "Defaults -> flow.config",
    "func": "const DEF = {\n  enableTX: false,\n  dryRun: false,\n  mode: 'AUTO',              // AUTO | MANUAL\n  charge_v: 54.8,           // V\n  charge_a: 50.0,           // A\n  discharge_a: 80.0,        // A\n  ramp_a_per_s: 20.0,       // A pro Sekunde\n  watchdog_s: 5,\n  // SOC Derating\n  soc_low_start: 20,  soc_low_stop: 10,\n  soc_high_start: 95, soc_high_stop: 99,\n  // Temperatur-Derating (\u00b0C)\n  tchg_start: 35, tchg_stop: 45,    // Charge reduziert bei >35\u21920 bei 45\n  tdis_start: 45, tdis_stop: 55,    // Discharge reduziert bei >45\u21920 bei 55\n};\n// Nur setzen, wenn noch nichts da ist\nlet cfg = flow.get('deye_cfg');\nif (!cfg) {\n  flow.set('deye_cfg', DEF);\n}\nnode.status({fill:'grey',shape:'ring',text:'Defaults geladen'});\nreturn null;",
    "outputs": 0,
    "noerr": 0,
    "initialize": "",
    "libs": [],
    "x": 370,
    "y": 80,
    "wires": []
  },
  {
    "id": "ui_form_settings",
    "type": "ui_form",
    "z": "tab_deye_bms",
    "name": "BMS Settings",
    "label": "Konfiguration",
    "group": "ui_grp_controls",
    "order": 1,
    "width": 0,
    "height": 0,
    "options": [
      {
        "label": "TX aktiv",
        "value": "enableTX",
        "type": "switch",
        "required": false
      },
      {
        "label": "Dry-Run (kein CAN)",
        "value": "dryRun",
        "type": "switch",
        "required": false
      },
      {
        "label": "Modus",
        "value": "mode",
        "type": "select",
        "options": [
          {
            "label": "AUTO",
            "value": "AUTO"
          },
          {
            "label": "MANUAL",
            "value": "MANUAL"
          }
        ],
        "required": true
      },
      {
        "label": "Ladespannung (V)",
        "value": "charge_v",
        "type": "number",
        "required": true
      },
      {
        "label": "I-Charge (A)",
        "value": "charge_a",
        "type": "number",
        "required": true
      },
      {
        "label": "I-Discharge (A)",
        "value": "discharge_a",
        "type": "number",
        "required": true
      },
      {
        "label": "Rampe A/s",
        "value": "ramp_a_per_s",
        "type": "number",
        "required": true
      },
      {
        "label": "Watchdog (s)",
        "value": "watchdog_s",
        "type": "number",
        "required": true
      },
      {
        "label": "SOC low start %",
        "value": "soc_low_start",
        "type": "number",
        "required": true
      },
      {
        "label": "SOC low stop %",
        "value": "soc_low_stop",
        "type": "number",
        "required": true
      },
      {
        "label": "SOC high start %",
        "value": "soc_high_start",
        "type": "number",
        "required": true
      },
      {
        "label": "SOC high stop %",
        "value": "soc_high_stop",
        "type": "number",
        "required": true
      },
      {
        "label": "Tchg Derate start \u00b0C",
        "value": "tchg_start",
        "type": "number",
        "required": true
      },
      {
        "label": "Tchg Derate stop \u00b0C",
        "value": "tchg_stop",
        "type": "number",
        "required": true
      },
      {
        "label": "Tdis Derate start \u00b0C",
        "value": "tdis_start",
        "type": "number",
        "required": true
      },
      {
        "label": "Tdis Derate stop \u00b0C",
        "value": "tdis_stop",
        "type": "number",
        "required": true
      }
    ],
    "formValue": {
      "enableTX": false,
      "dryRun": false,
      "mode": "AUTO",
      "charge_v": 54.8,
      "charge_a": 50,
      "discharge_a": 80,
      "ramp_a_per_s": 20,
      "watchdog_s": 5,
      "soc_low_start": 20,
      "soc_low_stop": 10,
      "soc_high_start": 95,
      "soc_high_stop": 99,
      "tchg_start": 35,
      "tchg_stop": 45,
      "tdis_start": 45,
      "tdis_stop": 55
    },
    "payload": "{}",
    "submit": "Update",
    "cancel": "Abbrechen",
    "topic": "",
    "x": 180,
    "y": 160,
    "wires": [
      [
        "fn_update_cfg"
      ]
    ]
  },
  {
    "id": "fn_update_cfg",
    "type": "function",
    "z": "tab_deye_bms",
    "name": "flow.deye_cfg aktualisieren",
    "func": "const current = flow.get('deye_cfg') || {};\nconst upd = msg.payload || {};\nconst merged = Object.assign({}, current, upd);\n// Plausibilit\u00e4tsklemmen\nfunction clamp(n,lo,hi){ return Math.max(lo, Math.min(hi, n)); }\nmerged.charge_v = clamp(+merged.charge_v||0, 48.0, 57.6);\nmerged.charge_a = clamp(+merged.charge_a||0, 0,   400);\nmerged.discharge_a = clamp(+merged.discharge_a||0, 0, 400);\nmerged.ramp_a_per_s = clamp(+merged.ramp_a_per_s||0, 0, 500);\nmerged.watchdog_s = clamp(+merged.watchdog_s||0, 1, 60);\n['soc_low_start','soc_low_stop','soc_high_start','soc_high_stop','tchg_start','tchg_stop','tdis_start','tdis_stop'].forEach(k=>{ merged[k]=+merged[k]; });\nflow.set('deye_cfg', merged);\nnode.status({fill: merged.enableTX? 'green':'grey', shape: merged.enableTX? 'dot':'ring', text: `TX ${merged.enableTX? 'AN':'AUS'} / ${merged.mode}`});\nreturn null;",
    "outputs": 0,
    "noerr": 0,
    "initialize": "",
    "libs": [],
    "x": 440,
    "y": 160,
    "wires": []
  },
  {
    "id": "link_in_agg",
    "type": "link in",
    "z": "tab_deye_bms",
    "name": "AGGREGATE_IN (von RS485/Parser)",
    "links": [],
    "x": 170,
    "y": 260,
    "wires": [
      [
        "fn_set_agg"
      ]
    ]
  },
  {
    "id": "fn_set_agg",
    "type": "function",
    "z": "tab_deye_bms",
    "name": "flow.agg setzen (Normalisieren)",
    "func": "// Erwartet msg.payload mit Feldern wie in deinem Aggregat\n// akzeptiert auch msg.payload.data (Snapshot)\nconst p = (msg.payload && (msg.payload.data||msg.payload)) || {};\n// minimale Normalisierung\nconst agg = {\n  ts: p.ts || Date.now(),\n  soc: p.soc, soh: p.soh,\n  voltage: p.voltage, current: p.current, temp: p.temp,\n  temp_min: p.temp_min, temp_max: p.temp_max,\n  charge_voltage: p.charge_voltage,\n  max_charge_a: p.max_charge_a,\n  max_discharge_a: p.max_discharge_a,\n  cell_min_mv: p.cell_min_mv, cell_max_mv: p.cell_max_mv,\n  alarms: p.alarms || [], manufacturer: p.manufacturer || 'PYLON'\n};\nflow.set('agg', agg);\nreturn null;",
    "outputs": 0,
    "noerr": 0,
    "initialize": "",
    "libs": [],
    "x": 440,
    "y": 260,
    "wires": []
  },
  {
    "id": "inject_tick",
    "type": "inject",
    "z": "tab_deye_bms",
    "name": "Tick 1s",
    "props": [
      {
        "p": "payload"
      }
    ],
    "repeat": "1",
    "once": true,
    "onceDelay": 1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 140,
    "y": 360,
    "wires": [
      [
        "fn_compute_build"
      ]
    ]
  },
  {
    "id": "fn_compute_build",
    "type": "function",
    "z": "tab_deye_bms",
    "name": "Compute & Build Pylon Frames",
    "func": "function u16le(v){ const b=Buffer.alloc(2); b.writeUInt16LE(v); return b;}\nfunction i16le(v){ const b=Buffer.alloc(2); b.writeInt16LE(v); return b;}\nfunction padAscii(s,len){ const b=Buffer.alloc(len,0x20); b.write((s||'').toString().slice(0,len)); return b;}\nfunction clamp(n,lo,hi){ return Math.max(lo, Math.min(hi, n)); }\n\nconst cfg = flow.get('deye_cfg') || {};\nconst agg = flow.get('agg') || {};\nconst now = Date.now();\nconst age = now - (agg.ts||0);\n\n// Watchdog\nconst wdTrip = age > (1000*(cfg.watchdog_s||5));\n\n// Basiswerte\nconst soc   = Math.round(clamp(+agg.soc||0, 0,100));\nconst soh   = Math.round(clamp(+agg.soh||100,0,100));\nconst volt  = Math.round((+agg.voltage||0)*100); // 0.01V\nconst curr  = Math.round((+agg.current||0)*10);  // 0.1A\nconst tpack = Math.round((+agg.temp??25)*10);    // 0.1\u00b0C\nconst tmax  = Math.round((agg.temp_max ?? agg.temp ?? 25)*10);\nconst tmin  = Math.round((agg.temp_min ?? agg.temp ?? 25)*10);\nconst cmin  = Math.round(agg.cell_min_mv ?? 0);\nconst cmax  = Math.round(agg.cell_max_mv ?? 0);\n\n// Setpoints (Auto/Manual)\nlet v_charge = Math.round(((cfg.mode==='MANUAL'? cfg.charge_v : (agg.charge_voltage ?? cfg.charge_v ?? 54.8)))*10);\nlet i_chg    = Math.round(((cfg.mode==='MANUAL'? cfg.charge_a : (agg.max_charge_a   ?? cfg.charge_a ?? 50.0)))*10);\nlet i_dis    = Math.round(((cfg.mode==='MANUAL'? cfg.discharge_a : (agg.max_discharge_a?? cfg.discharge_a ?? 80.0)))*10);\n\n// Derating \u2013 Temperatur\nfunction derate_lin(val, t, t1, t2){ if (t<=t1) return val; if (t>=t2) return 0; return Math.round(val * (1 - (t - t1)/(t2 - t1))); }\ni_chg = derate_lin(i_chg, (tmax/10), cfg.tchg_start||35, cfg.tchg_stop||45);\ni_dis = derate_lin(i_dis, (tmax/10), cfg.tdis_start||45, cfg.tdis_stop||55);\n\n// Derating \u2013 SOC\nfunction derate_soc(val, s, s1, s0, high){\n  // high=true: reduziere bei s>s1 linear auf 0 bei s0 (s0>s1)\n  // high=false: reduziere bei s<s1 linear auf 0 bei s0 (s0<s1)\n  if (high){ if (s<=s1) return val; if (s>=s0) return 0; return Math.round(val * (1 - (s - s1)/(s0 - s1))); }\n  else { if (s>=s1) return val; if (s<=s0) return 0; return Math.round(val * (s - s0)/(s1 - s0)); }\n}\ni_chg = derate_soc(i_chg, soc, cfg.soc_high_start||95, cfg.soc_high_stop||99, true);\ni_dis = derate_soc(i_dis, soc, cfg.soc_low_start||20,  cfg.soc_low_stop||10,  false);\n\n// Alarme \u2192 Limits 0\nif ((agg.alarms||[]).length) { i_chg = 0; i_dis = 0; }\n// Watchdog \u2192 0\nif (wdTrip) { i_chg = 0; i_dis = 0; }\n\n// Rampen\nconst last = context.get('last_limits') || { i_chg:0, i_dis:0, ts:now };\nconst dt = Math.max(0.5, (now - last.ts)/1000);\nconst step = (cfg.ramp_a_per_s||20)*10*dt; // in 0.1A\nfunction ramp(to, from){ if (to>from) return Math.min(to, Math.round(from+step)); else return Math.max(to, Math.round(from-step)); }\nconst i_chg_r = ramp(i_chg, last.i_chg||0);\nconst i_dis_r = ramp(i_dis, last.i_dis||0);\ncontext.set('last_limits', { i_chg:i_chg_r, i_dis:i_dis_r, ts:now });\n\n// Frames bauen\nconst frames = [];\n// 0x351 \u2013 ChargeVoltage & Limits\nframes.push({ id:0x351, ext:false, rtr:false, data: Buffer.concat([ u16le(v_charge), i16le(i_chg_r), i16le(i_dis_r), Buffer.alloc(2) ]) });\n// 0x355 \u2013 SoC/SoH\nframes.push({ id:0x355, ext:false, rtr:false, data: Buffer.concat([ u16le(soc), u16le(soh), Buffer.alloc(4) ]) });\n// 0x356 \u2013 Pack V/I/T\nframes.push({ id:0x356, ext:false, rtr:false, data: Buffer.concat([ i16le(volt), i16le(curr), i16le(tpack) ]) });\n// 0x35C \u2013 Flags (Bit7=Charge enable, Bit6=Discharge enable konservativ)\nlet b0 = 0x00; if (i_chg_r>0) b0|=0x80; if (i_dis_r>0) b0|=0x40;\nframes.push({ id:0x35C, ext:false, rtr:false, data: Buffer.from([b0,0,0,0,0,0,0,0]) });\n// 0x359 \u2013 Alarme (nur erste 2 Bytes)\nlet a0=0, a1=0; const A = agg.alarms||[];\nif (A.includes('Cell Overvoltage')) a0|=0x01;\nif (A.includes('Cell Undervoltage')) a0|=0x02;\nif (A.includes('Over Temperature'))  a0|=0x04;\nif (A.includes('Under Temperature'))  a0|=0x08;\nif (A.includes('Over Current Discharge')) a0|=0x10;\nif (A.includes('Over Current Charge'))    a0|=0x20;\nframes.push({ id:0x359, ext:false, rtr:false, data: Buffer.from([a0,a1,0,0,0,0,0,0]) });\n// 0x35E \u2013 Hersteller\nframes.push({ id:0x35E, ext:false, rtr:false, data: padAscii(agg.manufacturer||'PYLON',8) });\n// 0x370 \u2013 Temp max/min + Cell max/min mV\nframes.push({ id:0x370, ext:false, rtr:false, data: Buffer.concat([ u16le(tmax), u16le(tmin), u16le(cmax), u16le(cmin) ]) });\n\n// Enable & DryRun pr\u00fcfen\nconst enable = !!cfg.enableTX;\nconst dry    = !!cfg.dryRun;\nconst info = { enable, dry, age_ms: age, watchdog_trip: wdTrip, soc, soh,\n  v: (volt/100), i: (curr/10), t: (tpack/10),\n  set: { v_charge:(v_charge/10), i_charge:(i_chg_r/10), i_discharge:(i_dis_r/10) }\n};\n\n// Outputs: 1) Status+Frames (Array)  2) Debug text  3) Warn/Err\nif (!enable){\n  return [{ topic:'deye/status', payload: { info, frames: [] } }, null, null];\n}\nif (dry){\n  return [{ topic:'deye/status', payload: { info, frames } }, { payload: 'DRY-RUN: '+frames.length+' Frames gebaut' }, null];\n}\n// Senden: wir geben Frames-Array raus \u2013 nachfolgender Split zerlegt\nreturn [{ topic:'deye/status', payload: { info, frames } }, null, null];",
    "outputs": 3,
    "noerr": 0,
    "initialize": "",
    "libs": [],
    "x": 420,
    "y": 360,
    "wires": [
      [
        "split_frames",
        "ui_status"
      ],
      [
        "debug_dry"
      ],
      [
        "debug_err"
      ]
    ]
  },
  {
    "id": "split_frames",
    "type": "split",
    "z": "tab_deye_bms",
    "name": "Frames splitten",
    "splt": 1,
    "spltType": "len",
    "arraySplt": 1,
    "stream": false,
    "addname": "",
    "x": 740,
    "y": 360,
    "wires": [
      [
        "change_to_payload",
        "debug_frames",
        "link_out_can"
      ]
    ]
  },
  {
    "id": "change_to_payload",
    "type": "change",
    "z": "tab_deye_bms",
    "name": "msg.payload = frame",
    "rules": [
      {
        "t": "move",
        "p": "payload",
        "pt": "msg",
        "to": "payload",
        "tot": "json"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1000,
    "y": 380,
    "wires": [
      [
        "link_out_can"
      ]
    ],
    "d": true
  },
  {
    "id": "link_out_can",
    "type": "link out",
    "z": "tab_deye_bms",
    "name": "CAN_TX_OUT -> verbinde zu SocketCAN Send",
    "mode": "link",
    "links": [],
    "x": 1180,
    "y": 300,
    "wires": []
  },
  {
    "id": "debug_frames",
    "type": "debug",
    "z": "tab_deye_bms",
    "name": "CAN Frames (Debug)",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "x": 1000,
    "y": 420,
    "wires": []
  },
  {
    "id": "debug_dry",
    "type": "debug",
    "z": "tab_deye_bms",
    "name": "Dry-Run Info",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "x": 730,
    "y": 400,
    "wires": []
  },
  {
    "id": "debug_err",
    "type": "debug",
    "z": "tab_deye_bms",
    "name": "Warn/Err",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "x": 720,
    "y": 440,
    "wires": []
  },
  {
    "id": "ui_status",
    "type": "function",
    "z": "tab_deye_bms",
    "name": "To Dashboard Status",
    "func": "const info = (msg.payload&&msg.payload.info)||{};\nconst lines = [\n  `TX: ${info.enable? 'AN':'AUS'}${info.dry? ' (DRY)':''}`,\n  `SOC: ${info.soc??'--'}%  SOH: ${info.soh??'--'}%`,\n  `U/I/T: ${(info.v??0).toFixed? info.v.toFixed(2): info.v} V  ${(info.i??0).toFixed? info.i.toFixed(1): info.i} A  ${(info.t??0).toFixed? info.t.toFixed(1): info.t} \u00b0C`,\n  `Set: ${info.set? info.set.v_charge.toFixed(1):'--'} V, ${(info.set? info.set.i_charge.toFixed(1):'--')} A / ${(info.set? info.set.i_discharge.toFixed(1):'--')} A`,\n  `Age: ${info.age_ms} ms  WD: ${info.watchdog_trip?'TRIP':'OK'}`\n];\nreturn {payload: lines.join(' | ')};",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "libs": [],
    "x": 740,
    "y": 300,
    "wires": [
      [
        "ui_text_status"
      ]
    ]
  },
  {
    "id": "ui_text_status",
    "type": "ui_text",
    "z": "tab_deye_bms",
    "group": "ui_grp_status",
    "order": 1,
    "width": 12,
    "height": 1,
    "name": "Statuszeile",
    "label": "",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 990,
    "y": 300,
    "wires": []
  },
  {
    "id": "inj-tick",
    "type": "inject",
    "z": "tab-rs485-poller",
    "name": "Tick 60s",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "60",
    "crontab": "",
    "once": true,
    "onceDelay": "1",
    "topic": "poll",
    "payload": "tick",
    "payloadType": "str",
    "x": 130,
    "y": 80,
    "wires": [
      [
        "fn-scheduler"
      ]
    ]
  },
  {
    "id": "fn-scheduler",
    "type": "function",
    "z": "tab-rs485-poller",
    "name": "Poll Scheduler (ADDRS & Services)",
    "func": "// === CONFIG ===\nconst CFG = flow.get('RS485_POLL_CFG_DEYE') || {\n  PROTOCOL: 'PYLON_V3',\n  PORT: '/dev/ttyUSB0',\n  GROUP: 0,\n  ADDRS: [0x01,0x03],\n  INJECT_INTERVAL: \"60\",\n  CYCLE_42: 1,\n  CYCLE_44: 5,\n  CYCLE_47: 2,\n  CYCLE_51: 2,\n  CYCLE_83: 4,\n  CYCLE_B03: 6,\n  CYCLE_B04: 8\n};\nflow.set('RS485_POLL_CFG_DEYE', CFG);\n\nconst busy = flow.get('RS485_BUSY') || false;\nconst lastSentAt = flow.get('RS485_LAST_SENT') || 0;\nconst now = Date.now();\n// If we are stuck in BUSY for too long, force-unblock (lost response / cable issue).\nif (busy) {\n  const age = now - lastSentAt;\n  if (age < 400) return null;\n  if (age > 2500) { flow.set('RS485_BUSY', false); }\n}\n\n\nconst topic = (msg.topic || '').toString();\nconst payloadCmd = (typeof msg.payload === 'string') ? msg.payload.toLowerCase() : '';\nconst fastMode = flow.get('RS485_DEBUG_FAST') === true;\n// Optional: force an address for force42 injects (payload can be '01', '03', etc).\nlet forcedAddr = null;\ntry {\n  if ((topic === 'force42' || topic === 'poll_now') && typeof msg.payload === 'string') {\n    const s = msg.payload.trim().toUpperCase().replace(/[^0-9A-F]/g,'');\n    if (s.length>=1 && s.length<=2) forcedAddr = parseInt(s,16) & 0xFF;\n  }\n} catch(e) {}\n\n\nlet state = flow.get('RS485_POLLSTATE') || { tick: 0, svcIdx: {} };\nlet svc;\nlet b0mod = null;\n\nif (topic === 'fast_tick' || payloadCmd === 'fast_tick') {\n  if (!fastMode) return null;\n  svc = 0x42;\n} else if (topic === 'force42' || topic === 'poll_now' || payloadCmd === 'poll_now') {\n  svc = 0x42;\n} else if (topic === 'force47' || topic === 'limits_now' || payloadCmd === 'limits_now') {\n  svc = 0x47;\n} else if (topic === 'force51' || payloadCmd === 'id_now') {\n  svc = 0x51;\n} else if (topic === 'force83' || payloadCmd === 'diag_now') {\n  svc = 0x83;\n} else if (topic === 'forceb03' || payloadCmd === 'b0m3_now') {\n  svc = 0xB0; b0mod = 0x03;\n} else if (topic === 'forceb04' || payloadCmd === 'b0m4_now') {\n  svc = 0xB0; b0mod = 0x04;\n} else {\n  state.tick++;\n  svc = 0x42;\n  if (state.tick % CFG.CYCLE_44 === 0) svc = 0x44;\n  if (state.tick % CFG.CYCLE_47 === 0) svc = 0x47;\n  if (state.tick % CFG.CYCLE_51 === 0) svc = 0x51;\n  if (state.tick % CFG.CYCLE_83 === 0) svc = 0x83;\n  if (state.tick % CFG.CYCLE_B03 === 0) { svc = 0xB0; b0mod = 0x03; }\n  if (state.tick % CFG.CYCLE_B04 === 0) { svc = 0xB0; b0mod = 0x04; }\n}\n\nconst key = String(svc) + (b0mod!=null?('_'+b0mod):'');\nlet a = null;\nif (forcedAddr != null) {\n  a = forcedAddr;\n} else {\n  if (state.svcIdx[key] == null) state.svcIdx[key] = 0;\n  const idx = state.svcIdx[key] % CFG.ADDRS.length;\n  state.svcIdx[key] = (state.svcIdx[key] + 1) % CFG.ADDRS.length;\n  a = CFG.ADDRS[idx];\n}\nconst adr = (CFG.GROUP ? (a + (CFG.GROUP<<4)) : a) & 0xFF;\n\nmsg._req = { adr, svc, b0mod, ts: now, proto: CFG.PROTOCOL };\nmsg.addr = adr.toString(16).toUpperCase().padStart(2,'0');\nmsg.service = svc;\nmsg.b0mod = b0mod;\nmsg.command = (svc===0x42 || svc===0x44) ? adr : null;\nif (svc===0x83 || svc===0xB0) node.warn(\"[SCHED] svc=\"+svc.toString(16).toUpperCase()+\" adr=\"+msg.addr+(b0mod!=null?\" mod=\"+b0mod:\"\"));\n\nflow.set('RS485_POLLSTATE', state);\nflow.set('RS485_LAST_REQ', msg._req);\nflow.set('RS485_BUSY', true);\nflow.set('RS485_LAST_SENT', now);\nreturn msg;",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 420,
    "y": 80,
    "wires": [
      [
        "fn-buildframe"
      ]
    ]
  },
  {
    "id": "fn-buildframe",
    "type": "function",
    "z": "tab-rs485-poller",
    "name": "Build RS485 Frame (4A/42|44|47|51)",
    "func": "function lchksumNibble(lenId){\n  const n0 = (lenId     ) & 0xF;\n  const n1 = (lenId >> 4) & 0xF;\n  const n2 = (lenId >> 8) & 0xF;\n  const sum = (n0 + n1 + n2) & 0xF;\n  const inv = (~sum) & 0xF;\n  return (inv + 1) & 0xF;\n}\n\nfunction toHex(n,len){ return n.toString(16).toUpperCase().padStart(len,'0'); }\nfunction asciiChecksum(s){\n  let acc=0;\n  for(let i=1;i<s.length;i++) acc += s.charCodeAt(i);\n  return (((~acc) & 0xFFFF) + 1) & 0xFFFF;\n}\n\nconst adr = (msg.addr||'01').toUpperCase().padStart(2,'0');\nconst svc = Number(msg.service||0x42) & 0xFF;\nconst cid2 = toHex(svc,2);\nlet info = '';\nlet lenId = 0;\n\nif (svc===0x42 || svc===0x44){\n  const cmd = (msg.command!=null? Number(msg.command): parseInt(adr,16)) & 0xFF;\n  info = toHex(cmd,2);\n  lenId = 2;\n} else if (svc===0x83){\n  info = adr + '01';\n  lenId = 4;\n} else if (svc===0xB0){\n  const mod = Number(msg.b0mod||0x03) & 0xFF;\n  info = adr + '01' + toHex(mod,2) + 'FF00';\n  lenId = 10;\n}\n\nconst lenWord = ((lchksumNibble(lenId)&0xF) << 12) | (lenId & 0xFFF);\nconst lenHex = toHex(lenWord,4);\nconst prefix = '~22' + adr + '4A' + cid2 + lenHex + info;\nconst crc = toHex(asciiChecksum(prefix),4);\nmsg.payload = prefix + crc + '\\r';\nmsg._svc = svc;\nreturn msg;",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 750,
    "y": 80,
    "wires": [
      [
        "5cb9ca8a3a09bc35"
      ]
    ]
  },
  {
    "id": "fn-decode",
    "type": "function",
    "z": "tab-rs485-poller",
    "name": "Decoder 0x42/0x44/0x47/0x51 (Pylon V2.8/V3.3, Basen)",
    "func": "// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n// RS485 Decoder for 0x4A 0x42/0x44/0x47/0x51  (3 outputs)\n// Out1: status   Out2: alarms (placeholder)   Out3: params/id\n// \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\nfunction asciiChecksumVerify(rx){\n  // CRC is always the last 4 hex chars; frame may or may not include trailing CR/LF\n  var s = String(rx || '').trim().toUpperCase();\n  if (s.length < 8) return { ok:false, calc:0, rxCrc:NaN };\n  var crcHex = s.slice(-4);\n  if (!/^[0-9A-F]{4}$/.test(crcHex)) return { ok:false, calc:0, rxCrc:NaN };\n  var sum = 0;\n  for (var i = 1; i < s.length - 4; i++) sum += s.charCodeAt(i);\n  var calc = ((~sum) & 0xFFFF) + 1; calc &= 0xFFFF;\n  var rxCrc = parseInt(crcHex, 16);\n  return { ok: calc === rxCrc, calc: calc, rxCrc: rxCrc };\n}\n\nfunction parseLen(rx){\n  var lenHex = rx.substr(9,4);\n  var word = parseInt(lenHex,16);\n  var lenId = word & 0x0FFF;\n  var lcs   = (word >> 12) & 0xF;\n  var n0 = (lenId) & 0xF, n1 = (lenId >> 4) & 0xF, n2 = (lenId >> 8) & 0xF;\n  var sum = (n0 + n1 + n2) & 0xF;\n  var lcsCalc = ((~sum) & 0xF) + 1; lcsCalc &= 0xF;\n  return {lenId: lenId, lcs: lcs, lcsCalc: lcsCalc, ok: lcs === lcsCalc};\n}\n\nfunction rU8(hex, p){ return parseInt(hex.substr(p,2),16) & 0xFF; }\nfunction rU16(hex,p){ return parseInt(hex.substr(p,4),16) & 0xFFFF; }\nfunction rI16(hex,p){ var v=rU16(hex,p); if (v & 0x8000) v -= 0x10000; return v; }\n\nfunction kelvin10ToC(v){ return (v - 2731) / 10; }\nfunction guessTempToC(raw){\n  // akzeptiere Kelvin*10 oder Celsius*10\n  if (raw > 1000) return kelvin10ToC(raw);\n  return raw / 10;\n}\n\nfunction decode42(dataHex, adr){\n  // Layout reference: daren-485 reverse engineering. Some devices shift fields.\n  // We score candidate base offsets and support two temperature section variants.\n  var dataFlag = rU8(dataHex, 0);\n\n  function scoreBase(pos){\n    if (pos < 0) return -9999;\n    if ((pos + 10) > dataHex.length) return -9999;\n\n    var soc = rU16(dataHex, pos) / 100;\n    var v   = rU16(dataHex, pos + 4) / 100;\n    var m   = rU8(dataHex, pos + 8);\n    if (m < 4 || m > 24) return -9999;\n\n    var p = pos + 10;\n    if ((p + m * 4) > dataHex.length) return -9999;\n\n    var s = 0;\n    if (soc >= 0 && soc <= 100) s += 3; else s -= 4;\n    if (v >= 10 && v <= 80) s += 4; else s -= 6;\n\n    var ok = 0;\n    for (var i=0;i<Math.min(m,8);i++){\n      var mv = rU16(dataHex, p + i*4);\n      if (mv >= 2000 && mv <= 4000) ok++;\n    }\n    s += ok * 2;\n    return s;\n  }\n\n  var bestPos = 2;\n  var bestScore = -9999;\n  for (var pos=0; pos<=20; pos+=2){\n    var sc = scoreBase(pos);\n    if (sc > bestScore){ bestScore = sc; bestPos = pos; }\n  }\n\n  var p = bestPos;\n  var soc = null;\n  var voltageV = 0;\n\n  if ((p+4) <= dataHex.length){ soc = rU16(dataHex, p) / 100; p += 4; }\n  if ((p+4) <= dataHex.length){ voltageV = rU16(dataHex, p) / 100; p += 4; }\n\n  var m = 0;\n  if ((p+2) <= dataHex.length){ m = rU8(dataHex, p); p += 2; }\n\n  var cells = [];\n  for (var i=0; i<m && (p+4) <= dataHex.length; i++){\n    cells.push(rU16(dataHex, p));\n    p += 4;\n  }\n\n  // Fallback: derive pack voltage from cell sum when decoded voltage is implausible.\n  if (!isFinite(voltageV) || voltageV < 10 || voltageV > 80) {\n    if (cells.length) {\n      var sumMv = 0;\n      for (i=0;i<cells.length;i++) sumMv += cells[i];\n      voltageV = +(sumMv / 1000).toFixed(2);\n    } else {\n      voltageV = 0;\n    }\n  }\n\n  var temps = [];\n  var pTempsStart = p;\n\n  function tryTempsVariantA(){\n    // A: env/pack/mos (3x int16) then count byte then N temps (int16)\n    var q = pTempsStart;\n    if ((q + 12 + 2) > dataHex.length) return null;\n\n    var t1 = rI16(dataHex, q);\n    var t2 = rI16(dataHex, q+4);\n    var t3 = rI16(dataHex, q+8);\n\n    // raw temps are typically c*10; reject if absurd to avoid false alignment.\n    if (Math.abs(t1) > 2000 || Math.abs(t2) > 2000 || Math.abs(t3) > 2000) return null;\n\n    q += 12;\n    var n = rU8(dataHex, q);\n    if (n < 0 || n > 32) return null;\n    if ((q + 2 + (n * 4)) > dataHex.length) return null;\n    q += 2;\n\n    var arr = [\n      +guessTempToC(t1).toFixed(1),\n      +guessTempToC(t2).toFixed(1),\n      +guessTempToC(t3).toFixed(1)\n    ];\n    for (var i=0;i<n;i++){\n      var tr = rI16(dataHex, q); q += 4;\n      if (Math.abs(tr) > 2000) return null;\n      arr.push(+guessTempToC(tr).toFixed(1));\n    }\n    return { pAfter: q, temps: arr, kind: 'A' };\n  }\n\n  function tryTempsVariantB(){\n    // B: count byte then N temps (int16)\n    var q = pTempsStart;\n    if ((q + 2) > dataHex.length) return null;\n    var n = rU8(dataHex, q);\n    if (n < 0 || n > 32) return null;\n    if ((q + 2 + (n * 4)) > dataHex.length) return null;\n    q += 2;\n    var arr = [];\n    for (var i=0;i<n;i++){\n      var tr = rI16(dataHex, q); q += 4;\n      if (Math.abs(tr) > 2000) return null;\n      arr.push(+guessTempToC(tr).toFixed(1));\n    }\n    return { pAfter: q, temps: arr, kind: 'B' };\n  }\n\n  var candA = tryTempsVariantA();\n  var candB = tryTempsVariantB();\n\n  function tailOk(q){\n    // after current should be: Rint(2) + SOH(2) + user(1) + full(2) + remain(2) + cycles(2)\n    return (q + 4 + 4 + 2 + 4 + 4 + 4) <= dataHex.length;\n  }\n\n  var chosen = null;\n  if (candA && candB) {\n    // Prefer the one that leaves a plausible tail and yields a plausible current magnitude.\n    var aOk = tailOk(candA.pAfter);\n    var bOk = tailOk(candB.pAfter);\n    if (aOk && !bOk) chosen = candA;\n    else if (bOk && !aOk) chosen = candB;\n    else chosen = candA; // default\n  } else {\n    chosen = candA || candB;\n  }\n\n  if (chosen) {\n    temps = chosen.temps;\n    p = chosen.pAfter;\n  }\n\n  var currentRaw = 0;\n  if ((p + 4) <= dataHex.length){ currentRaw = rI16(dataHex, p); p += 4; }\n  var currentA = currentRaw / 100;\n\n  // internal resistance (optional)\n  if ((p + 4) <= dataHex.length){ p += 4; }\n\n  var soh = null;\n  if ((p + 4) <= dataHex.length){ soh = rU16(dataHex, p); p += 4; }\n\n  // user-defined number (1 byte)\n  if ((p + 2) <= dataHex.length){ p += 2; }\n\n  var full1 = ((p + 4) <= dataHex.length) ? rU16(dataHex, p) : 0; p += ((p + 4) <= dataHex.length) ? 4 : 0;\n  var remain1 = ((p + 4) <= dataHex.length) ? rU16(dataHex, p) : 0; p += ((p + 4) <= dataHex.length) ? 4 : 0;\n  var cycles = ((p + 4) <= dataHex.length) ? rU16(dataHex, p) : 0; p += ((p + 4) <= dataHex.length) ? 4 : 0;\n\n  var cellMin = cells.length ? Math.min.apply(null, cells) : null;\n  var cellMax = cells.length ? Math.max.apply(null, cells) : null;\n  var cellDelta = (cellMin!=null && cellMax!=null) ? (cellMax - cellMin) : null;\n\n  // Glitch guard: sporadisch wird die Zellliste falsch aligned (Delta springt kurz extrem),\n  // waehrend Packspannung nahezu konstant bleibt. Dann behalten wir die letzte gueltige Zellliste.\n  var cells_glitch = false;\n  try {\n    var lastMap = flow.get('RS485_LAST_GOOD_CELLS') || {};\n    var prev = lastMap[adr];\n    if (prev && Array.isArray(prev.cells_mv) && prev.cells_mv.length === cells.length && cellDelta != null && prev.cell_delta_mv != null) {\n      var vDiff = Math.abs((+voltageV) - (+prev.voltage || 0));\n      if (cellDelta > 300 && prev.cell_delta_mv < 120 && vDiff < 0.2) {\n        cells_glitch = true;\n        cells = prev.cells_mv.slice();\n        cellMin = prev.cell_min_mv;\n        cellMax = prev.cell_max_mv;\n        cellDelta = prev.cell_delta_mv;\n      }\n    }\n    // Store last good snapshot (cap delta to avoid persisting obvious garbage)\n    if (!cells_glitch && Array.isArray(cells) && cells.length && cellDelta != null && cellDelta <= 600) {\n      lastMap[adr] = {\n        ts: Date.now(),\n        voltage: +voltageV,\n        cells_mv: cells.slice(),\n        cell_min_mv: cellMin,\n        cell_max_mv: cellMax,\n        cell_delta_mv: cellDelta\n      };\n      flow.set('RS485_LAST_GOOD_CELLS', lastMap);\n    }\n  } catch(e) {}\n\n  var remainAh = remain1 / 100;\n  var fullAh   = full1   / 100;\n  var power = +(voltageV * currentA).toFixed(2);\n  var mode  = currentA > 0.1 ? 'CHARGING' : (currentA < -0.1 ? 'DISCHARGING' : 'IDLE');\n\n  return {\n    addr: adr,\n    dataflag: dataFlag,\n    soc: soc,\n    voltage: +voltageV,\n    current: +currentA,\n    power: power,\n    mode: mode,\n    cells_mv: cells,\n    cell_min_mv: cellMin,\n    cell_max_mv: cellMax,\n    cell_delta_mv: cellDelta,\n    cells_glitch: cells_glitch,\n    temps: temps,\n    remain_capacity_ah: +remainAh.toFixed(2),\n    full_capacity_ah: +fullAh.toFixed(2),\n    cycles: cycles,\n    soh: soh\n  };\n}\n\nfunction decode47(dataHex, adr){\n  // Service 0x47 (\"Limits/Params\") \u2013 offsets verified via raw capture.\n  // dataHex is hex string of payload (without header/CRC), starts with dataflag (1 byte).\n  // Observed layout (big-endian u16 unless noted), after dataflag:\n  //  0: dataflag (u8)\n  //  1: cell_hi_mV (u16)   -> /1000 V\n  //  3: cell_lo_mV (u16)   -> /1000 V\n  //  5: t_hi (i16)         -> /10 \u00b0C\n  //  7: t_lo (i16)         -> /10 \u00b0C\n  //  9: i_chg_upper (u16)  -> /100 A (semantics unclear; keep as \"upper\")\n  // 11: cell_hi_mV2 (u16)  (repeat)\n  // 13: cell_lo_mV2 (u16)  (repeat)\n  // 15: cell_count (u16)\n  // 17: i_chg_limit (u16)  -> /100 A\n  // 19: design_capacity (u16) -> /100 Ah\n  // 21: interval_min (u16)\n  // 23: balance_mode (u16)\n  // tail: mostly 0xFF + some ASCII identifiers\n\n  function safeU16(p){ return (p+4<=dataHex.length)? rU16(dataHex,p) : null; }\n  function safeI16(p){ return (p+4<=dataHex.length)? rI16(dataHex,p) : null; }\n\n  var dataFlag = rU8(dataHex, 0);\n\n  var cell_hi_raw = safeU16(2);\n  var cell_lo_raw = safeU16(6);\n  var t_hi_raw    = safeI16(10);\n  var t_lo_raw    = safeI16(14);\n  var i_upper_raw = safeU16(18);\n  var cell_hi2_raw= safeU16(22);\n  var cell_lo2_raw= safeU16(26);\n  var n_cells_raw = safeU16(30);\n  var i_lim_raw   = safeU16(34);\n  var cap_raw     = safeU16(38);\n  var int_raw     = safeU16(42);\n  var bal_raw     = safeU16(46);\n\n  function vFromMv(mv){ return (mv==null)?null: +(mv/1000).toFixed(3); }\n  function tFromDeci(raw){ return (raw==null)?null: +(raw/10).toFixed(1); }\n  function aFromCenti(raw){ return (raw==null)?null: +(raw/100).toFixed(1); }\n  function ahFromCenti(raw){ return (raw==null)?null: +(raw/100).toFixed(2); }\n\n  var cell_v_hi = vFromMv(cell_hi_raw);\n  var cell_v_lo = vFromMv(cell_lo_raw);\n\n  // Some devices repeat cell limits; prefer first, but fall back to second when missing.\n  if (cell_v_hi==null && cell_hi2_raw!=null) cell_v_hi = vFromMv(cell_hi2_raw);\n  if (cell_v_lo==null && cell_lo2_raw!=null) cell_v_lo = vFromMv(cell_lo2_raw);\n\n  var cell_count = (n_cells_raw!=null && n_cells_raw>0 && n_cells_raw<256) ? n_cells_raw : null;\n\n  // Derive pack limits from per-cell limits when we have a cell count.\n  var pack_v_hi = (cell_v_hi!=null && cell_count!=null) ? +((cell_v_hi*cell_count)).toFixed(2) : null;\n  var pack_v_lo = (cell_v_lo!=null && cell_count!=null) ? +((cell_v_lo*cell_count)).toFixed(2) : null;\n\n  // Extract best-effort ASCII tail for IDs/barcodes.\n  var ascii = '';\n  try {\n    var buf = Buffer.from(dataHex, 'hex');\n    var cur = '';\n    var best = '';\n    for (var i=0;i<buf.length;i++){\n      var b = buf[i];\n      if (b>=0x20 && b<=0x7E) cur += String.fromCharCode(b);\n      else {\n        if (cur.length >= 6 && cur.length > best.length) best = cur;\n        cur = '';\n      }\n    }\n    if (cur.length >= 6 && cur.length > best.length) best = cur;\n    ascii = best.trim();\n  } catch(e){}\n\n  return {\n    addr: adr,\n    dataflag: dataFlag,\n    ascii: ascii,\n    limits: {\n      // Keep legacy keys so existing dashboard/influx continues to work.\n      cell_v_hi: cell_v_hi,\n      cell_v_lo: cell_v_lo,\n      pack_v_hi: pack_v_hi,\n      pack_v_lo: pack_v_lo,\n\n      chg_t_lo: tFromDeci(t_lo_raw),\n      chg_t_hi: tFromDeci(t_hi_raw),\n\n      // Frame does not clearly contain discharge limits; leave null.\n      dch_t_lo: null,\n      dch_t_hi: null,\n      dch_i_lim: null,\n\n      // Charge current information\n      chg_i_upper: aFromCenti(i_upper_raw),\n      chg_i_lim: aFromCenti(i_lim_raw),\n\n      // Extra parameters\n      cell_count: cell_count,\n      design_capacity_ah: ahFromCenti(cap_raw),\n      interval_min: int_raw,\n      balance_mode: bal_raw,\n\n      // raw values (debug)\n      _raw: {\n        cell_hi_mv: cell_hi_raw,\n        cell_lo_mv: cell_lo_raw,\n        t_hi_deciC: t_hi_raw,\n        t_lo_deciC: t_lo_raw,\n        i_upper_centiA: i_upper_raw,\n        i_lim_centiA: i_lim_raw,\n        cap_centiAh: cap_raw\n      }\n    }\n  };\n}\n\nfunction decode44(dataHex, adr){\n  var p=0; var dataFlag=rU8(dataHex,p); p+=2;\n  var maybeCmd = rU8(dataHex,p);\n  if (maybeCmd === 0xFF || maybeCmd === parseInt(adr,16)) p+=2;\n  return { addr: adr, dataflag: dataFlag, raw: dataHex.substr(p) };\n}\n\nfunction decode83(dataHex){\n  var p=0;\n  var reqCid2 = (p+2<=dataHex.length)?rU8(dataHex,p):0; p+=2;\n  var reqOp   = (p+2<=dataHex.length)?rU8(dataHex,p):0; p+=2;\n  function g(){ var v=(p+4<=dataHex.length)?rU16(dataHex,p):null; p+=4; return v; }\n  return {\n    req_cid2:reqCid2, req_op:reqOp,\n    ochg_prot_cnt:g(), odisch_prot_cnt:g(), oc_prot_cnt:g(), temp_prot_cnt:g(),\n    short_circuit_prot_cnt:g(), mos_h_temp_prot_cnt:g(), env_h_temp_prot_cnt:g(), env_l_temp_prot_cnt:g()\n  };\n}\n\nfunction decodeB0(dataHex){\n  var head = dataHex.substr(0,12);\n  var mod = parseInt(head.substr(4,2)||'00',16);\n  var body = dataHex.substr(12);\n  var out = { mod: mod, head: head };\n  if (mod === 0x03){\n    out.ascii = Buffer.from(body,'hex').toString('ascii').replace(/[\\x00-\\x1F\\x7F]/g,' ').replace(/\\s+/g,' ').trim();\n  } else if (mod === 0x04){\n    function r(p){ return (p+4<=body.length)?parseInt(body.substr(p,4),16):null; }\n    out.remaining_ah = (r(0)!=null)? +(r(0)/100).toFixed(2) : null;\n    out.full_ah = (r(4)!=null)? +(r(4)/100).toFixed(2) : null;\n    out.design_ah = (r(8)!=null)? +(r(8)/100).toFixed(2) : null;\n    out.total_charge_ah = (r(12)!=null)? +(r(12)/100).toFixed(2) : null;\n    out.total_discharge_ah = (r(16)!=null)? +(r(16)/100).toFixed(2) : null;\n    out.total_charge_kwh = (r(20)!=null)? +(r(20)/10).toFixed(1) : null;\n    out.total_discharge_kwh = (r(24)!=null)? +(r(24)/10).toFixed(1) : null;\n  }\n  return out;\n}\n\n// \u2500\u2500 MAIN \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\nvar raw = msg.payload;\nvar s = '';\nif (Buffer.isBuffer(raw)) s = raw.toString('ascii');\nelse if (typeof raw === 'string') s = raw;\nelse if (raw != null) s = String(raw);\n\n// normalize and drop binary noise; keep CR/LF for frame boundaries\ns = s.replace(/[^~0-9A-Fa-f\\r\\n]/g,'').toUpperCase();\nif (!s) { flow.set('RS485_BUSY', false); return null; }\n\n// assemble chunked serial input\nvar buf = (flow.get('RS485_RXBUF') || '') + s;\nif (buf.length > 4096) buf = buf.slice(-4096);\n\nfunction takeFrameFromBuffer(b){\n  var start = b.indexOf('~22');\n  if (start < 0) return { frame:null, rest:'' };\n  b = b.slice(start);\n\n  // prefer CR/LF as delimiter\n  var endCR = b.indexOf('\\r');\n  var endLF = b.indexOf('\\n');\n  var end = -1;\n  if (endCR >= 0 && endLF >= 0) end = Math.min(endCR,endLF);\n  else if (endCR >= 0) end = endCR;\n  else if (endLF >= 0) end = endLF;\n\n  if (end >= 0){\n    var fr = b.slice(0,end);\n    var rest = b.slice(end+1);\n    return { frame:fr, rest:rest };\n  }\n\n  // no delimiter yet: if another ~22 exists, split there\n  var next = b.indexOf('~22',3);\n  if (next > 0){\n    return { frame:b.slice(0,next), rest:b.slice(next) };\n  }\n\n  // accept complete frame without delimiter when CRC verifies\n  if (b.length >= 20 && /^[~0-9A-F]+$/.test(b)){\n    var vv = asciiChecksumVerify(b);\n    if (vv.ok) return { frame:b, rest:'' };\n  }\n\n  // wait for more bytes\n  return { frame:null, rest:b };\n}\n\nvar got = takeFrameFromBuffer(buf);\nflow.set('RS485_RXBUF', got.rest);\nif (!got.frame){ return null; }\n\nvar rx = got.frame.trim();\nif (!rx || rx.indexOf('~22') !== 0) { flow.set('RS485_BUSY', false); return null; }\n\n// CRC\nvar v = asciiChecksumVerify(rx);\nif (!v.ok){\n  // try to salvage when frame has extra trailing chars\n  var okFrame = null;\n  for (var cut = rx.length; cut >= 18; cut--) {\n    var c = rx.slice(0, cut);\n    if (!/^~22[0-9A-F]+$/.test(c)) continue;\n    var vv = asciiChecksumVerify(c);\n    if (vv.ok){ okFrame = c; break; }\n  }\n  if (!okFrame){ node.warn('[RS485] CRC error'); flow.set('RS485_BUSY', false); return [null,null,null]; }\n  rx = okFrame;\n}\n\n// Header\nvar adr  = rx.substr(3,2);\nvar cid1 = rx.substr(5,2); if (cid1 !== '4A'){ flow.set('RS485_BUSY', false); return [null,null,null]; }\nvar rtn  = rx.substr(7,2); if (rtn !== '00'){ node.warn('[RS485] RTN=' + rtn); flow.set('RS485_BUSY', false); return [null,null,null]; }\n\nvar len = parseLen(rx);\nvar dataHex = rx.substring(13, rx.length - 4);\n\n// Service detection: prefer request context from scheduler/buildframe.\nvar which = null;\nvar svcHint = null;\nif (msg && msg._req && msg._req.svc != null) svcHint = Number(msg._req.svc) & 0xFF;\nelse if (msg && msg._svc != null) svcHint = Number(msg._svc) & 0xFF;\nelse if (msg && msg.service != null) svcHint = Number(msg.service) & 0xFF;\nif (svcHint == null) {\n  var lastReq = flow.get('RS485_LAST_REQ') || null;\n  if (lastReq && lastReq.svc != null) svcHint = Number(lastReq.svc) & 0xFF;\n}\n\nif (svcHint === 0x42) which = '42';\nelse if (svcHint === 0x44) which = '44';\nelse if (svcHint === 0x47) which = '47';\nelse if (svcHint === 0x51) which = '51';\nelse if (svcHint === 0x83) which = '83';\nelse if (svcHint === 0xB0) which = 'B0';\nelse if (svcHint === 0x49) which = '49';\nelse if (svcHint === 0x45) which = '45';\nelse if (svcHint === 0x8B) which = '8B';\n\nif (!which){\n  // fallback heuristic when context is missing\n  if (len.lenId === 0) which = '51';\n  else if (len.lenId >= 120) which = '42';\n  else if (len.lenId >= 80) which = '44';\n  else which = '47';\n}\nnode.warn('[DECODE] which=' + which + ' adr=' + adr + ' lenId=' + len.lenId + ' rxLen=' + rx.length);\n\nvar outStatus = null, outAlarms = null, outParams = null;\ntry {\n  if (which === '42'){\n    var d = decode42(dataHex, adr);\n    var payload = {\n      timestamp: new Date().toISOString(),\n      addr: d.addr,\n      soc: d.soc,\n      voltage: d.voltage,\n      current: d.current,\n      power: d.power,\n      mode: d.mode,\n      cells_mv: d.cells_mv,\n      cell_min_mv: d.cell_min_mv,\n      cell_max_mv: d.cell_max_mv,\n      cell_delta_mv: d.cell_delta_mv,\n      temps: d.temps,\n      capacity_ah_full: d.full_capacity_ah,\n      capacity_ah_remain: d.remain_capacity_ah,\n      cycles: d.cycles,\n      soh: d.soh,\n      raw_len: rx.length\n    };\n    outStatus = { topic: 'rs485/bms/' + adr + '/status', payload: payload };\n  } else if (which === '44'){\n    var a44 = decode44(dataHex, adr);\n    outAlarms = { topic: 'rs485/bms/' + adr + '/alarms', payload: a44 };\n  } else if (which === '47'){\n    var p = decode47(dataHex, adr);\n    // attach raw telegram for troubleshooting / offline decoding\n    try {\n      p.addr = adr;\n      p.svc = '47';\n      p.lenId = len.lenId;\n      p.len_ok = !!len.ok;\n      p.crc_ok = !!v.ok;\n      p.data_hex = dataHex;\n      p.raw_frame = String(rx||'').trim();\n    } catch(e){}\n    outParams = { topic: 'rs485/bms/' + adr + '/params', payload: p };\n    node.warn('[DECODE] out params adr=' + adr);\n  } else if (which === '51'){\n    var ascii = Buffer.from(dataHex, 'hex').toString('ascii');\n    outParams = { topic: 'rs485/bms/' + adr + '/id', payload: { ascii: ascii } };\n  } else if (which === '83'){\n    var d83 = decode83(dataHex);\n    outParams = { topic: 'rs485/bms/' + adr + '/diag', payload: { svc83: d83 } };\n  } else if (which === 'B0'){\n    var db0 = decodeB0(dataHex);\n    outParams = { topic: 'rs485/bms/' + adr + '/b0', payload: { b0: db0 } };\n  } else if (which === '49' || which === '45' || which === '8B'){\n    outParams = { topic: 'rs485/bms/' + adr + '/setack', payload: { setack:true, svc:which, raw:dataHex, ok:true } };\n  }\n} catch(e){\n  node.warn('Decode error: ' + e.message);\n}\n\nflow.set('RS485_BUSY', false);\nreturn [outStatus, outAlarms, outParams];\n",
    "outputs": 3,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 470,
    "y": 280,
    "wires": [
      [
        "db-status",
        "lout_status_01",
        "fn_rs485_status_to_influx"
      ],
      [
        "db-alarms",
        "lout_alarms_01"
      ],
      [
        "db-params",
        "lout_params_01",
        "fn_rs485_limits_to_influx",
        "cdaaa47a0ef44101"
      ]
    ]
  },
  {
    "id": "db-status",
    "type": "debug",
    "z": "tab-rs485-poller",
    "name": "Status",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 950,
    "y": 160,
    "wires": []
  },
  {
    "id": "db-alarms",
    "type": "debug",
    "z": "tab-rs485-poller",
    "name": "Alarms",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 950,
    "y": 200,
    "wires": []
  },
  {
    "id": "db-params",
    "type": "debug",
    "z": "tab-rs485-poller",
    "name": "Params/ID",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 970,
    "y": 240,
    "wires": []
  },
  {
    "id": "66e1934504a3cc37",
    "type": "link in",
    "z": "tab-rs485-poller",
    "name": "link in 2",
    "links": [
      "8b83d96e53bcea1e"
    ],
    "x": 145,
    "y": 280,
    "wires": [
      [
        "fn-decode"
      ]
    ]
  },
  {
    "id": "576f851cc8d93310",
    "type": "debug",
    "z": "tab-rs485-poller",
    "name": "debug RS485 \u279c /dev/ttyUSB0",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 1090,
    "y": 120,
    "wires": []
  },
  {
    "id": "5cb9ca8a3a09bc35",
    "type": "link out",
    "z": "tab-rs485-poller",
    "name": "link out 3 - Build Frame",
    "mode": "link",
    "links": [
      "08349c8549bc7f16"
    ],
    "x": 985,
    "y": 60,
    "wires": []
  },
  {
    "id": "fn_status_01fcae0f",
    "type": "function",
    "z": "tab_a3412f46",
    "name": "Store + Fanout (Status)",
    "func": "// RS485 status -> deterministic fanout (one output per widget)\nconst s = msg.payload || {};\nconst addr = (s.addr || '').toString();\nif (!addr) return null;\n\nlet packs = flow.get('packs') || {};\nconst prev = packs[addr] || {};\nconst merged = { ...prev, ...s, ts_ms: Date.now() };\n\n// derive SoC when not provided\nif ((merged.soc == null || Number.isNaN(Number(merged.soc))) && merged.capacity_ah_full > 0 && merged.capacity_ah_remain >= 0) {\n  merged.soc = Math.max(0, Math.min(100, (Number(merged.capacity_ah_remain) / Number(merged.capacity_ah_full)) * 100));\n}\n\npacks[addr] = merged;\nflow.set('packs', packs);\n\n// ui_dropdown expects [{label,value},...]. Raw strings can render as \"Label/Value\" placeholders.\nconst opts = [{ label: 'auto', value: 'auto' }].concat(\n  Object.keys(packs).sort().map(a => ({ label: 'ID ' + a, value: a }))\n);\n\nlet sel = flow.get('sel_addr') || 'auto';\nif (sel === 'auto') sel = addr;\nconst p = packs[sel] || merged;\n\nconst voltage = Number(p.voltage || 0);\nconst current = Number(p.current || 0);\nconst power = Number((p.power != null ? p.power : (voltage * current)) || 0);\nconst soc = Number(p.soc || 0);\nconst cd = Number(p.cell_delta_mv || 0);\n\nconst hdr = 'Pack ' + sel + ' | ' + (p.mode || '') + ' | ' + voltage.toFixed(2) + ' V, ' + current.toFixed(1) + ' A, ' + Math.round(power) + ' W';\nlet stat = 'OK';\nif (p.soh != null && Number(p.soh) < 70) stat = 'WARNING';\nif (p.cell_delta_mv != null && Number(p.cell_delta_mv) > 120) stat = 'WARNING';\nconst ledColor = stat === 'OK' ? 'green' : (stat === 'WARNING' ? 'yellow' : 'red');\n\nconst misc = 'SOH ' + (p.soh ?? '--') + '% | Zyklen ' + (p.cycles ?? '--') + ' | Cap ' + (p.capacity_ah_remain ?? '--') + '/' + (p.capacity_ah_full ?? '--') + ' Ah';\n\nconst cells = Array.isArray(p.cells_mv) ? p.cells_mv : [];\nconst tblCells = cells.map((mv, i) => ({ idx: i + 1, mv, v: (Number(mv) / 1000).toFixed(3) }));\n\nconst tarr = Array.isArray(p.temps) ? p.temps.map(Number) : [];\nconst tpack = tarr.length ? (tarr.length>=2 ? tarr[1] : tarr[0]) : (p.temps != null ? Number(p.temps) : 0);\nconst tmax = tarr.length ? Math.max(...tarr) : tpack;\nconst tmin = tarr.length ? Math.min(...tarr) : tpack;\nconst tempsTxt = 'Pack ' + (Number.isFinite(tpack) ? tpack : '--') + ' \u00b0C | Max ' + (Number.isFinite(tmax) ? tmax : '--') + ' \u00b0C | Min ' + (Number.isFinite(tmin) ? tmin : '--') + ' \u00b0C';\n\nconst list = Object.keys(packs).sort().map(a => {\n  const q = packs[a] || {};\n  return {\n    addr: a,\n    soc: Math.round(Number(q.soc || 0)),\n    volt: Number(q.voltage || 0).toFixed(2),\n    curr: Number(q.current || 0).toFixed(1),\n    delta: q.cell_delta_mv ?? '',\n    cycles: q.cycles ?? '',\n    soh: q.soh ?? '',\n    ts: q.ts_ms ? new Date(q.ts_ms).toLocaleTimeString('de-DE', { hour12: false }) : ''\n  };\n});\n\nreturn [\n  { payload: hdr },\n  { payload: soc },\n  { payload: voltage },\n  { payload: current },\n  { payload: power },\n  { payload: true, color: ledColor },\n  { payload: p.mode || '' },\n  { payload: misc },\n  { payload: tblCells },\n  { payload: (p.cell_min_mv != null ? (Number(p.cell_min_mv) / 1000).toFixed(3) + ' V' : '\u2014') },\n  { payload: (p.cell_max_mv != null ? (Number(p.cell_max_mv) / 1000).toFixed(3) + ' V' : '\u2014') },\n  { payload: cd },\n  { payload: tempsTxt },\n  { payload: list },\n  { options: opts, payload: (flow.get('sel_addr') || 'auto') },\n  { topic: 'SoC ' + sel, payload: soc },\n  [{ topic: 'U ' + sel, payload: voltage }, { topic: 'I ' + sel, payload: current }],\n  { topic: 'P ' + sel, payload: power },\n  [{ topic: 'Tpack ' + sel, payload: Number(tpack || 0) }, { topic: 'Tmax ' + sel, payload: Number(tmax || 0) }, { topic: 'Tmin ' + sel, payload: Number(tmin || 0) }],\n  { topic: '\u0394mV ' + sel, payload: cd }\n];",
    "outputs": 20,
    "noerr": 0,
    "initialize": "",
    "libs": [],
    "x": 420,
    "y": 80,
    "wires": [
      [
        "ui_txthdr_ff84e8c7"
      ],
      [
        "ui_gsoc_bc6982b1"
      ],
      [
        "ui_gu_65433453"
      ],
      [
        "ui_gi_5f3958a3"
      ],
      [
        "ui_gp_f5dd21e1"
      ],
      [
        "ui_led_b114d325"
      ],
      [
        "ui_txtmode_972268a6"
      ],
      [
        "ui_txtmisc_ca463fec"
      ],
      [
        "ui_tblcells_dd3df18e"
      ],
      [
        "ui_txtcmin_fbe79220"
      ],
      [
        "ui_txtcmax_398949b5"
      ],
      [
        "ui_gcdel_2d8f3f67"
      ],
      [
        "ui_txttemps_4f0b08d6"
      ],
      [
        "ui_tblpacks_1be48567"
      ],
      [
        "ui_ddr_aee3eb1e"
      ],
      [
        "ui_chsoc_62cd7124"
      ],
      [
        "ui_chui_111480d8"
      ],
      [
        "ui_chp_d43428b5"
      ],
      [
        "ui_chtemp_19ea2049"
      ],
      [
        "ui_chcdel_a6a88be6"
      ]
    ]
  },
  {
    "id": "fn_params_ec09b695",
    "type": "function",
    "z": "tab_a3412f46",
    "name": "Store + UI (Params)",
    "func": "var pl=(msg&&msg.payload&&typeof msg.payload==='object')?msg.payload:{};\nvar t=String((msg&&msg.topic)||'');\nvar m=t.match(/rs485\\/bms\\/([0-9A-F]{2})\\//i);\nvar addr=(m?m[1]:(pl.addr||'--')).toString().toUpperCase();\n\nvar lim=flow.get('RS485_LIMITS_TXT_MAP2')||{};\nvar idm=flow.get('RS485_ID_TXT_MAP2')||{};\nvar dgm=flow.get('RS485_DIAG_TXT_MAP2')||{};\nvar sam=flow.get('RS485_SETACK_TXT_MAP2')||{};\n\nfunction num(v){var x=Number(v);return Number.isFinite(x)?x:null;}\nfunction fN(v,d){return v==null?'--':Number(v).toFixed(d);}\nfunction pick(a,b){ return (a!=null && a!=='' ) ? a : b; }\n\nif(pl.limits&&typeof pl.limits==='object'){\n  var L=pl.limits;\n  var cellHi=num(L.cell_v_hi);\n  var cellLo=num(L.cell_v_lo);\n  var nCells=num(L.cell_count);\n  if(!(nCells>0 && nCells<256)) nCells=null;\n\n  var packHi=num(L.pack_v_hi);\n  var packLo=num(L.pack_v_lo);\n  if((packHi==null||packHi<10) && cellHi!=null && nCells!=null) packHi=cellHi*nCells;\n  if((packLo==null||packLo<10) && cellLo!=null && nCells!=null) packLo=cellLo*nCells;\n\n  var iChg=num(L.chg_i_lim);\n  var iUp =num(L.chg_i_upper);\n  var tLo =num(L.chg_t_lo);\n  var tHi =num(L.chg_t_hi);\n  if(tLo!=null && tHi!=null && tLo>tHi){ var z=tLo; tLo=tHi; tHi=z; }\n\n  var cap=num(L.design_capacity_ah);\n  var interval = (L.interval_min!=null && isFinite(L.interval_min)) ? Number(L.interval_min) : null;\n\n  var line1 = 'ID '+addr+' \u2022 Zellen: '+(nCells!=null?String(nCells):'--');\n  var line2 = 'Cell OV/UV: '+fN(cellHi,3)+' / '+fN(cellLo,3)+' V';\n  var line3 = 'Pack OV/UV: '+fN(packHi,2)+' / '+fN(packLo,2)+' V';\n  var line4 = 'I Charge: '+fN(iChg,1)+' A' + (iUp!=null ? (' (upper '+fN(iUp,1)+' A)') : '');\n  var line5 = 'T Charge: '+fN(tLo,1)+' .. '+fN(tHi,1)+' \u00b0C';\n  var line6 = (cap!=null ? ('Design Cap: '+fN(cap,2)+' Ah') : null);\n  var line7 = (interval!=null ? ('Interval: '+interval+' min') : null);\n\n  lim[addr] = [line1,line2,line3,line4,line5,line6,line7].filter(Boolean).join('\\n');\n  flow.set('RS485_LIMITS_TXT_MAP2',lim);\n}\n\nif(typeof pl.ascii==='string'&&pl.ascii.length){\n  idm[addr]='ID '+addr+'\\n'+pl.ascii.replace(/[\\x00-\\x1F\\x7F]/g,' ').replace(/\\s+/g,' ').trim();\n  flow.set('RS485_ID_TXT_MAP2',idm);\n}\n\nif(pl.svc83&&typeof pl.svc83==='object'){\n  var d=pl.svc83;\n  dgm[addr]='Diag 83\\nOCHG_PROT: '+(d.ochg_prot_cnt??'--')+'\\nODISCH_PROT: '+(d.odisch_prot_cnt??'--')+'\\nOC_PROT: '+(d.oc_prot_cnt??'--')+'\\nTEMP_PROT: '+(d.temp_prot_cnt??'--')+'\\nSHORT_PROT: '+(d.short_circuit_prot_cnt??'--');\n  flow.set('RS485_DIAG_TXT_MAP2',dgm);\n}\n\nif(pl.svc49 || pl.setack){\n  var svc=(pl.svc?pl.svc:'49');\n  sam[addr]='Set ACK ('+svc+') empfangen: '+new Date().toLocaleTimeString('de-DE',{hour12:false});\n  flow.set('RS485_SETACK_TXT_MAP2',sam);\n}\n\nif(pl.b0&&typeof pl.b0==='object'){\n  var b=pl.b0;\n  if(b.mod===3){ dgm[addr]='B0/03 Info\\n'+(b.ascii||'--'); }\n  if(b.mod===4){\n    dgm[addr]='B0/04 Capacity\\nRemain: '+(b.remaining_ah??'--')+' Ah\\nFull: '+(b.full_ah??'--')+' Ah\\nDesign: '+(b.design_ah??'--')+' Ah\\nCharged: '+(b.total_charge_ah??'--')+' Ah\\nDischarged: '+(b.total_discharge_ah??'--')+' Ah\\nChg Energy: '+(b.total_charge_kwh??'--')+' kWh\\nDis Energy: '+(b.total_discharge_kwh??'--')+' kWh';\n  }\n  flow.set('RS485_DIAG_TXT_MAP2',dgm);\n}\n\nvar lt=lim[addr]||('ID '+addr+'\\nNoch keine Limits/Parameter (0x47) empfangen.');\nvar info=(idm[addr]||('ID '+addr+'\\nNoch keine Geraeteinfo empfangen.'));\nif(dgm[addr]) info = info + '\\n\\n' + dgm[addr];\nif(sam[addr]) info = info + '\\n\\n' + sam[addr];\n\nnode.warn('[PARAMS_UI] addr='+addr+' hasLimits='+!!pl.limits+' hasId='+!!pl.ascii+' hasDiag='+!!pl.svc83+' hasB0='+!!pl.b0);\n\nvar h1=''\n + '<div style=\"padding:16px;border:1px solid #3b4b55;border-radius:12px;background:#162028\">'\n +   '<div style=\"font-size:18px;font-weight:700;margin-bottom:10px\">Parameter / Limits (RS485 0x47)</div>'\n +   '<pre style=\"margin:0;white-space:pre-wrap;line-height:1.6;font-size:15px\">'+lt+'</pre>'\n + '</div>';\n\nvar h2=''\n + '<div style=\"padding:16px;border:1px solid #3b4b55;border-radius:12px;background:#141b21\">'\n +   '<div style=\"font-size:18px;font-weight:700;margin-bottom:10px\">Geraeteinfo / Diagnose</div>'\n +   '<pre style=\"margin:0;white-space:pre-wrap;line-height:1.6;font-size:15px\">'+info+'</pre>'\n + '</div>';\n\nreturn [{payload:h1},{payload:h2},{payload:lt},{payload:info}];",
    "outputs": 4,
    "noerr": 0,
    "initialize": "",
    "libs": [],
    "x": 420,
    "y": 520,
    "wires": [
      [
        "ui_tpl_limits_pretty"
      ],
      [
        "ui_tpl_id_pretty"
      ],
      [
        "ui_txtlimits_bf20908e"
      ],
      [
        "ui_txtid_5da1dade"
      ]
    ]
  },
  {
    "id": "fn_alarms_af059c50",
    "type": "function",
    "z": "tab_a3412f46",
    "name": "Alarms (optional)",
    "func": "return null;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "libs": [],
    "x": 430,
    "y": 160,
    "wires": [
      []
    ]
  },
  {
    "id": "fn_select_10e0cc68",
    "type": "function",
    "z": "tab_a3412f46",
    "name": "Set selected addr",
    "func": "let v = msg.payload;\nif (v && typeof v === 'object') v = v.value ?? v.label ?? v.payload;\nconst sel = (v || 'auto').toString().replace(/^IDs*/i,'').toLowerCase()==='auto' ? 'auto' : (v||'').toString().toUpperCase().replace(/^IDs*/i,'');\nflow.set('sel_addr', sel || 'auto');\nreturn null;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "libs": [],
    "x": 420,
    "y": 220,
    "wires": [
      []
    ]
  },
  {
    "id": "lin_status_277c4db6",
    "type": "link in",
    "z": "tab_a3412f46",
    "name": "STATUS_IN (from Poller Out1)",
    "links": [],
    "x": 130,
    "y": 80,
    "wires": [
      [
        "fn_status_01fcae0f"
      ]
    ]
  },
  {
    "id": "lin_alarms_fdc21ec8",
    "type": "link in",
    "z": "tab_a3412f46",
    "name": "ALARMS_IN (from Poller Out2)",
    "links": [],
    "x": 130,
    "y": 120,
    "wires": [
      [
        "fn_alarms_af059c50"
      ]
    ]
  },
  {
    "id": "lin_params_c089092a",
    "type": "link in",
    "z": "tab_a3412f46",
    "name": "PARAMS_IN (from Poller Out3)",
    "links": [
      "lout_params_01"
    ],
    "x": 130,
    "y": 520,
    "wires": [
      [
        "fn_params_ec09b695"
      ]
    ]
  },
  {
    "id": "ui_txthdr_ff84e8c7",
    "type": "ui_text",
    "z": "tab_a3412f46",
    "group": "grp1_b4146321",
    "order": 1,
    "width": 12,
    "height": 1,
    "name": "Header",
    "label": "",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 900,
    "y": 60,
    "wires": []
  },
  {
    "id": "ui_gsoc_bc6982b1",
    "type": "ui_gauge",
    "z": "tab_a3412f46",
    "name": "SoC",
    "group": "grp1_b4146321",
    "order": 2,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "SoC",
    "label": "%",
    "format": "{{value}}",
    "min": 0,
    "max": 100,
    "colors": [
      "#e53935",
      "#fdd835",
      "#43a047"
    ],
    "seg1": 20,
    "seg2": 90,
    "x": 690,
    "y": 120,
    "wires": []
  },
  {
    "id": "ui_gu_65433453",
    "type": "ui_gauge",
    "z": "tab_a3412f46",
    "name": "U",
    "group": "grp1_b4146321",
    "order": 3,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Spannung",
    "label": "V",
    "format": "{{value | number:2}}",
    "min": 40,
    "max": 60,
    "colors": [
      "#ca3838",
      "#1e88e5",
      "#1de9b6"
    ],
    "seg1": 48,
    "seg2": 58,
    "x": 890,
    "y": 120,
    "wires": []
  },
  {
    "id": "ui_gi_5f3958a3",
    "type": "ui_gauge",
    "z": "tab_a3412f46",
    "name": "I",
    "group": "grp1_b4146321",
    "order": 4,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Strom",
    "label": "A",
    "format": "{{value | number:1}}",
    "min": -300,
    "max": 300,
    "colors": [
      "#039be5",
      "#f7c600",
      "#ef6c00"
    ],
    "seg1": -50,
    "seg2": 50,
    "x": 1090,
    "y": 120,
    "wires": []
  },
  {
    "id": "ui_gp_f5dd21e1",
    "type": "ui_gauge",
    "z": "tab_a3412f46",
    "name": "P",
    "group": "grp1_b4146321",
    "order": 5,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Leistung",
    "label": "W",
    "format": "{{value | number:0}}",
    "min": -20000,
    "max": 20000,
    "colors": [
      "#1976d2",
      "#9e9e9e",
      "#d32f2f"
    ],
    "seg1": -2000,
    "seg2": 2000,
    "x": 1290,
    "y": 120,
    "wires": []
  },
  {
    "id": "ui_led_b114d325",
    "type": "ui_led",
    "z": "tab_a3412f46",
    "order": 6,
    "group": "grp1_b4146321",
    "width": 2,
    "height": 1,
    "label": "Status",
    "name": "LED Status",
    "x": 690,
    "y": 180,
    "wires": [],
    "d": true
  },
  {
    "id": "ui_txtmode_972268a6",
    "type": "ui_text",
    "z": "tab_a3412f46",
    "group": "grp1_b4146321",
    "order": 7,
    "width": 5,
    "height": 1,
    "name": "Mode",
    "label": "Modus",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 910,
    "y": 180,
    "wires": []
  },
  {
    "id": "ui_txtmisc_ca463fec",
    "type": "ui_text",
    "z": "tab_a3412f46",
    "group": "grp1_b4146321",
    "order": 8,
    "width": 5,
    "height": 1,
    "name": "Misc",
    "label": "SOH / Zyklen",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 1120,
    "y": 180,
    "wires": []
  },
  {
    "id": "ui_ddr_aee3eb1e",
    "type": "ui_dropdown",
    "z": "tab_a3412f46",
    "name": "Pack w\u00e4hlen",
    "label": "Pack",
    "tooltip": "Adresse w\u00e4hlen",
    "place": "auto",
    "group": "grp2_379a7d9d",
    "order": 1,
    "width": 6,
    "height": 1,
    "passthru": true,
    "multiple": false,
    "options": [
      {
        "label": "auto",
        "value": "auto",
        "type": "str"
      }
    ],
    "payload": "auto",
    "topic": "",
    "x": 210,
    "y": 220,
    "wires": [
      [
        "fn_select_10e0cc68"
      ]
    ]
  },
  {
    "id": "ui_tblcells_dd3df18e",
    "type": "ui_table",
    "z": "tab_a3412f46",
    "group": "grp3_5b115d66",
    "name": "Zellen",
    "order": 1,
    "width": 6,
    "height": 8,
    "columns": [
      {
        "field": "idx",
        "title": "#",
        "width": "10%"
      },
      {
        "field": "mv",
        "title": "mV",
        "width": "30%"
      },
      {
        "field": "v",
        "title": "V",
        "width": "30%"
      },
      {
        "field": "note",
        "title": "",
        "width": "30%"
      }
    ],
    "outputs": 0,
    "cts": false,
    "x": 910,
    "y": 260,
    "wires": []
  },
  {
    "id": "ui_txtcmin_fbe79220",
    "type": "ui_text",
    "z": "tab_a3412f46",
    "group": "grp3_5b115d66",
    "order": 2,
    "width": 3,
    "height": 1,
    "name": "Cmin",
    "label": "Min",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 670,
    "y": 320,
    "wires": []
  },
  {
    "id": "ui_txtcmax_398949b5",
    "type": "ui_text",
    "z": "tab_a3412f46",
    "group": "grp3_5b115d66",
    "order": 3,
    "width": 3,
    "height": 1,
    "name": "Cmax",
    "label": "Max",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 880,
    "y": 320,
    "wires": []
  },
  {
    "id": "ui_gcdel_2d8f3f67",
    "type": "ui_gauge",
    "z": "tab_a3412f46",
    "name": "\u0394 mV",
    "group": "grp3_5b115d66",
    "order": 4,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "\u0394 Zelle",
    "label": "mV",
    "format": "{{value}}",
    "min": 0,
    "max": 200,
    "colors": [
      "#43a047",
      "#fdd835",
      "#e53935"
    ],
    "seg1": 30,
    "seg2": 100,
    "x": 1090,
    "y": 320,
    "wires": []
  },
  {
    "id": "ui_txttemps_4f0b08d6",
    "type": "ui_text",
    "z": "tab_a3412f46",
    "group": "grp3_5b115d66",
    "order": 5,
    "width": 12,
    "height": 1,
    "name": "Temps",
    "label": "Temperaturen",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 1310,
    "y": 320,
    "wires": []
  },
  {
    "id": "ui_chsoc_62cd7124",
    "type": "ui_chart",
    "z": "tab_a3412f46",
    "name": "SoC Verlauf",
    "group": "grp4_f79d1046",
    "order": 1,
    "width": 6,
    "height": 4,
    "label": "SoC %",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "0",
    "ymax": "100",
    "removeOlder": "6",
    "removeOlderUnit": "3600",
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#26a69a"
    ],
    "outputs": 1,
    "useDifferentColor": true,
    "x": 690,
    "y": 400,
    "wires": [
      []
    ]
  },
  {
    "id": "ui_chui_111480d8",
    "type": "ui_chart",
    "z": "tab_a3412f46",
    "name": "U / I Verlauf",
    "group": "grp4_f79d1046",
    "order": 2,
    "width": 6,
    "height": 4,
    "label": "U (V) / I (A)",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "auto",
    "ymax": "auto",
    "removeOlder": "6",
    "removeOlderUnit": "3600",
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#42a5f5",
      "#ef6c00"
    ],
    "outputs": 1,
    "useDifferentColor": true,
    "x": 910,
    "y": 400,
    "wires": [
      []
    ]
  },
  {
    "id": "ui_chp_d43428b5",
    "type": "ui_chart",
    "z": "tab_a3412f46",
    "name": "Power Verlauf",
    "group": "grp4_f79d1046",
    "order": 3,
    "width": 6,
    "height": 4,
    "label": "Leistung (W)",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "auto",
    "ymax": "auto",
    "removeOlder": "6",
    "removeOlderUnit": "3600",
    "useOneColor": true,
    "useUTC": false,
    "colors": [
      "#9ccc65"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "x": 1130,
    "y": 400,
    "wires": [
      []
    ]
  },
  {
    "id": "ui_chtemp_19ea2049",
    "type": "ui_chart",
    "z": "tab_a3412f46",
    "name": "Temp Verlauf",
    "group": "grp4_f79d1046",
    "order": 4,
    "width": 6,
    "height": 4,
    "label": "Temp (Pack/Max/Min)",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "auto",
    "ymax": "auto",
    "removeOlder": "6",
    "removeOlderUnit": "3600",
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#66bb6a",
      "#ef5350",
      "#42a5f5"
    ],
    "outputs": 1,
    "useDifferentColor": true,
    "x": 1350,
    "y": 400,
    "wires": [
      []
    ]
  },
  {
    "id": "ui_chcdel_a6a88be6",
    "type": "ui_chart",
    "z": "tab_a3412f46",
    "name": "\u0394 mV Verlauf",
    "group": "grp4_f79d1046",
    "order": 5,
    "width": 6,
    "height": 4,
    "label": "Zell \u0394 (mV)",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "0",
    "ymax": "200",
    "removeOlder": "6",
    "removeOlderUnit": "3600",
    "useOneColor": true,
    "useUTC": false,
    "colors": [
      "#ab47bc"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "x": 1570,
    "y": 400,
    "wires": [
      []
    ]
  },
  {
    "id": "ui_txtlimits_bf20908e",
    "type": "ui_text",
    "z": "tab_a3412f46",
    "group": "grp5_c1450fb3",
    "order": 3,
    "width": 12,
    "height": 3,
    "name": "Limits",
    "label": "Limits",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 720,
    "y": 520,
    "wires": [],
    "d": false
  },
  {
    "id": "ui_txtid_5da1dade",
    "type": "ui_text",
    "z": "tab_a3412f46",
    "group": "grp5_c1450fb3",
    "order": 4,
    "width": 12,
    "height": 2,
    "name": "Identity",
    "label": "Ger\u00e4teinfo",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 940,
    "y": 520,
    "wires": [],
    "d": false
  },
  {
    "id": "ui_tblpacks_1be48567",
    "type": "ui_table",
    "z": "tab_a3412f46",
    "group": "grp6_8fca39a9",
    "name": "Packs",
    "order": 1,
    "width": 12,
    "height": 6,
    "columns": [
      {
        "field": "addr",
        "title": "Addr",
        "width": "10%"
      },
      {
        "field": "soc",
        "title": "SoC %",
        "width": "10%"
      },
      {
        "field": "volt",
        "title": "U (V)",
        "width": "15%"
      },
      {
        "field": "curr",
        "title": "I (A)",
        "width": "15%"
      },
      {
        "field": "delta",
        "title": "\u0394 mV",
        "width": "10%"
      },
      {
        "field": "cycles",
        "title": "Zyklen",
        "width": "10%"
      },
      {
        "field": "soh",
        "title": "SOH %",
        "width": "10%"
      },
      {
        "field": "ts",
        "title": "Zeit",
        "width": "20%"
      }
    ],
    "outputs": 0,
    "cts": false,
    "x": 1190,
    "y": 520,
    "wires": []
  },
  {
    "id": "63d077e8bacc1",
    "type": "mqtt in",
    "z": "63d077e8ba67d",
    "name": "bms/can/356",
    "topic": "bms/can/356",
    "qos": "0",
    "datatype": "auto",
    "broker": "63d077e8ba7f0",
    "nl": false,
    "rap": false,
    "rh": 0,
    "inputs": 0,
    "x": 200,
    "y": 220,
    "wires": [
      [
        "63d077e8ba9e6"
      ]
    ]
  },
  {
    "id": "63d077e8bac78",
    "type": "mqtt in",
    "z": "63d077e8ba67d",
    "name": "bms/can/351",
    "topic": "bms/can/351",
    "qos": "0",
    "datatype": "auto",
    "broker": "63d077e8ba7f0",
    "nl": false,
    "rap": false,
    "rh": 0,
    "inputs": 0,
    "x": 200,
    "y": 280,
    "wires": [
      [
        "63d077e8bab04"
      ]
    ]
  },
  {
    "id": "63d077e8bab4b",
    "type": "mqtt in",
    "z": "63d077e8ba67d",
    "name": "bms/can/355",
    "topic": "bms/can/355",
    "qos": "0",
    "datatype": "auto",
    "broker": "63d077e8ba7f0",
    "nl": false,
    "rap": false,
    "rh": 0,
    "inputs": 0,
    "x": 200,
    "y": 340,
    "wires": [
      [
        "63d077e8bab43"
      ]
    ]
  },
  {
    "id": "63d077e8bac4d",
    "type": "mqtt in",
    "z": "63d077e8ba67d",
    "name": "bms/can/359",
    "topic": "bms/can/359",
    "qos": "0",
    "datatype": "auto",
    "broker": "63d077e8ba7f0",
    "nl": false,
    "rap": false,
    "rh": 0,
    "inputs": 0,
    "x": 200,
    "y": 400,
    "wires": [
      [
        "63d077e8ba905"
      ]
    ]
  },
  {
    "id": "63d077e8ba9e6",
    "type": "function",
    "z": "63d077e8ba67d",
    "name": "Parse CAN 356",
    "func": "\n// Accept JSON string or object, expect fields voltage(V), current(A), temperature(C)\nlet p = msg.payload;\ntry { if (typeof p === 'string') p = JSON.parse(p); } catch(e){}\nif (p && typeof p === 'object') {\n    const v = Number(p.voltage); const i = Number(p.current); const t = Number(p.temperature);\n    if (!Number.isFinite(v) || !Number.isFinite(i)) return null;\n    // store to global for exporters\n    const g = global.get('bms')||{};\n    g.voltage = v; g.current = i; if (Number.isFinite(t)) g.temperature = t;\n    g.updated = Date.now();\n    global.set('bms', g);\n    // forward simple topic/value for charts\n    return [ {topic: 'voltage', payload: v, meta: p} ];\n}\nreturn null;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 460,
    "y": 220,
    "wires": [
      [
        "63d077e8bad2b",
        "63d077e8baca2"
      ]
    ]
  },
  {
    "id": "63d077e8bab04",
    "type": "function",
    "z": "63d077e8ba67d",
    "name": "Parse CAN 351",
    "func": "\nlet p = msg.payload;\ntry { if (typeof p === 'string') p = JSON.parse(p); } catch(e){}\nif (p && typeof p === 'object') {\n    const vlim = Number(p.voltage); const clim = Number(p.charge_current); const dlim = Number(p.discharge_current);\n    const g = global.get('bms')||{};\n    if (Number.isFinite(vlim)) g.voltage_limit = vlim;\n    if (Number.isFinite(clim)) g.charge_limit = clim;\n    if (Number.isFinite(dlim)) g.discharge_limit = dlim;\n    g.updated = Date.now();\n    global.set('bms', g);\n    return [ {topic: 'limits', payload: { voltage_limit:vlim, charge_limit:clim, discharge_limit:dlim }} ];\n}\nreturn null;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 460,
    "y": 280,
    "wires": [
      []
    ]
  },
  {
    "id": "63d077e8bab43",
    "type": "function",
    "z": "63d077e8ba67d",
    "name": "Parse CAN 355",
    "func": "\nlet p = msg.payload;\ntry { if (typeof p === 'string') p = JSON.parse(p); } catch(e){}\nif (p && typeof p === 'object') {\n    const soc = Number(p.SOC ?? p.soc ?? p.Soc ?? p.SoC);\n    const soh = Number(p.SOH ?? p.soh);\n    if (!Number.isFinite(soc)) return null;\n    const g = global.get('bms')||{};\n    g.soc = soc; if (Number.isFinite(soh)) g.soh = soh;\n    g.updated = Date.now();\n    global.set('bms', g);\n    return [ {topic: 'soc', payload: soc} ];\n}\nreturn null;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 460,
    "y": 340,
    "wires": [
      [
        "63d077e8baf2e"
      ]
    ]
  },
  {
    "id": "63d077e8ba905",
    "type": "function",
    "z": "63d077e8ba67d",
    "name": "Parse CAN 359",
    "func": "\nlet p = msg.payload;\ntry { if (typeof p === 'string') p = JSON.parse(p); } catch(e){}\nif (p && typeof p === 'object') {\n    const g = global.get('bms')||{};\n    g.flags = p; g.updated = Date.now();\n    global.set('bms', g);\n    return [ {topic: 'flags', payload: p} ];\n}\nreturn null;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 460,
    "y": 400,
    "wires": [
      []
    ]
  },
  {
    "id": "63d077e8bad2b",
    "type": "switch",
    "z": "63d077e8ba67d",
    "name": "pick voltage",
    "property": "topic",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "voltage",
        "vt": "str"
      }
    ],
    "checkall": "true",
    "repair": false,
    "outputs": 1,
    "x": 760,
    "y": 220,
    "wires": [
      [
        "63d077e8babb6"
      ]
    ]
  },
  {
    "id": "63d077e8babb6",
    "type": "rbe",
    "z": "63d077e8ba67d",
    "name": "RBE",
    "func": "rbe",
    "gap": "",
    "start": "",
    "inout": "out",
    "septopics": true,
    "property": "payload",
    "topi": "topic",
    "x": 970,
    "y": 220,
    "wires": [
      [
        "63d077e8bab19"
      ]
    ]
  },
  {
    "id": "63d077e8bab19",
    "type": "delay",
    "z": "63d077e8ba67d",
    "name": "Rate 5/s",
    "pauseType": "rate",
    "timeout": "5",
    "timeoutUnits": "seconds",
    "rate": "5",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": true,
    "allowrate": true,
    "outputs": 1,
    "x": 1120,
    "y": 220,
    "wires": [
      [
        "63d077e8bade3",
        "63d077e8bb2ac"
      ]
    ]
  },
  {
    "id": "63d077e8bade3",
    "type": "ui_text",
    "z": "63d077e8ba67d",
    "group": "63d077e8ba730",
    "order": 200,
    "width": 0,
    "height": 0,
    "name": "Pack Voltage (V)",
    "label": "Pack Voltage (V)",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 1420,
    "y": 200,
    "wires": []
  },
  {
    "id": "63d077e8bb2ac",
    "type": "change",
    "z": "63d077e8ba67d",
    "name": "to chart",
    "rules": [
      {
        "t": "set",
        "p": "topic",
        "pt": "msg",
        "to": "Voltage",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1280,
    "y": 360,
    "wires": [
      [
        "63d077e8bb139"
      ]
    ]
  },
  {
    "id": "63d077e8bb139",
    "type": "ui_chart",
    "z": "63d077e8ba67d",
    "name": "Voltage (V)",
    "group": "63d077e8ba4ad",
    "order": 360,
    "width": 0,
    "height": 0,
    "label": "Voltage (V)",
    "chartType": "line",
    "legend": "false",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "",
    "ymax": "",
    "removeOlder": "12",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": "0",
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#1f77b4",
      "#aec7e8",
      "#ff7f0e"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 1420,
    "y": 360,
    "wires": [
      []
    ]
  },
  {
    "id": "63d077e8baca2",
    "type": "function",
    "z": "63d077e8ba67d",
    "name": "Extract current from meta",
    "func": "\nif (msg.topic==='voltage' && msg.meta && Number.isFinite(Number(msg.meta.current))){\n    return {topic:'current', payload:Number(msg.meta.current)};\n}\nif (msg.topic==='soc'){\n    return msg;\n}\nreturn null;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 760,
    "y": 260,
    "wires": [
      [
        "63d077e8bac05"
      ]
    ]
  },
  {
    "id": "63d077e8bac05",
    "type": "rbe",
    "z": "63d077e8ba67d",
    "name": "RBE",
    "func": "rbe",
    "gap": "",
    "start": "",
    "inout": "out",
    "septopics": true,
    "property": "payload",
    "topi": "topic",
    "x": 970,
    "y": 260,
    "wires": [
      [
        "63d077e8bae88"
      ]
    ]
  },
  {
    "id": "63d077e8bae88",
    "type": "delay",
    "z": "63d077e8ba67d",
    "name": "Rate 5/s",
    "pauseType": "rate",
    "timeout": "5",
    "timeoutUnits": "seconds",
    "rate": "5",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": true,
    "allowrate": true,
    "outputs": 1,
    "x": 1120,
    "y": 260,
    "wires": [
      [
        "63d077e8bafa7",
        "63d077e8bb323"
      ]
    ]
  },
  {
    "id": "63d077e8bafa7",
    "type": "ui_text",
    "z": "63d077e8ba67d",
    "group": "63d077e8ba730",
    "order": 240,
    "width": 0,
    "height": 0,
    "name": "Current (A)",
    "label": "Current (A)",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 1420,
    "y": 240,
    "wires": []
  },
  {
    "id": "63d077e8bb323",
    "type": "change",
    "z": "63d077e8ba67d",
    "name": "to chart",
    "rules": [
      {
        "t": "set",
        "p": "topic",
        "pt": "msg",
        "to": "Current",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1280,
    "y": 420,
    "wires": [
      [
        "63d077e8bb122"
      ]
    ]
  },
  {
    "id": "63d077e8bb122",
    "type": "ui_chart",
    "z": "63d077e8ba67d",
    "name": "Current (A)",
    "group": "63d077e8ba4ad",
    "order": 420,
    "width": 0,
    "height": 0,
    "label": "Current (A)",
    "chartType": "line",
    "legend": "false",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "",
    "ymax": "",
    "removeOlder": "12",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": "0",
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#1f77b4",
      "#aec7e8",
      "#ff7f0e"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 1420,
    "y": 420,
    "wires": [
      []
    ]
  },
  {
    "id": "63d077e8baf2e",
    "type": "switch",
    "z": "63d077e8ba67d",
    "name": "pick soc",
    "property": "topic",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "soc",
        "vt": "str"
      }
    ],
    "checkall": "true",
    "repair": false,
    "outputs": 1,
    "x": 760,
    "y": 300,
    "wires": [
      [
        "63d077e8bac0a"
      ]
    ]
  },
  {
    "id": "63d077e8bac0a",
    "type": "rbe",
    "z": "63d077e8ba67d",
    "name": "RBE",
    "func": "rbe",
    "gap": "",
    "start": "",
    "inout": "out",
    "septopics": true,
    "property": "payload",
    "topi": "topic",
    "x": 970,
    "y": 300,
    "wires": [
      [
        "63d077e8bad54"
      ]
    ]
  },
  {
    "id": "63d077e8bad54",
    "type": "delay",
    "z": "63d077e8ba67d",
    "name": "Rate 5/s",
    "pauseType": "rate",
    "timeout": "5",
    "timeoutUnits": "seconds",
    "rate": "5",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": true,
    "allowrate": true,
    "outputs": 1,
    "x": 1120,
    "y": 300,
    "wires": [
      [
        "63d077e8bae85",
        "63d077e8bb1f8"
      ]
    ]
  },
  {
    "id": "63d077e8bae85",
    "type": "ui_text",
    "z": "63d077e8ba67d",
    "group": "63d077e8ba730",
    "order": 280,
    "width": 0,
    "height": 0,
    "name": "SOC (%)",
    "label": "SOC (%)",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 1420,
    "y": 280,
    "wires": []
  },
  {
    "id": "63d077e8bb1f8",
    "type": "change",
    "z": "63d077e8ba67d",
    "name": "to chart",
    "rules": [
      {
        "t": "set",
        "p": "topic",
        "pt": "msg",
        "to": "SOC",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1280,
    "y": 480,
    "wires": [
      [
        "63d077e8bb15b"
      ]
    ]
  },
  {
    "id": "63d077e8bb15b",
    "type": "ui_chart",
    "z": "63d077e8ba67d",
    "name": "SOC (%)",
    "group": "63d077e8ba4ad",
    "order": 480,
    "width": 0,
    "height": 0,
    "label": "SOC (%)",
    "chartType": "line",
    "legend": "false",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "",
    "ymax": "",
    "removeOlder": "12",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": "0",
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#1f77b4",
      "#aec7e8",
      "#ff7f0e"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 1420,
    "y": 480,
    "wires": [
      []
    ]
  },
  {
    "id": "63d077e8bb1e4",
    "type": "ui_form",
    "z": "63d077e8ba67d",
    "name": "Set Limits",
    "label": "Limits",
    "group": "63d077e8ba4bd",
    "order": 1,
    "width": 0,
    "height": 0,
    "options": [
      {
        "label": "Voltage Limit (V)",
        "value": "voltage_limit",
        "type": "number"
      },
      {
        "label": "Charge Limit (A)",
        "value": "charge_limit",
        "type": "number"
      },
      {
        "label": "Discharge Limit (A)",
        "value": "discharge_limit",
        "type": "number"
      }
    ],
    "formValue": {
      "voltage_limit": "",
      "charge_limit": "",
      "discharge_limit": ""
    },
    "payload": "",
    "submit": "save limits",
    "cancel": "cancel",
    "topic": "",
    "x": 200,
    "y": 520,
    "wires": [
      [
        "63d077e8bb459"
      ]
    ]
  },
  {
    "id": "63d077e8bb459",
    "type": "function",
    "z": "63d077e8ba67d",
    "name": "Store+Publish limits",
    "func": "\nlet v = Number(msg.payload.voltage_limit);\nlet c = Number(msg.payload.charge_limit);\nlet d = Number(msg.payload.discharge_limit);\nconst g = global.get('bms')||{};\nif (Number.isFinite(v)) g.voltage_limit=v;\nif (Number.isFinite(c)) g.charge_limit=c;\nif (Number.isFinite(d)) g.discharge_limit=d;\nglobal.set('bms', g);\nmsg.retain = true;\nmsg.topic = \"bms/cmd/limits\";\nmsg.payload = JSON.stringify({voltage_limit:g.voltage_limit,charge_limit:g.charge_limit,discharge_limit:g.discharge_limit});\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 470,
    "y": 520,
    "wires": [
      [
        "63d077e8bb336"
      ]
    ]
  },
  {
    "id": "63d077e8bb336",
    "type": "mqtt out",
    "z": "63d077e8ba67d",
    "name": "Publish limits",
    "topic": "",
    "qos": "1",
    "retain": "true",
    "broker": "63d077e8ba7f0",
    "x": 710,
    "y": 520,
    "wires": []
  },
  {
    "id": "63d077e8bb4de",
    "type": "inject",
    "z": "63d077e8ba67d",
    "name": "2s",
    "props": [
      {
        "p": "payload"
      }
    ],
    "repeat": "2",
    "once": true,
    "onceDelay": "1",
    "topic": "",
    "payloadType": "date",
    "x": 200,
    "y": 600,
    "wires": [
      [
        "63d077e8bb482"
      ]
    ]
  },
  {
    "id": "63d077e8bb482",
    "type": "function",
    "z": "63d077e8ba67d",
    "name": "To Influx line",
    "func": "\nconst g = global.get('bms')||{};\nconst host = global.get('hostTag')||'raspi5';\nconst fields = [];\nif (Number.isFinite(g.voltage)) fields.push(`voltage=${g.voltage}`);\nif (Number.isFinite(g.current)) fields.push(`current=${g.current}`);\nif (Number.isFinite(g.soc)) fields.push(`soc=${g.soc}`);\nif (Number.isFinite(g.temperature)) fields.push(`temperature=${g.temperature}`);\nif (Number.isFinite(g.soh)) fields.push(`soh=${g.soh}`);\nif (fields.length===0) return null;\nmsg.payload = `bms_pack,host=${host} ${fields.join(',')}`;\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 470,
    "y": 600,
    "wires": [
      [
        "63d077e8bb446",
        "63d077e8bb571"
      ]
    ]
  },
  {
    "id": "63d077e8bb446",
    "type": "udp out",
    "z": "63d077e8ba67d",
    "name": "Telegraf UDP 8094",
    "addr": "127.0.0.1",
    "iface": "",
    "port": "8094",
    "ipv": "udp4",
    "outport": "",
    "base64": false,
    "multicast": "false",
    "x": 880,
    "y": 600,
    "wires": []
  },
  {
    "id": "63d077e8bb571",
    "type": "mqtt out",
    "z": "63d077e8ba67d",
    "name": "Telegraf MQTT",
    "topic": "telegraf/bms",
    "qos": "0",
    "retain": "false",
    "broker": "63d077e8ba7f0",
    "x": 880,
    "y": 640,
    "wires": []
  },
  {
    "id": "63d077e8bb6b2",
    "type": "http in",
    "z": "63d077e8ba67d",
    "name": "Prometheus /metrics",
    "url": "/metrics",
    "method": "get",
    "upload": false,
    "swaggerDoc": "",
    "x": 190,
    "y": 700,
    "wires": [
      [
        "63d077e8bb3d6"
      ]
    ]
  },
  {
    "id": "63d077e8bb3d6",
    "type": "function",
    "z": "63d077e8ba67d",
    "name": "Build metrics",
    "func": "\nconst g = global.get('bms')||{};\nfunction line(n,v,help,labels={}){\n  let lbl = Object.keys(labels).length? '{'+Object.entries(labels).map(([k,val])=>k+'=\"'+val+'\"').join(',')+'}':'';\n  return `# HELP ${n} ${help}\\n# TYPE ${n} gauge\\n${n}${lbl} ${v}\\n`;\n}\nlet out='';\nif (Number.isFinite(g.voltage)) out+=line('bms_voltage', g.voltage, 'Pack voltage in V');\nif (Number.isFinite(g.current)) out+=line('bms_current', g.current, 'Current in A');\nif (Number.isFinite(g.soc)) out+=line('bms_soc', g.soc, 'State of charge in percent');\nif (Number.isFinite(g.soh)) out+=line('bms_soh', g.soh, 'State of health in percent');\nif (Number.isFinite(g.temperature)) out+=line('bms_temperature', g.temperature, 'Temperature in C');\nif (g.voltage_limit) out+=line('bms_voltage_limit', g.voltage_limit, 'Voltage limit V');\nif (g.charge_limit) out+=line('bms_charge_limit', g.charge_limit, 'Charge current limit A');\nif (g.discharge_limit) out+=line('bms_discharge_limit', g.discharge_limit, 'Discharge current limit A');\nmsg.headers = {'Content-Type':'text/plain; version=0.0.4'};\nmsg.payload = out || '# no data yet\\n';\nreturn msg;\n",
    "outputs": 1,
    "noerr": 0,
    "x": 430,
    "y": 700,
    "wires": [
      [
        "63d077e8bb4cd"
      ]
    ]
  },
  {
    "id": "63d077e8bb4cd",
    "type": "http response",
    "z": "63d077e8ba67d",
    "name": "",
    "statusCode": "",
    "headers": {},
    "x": 690,
    "y": 700,
    "wires": []
  },
  {
    "id": "f75ededf7c88e695",
    "type": "comment",
    "z": "150517867e77a9f8",
    "name": "RX: deinen `socketcan-out (can0)` hier an den Eingang anschlie\u00dfen \u2192 `CAN-Telegramme zerlegen`",
    "info": "Kein `candump`, kein `socketcan-in`. Dieser Flow erwartet Frames im Format { timestamp, ext, canid, dlc, rtr, data } so wie bei dir gesehen.",
    "x": 360,
    "y": 420,
    "wires": []
  },
  {
    "id": "a07f3771794b733c",
    "type": "function",
    "z": "150517867e77a9f8",
    "name": "CAN-Telegramme zerlegen",
    "func": "var p = msg.payload;\nif (p && typeof p === 'object') {\n    var canid = (p.canid!=null)? p.canid.toString(16) : (p.can_id!=null? p.can_id.toString(16) : (typeof p.id==='number'? p.id.toString(16) : p.id));\n    msg.payload = { canid: (canid||'').toLowerCase(), dlc: p.dlc, data: p.data, timestamp: p.timestamp, ext: p.ext, rtr: p.rtr };\n    return msg;\n}\nreturn null;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 280,
    "y": 520,
    "wires": [
      [
        "854d0c0dd68d40b8",
        "ede4f770a9215a97",
        "f152b85bcb6992d6"
      ]
    ]
  },
  {
    "id": "854d0c0dd68d40b8",
    "type": "switch",
    "z": "150517867e77a9f8",
    "name": "nach CANID",
    "property": "msg.payload.canid",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "356",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "351",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "355",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "35c",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "359",
        "vt": "str"
      },
      {
        "t": "else"
      }
    ],
    "checkall": "true",
    "repair": false,
    "outputs": 6,
    "x": 590,
    "y": 460,
    "wires": [
      [
        "2673f530c1ab7d51"
      ],
      [
        "5cee79aa611829af"
      ],
      [
        "9549f45cfa098e9f"
      ],
      [
        "93f0f83dd6818c5a"
      ],
      [
        "a75d0ade2c5998d3",
        "e1e4921293aef509"
      ],
      []
    ]
  },
  {
    "id": "2673f530c1ab7d51",
    "type": "function",
    "z": "150517867e77a9f8",
    "name": "CAN_356",
    "func": "var payload = msg.payload;\nif (typeof payload === 'object' && payload !== null) {\n    var canid = parseInt(payload.canid,16);\n    var data = payload.data||[];\n    function u16(i){ return (data[i+1]<<8)|data[i]; }\n    function i16(i){ let v=u16(i); if(v&0x8000) v-=0x10000; return v; }\n    var voltage = +(u16(0) * 0.01).toFixed(2);\n    var current = +(i16(2) * 0.1).toFixed(1);\n    var temperature = +(i16(4) * 0.1).toFixed(1);\n    msg.payload = { canid: canid, voltage, current, temperature };\n    return msg;\n} else { return null; }",
    "outputs": 1,
    "noerr": 0,
    "x": 1010,
    "y": 160,
    "wires": [
      [
        "b4b95dc4a6453638",
        "046c46f20f6c44cc",
        "e570b3dad0e88df0"
      ]
    ]
  },
  {
    "id": "5cee79aa611829af",
    "type": "function",
    "z": "150517867e77a9f8",
    "name": "CAN_351",
    "func": "var payload = msg.payload;\nif (typeof payload === 'object' && payload !== null) {\n    var canid = parseInt(payload.canid,16);\n    var d = payload.data||[];\n    function u16(i){ return (d[i+1]<<8)|d[i]; }\n    function i16(i){ let v=u16(i); if(v&0x8000) v-=0x10000; return v; }\n    var voltage = u16(0) * 0.1;           // CVL\n    var charge_current = i16(2) * 0.1;    // CCL\n    var discharge_current = i16(4) * 0.1; // DCL\n    msg.payload = { canid: canid, voltage, charge_current, discharge_current };\n    return msg;\n} else { return null; }",
    "outputs": 1,
    "noerr": 0,
    "x": 1010,
    "y": 200,
    "wires": [
      [
        "e854a32a5f5f7ef1"
      ]
    ]
  },
  {
    "id": "9549f45cfa098e9f",
    "type": "function",
    "z": "150517867e77a9f8",
    "name": "CAN_355",
    "func": "var payload = msg.payload;\nif (typeof payload === 'object' && payload !== null) {\n    var canid = parseInt(payload.canid,16);\n    var d = payload.data||[];\n    var SOC = (d[1]<<8 | d[0]) * 1;\n    var SOH = (d[3]<<8 | d[2]) * 1;\n    msg.payload = { canid: canid, SOC, SOH };\n    return msg;\n} else { return null; }",
    "outputs": 1,
    "noerr": 0,
    "x": 1010,
    "y": 240,
    "wires": [
      [
        "f1c61880d2c40806"
      ]
    ]
  },
  {
    "id": "93f0f83dd6818c5a",
    "type": "function",
    "z": "150517867e77a9f8",
    "name": "CAN_35C",
    "func": "var payload = msg.payload;\nif (typeof payload === 'object' && payload !== null) {\n    var canid = parseInt(payload.canid,16);\n    var d = payload.data||[];\n    var b0 = d[0]||0;\n    var bit3 = !!(b0 & 0x08); // full charge request\n    var bit4 = !!(b0 & 0x10); // force charge II\n    var bit5 = !!(b0 & 0x20); // force charge I\n    var bit6 = !!(b0 & 0x40); // discharge enable\n    var bit7 = !!(b0 & 0x80); // charge enable\n    msg.payload = { canid, bit3, bit4, bit5, bit6, bit7 };\n    return msg;\n} else { return null; }",
    "outputs": 1,
    "noerr": 0,
    "x": 1010,
    "y": 280,
    "wires": [
      [
        "cd487c194c0f1650",
        "45f21a582d1780dc"
      ]
    ]
  },
  {
    "id": "a75d0ade2c5998d3",
    "type": "function",
    "z": "150517867e77a9f8",
    "name": "CAN_359 (fix)",
    "func": "var payload = msg.payload;\nif (typeof payload === 'object' && payload !== null) {\n    var canid = parseInt(payload.canid,16);\n    var data = payload.data||[];\n    var b0 = data[0]||0, b1=data[1]||0, b2=data[2]||0, b3=data[3]||0;\n    var out = {\n      canid: canid,\n      by0bit0: !!(b0&1), by0bit1: !!(b0&2), by0bit2: !!(b0&4), by0bit3: !!(b0&8),\n      by0bit4: !!(b0&16), by0bit5: !!(b0&32), by0bit6: !!(b0&64), by0bit7: !!(b0&128),\n      by1bit0: !!(b1&1), by1bit1: !!(b1&2), by1bit2: !!(b1&4), by1bit3: !!(b1&8),\n      by1bit4: !!(b1&16), by1bit5: !!(b1&32), by1bit6: !!(b1&64), by1bit7: !!(b1&128),\n      by2bit0: !!(b2&1), by2bit1: !!(b2&2), by2bit2: !!(b2&4), by2bit3: !!(b2&8),\n      by2bit4: !!(b2&16), by2bit5: !!(b2&32), by2bit6: !!(b2&64), by2bit7: !!(b2&128),\n      by3bit0: !!(b3&1), by3bit1: !!(b3&2), by3bit2: !!(b3&4), by3bit3: !!(b3&8),\n      by3bit4: !!(b3&16), by3bit5: !!(b3&32), by3bit6: !!(b3&64), by3bit7: !!(b3&128),\n      byte4: parseInt(data[4]||0), byte5: data[5], byte6: data[6]\n    };\n    msg.payload = out;\n    return msg;\n} else { return null; }",
    "outputs": 1,
    "noerr": 0,
    "x": 1020,
    "y": 320,
    "wires": [
      [
        "b57a926047c5dc72",
        "6dd1965c7d97d2d8"
      ]
    ]
  },
  {
    "id": "e1e4921293aef509",
    "type": "function",
    "z": "150517867e77a9f8",
    "name": "CAN_359_to_Table",
    "func": "var p = msg.payload; if (!p) return null;\nfunction row(name, val, addr){ return {Name:name, Boolean: !!val, Adresse: addr}; }\nvar rows = [];\nrows.push(row(\"Cell or module over voltage\", p.by0bit1, \"Byte 0 Bit 1\"));\nrows.push(row(\"Cell or module under voltage\", p.by0bit2, \"Byte 0 Bit 2\"));\nrows.push(row(\"Cell or module over Temp\", p.by0bit3, \"Byte 0 Bit 3\"));\nrows.push(row(\"Cell or module under Temp\", p.by0bit4, \"Byte 0 Bit 4\"));\nrows.push(row(\"Discharge over Current\", p.by0bit7, \"Byte 0 Bit 7\"));\nrows.push(row(\"Charge over Current\", p.by1bit0, \"Byte 1 Bit 0\"));\nrows.push(row(\"System error\", p.by1bit3, \"Byte 1 Bit 3\"));\nrows.push(row(\"Cell or module high voltage\", p.by2bit1, \"Byte 2 Bit 1\"));\nrows.push(row(\"Cell or module low voltage\", p.by2bit2, \"Byte 2 Bit 2\"));\nrows.push(row(\"Cell High Temp\", p.by2bit3, \"Byte 2 Bit 3\"));\nrows.push(row(\"Cell Low Temp\", p.by2bit4, \"Byte 2 Bit 4\"));\nrows.push(row(\"Discharge High Current\", p.by2bit7, \"Byte 2 Bit 7\"));\nrows.push(row(\"Charge High Current\", p.by3bit0, \"Byte 3 Bit 0\"));\nrows.push(row(\"Internal Communication failure\", p.by3bit3, \"Byte 3 Bit 3\"));\nmsg.payload = rows; return msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 1160,
    "y": 600,
    "wires": [
      [
        "6dd1965c7d97d2d8"
      ]
    ]
  },
  {
    "id": "ede4f770a9215a97",
    "type": "function",
    "z": "150517867e77a9f8",
    "name": "CAN-BMS Snapshot (Pylontech)",
    "func": "const CFG={TO:5000,REQ:[0x355,0x356,0x351],DB:0.3,DELTA:100,LOW:10};\nfunction u16(b,i){return b[i]|(b[i+1]<<8);}function i16(b,i){let v=u16(b,i);return (v&0x8000)?v-0x10000:v;}\nfunction hex(b){return Buffer.from(b).toString('hex').toUpperCase();}\nfunction mode(i){if(typeof i!=='number') return 'IDLE'; if(i>CFG.DB) return 'CHARGING'; if(i<-CFG.DB) return 'DISCHARGING'; return 'IDLE';}\nconst st=context.get('st')||{frames:{}}; const p=msg.payload||{}; let id=p.canid; if(typeof id==='string') id=parseInt(id,16); const d=Buffer.from(p.data||[]);\nif(!Number.isFinite(id)) return [null,null,{warning:'Invalid id'}];\nlet data=null;\nif(id===0x351&&d.length>=6) data={charge_voltage:u16(d,0)/10,max_charge_a:i16(d,2)/10,max_discharge_a:i16(d,4)/10};\nelse if(id===0x355&&d.length>=4) data={soc:u16(d,0),soh:u16(d,2)};\nelse if(id===0x356&&d.length>=6) data={voltage:i16(d,0)/100,current:i16(d,2)/10,temp:i16(d,4)/10};\nelse if(id===0x35C) data={flags_raw:hex(d)};\nelse if(id===0x370){const o={}; if(d.length>=2)o.temp_max=u16(d,0)/10; if(d.length>=4)o.temp_min=u16(d,2)/10; if(d.length>=6)o.cell_max_mv=u16(d,4); if(d.length>=8)o.cell_min_mv=u16(d,6); if(o.cell_max_mv!=null&&o.cell_min_mv!=null)o.cell_delta_mv=o.cell_max_mv-o.cell_min_mv; data=o;}\nelse if(id===0x35E) data={manufacturer:Buffer.from(d).toString('ascii').replace(/\\0/g,'').trim()};\nelse if(id===0x359) data={alarm_raw:hex(d)}; else data={};\nst.frames[id]={ts:Date.now(),data}; context.set('st',st);\nconst now=Date.now(); for(const r of CFG.REQ){ if(!st.frames[r]||now-st.frames[r].ts>CFG.TO) return [{topic:'can/bms/frame',payload:{id:'0x'+id.toString(16),parsed:data,ts:now}},null,null]; }\nconst snap={ts:now,ids:{}}; function merge(i){const fr=st.frames[i]; if(!fr) return; Object.assign(snap,fr.data); snap.ids[i]=fr.ts;}\n[0x355,0x356,0x351,0x370,0x35C,0x35E,0x359].forEach(merge);\nif(typeof snap.voltage==='number'&&typeof snap.current==='number'){snap.power=+(snap.voltage*snap.current).toFixed(1); snap.mode=mode(snap.current);} \nif(typeof snap.max_charge_a==='number') snap.charge_allowed=snap.max_charge_a>0; if(typeof snap.max_discharge_a==='number') snap.discharge_allowed=snap.max_discharge_a>0;\nlet status='OK'; if(snap.alarm_raw) status='ALARM'; else if(typeof snap.cell_delta_mv==='number'&&snap.cell_delta_mv>CFG.DELTA) status='WARNING'; else if(typeof snap.soc==='number'&&snap.soc<CFG.LOW) status='LOW_SOC';\nsnap.status=status;\nconst flat={manufacturer:snap.manufacturer,soc:snap.soc,soh:snap.soh,voltage:snap.voltage,current:snap.current,power:snap.power,temp:snap.temp,temp_max:snap.temp_max,temp_min:snap.temp_min,charge_voltage:snap.charge_voltage,max_charge_a:snap.max_charge_a,max_discharge_a:snap.max_discharge_a,charge_allowed:snap.charge_allowed,discharge_allowed:snap.discharge_allowed,cell_min_mv:snap.cell_min_mv,cell_max_mv:snap.cell_max_mv,cell_delta_mv:snap.cell_delta_mv,status:snap.status,mode:snap.mode};\nreturn [{topic:'can/bms/status',payload:{ts:snap.ts,data:snap,mqtt_friendly:flat}},null,null];",
    "outputs": 3,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 630,
    "y": 720,
    "wires": [
      [
        "2d78c83684fd0ade",
        "ce4be4eb433ca50b"
      ],
      [],
      []
    ]
  },
  {
    "id": "2d78c83684fd0ade",
    "type": "function",
    "z": "150517867e77a9f8",
    "name": "MQTT payload (mqtt_friendly)",
    "func": "var root=msg.payload||{}; var p=root.mqtt_friendly||root.data||{}; msg.payload=JSON.stringify(p); return msg;",
    "outputs": 1,
    "noerr": 0,
    "x": 970,
    "y": 880,
    "wires": [
      [
        "e22cd7c75bc975cd"
      ]
    ]
  },
  {
    "id": "e22cd7c75bc975cd",
    "type": "mqtt out",
    "z": "150517867e77a9f8",
    "name": "MQTT bms/status",
    "topic": "bms/status",
    "qos": "",
    "retain": "",
    "broker": "2444f8dc7ec4c282",
    "x": 1470,
    "y": 880,
    "wires": []
  },
  {
    "id": "ce4be4eb433ca50b",
    "type": "function",
    "z": "150517867e77a9f8",
    "name": "Snapshot \u2192 UI Fanout",
    "func": "const root = msg.payload || {}; const snap = root.data || root; const f = root.mqtt_friendly || {};\nconst soc=+(snap.soc ?? f.soc ?? 0); const soh=+(snap.soh ?? f.soh ?? 0);\nconst u=+(snap.voltage ?? f.voltage ?? 0); const i=+(snap.current ?? f.current ?? 0);\nconst p=+(snap.power ?? f.power ?? (u*i));\nconst t=+(snap.temp ?? f.temp ?? 0); const tmax=+(snap.temp_max ?? f.temp_max ?? t); const tmin=+(snap.temp_min ?? f.temp_min ?? t);\nconst cmax=+(snap.cell_max_mv ?? f.cell_max_mv ?? 0); const cmin=+(snap.cell_min_mv ?? f.cell_min_mv ?? 0);\nconst cdel=+(snap.cell_delta_mv ?? f.cell_delta_mv ?? (cmax-cmin));\nconst vchg=+(snap.charge_voltage ?? f.charge_voltage ?? 0);\nconst ichg=+(snap.max_charge_a ?? f.max_charge_a ?? 0);\nconst idis=+(snap.max_discharge_a ?? f.max_discharge_a ?? 0);\nconst chga= !!(snap.charge_allowed ?? f.charge_allowed ?? (ichg>0));\nconst disa= !!(snap.discharge_allowed ?? f.discharge_allowed ?? (idis>0));\nconst mode= String(snap.mode ?? f.mode ?? '');\nconst stat= String(snap.status ?? f.status ?? '');\nfunction led(color,on){ return {payload:!!on, color}; }\nfunction txt(s){ return {payload:s}; }\nfunction gauge(n){ return {payload:n}; }\nfunction chart(topic,val){ return {topic, payload:Number(val)}; }\nconst out=[];\nout[0]=gauge(soc); out[1]=gauge(u); out[2]=gauge(i); out[3]=gauge(t); out[4]=gauge(p);\nout[5]=txt(mode); out[6]=txt(stat + (soh? (' | SOH '+soh+'%') : ''));\nout[7]=led(stat==='ALARM'?'red':(stat==='WARNING' || stat==='LOW_SOC'?'yellow':'green'), true);\nout[8]=led(chga?'green':'grey', chga); out[9]=led(disa?'green':'grey', disa);\nout[10]=txt((cmin/1000).toFixed(3)+' V'); out[11]=txt((cmax/1000).toFixed(3)+' V'); out[12]=gauge(cdel);\nout[13]=chart('SoC', soc); out[14]=[chart('Voltage', u), chart('Current', i)]; out[15]=chart('Power', p);\nout[16]=[chart('PackTemp', t), chart('TempMax', tmax), chart('TempMin', tmin)]; out[17]=chart('CellDelta', cdel);\nout[18]=txt(`Vchg ${vchg.toFixed? vchg.toFixed(1):vchg} V | CCL ${ichg} A | DCL ${idis} A`);\nreturn out;",
    "outputs": 19,
    "noerr": 0,
    "x": 940,
    "y": 720,
    "wires": [
      [
        "f1c61880d2c40806"
      ],
      [
        "046c46f20f6c44cc"
      ],
      [
        "b4b95dc4a6453638"
      ],
      [
        "e570b3dad0e88df0"
      ],
      [
        "f2b161f9a182d3ed"
      ],
      [
        "f4ed051ae441117e"
      ],
      [
        "fa5d7e4e9b7c61da"
      ],
      [
        "67c1b87e874f021b"
      ],
      [
        "cd487c194c0f1650"
      ],
      [
        "45f21a582d1780dc"
      ],
      [
        "31fabaeb6a7570fa"
      ],
      [
        "2f46eaee39374314"
      ],
      [
        "23cda14f632fa815"
      ],
      [
        "e2443147cb37f5ab"
      ],
      [
        "9a7ecc42c00f595d"
      ],
      [
        "6ab605b472f1c0d5"
      ],
      [
        "d954eb130ef52402"
      ],
      [
        "b6b80243f3570721"
      ],
      [
        "e854a32a5f5f7ef1"
      ]
    ]
  },
  {
    "id": "f152b85bcb6992d6",
    "type": "function",
    "z": "150517867e77a9f8",
    "d": true,
    "name": "Raw-Historie (letzte 200)",
    "func": "const p=msg.payload||{}; const id = (p.canid||'').toString(); const dlc=p.dlc; const data = Array.isArray(p.data)? p.data : [];\nconst hex = data.map(b=> (b&0xff).toString(16).padStart(2,'0')).join('').toUpperCase();\nconst row = { ts: (p.timestamp||Date.now()), id: id, dlc: dlc, data_hex: hex };\nconst key='raw_hist'; const N=200;\nconst buf = flow.get(key) || [];\nbuf.push(row); if (buf.length>N) buf.shift();\nflow.set(key, buf);\nmsg.payload = buf.slice().reverse();\nreturn msg;",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 630,
    "y": 940,
    "wires": [
      [
        "1046d09ac587ee20",
        "1f8131b5926544bb"
      ]
    ]
  },
  {
    "id": "1f8131b5926544bb",
    "type": "mqtt out",
    "z": "150517867e77a9f8",
    "name": "MQTT bms/raw",
    "topic": "bms/raw",
    "qos": "",
    "retain": "",
    "broker": "2444f8dc7ec4c282",
    "x": 920,
    "y": 920,
    "wires": []
  },
  {
    "id": "f1c61880d2c40806",
    "type": "ui_gauge",
    "z": "150517867e77a9f8",
    "name": "SoC %",
    "group": "63d084d042e03",
    "order": 1,
    "width": 4,
    "height": 3,
    "gtype": "gage",
    "title": "SoC",
    "label": "%",
    "format": "{{value}}",
    "min": 0,
    "max": 100,
    "colors": [
      "#ff0000",
      "#f7c600",
      "#00b500"
    ],
    "seg1": 20,
    "seg2": 80,
    "diff": false,
    "className": "",
    "x": 1560,
    "y": 100,
    "wires": []
  },
  {
    "id": "046c46f20f6c44cc",
    "type": "ui_gauge",
    "z": "150517867e77a9f8",
    "name": "Voltage",
    "group": "63d084d042e03",
    "order": 2,
    "width": 4,
    "height": 3,
    "gtype": "gage",
    "title": "Spannung",
    "label": "V",
    "format": "{{value | number:2}}",
    "min": 40,
    "max": 60,
    "colors": [
      "#ca3838",
      "#1e88e5",
      "#1de9b6"
    ],
    "seg1": 48,
    "seg2": 58,
    "diff": false,
    "className": "",
    "x": 1560,
    "y": 140,
    "wires": []
  },
  {
    "id": "b4b95dc4a6453638",
    "type": "ui_gauge",
    "z": "150517867e77a9f8",
    "name": "Current",
    "group": "63d084d042e03",
    "order": 3,
    "width": 4,
    "height": 3,
    "gtype": "gage",
    "title": "Strom",
    "label": "A",
    "format": "{{value | number:1}}",
    "min": -300,
    "max": 300,
    "colors": [
      "#039be5",
      "#f7c600",
      "#ef6c00"
    ],
    "seg1": -50,
    "seg2": 50,
    "diff": false,
    "className": "",
    "x": 1560,
    "y": 180,
    "wires": []
  },
  {
    "id": "e570b3dad0e88df0",
    "type": "ui_gauge",
    "z": "150517867e77a9f8",
    "name": "Temp",
    "group": "63d084d042e03",
    "order": 4,
    "width": 4,
    "height": 3,
    "gtype": "gage",
    "title": "Pack-Temp",
    "label": "\u00b0C",
    "format": "{{value | number:1}}",
    "min": -10,
    "max": 70,
    "colors": [
      "#64b5f6",
      "#ffee58",
      "#ef5350"
    ],
    "seg1": 35,
    "seg2": 45,
    "diff": false,
    "className": "",
    "x": 1270,
    "y": 540,
    "wires": []
  },
  {
    "id": "f2b161f9a182d3ed",
    "type": "ui_gauge",
    "z": "150517867e77a9f8",
    "name": "Power",
    "group": "63d084d042e03",
    "order": 5,
    "width": 4,
    "height": 3,
    "gtype": "gage",
    "title": "Leistung",
    "label": "W",
    "format": "{{value | number:0}}",
    "min": -20000,
    "max": 20000,
    "colors": [
      "#1976d2",
      "#9e9e9e",
      "#d32f2f"
    ],
    "seg1": -2000,
    "seg2": 2000,
    "diff": false,
    "className": "",
    "x": 1270,
    "y": 580,
    "wires": []
  },
  {
    "id": "f4ed051ae441117e",
    "type": "ui_text",
    "z": "150517867e77a9f8",
    "group": "63d084d042e03",
    "order": 6,
    "width": 4,
    "height": 1,
    "name": "Mode",
    "label": "Modus",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": "",
    "color": "#000000",
    "x": 1270,
    "y": 620,
    "wires": []
  },
  {
    "id": "fa5d7e4e9b7c61da",
    "type": "ui_text",
    "z": "150517867e77a9f8",
    "group": "63d084d042e03",
    "order": 7,
    "width": 4,
    "height": 1,
    "name": "Status",
    "label": "Status",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": "",
    "color": "#000000",
    "x": 1270,
    "y": 660,
    "wires": []
  },
  {
    "id": "67c1b87e874f021b",
    "type": "ui_led",
    "z": "150517867e77a9f8",
    "order": 8,
    "group": "63d084d042ff2",
    "width": 2,
    "height": 1,
    "label": "Gesamt",
    "labelPlacement": "left",
    "labelAlignment": "center",
    "colorForValue": [
      {
        "color": "#ff0000",
        "value": "false",
        "valueType": "bool"
      },
      {
        "color": "#008000",
        "value": "true",
        "valueType": "bool"
      }
    ],
    "allowColorForValueInMessage": false,
    "shape": "circle",
    "showGlow": true,
    "name": "LED Status",
    "x": 1540,
    "y": 360,
    "wires": []
  },
  {
    "id": "cd487c194c0f1650",
    "type": "ui_led",
    "z": "150517867e77a9f8",
    "order": 9,
    "group": "63d084d042ff2",
    "width": 3,
    "height": 1,
    "label": "Charge allowed",
    "colorForValue": [
      {
        "color": "#ff0000",
        "value": "false",
        "valueType": "bool"
      },
      {
        "color": "#008000",
        "value": "true",
        "valueType": "bool"
      }
    ],
    "allowColorForValueInMessage": false,
    "shape": "circle",
    "showGlow": true,
    "name": "LED Charge",
    "x": 1550,
    "y": 400,
    "wires": []
  },
  {
    "id": "45f21a582d1780dc",
    "type": "ui_led",
    "z": "150517867e77a9f8",
    "order": 10,
    "group": "63d084d042ff2",
    "width": 3,
    "height": 1,
    "label": "Discharge allowed",
    "colorForValue": [
      {
        "color": "#ff0000",
        "value": "false",
        "valueType": "bool"
      },
      {
        "color": "#008000",
        "value": "true",
        "valueType": "bool"
      }
    ],
    "allowColorForValueInMessage": false,
    "shape": "circle",
    "showGlow": true,
    "name": "LED Disch",
    "x": 1570,
    "y": 440,
    "wires": []
  },
  {
    "id": "31fabaeb6a7570fa",
    "type": "ui_text",
    "z": "150517867e77a9f8",
    "group": "63d084d042e03",
    "order": 11,
    "width": 4,
    "height": 1,
    "name": "Cell min",
    "label": "Zelle min",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": "",
    "color": "#000000",
    "x": 1280,
    "y": 820,
    "wires": []
  },
  {
    "id": "2f46eaee39374314",
    "type": "ui_text",
    "z": "150517867e77a9f8",
    "group": "63d084d042e03",
    "order": 12,
    "width": 4,
    "height": 1,
    "name": "Cell max",
    "label": "Zelle max",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": "",
    "color": "#000000",
    "x": 1280,
    "y": 860,
    "wires": []
  },
  {
    "id": "23cda14f632fa815",
    "type": "ui_gauge",
    "z": "150517867e77a9f8",
    "name": "\u0394Zelle (mV)",
    "group": "63d084d042e03",
    "order": 13,
    "width": 4,
    "height": 3,
    "gtype": "gage",
    "title": "\u0394 mV",
    "label": "mV",
    "format": "{{value}}",
    "min": 0,
    "max": 200,
    "colors": [
      "#43a047",
      "#fdd835",
      "#e53935"
    ],
    "seg1": 30,
    "seg2": 100,
    "diff": false,
    "className": "",
    "x": 1280,
    "y": 900,
    "wires": []
  },
  {
    "id": "e854a32a5f5f7ef1",
    "type": "ui_text",
    "z": "150517867e77a9f8",
    "group": "63d084d042e03",
    "order": 14,
    "width": 12,
    "height": 1,
    "name": "Limits",
    "label": "Limits",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "className": "",
    "style": false,
    "font": "",
    "fontSize": "",
    "color": "#000000",
    "x": 1260,
    "y": 940,
    "wires": []
  },
  {
    "id": "e2443147cb37f5ab",
    "type": "ui_chart",
    "z": "150517867e77a9f8",
    "name": "SoC Verlauf",
    "group": "63d084d042ffa",
    "order": 1,
    "width": 6,
    "height": 4,
    "label": "SoC %",
    "chartType": "line",
    "legend": "false",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "0",
    "ymax": "100",
    "removeOlder": "24",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": "",
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#1de9b6",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 1280,
    "y": 1000,
    "wires": [
      []
    ]
  },
  {
    "id": "9a7ecc42c00f595d",
    "type": "ui_chart",
    "z": "150517867e77a9f8",
    "name": "U / I Verlauf",
    "group": "63d084d042ffa",
    "order": 2,
    "width": 6,
    "height": 4,
    "label": "U (V) / I (A)",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "auto",
    "ymax": "auto",
    "removeOlder": "24",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": "",
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#42a5f5",
      "#ef6c00",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 1280,
    "y": 1040,
    "wires": [
      []
    ]
  },
  {
    "id": "6ab605b472f1c0d5",
    "type": "ui_chart",
    "z": "150517867e77a9f8",
    "name": "Power Verlauf",
    "group": "63d084d042ffa",
    "order": 3,
    "width": 6,
    "height": 4,
    "label": "Leistung (W)",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "auto",
    "ymax": "auto",
    "removeOlder": "24",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": "",
    "useOneColor": true,
    "useUTC": false,
    "colors": [
      "#9ccc65",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 1280,
    "y": 1080,
    "wires": [
      []
    ]
  },
  {
    "id": "d954eb130ef52402",
    "type": "ui_chart",
    "z": "150517867e77a9f8",
    "name": "Temp Verlauf",
    "group": "63d084d042ffa",
    "order": 4,
    "width": 6,
    "height": 4,
    "label": "Temp (Pack/Max/Min)",
    "chartType": "line",
    "legend": "true",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "auto",
    "ymax": "auto",
    "removeOlder": "24",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": "",
    "useOneColor": false,
    "useUTC": false,
    "colors": [
      "#66bb6a",
      "#ef5350",
      "#42a5f5",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 1280,
    "y": 1120,
    "wires": [
      []
    ]
  },
  {
    "id": "b6b80243f3570721",
    "type": "ui_chart",
    "z": "150517867e77a9f8",
    "name": "\u0394 mV Verlauf",
    "group": "63d084d042ffa",
    "order": 5,
    "width": 6,
    "height": 4,
    "label": "Zell \u0394 (mV)",
    "chartType": "line",
    "legend": "false",
    "xformat": "HH:mm:ss",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "0",
    "ymax": "200",
    "removeOlder": "24",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": "",
    "useOneColor": true,
    "useUTC": false,
    "colors": [
      "#ab47bc",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000",
      "#000000"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 1280,
    "y": 1160,
    "wires": [
      []
    ]
  },
  {
    "id": "1046d09ac587ee20",
    "type": "ui_table",
    "z": "150517867e77a9f8",
    "group": "10919e9a9aebe48a",
    "name": "Telegramm-Historie",
    "order": 1,
    "width": 12,
    "height": 8,
    "columns": [
      {
        "field": "ts",
        "title": "Zeit",
        "formatter": "datetime",
        "formatterParams": {
          "inputFormat": "x",
          "outputFormat": "HH:mm:ss.SSS"
        }
      },
      {
        "field": "id",
        "title": "ID (hex)",
        "width": "100"
      },
      {
        "field": "dlc",
        "title": "DLC",
        "width": "60"
      },
      {
        "field": "data_hex",
        "title": "Daten (HEX)",
        "width": "400"
      }
    ],
    "outputs": 0,
    "cts": false,
    "x": 930,
    "y": 960,
    "wires": []
  },
  {
    "id": "b57a926047c5dc72",
    "type": "function",
    "z": "150517867e77a9f8",
    "name": "HTML Alarm-Matrix",
    "func": "var p=msg.payload||{}; var html='<table border=\"1\">'+\n'<tr><th>Key</th><th>Value</th></tr>'+ \n`<tr><td>canid</td><td>${p.canid}</td></tr>`+\n`<tr><td>Cell or module over voltage</td><td style=\"color:${p.by0bit1?'lime':'red'};\">${p.by0bit1}</td></tr>`+\n`<tr><td>Cell or module under voltage</td><td style=\"color:${p.by0bit2?'lime':'red'};\">${p.by0bit2}</td></tr>`+\n`<tr><td>Cell or module over Temp</td><td style=\"color:${p.by0bit3?'lime':'red'};\">${p.by0bit3}</td></tr>`+\n`<tr><td>Cell or module under Temp</td><td style=\"color:${p.by0bit4?'lime':'red'};\">${p.by0bit4}</td></tr>`+\n`<tr><td>Discharge over Current</td><td style=\"color:${p.by0bit7?'lime':'red'};\">${p.by0bit7}</td></tr>`+\n`<tr><td>Charge over Current</td><td style=\"color:${p.by1bit0?'lime':'red'};\">${p.by1bit0}</td></tr>`+\n`<tr><td>System error</td><td style=\"color:${p.by1bit3?'lime':'red'};\">${p.by1bit3}</td></tr>`+\n`<tr><td>Cell or module high voltage</td><td style=\"color:${p.by2bit1?'lime':'red'};\">${p.by2bit1}</td></tr>`+\n`<tr><td>Cell or module low voltage</td><td style=\"color:${p.by2bit2?'lime':'red'};\">${p.by2bit2}</td></tr>`+\n`<tr><td>Cell High Temp</td><td style=\"color:${p.by2bit3?'lime':'red'};\">${p.by2bit3}</td></tr>`+\n`<tr><td>Cell Low Temp</td><td style=\"color:${p.by2bit4?'lime':'red'};\">${p.by2bit4}</td></tr>`+\n`<tr><td>Discharge High Current</td><td style=\"color:${p.by2bit7?'lime':'red'};\">${p.by2bit7}</td></tr>`+\n`<tr><td>Charge High Current</td><td style=\"color:${p.by3bit0?'lime':'red'};\">${p.by3bit0}</td></tr>`+\n`<tr><td>Internal Communication failure</td><td style=\"color:${p.by3bit3?'lime':'red'};\">${p.by3bit3}</td></tr>`+\n'</table>'; return {payload:html};",
    "outputs": 1,
    "noerr": 0,
    "x": 1290,
    "y": 320,
    "wires": [
      [
        "9088d3ee9fed5112"
      ]
    ]
  },
  {
    "id": "9088d3ee9fed5112",
    "type": "ui_template",
    "z": "150517867e77a9f8",
    "group": "63d084d042ddd",
    "name": "Alarm HTML",
    "order": 2,
    "width": 12,
    "height": 7,
    "format": "<div ng-bind-html=\"msg.payload | trusted\"></div>",
    "storeOutMessages": true,
    "fwdInMessages": true,
    "resendOnRefresh": false,
    "templateScope": "local",
    "className": "",
    "x": 1550,
    "y": 320,
    "wires": [
      []
    ]
  },
  {
    "id": "6dd1965c7d97d2d8",
    "type": "ui_table",
    "z": "150517867e77a9f8",
    "group": "c4ebe5b96811d749",
    "name": "Alarm-Tabelle",
    "order": 1,
    "width": 12,
    "height": 8,
    "columns": [
      {
        "field": "Name",
        "title": "Beschreibung",
        "align": "left",
        "formatter": "plaintext"
      },
      {
        "field": "Boolean",
        "title": "True/False",
        "width": "80",
        "align": "center",
        "formatter": "tickCross"
      },
      {
        "field": "Adresse",
        "title": "Adresse",
        "align": "left",
        "formatter": "plaintext"
      }
    ],
    "outputs": 0,
    "cts": false,
    "x": 1400,
    "y": 600,
    "wires": []
  },
  {
    "id": "9ed61d1e54e41041",
    "type": "socketcan-out",
    "z": "150517867e77a9f8",
    "name": "socketcan-out",
    "config": "f534d1e5074abc96",
    "x": 170,
    "y": 660,
    "wires": [
      [
        "a07f3771794b733c"
      ]
    ]
  },
  {
    "id": "5c83d74e42b417f6",
    "type": "inject",
    "z": "150517867e77a9f8",
    "name": "",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 340,
    "y": 1700,
    "wires": [
      []
    ]
  },
  {
    "id": "e9146f5180f7aaae",
    "type": "exec",
    "z": "150517867e77a9f8",
    "command": "whoami id sudo -n true; echo $?",
    "addpay": "",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "winHide": false,
    "oldrc": false,
    "name": "",
    "x": 1390,
    "y": 1740,
    "wires": [
      [
        "18a0a5b65ca59fd6"
      ],
      [],
      []
    ]
  },
  {
    "id": "8235becd49dadc3b",
    "type": "inject",
    "z": "150517867e77a9f8",
    "name": "",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 1020,
    "y": 1740,
    "wires": [
      [
        "e9146f5180f7aaae"
      ]
    ]
  },
  {
    "id": "18a0a5b65ca59fd6",
    "type": "debug",
    "z": "150517867e77a9f8",
    "name": "debug 24",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "false",
    "statusVal": "",
    "statusType": "auto",
    "x": 1800,
    "y": 1700,
    "wires": []
  },
  {
    "id": "inj_hostcheck_01",
    "type": "inject",
    "z": "tab_hostcheck_01",
    "name": "Starte Host-Check",
    "props": [
      {
        "p": "payload"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 170,
    "y": 120,
    "wires": [
      [
        "fn_cmd_01"
      ]
    ]
  },
  {
    "id": "fn_cmd_01",
    "type": "function",
    "z": "tab_hostcheck_01",
    "name": "Befehle setzen",
    "func": "msg.payload = \"echo '--- whoami ---'; whoami; echo '--- id ---'; id; echo '--- sudo test ---'; sudo -n true; echo sudo_exit:$?; echo '--- user list ---'; cut -d: -f1 /etc/passwd\";\nreturn msg;",
    "outputs": 1,
    "timeout": 0,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 390,
    "y": 120,
    "wires": [
      [
        "exec_hostcheck_01"
      ]
    ]
  },
  {
    "id": "exec_hostcheck_01",
    "type": "exec",
    "z": "tab_hostcheck_01",
    "command": "",
    "addpay": "payload",
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "winHide": false,
    "oldrc": false,
    "name": "exec",
    "x": 580,
    "y": 120,
    "wires": [
      [
        "dbg_stdout_01"
      ],
      [
        "dbg_stderr_01"
      ],
      [
        "dbg_rc_01"
      ]
    ]
  },
  {
    "id": "dbg_stdout_01",
    "type": "debug",
    "z": "tab_hostcheck_01",
    "name": "STDOUT",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 770,
    "y": 80,
    "wires": []
  },
  {
    "id": "dbg_stderr_01",
    "type": "debug",
    "z": "tab_hostcheck_01",
    "name": "STDERR",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 770,
    "y": 120,
    "wires": []
  },
  {
    "id": "dbg_rc_01",
    "type": "debug",
    "z": "tab_hostcheck_01",
    "name": "Return Code",
    "active": true,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 780,
    "y": 160,
    "wires": []
  },
  {
    "id": "ui_tpl_reset_menu_01",
    "type": "ui_template",
    "z": "tab-rs485-poller",
    "group": "",
    "name": "UI LocalStorage Reset",
    "order": 0,
    "width": 0,
    "height": 0,
    "format": "<script>(function(){try{if(sessionStorage.getItem('nr_ui_reset_done')) return; var changed=false; Object.keys(localStorage).forEach(function(k){ if(/^th\\d+/.test(k)||/^td\\d+/.test(k)||/^g[A-Za-z0-9_]+$/.test(k)){ localStorage.removeItem(k); changed=true; }}); sessionStorage.setItem('nr_ui_reset_done','1'); if(changed){ setTimeout(function(){ location.reload(); }, 50); }}catch(e){}})();</script>",
    "storeOutMessages": true,
    "fwdInMessages": true,
    "resendOnRefresh": true,
    "templateScope": "global",
    "className": "",
    "x": 260,
    "y": 10420,
    "wires": [
      []
    ]
  },
  {
    "id": "lout_status_01",
    "type": "link out",
    "z": "tab-rs485-poller",
    "name": "OUT1 -> RS485 Dashboard Status",
    "mode": "link",
    "links": [
      "lin_status_277c4db6"
    ],
    "x": 1120,
    "y": 10260,
    "wires": []
  },
  {
    "id": "lout_alarms_01",
    "type": "link out",
    "z": "tab-rs485-poller",
    "name": "OUT2 -> RS485 Dashboard Alarms",
    "mode": "link",
    "links": [
      "lin_alarms_fdc21ec8"
    ],
    "x": 1130,
    "y": 10320,
    "wires": []
  },
  {
    "id": "lout_params_01",
    "type": "link out",
    "z": "tab-rs485-poller",
    "name": "OUT3 -> RS485 Dashboard Params",
    "mode": "link",
    "links": [
      "lin_params_c089092a"
    ],
    "x": 1120,
    "y": 10380,
    "wires": []
  },
  {
    "id": "inj_fast_tick_10s",
    "type": "inject",
    "z": "tab-rs485-poller",
    "name": "Fast Tick 10s (gated)",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "10",
    "crontab": "",
    "once": true,
    "onceDelay": "2",
    "topic": "fast_tick",
    "payload": "tick",
    "payloadType": "str",
    "x": 140,
    "y": 120,
    "wires": [
      [
        "fn-scheduler"
      ]
    ]
  },
  {
    "id": "lin_fast_mode_ctrl",
    "type": "link in",
    "z": "tab-rs485-poller",
    "name": "FAST_MODE_CTRL",
    "links": [
      "lout_fast_mode_ctrl"
    ],
    "x": 130,
    "y": 160,
    "wires": [
      [
        "fn_fast_mode_ctrl"
      ]
    ]
  },
  {
    "id": "fn_fast_mode_ctrl",
    "type": "function",
    "z": "tab-rs485-poller",
    "name": "Set Fast Mode",
    "func": "flow.set('RS485_DEBUG_FAST', !!msg.payload); return null;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 340,
    "y": 160,
    "wires": [
      []
    ]
  },
  {
    "id": "lin_poll_now_ctrl",
    "type": "link in",
    "z": "tab-rs485-poller",
    "name": "POLL_NOW_CTRL",
    "links": [
      "lout_poll_now_ctrl"
    ],
    "x": 130,
    "y": 280,
    "wires": [
      [
        "fn-scheduler"
      ]
    ]
  },
  {
    "id": "lin_limits_now_ctrl",
    "type": "link in",
    "z": "tab-rs485-poller",
    "name": "LIMITS_NOW_CTRL",
    "links": [
      "lout_limits_now_ctrl"
    ],
    "x": 130,
    "y": 240,
    "wires": [
      [
        "fn-scheduler"
      ]
    ]
  },
  {
    "id": "ui_sw_fast_poll",
    "type": "ui_switch",
    "z": "tab_a3412f46",
    "name": "Fast Poll 10s",
    "label": "Fast Poll 10s",
    "tooltip": "",
    "group": "grp2_379a7d9d",
    "order": 3,
    "width": "6",
    "height": "1",
    "passthru": true,
    "decouple": "false",
    "topic": "fast_mode",
    "topicType": "str",
    "style": "",
    "onvalue": "true",
    "onvalueType": "bool",
    "onicon": "",
    "oncolor": "",
    "offvalue": "false",
    "offvalueType": "bool",
    "officon": "",
    "offcolor": "",
    "animate": false,
    "className": "",
    "x": 210,
    "y": 280,
    "wires": [
      [
        "fn_ui_fast_mode"
      ]
    ]
  },
  {
    "id": "fn_ui_fast_mode",
    "type": "function",
    "z": "tab_a3412f46",
    "name": "UI -> Fast Mode",
    "func": "msg.topic='fast_mode'; msg.payload=!!msg.payload; return msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 420,
    "y": 280,
    "wires": [
      [
        "lout_fast_mode_ctrl"
      ]
    ]
  },
  {
    "id": "lout_fast_mode_ctrl",
    "type": "link out",
    "z": "tab_a3412f46",
    "name": "FAST_MODE_CTRL",
    "mode": "link",
    "links": [
      "lin_fast_mode_ctrl"
    ],
    "x": 640,
    "y": 280,
    "wires": []
  },
  {
    "id": "ui_btn_poll_now",
    "type": "ui_button",
    "z": "tab_a3412f46",
    "name": "Poll jetzt",
    "group": "grp2_379a7d9d",
    "order": 4,
    "width": "3",
    "height": "1",
    "passthru": false,
    "label": "Poll jetzt",
    "tooltip": "Sofortige 0x42-Abfrage",
    "color": "",
    "bgcolor": "",
    "className": "",
    "icon": "refresh",
    "payload": "poll_now",
    "payloadType": "str",
    "topic": "poll_now",
    "x": 200,
    "y": 330,
    "wires": [
      [
        "lout_poll_now_ctrl"
      ]
    ]
  },
  {
    "id": "lout_poll_now_ctrl",
    "type": "link out",
    "z": "tab_a3412f46",
    "name": "POLL_NOW_CTRL",
    "mode": "link",
    "links": [
      "lin_poll_now_ctrl"
    ],
    "x": 420,
    "y": 330,
    "wires": []
  },
  {
    "id": "ui_btn_limits_now",
    "type": "ui_button",
    "z": "tab_a3412f46",
    "name": "Limits jetzt",
    "group": "grp2_379a7d9d",
    "order": 5,
    "width": "3",
    "height": "1",
    "passthru": false,
    "label": "Limits jetzt",
    "tooltip": "Sofortige 0x47-Abfrage",
    "color": "",
    "bgcolor": "",
    "className": "",
    "icon": "playlist_add_check",
    "payload": "limits_now",
    "payloadType": "str",
    "topic": "limits_now",
    "x": 200,
    "y": 370,
    "wires": [
      [
        "lout_limits_now_ctrl"
      ]
    ]
  },
  {
    "id": "lout_limits_now_ctrl",
    "type": "link out",
    "z": "tab_a3412f46",
    "name": "LIMITS_NOW_CTRL",
    "mode": "link",
    "links": [
      "lin_limits_now_ctrl"
    ],
    "x": 430,
    "y": 370,
    "wires": []
  },
  {
    "id": "ui_tpl_limits_pretty",
    "type": "ui_template",
    "z": "tab_a3412f46",
    "group": "grp5_c1450fb3",
    "name": "Limits Card",
    "order": 1,
    "width": 12,
    "height": 6,
    "format": "<div ng-bind-html=\"msg.payload | trusted\"></div>",
    "storeOutMessages": true,
    "fwdInMessages": true,
    "resendOnRefresh": true,
    "templateScope": "local",
    "className": "",
    "x": 760,
    "y": 540,
    "wires": [
      []
    ]
  },
  {
    "id": "ui_tpl_id_pretty",
    "type": "ui_template",
    "z": "tab_a3412f46",
    "group": "grp5_c1450fb3",
    "name": "Identity Card",
    "order": 2,
    "width": 12,
    "height": 4,
    "format": "<div ng-bind-html=\"msg.payload | trusted\"></div>",
    "storeOutMessages": true,
    "fwdInMessages": true,
    "resendOnRefresh": true,
    "templateScope": "local",
    "className": "",
    "x": 980,
    "y": 540,
    "wires": [
      []
    ]
  },
  {
    "id": "inj_limits_boot_once",
    "type": "inject",
    "z": "tab-rs485-poller",
    "name": "Limits once on start",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": true,
    "onceDelay": "4",
    "topic": "limits_now",
    "payload": "limits_now",
    "payloadType": "str",
    "x": 150,
    "y": 300,
    "wires": [
      [
        "fn-scheduler"
      ]
    ]
  },
  {
    "id": "uitab_rs485_service_01",
    "type": "ui_tab",
    "name": "RS485 Service",
    "icon": "build",
    "order": 11,
    "disabled": false,
    "hidden": false
  },
  {
    "id": "grp_rs485_service_cmd",
    "type": "ui_group",
    "name": "Service Write (Expert)",
    "tab": "uitab_rs485_service_01",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "grp_rs485_service_status",
    "type": "ui_group",
    "name": "Status",
    "tab": "uitab_rs485_service_01",
    "order": 2,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "ui_tpl_rs485_service_help",
    "type": "ui_template",
    "z": "tab_a3412f46",
    "group": "grp_rs485_service_cmd",
    "name": "Service Help",
    "order": 1,
    "width": 12,
    "height": 2,
    "format": "<div style=\"padding:10px;border:1px solid #455a64;border-radius:8px;background:#102027;line-height:1.35\">Write-Frame Builder (ASCII-Hex). Service 83/B0 mit Operation 02 ist moeglich, aber auf eigenes Risiko. Erst mit Dry-Run testen.</div>",
    "storeOutMessages": true,
    "fwdInMessages": true,
    "resendOnRefresh": true,
    "templateScope": "local",
    "className": "",
    "x": 220,
    "y": 740,
    "wires": [
      []
    ]
  },
  {
    "id": "ui_form_rs485_service_write",
    "type": "ui_form",
    "z": "tab_a3412f46",
    "name": "RS485 Service Write Form",
    "label": "Frame Builder",
    "group": "grp_rs485_service_cmd",
    "order": 2,
    "width": 12,
    "height": 10,
    "options": [
      {
        "label": "Adresse (HEX)",
        "value": "addr",
        "type": "text",
        "required": true
      },
      {
        "label": "CID2 Service (HEX)",
        "value": "cid2",
        "type": "text",
        "required": true
      },
      {
        "label": "Operation (HEX)",
        "value": "op",
        "type": "text",
        "required": false
      },
      {
        "label": "Module (HEX)",
        "value": "module",
        "type": "text",
        "required": false
      },
      {
        "label": "Function ID (HEX)",
        "value": "fid",
        "type": "text",
        "required": false
      },
      {
        "label": "Function LEN (HEX)",
        "value": "flen",
        "type": "text",
        "required": false
      },
      {
        "label": "Passwort HEX (optional)",
        "value": "pwd",
        "type": "text",
        "required": false
      },
      {
        "label": "Data HEX (optional)",
        "value": "data",
        "type": "text",
        "required": false
      },
      {
        "label": "Kompletter Frame (optional)",
        "value": "full",
        "type": "text",
        "required": false
      },
      {
        "label": "Dry-Run (nicht senden)",
        "value": "dry",
        "type": "switch",
        "required": false
      }
    ],
    "formValue": {
      "addr": "01",
      "cid2": "B0",
      "op": "02",
      "module": "01",
      "fid": "00",
      "flen": "00",
      "pwd": "",
      "data": "",
      "full": "",
      "dry": true
    },
    "payload": "{}",
    "submit": "Build/Send",
    "cancel": "Reset",
    "topic": "",
    "x": 260,
    "y": 800,
    "wires": [
      [
        "fn_rs485_service_buildsend"
      ]
    ]
  },
  {
    "id": "fn_rs485_service_buildsend",
    "type": "function",
    "z": "tab_a3412f46",
    "name": "Build+Send Service Frame",
    "outputs": 2,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "func": "function cleanHex(s){ return String(s||'').toUpperCase().replace(/[^0-9A-F]/g,''); }\nfunction toHex(n,len){ return Number(n).toString(16).toUpperCase().padStart(len,'0'); }\nfunction lchk(lenId){ var n0=lenId&0xF, n1=(lenId>>4)&0xF, n2=(lenId>>8)&0xF; var sum=(n0+n1+n2)&0xF; return (((~sum)&0xF)+1)&0xF; }\nfunction checksum(frameNoCrc){ var a=0; for(var i=1;i<frameNoCrc.length;i++) a+=frameNoCrc.charCodeAt(i); return (((~a)&0xFFFF)+1)&0xFFFF; }\n\nvar p=(msg&&msg.payload&&typeof msg.payload==='object')?msg.payload:{};\nvar dry = !!p.dry;\nvar full = cleanHex(p.full||'');\nvar frame='';\nvar addr='01';\nvar svc=0x42;\n\nif (full && full.indexOf('7E')!==0){\n  // user likely entered ~ removed by cleanHex, prepend not needed in hex-only path\n}\n\nif (full && full.length>=16){\n  // full frame provided as hex without ~ / CR\n  if (full.startsWith('22')) frame = '~' + full + '\\r';\n  else if (full.startsWith('7E22')) frame = String.fromCharCode(0x7E) + full.slice(2) + '\\r';\n} else {\n  addr = cleanHex(p.addr||'01').padStart(2,'0').slice(-2);\n  var cid2 = cleanHex(p.cid2||'B0').padStart(2,'0').slice(-2);\n  svc = parseInt(cid2,16);\n  var op = cleanHex(p.op||'').padStart(2,'0').slice(-2);\n  var mod = cleanHex(p.module||'').padStart(2,'0').slice(-2);\n  var fid = cleanHex(p.fid||'').padStart(2,'0').slice(-2);\n  var flen = cleanHex(p.flen||'').padStart(2,'0').slice(-2);\n  var pwd = cleanHex(p.pwd||'');\n  var data = cleanHex(p.data||'');\n\n  var info='';\n  if (cid2==='42' || cid2==='44') info = addr;\n  else if (cid2==='47') info = addr;\n  else if (cid2==='83') info = addr + (op||'01') + (data||'');\n  else if (cid2==='B0') info = addr + (op||'01') + (mod||'03') + (fid||'FF') + (flen||'00') + pwd + data;\n  else info = addr + op + mod + fid + flen + pwd + data;\n\n  var lenId = info.length;\n  var lenWord = ((lchk(lenId)&0xF)<<12) | (lenId&0xFFF);\n  var lenHex = toHex(lenWord,4);\n  var prefix='~22'+addr+'4A'+cid2+lenHex+info;\n  var crc=toHex(checksum(prefix),4);\n  frame = prefix+crc+'\\r';\n}\n\nif (!frame || frame.indexOf('~22')!==0){\n  return [null,{payload:'FEHLER: Kein gueltiger Frame erzeugt.'}];\n}\n\nvar adr = frame.substr(3,2);\nvar cid2out = frame.substr(7,2);\nmsg.payload = frame;\nmsg.addr = adr;\nmsg.service = parseInt(cid2out,16);\nmsg._req = { adr: parseInt(adr,16), svc: msg.service, ts: Date.now(), manual: true };\n\nvar status='TX '+(dry?'(Dry-Run) ':'')+frame.trim();\nif (dry) return [null,{payload:status}];\n\nflow.set('RS485_BUSY', true);\nflow.set('RS485_LAST_SENT', Date.now());\nflow.set('RS485_LAST_REQ', msg._req);\nreturn [msg,{payload:status}];",
    "x": 560,
    "y": 800,
    "wires": [
      [
        "lout_rs485_service_tx",
        "5834f31419504261"
      ],
      [
        "ui_txt_rs485_service_status"
      ]
    ]
  },
  {
    "id": "lout_rs485_service_tx",
    "type": "link out",
    "z": "tab_a3412f46",
    "name": "Service TX -> RS485 serial request",
    "mode": "link",
    "links": [
      "08349c8549bc7f16"
    ],
    "x": 900,
    "y": 780,
    "wires": []
  },
  {
    "id": "ui_txt_rs485_service_status",
    "type": "ui_text",
    "z": "tab_a3412f46",
    "group": "grp_rs485_service_status",
    "order": 1,
    "width": 12,
    "height": 4,
    "name": "Service TX Status",
    "label": "Letzter Service-Frame",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 900,
    "y": 820,
    "wires": []
  },
  {
    "id": "grp_rs485_service_tune",
    "type": "ui_group",
    "name": "BMS Tuning",
    "tab": "uitab_rs485_service_01",
    "order": 0,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "ui_form_rs485_tune",
    "type": "ui_form",
    "z": "tab_a3412f46",
    "name": "BMS Tune Form",
    "label": "Ladeprofil",
    "group": "grp_rs485_service_tune",
    "order": 1,
    "width": 12,
    "height": 8,
    "options": [
      {
        "label": "Profilname",
        "value": "name",
        "type": "text",
        "required": true
      },
      {
        "label": "Ladespannung (V)",
        "value": "charge_v",
        "type": "number",
        "required": true
      },
      {
        "label": "Float-Spannung (V)",
        "value": "float_v",
        "type": "number",
        "required": true
      },
      {
        "label": "Max Lade-A (A)",
        "value": "charge_a",
        "type": "number",
        "required": true
      },
      {
        "label": "Max Entlade-A (A)",
        "value": "discharge_a",
        "type": "number",
        "required": true
      },
      {
        "label": "SOC Derate Start %",
        "value": "soc_start",
        "type": "number",
        "required": true
      },
      {
        "label": "SOC Derate Stop %",
        "value": "soc_stop",
        "type": "number",
        "required": true
      },
      {
        "label": "Tchg Derate Start C",
        "value": "t_start",
        "type": "number",
        "required": true
      },
      {
        "label": "Tchg Derate Stop C",
        "value": "t_stop",
        "type": "number",
        "required": true
      },
      {
        "label": "Nur simulieren",
        "value": "dry",
        "type": "switch",
        "required": false
      }
    ],
    "formValue": {
      "name": "Standard",
      "charge_v": 56.8,
      "float_v": 54,
      "charge_a": 50,
      "discharge_a": 100,
      "soc_start": 90,
      "soc_stop": 99,
      "t_start": 40,
      "t_stop": 50,
      "dry": true
    },
    "payload": "{}",
    "submit": "Profil anwenden",
    "cancel": "Reset",
    "topic": "",
    "x": 190,
    "y": 880,
    "wires": [
      [
        "fn_rs485_tune_apply"
      ]
    ]
  },
  {
    "id": "fn_rs485_tune_apply",
    "type": "function",
    "z": "tab_a3412f46",
    "name": "Apply Tune + Build Curve",
    "outputs": 2,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "func": "var p=(msg&&msg.payload&&typeof msg.payload==='object')?msg.payload:{};\nfunction num(k,d){ var x=Number(p[k]); return Number.isFinite(x)?x:d; }\nvar cfg={\n  name:String(p.name||'Standard'),\n  charge_v:num('charge_v',56.8),\n  float_v:num('float_v',54.0),\n  charge_a:num('charge_a',50),\n  discharge_a:num('discharge_a',100),\n  soc_start:num('soc_start',90),\n  soc_stop:num('soc_stop',99),\n  t_start:num('t_start',40),\n  t_stop:num('t_stop',50),\n  dry:!!p.dry,\n  ts:Date.now()\n};\nif(cfg.soc_stop<cfg.soc_start){ var t=cfg.soc_stop; cfg.soc_stop=cfg.soc_start; cfg.soc_start=t; }\nif(cfg.t_stop<cfg.t_start){ var tt=cfg.t_stop; cfg.t_stop=cfg.t_start; cfg.t_start=tt; }\n\nflow.set('RS485_SERVICE_PROFILE',cfg);\n\nfunction clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }\nfunction socFactor(s){\n  if (s<=cfg.soc_start) return 1;\n  if (s>=cfg.soc_stop) return 0.1;\n  var k=(s-cfg.soc_start)/(cfg.soc_stop-cfg.soc_start||1);\n  return 1-(0.9*k);\n}\nfunction tempFactor(t){\n  if (t<=cfg.t_start) return 1;\n  if (t>=cfg.t_stop) return 0.2;\n  var k=(t-cfg.t_start)/(cfg.t_stop-cfg.t_start||1);\n  return 1-(0.8*k);\n}\n\nvar rows=[];\nfor(var s=0;s<=100;s+=10){\n  var f=socFactor(s);\n  rows.push({soc:s, a: +(cfg.charge_a*f).toFixed(1)});\n}\n\nvar trows=[];\nfor(var t=0;t<=60;t+=5){\n  var f=tempFactor(t);\n  trows.push({t:t, a:+(cfg.charge_a*f).toFixed(1)});\n}\n\nvar html='';\nhtml+='<div style=\"padding:12px;border:1px solid #455a64;border-radius:10px;background:#102027\">';\nhtml+='<div style=\"font-size:18px;font-weight:700;margin-bottom:8px\">'+cfg.name+' - Ladeprofil</div>';\nhtml+='<div style=\"margin-bottom:8px\">Uchg '+cfg.charge_v.toFixed(2)+' V | Ufloat '+cfg.float_v.toFixed(2)+' V | Ichg '+cfg.charge_a.toFixed(1)+' A | Idis '+cfg.discharge_a.toFixed(1)+' A</div>';\nhtml+='<div style=\"display:grid;grid-template-columns:1fr 1fr;gap:12px\">';\nhtml+='<div><div style=\"font-weight:700;margin-bottom:6px\">SOC Derating</div>';\nfor(var i=0;i<rows.length;i++){ var r=rows[i]; var w=Math.round((r.a/cfg.charge_a)*100); html+='<div style=\"display:flex;gap:8px;align-items:center;margin:2px 0\"><div style=\"width:44px\">'+r.soc+'%</div><div style=\"flex:1;background:#263238;height:10px;border-radius:6px\"><div style=\"width:'+w+'%;height:10px;background:#4db6ac;border-radius:6px\"></div></div><div style=\"width:52px;text-align:right\">'+r.a+'A</div></div>'; }\nhtml+='</div>';\nhtml+='<div><div style=\"font-weight:700;margin-bottom:6px\">Temp Derating</div>';\nfor(var j=0;j<trows.length;j++){ var q=trows[j]; var w2=Math.round((q.a/cfg.charge_a)*100); html+='<div style=\"display:flex;gap:8px;align-items:center;margin:2px 0\"><div style=\"width:44px\">'+q.t+'C</div><div style=\"flex:1;background:#263238;height:10px;border-radius:6px\"><div style=\"width:'+w2+'%;height:10px;background:#ffb74d;border-radius:6px\"></div></div><div style=\"width:52px;text-align:right\">'+q.a+'A</div></div>'; }\nhtml+='</div>';\nhtml+='</div>';\nhtml+='<div style=\"margin-top:10px;color:#b0bec5\">Hinweis: Dieses Profil wirkt aktuell als Regel-/Sollwertprofil in Node-RED. Persistente BMS-Write-Kommandos weiterhin ueber Service Write (Expert).</div>';\nhtml+='</div>';\n\nvar summary='Profil '+cfg.name+' gespeichert | Dry='+cfg.dry+' | Uchg='+cfg.charge_v+'V | Ufloat='+cfg.float_v+'V | Ichg='+cfg.charge_a+'A | Idis='+cfg.discharge_a+'A';\nreturn [{payload:summary},{payload:html}];",
    "x": 530,
    "y": 880,
    "wires": [
      [
        "ui_txt_rs485_tune_status"
      ],
      [
        "ui_tpl_rs485_tune_curve"
      ]
    ]
  },
  {
    "id": "ui_txt_rs485_tune_status",
    "type": "ui_text",
    "z": "tab_a3412f46",
    "group": "grp_rs485_service_tune",
    "order": 2,
    "width": 12,
    "height": 1,
    "name": "Tune Status",
    "label": "Profilstatus",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 860,
    "y": 860,
    "wires": []
  },
  {
    "id": "ui_tpl_rs485_tune_curve",
    "type": "ui_template",
    "z": "tab_a3412f46",
    "group": "grp_rs485_service_tune",
    "name": "Tune Curve",
    "order": 3,
    "width": 12,
    "height": 9,
    "format": "<div ng-bind-html=\"msg.payload | trusted\"></div>",
    "storeOutMessages": true,
    "fwdInMessages": true,
    "resendOnRefresh": true,
    "templateScope": "local",
    "className": "",
    "x": 850,
    "y": 900,
    "wires": [
      []
    ]
  },
  {
    "id": "ui_form_rs485_set49_core",
    "type": "ui_form",
    "z": "tab_a3412f46",
    "name": "BMS Core Limits Write",
    "label": "BMS Kernparameter schreiben (CID2=49)",
    "group": "grp_rs485_service_tune",
    "order": 4,
    "width": 12,
    "height": 9,
    "options": [
      {
        "label": "Pack Adresse (HEX)",
        "value": "addr",
        "type": "text",
        "required": true
      },
      {
        "label": "CellV High (V)",
        "value": "cell_hi_v",
        "type": "number",
        "required": false
      },
      {
        "label": "CellV Low (V)",
        "value": "cell_lo_v",
        "type": "number",
        "required": false
      },
      {
        "label": "PackV High (V)",
        "value": "pack_hi_v",
        "type": "number",
        "required": false
      },
      {
        "label": "PackV Low (V)",
        "value": "pack_lo_v",
        "type": "number",
        "required": false
      },
      {
        "label": "Charge Limit (A)",
        "value": "chg_i_a",
        "type": "number",
        "required": false
      },
      {
        "label": "Dry-Run",
        "value": "dry",
        "type": "switch",
        "required": false
      }
    ],
    "formValue": {
      "addr": "01",
      "cell_hi_v": 3.65,
      "cell_lo_v": 2.8,
      "pack_hi_v": 56.8,
      "pack_lo_v": 44.8,
      "chg_i_a": 50,
      "dry": true
    },
    "payload": "{}",
    "submit": "Schreiben",
    "cancel": "Reset",
    "topic": "",
    "x": 250,
    "y": 980,
    "wires": [
      [
        "fn_rs485_set49_build"
      ]
    ]
  },
  {
    "id": "fn_rs485_set49_build",
    "type": "function",
    "z": "tab_a3412f46",
    "name": "Build CID2=49 frames",
    "outputs": 2,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "func": "function cleanHex(s){ return String(s||'').toUpperCase().replace(/[^0-9A-F]/g,''); }\nfunction toHex(n,len){ return Number(n).toString(16).toUpperCase().padStart(len,'0'); }\nfunction lchk(lenId){ var n0=lenId&0xF,n1=(lenId>>4)&0xF,n2=(lenId>>8)&0xF; var sum=(n0+n1+n2)&0xF; return (((~sum)&0xF)+1)&0xF; }\nfunction crc(prefix){ var a=0; for(var i=1;i<prefix.length;i++) a+=prefix.charCodeAt(i); return (((~a)&0xFFFF)+1)&0xFFFF; }\nfunction frame49(addrHex, cmdType, valueU16){\n  var addr = cleanHex(addrHex).padStart(2,'0').slice(-2);\n  var info = addr + toHex(cmdType,2) + toHex(valueU16,4);\n  var lenId = info.length;\n  var lenWord = ((lchk(lenId)&0xF)<<12) | (lenId&0xFFF);\n  var pre='~22'+addr+'4A49'+toHex(lenWord,4)+info;\n  return pre + toHex(crc(pre),4) + '\\r';\n}\n\nvar p=(msg&&msg.payload&&typeof msg.payload==='object')?msg.payload:{};\nvar addr = cleanHex(p.addr||'01').padStart(2,'0').slice(-2);\nvar dry = !!p.dry;\nvar jobs=[];\n\nfunction addNum(v, cmd, scale, min, max, label){\n  if(v===undefined||v===null||v==='') return;\n  var n=Number(v); if(!Number.isFinite(n)) return;\n  var raw=Math.round(n*scale);\n  raw=Math.max(min,Math.min(max,raw));\n  jobs.push({cmd:cmd, raw:raw, label:label, val:n});\n}\n\n// commandType mapping from original web app (P1363SetBasicParams)\naddNum(p.cell_hi_v,0x80,1000,0,65535,'CellV High');\naddNum(p.cell_lo_v,0x81,1000,0,65535,'CellV Low');\naddNum(p.chg_i_a,0x84,100,0,65535,'Charge Current Limit');\naddNum(p.pack_hi_v,0x85,1000,0,65535,'PackV High');\naddNum(p.pack_lo_v,0x86,1000,0,65535,'PackV Low');\n\nif(!jobs.length) return [null,{payload:'Keine gueltigen Werte eingegeben.'}];\n\nvar out=[];\nfor(var i=0;i<jobs.length;i++){\n  var j=jobs[i];\n  var fr=frame49(addr,j.cmd,j.raw);\n  out.push({\n    payload:fr,\n    addr:addr,\n    service:0x49,\n    _req:{adr:parseInt(addr,16),svc:0x49,ts:Date.now(),manual:true,set:{cmd:j.cmd,label:j.label,val:j.val,raw:j.raw}}\n  });\n}\n\nvar txt='CID2=49 '+(dry?'Dry-Run':'TX')+' an ID '+addr+'\\n' + jobs.map(j=>j.label+': '+j.val+' -> cmd 0x'+toHex(j.cmd,2)+' raw '+j.raw).join('\\n');\nif(dry) return [null,{payload:txt+'\\n\\n'+out.map(m=>m.payload.trim()).join('\\n')}];\nreturn [out,{payload:txt}];",
    "x": 520,
    "y": 980,
    "wires": [
      [
        "split_rs485_set49_frames"
      ],
      [
        "ui_txt_rs485_set49_status"
      ]
    ]
  },
  {
    "id": "split_rs485_set49_frames",
    "type": "split",
    "z": "tab_a3412f46",
    "name": "Split set49 frames",
    "splt": "\\n",
    "spltType": "str",
    "arraySplt": 1,
    "arraySpltType": "len",
    "stream": false,
    "addname": "",
    "x": 760,
    "y": 960,
    "wires": [
      [
        "delay_rs485_set49_frames"
      ]
    ]
  },
  {
    "id": "delay_rs485_set49_frames",
    "type": "delay",
    "z": "tab_a3412f46",
    "name": "Pace set49 tx",
    "pauseType": "rate",
    "timeout": "1",
    "timeoutUnits": "seconds",
    "rate": "1",
    "nbRateUnits": "350",
    "rateUnits": "millisecond",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "allowrate": false,
    "outputs": 1,
    "x": 980,
    "y": 960,
    "wires": [
      [
        "lout_rs485_service_tx"
      ]
    ]
  },
  {
    "id": "ui_txt_rs485_set49_status",
    "type": "ui_text",
    "z": "tab_a3412f46",
    "group": "grp_rs485_service_status",
    "order": 2,
    "width": 12,
    "height": 4,
    "name": "Set49 Status",
    "label": "Set49 Status",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "x": 780,
    "y": 1020,
    "wires": []
  },
  {
    "id": "grp_rs485_service_auto",
    "type": "ui_group",
    "z": "",
    "name": "Service Assistent",
    "tab": "uitab_rs485_service_01",
    "order": 0,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "ui_form_rs485_service_preset",
    "type": "ui_form",
    "z": "tab_a3412f46",
    "name": "Service Preset Form",
    "label": "Service Presets",
    "group": "grp_rs485_service_auto",
    "order": 1,
    "width": "12",
    "height": 7,
    "options": [
      {
        "label": "Pack Adresse (HEX)",
        "value": "addr",
        "type": "text",
        "required": true
      },
      {
        "label": "Aktion (z.B. GET_47, GET_51, GET_B0_INFO, GET_B0_CAP, CTRL_45_0D)",
        "value": "action",
        "type": "text",
        "required": true
      },
      {
        "label": "Passwort HEX (optional, z.B. 363636363636)",
        "value": "pwd",
        "type": "text",
        "required": false
      },
      {
        "label": "Dry-Run",
        "value": "dry",
        "type": "switch",
        "required": false
      }
    ],
    "formValue": {
      "addr": "01",
      "action": "GET_47",
      "pwd": "",
      "dry": true
    },
    "submit": "Ausfuehren",
    "cancel": "Reset",
    "topic": "",
    "className": "",
    "x": 340,
    "y": 720,
    "wires": [
      [
        "fn_rs485_service_preset_build"
      ]
    ]
  },
  {
    "id": "fn_rs485_service_preset_build",
    "type": "function",
    "z": "tab_a3412f46",
    "name": "Build Service Preset",
    "func": "function hx(s){return String(s||'').toUpperCase().replace(/[^0-9A-F_]/g,'');}\nvar p=(msg&&msg.payload&&typeof msg.payload==='object')?msg.payload:{};\nvar addr=hx(p.addr||'01').replace(/_/g,'').padStart(2,'0').slice(-2);\nvar act=String(p.action||'GET_47').toUpperCase().trim();\nvar dry=!!p.dry;\nvar pwd=String(p.pwd||'').toUpperCase().replace(/[^0-9A-F]/g,'');\nvar out={addr:addr,dry:dry};\nif(act==='GET_42' || act==='GET_STATUS42'){ out.cid2='42'; }\nelse if(act==='GET_44' || act==='GET_ALARM44'){ out.cid2='44'; }\nelse if(act==='GET_47' || act==='GET_LIMITS47'){ out.cid2='47'; }\nelse if(act==='GET_51' || act==='GET_ID51'){ out.cid2='51'; }\nelse if(act==='GET_83' || act==='GET_DIAG83'){ out.cid2='83'; out.op='01'; }\nelse if(act==='GET_B0_INFO'){ out.cid2='B0'; out.op='02'; out.module='03'; out.fid='FF'; out.flen='00'; if(pwd) out.pwd=pwd; }\nelse if(act==='GET_B0_CAP'){ out.cid2='B0'; out.op='02'; out.module='04'; out.fid='FF'; out.flen='00'; if(pwd) out.pwd=pwd; }\nelse if(act==='CTRL_45_0D'){ out.cid2='45'; out.op='0D'; }\nelse if(act==='CTRL_45_0F'){ out.cid2='45'; out.op='0F'; }\nelse {\n  return [null,{payload:'Unbekannte Aktion: '+act+' | Beispiele: GET_47, GET_51, GET_B0_INFO, GET_B0_CAP, CTRL_45_0D'}];\n}\nmsg.payload=out;\nreturn [msg,{payload:'Preset '+act+' -> CID2 '+out.cid2+' fuer ID '+addr+(dry?' (Dry-Run)':'')}];",
    "outputs": 2,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 620,
    "y": 720,
    "wires": [
      [
        "fn_rs485_service_buildsend"
      ],
      [
        "ui_txt_rs485_service_preset_status"
      ]
    ]
  },
  {
    "id": "ui_txt_rs485_service_preset_status",
    "type": "ui_text",
    "z": "tab_a3412f46",
    "group": "grp_rs485_service_status",
    "order": 3,
    "width": "12",
    "height": 2,
    "name": "Preset Status",
    "label": "Preset",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "className": "",
    "x": 940,
    "y": 720,
    "wires": []
  },
  {
    "id": "ui_form_rs485_apply_profile",
    "type": "ui_form",
    "z": "tab_a3412f46",
    "name": "Apply Profile to BMS",
    "label": "Profil -> BMS schreiben (CID2=49)",
    "group": "grp_rs485_service_auto",
    "order": 2,
    "width": "12",
    "height": 9,
    "options": [
      {
        "label": "Pack Adresse (HEX)",
        "value": "addr",
        "type": "text",
        "required": true
      },
      {
        "label": "Ladespannung Pack (V)",
        "value": "pack_hi_v",
        "type": "number",
        "required": true
      },
      {
        "label": "Entladeschluss Pack (V)",
        "value": "pack_lo_v",
        "type": "number",
        "required": true
      },
      {
        "label": "Cell High (V)",
        "value": "cell_hi_v",
        "type": "number",
        "required": true
      },
      {
        "label": "Cell Low (V)",
        "value": "cell_lo_v",
        "type": "number",
        "required": true
      },
      {
        "label": "Charge Limit (A)",
        "value": "chg_i_a",
        "type": "number",
        "required": true
      },
      {
        "label": "Dry-Run",
        "value": "dry",
        "type": "switch",
        "required": false
      }
    ],
    "formValue": {
      "addr": "01",
      "pack_hi_v": 56.8,
      "pack_lo_v": 44.8,
      "cell_hi_v": 3.55,
      "cell_lo_v": 2.8,
      "chg_i_a": 50,
      "dry": true
    },
    "submit": "Profil senden",
    "cancel": "Reset",
    "topic": "",
    "className": "",
    "x": 350,
    "y": 780,
    "wires": [
      [
        "fn_rs485_apply_profile_build"
      ]
    ]
  },
  {
    "id": "fn_rs485_apply_profile_build",
    "type": "function",
    "z": "tab_a3412f46",
    "name": "Build profile CID2=49 frames",
    "func": "function cleanHex(s){ return String(s||'').toUpperCase().replace(/[^0-9A-F]/g,''); }\nfunction toHex(n,len){ return Number(n).toString(16).toUpperCase().padStart(len,'0'); }\nfunction lchk(lenId){ var n0=lenId&0xF,n1=(lenId>>4)&0xF,n2=(lenId>>8)&0xF; var sum=(n0+n1+n2)&0xF; return (((~sum)&0xF)+1)&0xF; }\nfunction crc(prefix){ var a=0; for(var i=1;i<prefix.length;i++) a+=prefix.charCodeAt(i); return (((~a)&0xFFFF)+1)&0xFFFF; }\nfunction frame49(addrHex, cmdType, valueU16){\n  var addr = cleanHex(addrHex).padStart(2,'0').slice(-2);\n  var info = addr + toHex(cmdType,2) + toHex(valueU16,4);\n  var lenId = info.length;\n  var lenWord = ((lchk(lenId)&0xF)<<12) | (lenId&0xFFF);\n  var pre='~22'+addr+'4A49'+toHex(lenWord,4)+info;\n  return pre + toHex(crc(pre),4) + '\\r';\n}\nvar p=(msg&&msg.payload&&typeof msg.payload==='object')?msg.payload:{};\nvar profile=flow.get('RS485_SERVICE_PROFILE')||{};\nvar addr=cleanHex(p.addr||'01').padStart(2,'0').slice(-2);\nvar dry=!!p.dry;\nfunction pick(k,def){\n  if(p[k]!==undefined && p[k]!==null && p[k]!=='') return Number(p[k]);\n  if(profile[k]!==undefined && profile[k]!==null && profile[k]!=='') return Number(profile[k]);\n  return def;\n}\nvar vals={\n  cell_hi_v:pick('cell_hi_v',3.55),\n  cell_lo_v:pick('cell_lo_v',2.80),\n  pack_hi_v:pick('pack_hi_v',56.8),\n  pack_lo_v:pick('pack_lo_v',44.8),\n  chg_i_a:pick('chg_i_a',50)\n};\nvar jobs=[];\nfunction addNum(v, cmd, scale, min, max, label){\n  if(!Number.isFinite(v)) return;\n  var raw=Math.round(v*scale);\n  raw=Math.max(min,Math.min(max,raw));\n  jobs.push({cmd:cmd,raw:raw,label:label,val:v});\n}\naddNum(vals.cell_hi_v,0x80,1000,0,65535,'CellV High');\naddNum(vals.cell_lo_v,0x81,1000,0,65535,'CellV Low');\naddNum(vals.chg_i_a,0x84,100,0,65535,'Charge Current Limit');\naddNum(vals.pack_hi_v,0x85,1000,0,65535,'PackV High');\naddNum(vals.pack_lo_v,0x86,1000,0,65535,'PackV Low');\nif(!jobs.length) return [null,{payload:'Keine gueltigen Profilwerte.'}];\nvar out=[];\nfor (var i=0;i<jobs.length;i++){\n  var j=jobs[i];\n  out.push({\n    payload:frame49(addr,j.cmd,j.raw),\n    addr:addr,\n    service:0x49,\n    _req:{adr:parseInt(addr,16),svc:0x49,ts:Date.now(),manual:true,set:{cmd:j.cmd,label:j.label,val:j.val,raw:j.raw}}\n  });\n}\nvar text='Profil->BMS ID '+addr+' '+(dry?'Dry-Run':'TX')+'\\n'+jobs.map(j=>j.label+': '+j.val).join('\\n');\nif(dry) return [null,{payload:text+'\\n\\n'+out.map(m=>m.payload.trim()).join('\\n')}];\nreturn [out,{payload:text}];",
    "outputs": 2,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 640,
    "y": 780,
    "wires": [
      [
        "split_rs485_set49_frames"
      ],
      [
        "ui_txt_rs485_profile_status"
      ]
    ]
  },
  {
    "id": "ui_txt_rs485_profile_status",
    "type": "ui_text",
    "z": "tab_a3412f46",
    "group": "grp_rs485_service_status",
    "order": 4,
    "width": "12",
    "height": 3,
    "name": "Profile Apply Status",
    "label": "Profil Sendestatus",
    "format": "{{msg.payload}}",
    "layout": "col-center",
    "className": "",
    "x": 960,
    "y": 780,
    "wires": []
  },
  {
    "id": "uitab_jk_ble",
    "type": "ui_tab",
    "name": "JK BLE",
    "icon": "bluetooth",
    "order": 12,
    "disabled": false,
    "hidden": false
  },
  {
    "id": "grp_jk_ble_ctrl",
    "type": "ui_group",
    "name": "JK Control",
    "tab": "uitab_jk_ble",
    "order": 0,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "grp_jk_ble_live",
    "type": "ui_group",
    "name": "Live",
    "tab": "uitab_jk_ble",
    "order": 1,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "grp_jk_ble_cells",
    "type": "ui_group",
    "name": "Cells",
    "tab": "uitab_jk_ble",
    "order": 3,
    "disp": true,
    "width": "12",
    "collapse": false,
    "className": ""
  },
  {
    "id": "grp_jk_ble_logs",
    "type": "ui_group",
    "name": "Logs",
    "tab": "uitab_jk_ble",
    "order": 4,
    "disp": true,
    "width": "12",
    "collapse": true,
    "className": ""
  },
  {
    "id": "tab_jk_ble_flow",
    "type": "tab",
    "label": "JK BLE",
    "disabled": false,
    "info": ""
  },
  {
    "id": "ui_form_jk_ble_cfg",
    "type": "ui_form",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE Config",
    "label": "JK BLE Verbindung",
    "group": "grp_jk_ble_ctrl",
    "order": 1,
    "width": "12",
    "height": 6,
    "options": [
      {
        "label": "BMS Address (MAC)",
        "value": "address",
        "type": "text",
        "required": true
      },
      {
        "label": "Adapter (hciX)",
        "value": "adapter",
        "type": "text",
        "required": false
      },
      {
        "label": "Auto Poll",
        "value": "auto",
        "type": "switch",
        "required": false
      },
      {
        "label": "Poll Rate (s)",
        "value": "rate",
        "type": "number",
        "required": false
      }
    ],
    "formValue": {
      "address": "C8:47:80:37:02:E8",
      "adapter": "hci1",
      "auto": false,
      "rate": 10
    },
    "submit": "Apply",
    "cancel": "Reset",
    "x": 260,
    "y": 160,
    "wires": [
      [
        "fn_jk_ble_apply_cfg"
      ]
    ]
  },
  {
    "id": "fn_jk_ble_apply_cfg",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "Apply JK BLE cfg",
    "func": "var p=(msg&&msg.payload)||{};\nvar rate = Number(p.rate);\nif(!Number.isFinite(rate) || rate<=0) rate = 3;\nvar cfg={\n  address:String(p.address||'').trim(),\n  adapter:String(p.adapter||'').trim()||null,\n  auto:!!p.auto,\n  rate: Math.max(1, Math.round(rate))\n};\nflow.set('JK_BLE_CFG', cfg);\nreturn {payload:cfg};",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 520,
    "y": 160,
    "wires": [
      [
        "ui_txt_jk_ble_cfg",
        "fn_jk_ble_schedule",
        "9e72060e01ac4f1c"
      ]
    ]
  },
  {
    "id": "ui_txt_jk_ble_cfg",
    "type": "ui_text",
    "z": "tab_jk_ble_flow",
    "name": "JK cfg status",
    "group": "grp_jk_ble_ctrl",
    "order": 2,
    "width": "12",
    "height": 2,
    "label": "Config",
    "format": "{{msg.payload | json}}",
    "layout": "row-spread",
    "className": "",
    "x": 780,
    "y": 140,
    "wires": []
  },
  {
    "id": "ui_btn_jk_ble_read",
    "type": "ui_button",
    "z": "tab_jk_ble_flow",
    "name": "Read now",
    "group": "grp_jk_ble_ctrl",
    "order": 3,
    "width": "4",
    "height": 1,
    "label": "Read Now",
    "tooltip": "Read device/settings/cell now",
    "color": "#ffffff",
    "bgcolor": "#1f77b4",
    "icon": "refresh",
    "payload": "",
    "payloadType": "str",
    "topic": "",
    "x": 260,
    "y": 220,
    "wires": [
      [
        "fn_jk_ble_read_trigger"
      ]
    ]
  },
  {
    "id": "fn_jk_ble_read_trigger",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "Build read cmd",
    "func": "var cfg=flow.get('JK_BLE_CFG')||{address:'C8:47:80:37:02:E8',adapter:'hci1',rate:3,auto:true};\n// Prevent parallel BLE ops: BlueZ will error with \"Operation already in progress\" / \"Notify acquired\".\nvar now=Date.now();\nvar busyUntil=Number(flow.get('JK_BLE_BUSY_UNTIL')||0);\nif(now < busyUntil) return null;\nflow.set('JK_BLE_BUSY_UNTIL', now + 25000);\n\nmsg._cfg=cfg;\nvar args='--address '+cfg.address+' --timeout 20';\nif(cfg.adapter) args += ' --adapter '+cfg.adapter;\nmsg.payload = args;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 520,
    "y": 220,
    "wires": [
      [
        "dbg_jk_ble_cmd",
        "377bb784586c4514"
      ]
    ]
  },
  {
    "id": "exec_jk_ble_echo",
    "type": "exec",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE echo test",
    "command": "echo",
    "addpay": true,
    "append": "",
    "useSpawn": "false",
    "timer": "",
    "winHide": false,
    "oldrc": false,
    "mode": "exec",
    "x": 770,
    "y": 140,
    "wires": [
      [
        "dbg_jk_ble_echo_out"
      ],
      [],
      []
    ],
    "d": true
  },
  {
    "id": "dbg_jk_ble_echo_out",
    "type": "debug",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE echo out",
    "active": true,
    "tosidebar": true,
    "console": true,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 1010,
    "y": 140,
    "wires": []
  },
  {
    "id": "exec_jk_ble_read",
    "type": "exec",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE read (python)",
    "command": "/home/black/bms-rs485-service-suite/.venv/bin/python -u /home/black/bms-rs485-service-suite/tools/jk_ble_read.py",
    "addpay": true,
    "append": "",
    "useSpawn": "false",
    "timer": "25",
    "winHide": false,
    "oldrc": false,
    "mode": "exec",
    "x": 770,
    "y": 220,
    "wires": [
      [
        "dbg_jk_ble_stdout",
        "fn_jk_ble_stdout_meta",
        "fn_jk_ble_stdout_guard"
      ],
      [
        "dbg_jk_ble_stderr",
        "ui_txt_jk_ble_err"
      ],
      [
        "dbg_jk_ble_rc",
        "fn_jk_ble_clear_busy",
        "ui_txt_jk_ble_rc"
      ]
    ],
    "d": true
  },
  {
    "id": "fn_jk_ble_stdout_guard",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "JK stdout -> JSON guard",
    "func": "var p = msg.payload;\n\n// Accept: string (exec), Buffer (exec), object (mqtt auto/json)\nif (Buffer.isBuffer(p)) p = p.toString('utf8');\nif (p && typeof p === 'object') {\n  msg.payload = JSON.stringify(p);\n  return msg;\n}\n\nvar s=(p==null)?'':String(p);\nvar t=s.trim();\nif(!t){\n  var cfg=flow.get('JK_BLE_CFG')||{};\n  msg.payload = JSON.stringify({address:cfg.address||null, adapter:cfg.adapter||null, connected:false, model_nbr:null, got:{}, status:{}, error:{type:'EmptyStdout', message:'JK BLE read produced no stdout (killed/crashed)'}});\n  return msg;\n}\nmsg.payload = t;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1010,
    "y": 200,
    "wires": [
      [
        "json_jk_ble_read"
      ]
    ]
  },
  {
    "id": "fn_jk_ble_clear_busy",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "JK clear busy",
    "func": "flow.set('JK_BLE_BUSY_UNTIL', 0);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 980,
    "y": 340,
    "wires": [
      []
    ]
  },
  {
    "id": "fn_jk_ble_stdout_meta",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "JK stdout meta",
    "func": "var s=(msg.payload==null)?'':String(msg.payload);\nreturn {payload:{len:s.length,head:s.slice(0,160),tail:s.slice(Math.max(0,s.length-160))}};",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1030,
    "y": 140,
    "wires": [
      [
        "dbg_jk_ble_stdout_meta"
      ]
    ]
  },
  {
    "id": "dbg_jk_ble_stdout_meta",
    "type": "debug",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE stdout meta",
    "active": true,
    "tosidebar": true,
    "console": true,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 1260,
    "y": 140,
    "wires": []
  },
  {
    "id": "dbg_jk_ble_cmd",
    "type": "debug",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE cmd",
    "active": true,
    "tosidebar": true,
    "console": true,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 770,
    "y": 180,
    "wires": []
  },
  {
    "id": "dbg_jk_ble_stdout",
    "type": "debug",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE stdout",
    "active": true,
    "tosidebar": true,
    "console": true,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 1010,
    "y": 180,
    "wires": []
  },
  {
    "id": "dbg_jk_ble_stderr",
    "type": "debug",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE stderr",
    "active": true,
    "tosidebar": true,
    "console": true,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 1020,
    "y": 260,
    "wires": []
  },
  {
    "id": "dbg_jk_ble_rc",
    "type": "debug",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE rc",
    "active": true,
    "tosidebar": true,
    "console": true,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 1010,
    "y": 300,
    "wires": []
  },
  {
    "id": "json_jk_ble_read",
    "type": "json",
    "z": "tab_jk_ble_flow",
    "name": "parse json",
    "property": "payload",
    "action": "obj",
    "pretty": false,
    "x": 1010,
    "y": 220,
    "wires": [
      [
        "fn_jk_ble_store",
        "ui_txt_jk_ble_raw"
      ]
    ]
  },
  {
    "id": "ui_txt_jk_ble_err",
    "type": "ui_text",
    "z": "tab_jk_ble_flow",
    "name": "JK error",
    "group": "grp_jk_ble_logs",
    "order": 1,
    "width": "12",
    "height": 3,
    "label": "Errors",
    "format": "{{msg.payload}}",
    "layout": "col-center",
    "className": "",
    "x": 1040,
    "y": 300,
    "wires": []
  },
  {
    "id": "ui_txt_jk_ble_rc",
    "type": "ui_text",
    "z": "tab_jk_ble_flow",
    "name": "JK rc",
    "group": "grp_jk_ble_logs",
    "order": 2,
    "width": "12",
    "height": 1,
    "label": "Return Code",
    "format": "{{msg.payload}}",
    "layout": "col-center",
    "className": "",
    "x": 1040,
    "y": 320,
    "wires": []
  },
  {
    "id": "ui_txt_jk_ble_raw",
    "type": "ui_text",
    "z": "tab_jk_ble_flow",
    "name": "JK raw",
    "group": "grp_jk_ble_logs",
    "order": 2,
    "width": "12",
    "height": 3,
    "label": "Raw JSON",
    "format": "{{msg.payload}}",
    "layout": "col-center",
    "className": "",
    "x": 1040,
    "y": 260,
    "wires": []
  },
  {
    "id": "fn_jk_ble_store",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "Store + format UI",
    "func": "var o=msg.payload||{};\nflow.set('JK_BLE_LAST', o);\nvar st=((o.status)||{});\nvar di=st.device_info||{};\nvar se=st.settings||{};\nvar ci=st.cell_info||{};\nfunction f(n,d){if(n==null||!isFinite(n)) return '--'; d=Math.min(3, (d==null?3:d)); return Number(n).toFixed(d);}\nvar summary={\n  name: di.vendor_id||'--',\n  serial: di.serial_number||'--',\n  hw: di.hw_rev||'--',\n  sw: di.sw_rev||'--',\n  v: ci.total_voltage,\n  a: ci.current,\n  soc: ci.battery_soc,\n  t1: ci.temperature_sensor_1,\n  t2: ci.temperature_sensor_2,\n  tmos: ci.temperature_mos,\n  balancing: !!ci.balancing_active,\n  chg_en: !!ci.charging_switch_enabled,\n  dis_en: !!ci.discharging_switch_enabled\n};\nvar txt=''+summary.name+' / SN '+summary.serial+'  HW '+summary.hw+' SW '+summary.sw+'\\n'\n  +'U='+f(summary.v,3)+'V  I='+f(summary.a,3)+'A  SOC='+f(summary.soc,0)+'%\\n'\n  +'T1='+f(summary.t1,3)+'C  T2='+f(summary.t2,3)+'C  MOS='+f(summary.tmos,3)+'C\\n'\n  +'CHG='+summary.chg_en+'  DIS='+summary.dis_en+'  BAL='+summary.balancing;\n\n// Build cells table lines\nvar cells=ci.voltages||[];\nvar res=ci.resistances||[];\nvar lines=[];\nfor(var i=0;i<cells.length;i++){\n  var v=cells[i];\n  var r0=(res&&res[i]!=null)?res[i]:null;\n  lines.push('C'+String(i+1).padStart(2,'0')+': '+f(v,3)+' V  R='+f(r0,3));\n}\nreturn [\n  {payload:txt},\n  {payload:lines.join('\\n')},\n  msg\n];",
    "outputs": 3,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 260,
    "y": 360,
    "wires": [
      [
        "ui_txt_jk_ble_summary"
      ],
      [
        "ui_txt_jk_ble_cells"
      ],
      [
        "fn_jk_ble_metrics_fanout",
        "fn_jk_ble_to_influx"
      ]
    ]
  },
  {
    "id": "ui_txt_jk_ble_summary",
    "type": "ui_text",
    "z": "tab_jk_ble_flow",
    "name": "JK Summary",
    "group": "grp_jk_ble_live",
    "order": 1,
    "width": "12",
    "height": 5,
    "label": "Status",
    "format": "{{msg.payload}}",
    "layout": "col-center",
    "className": "",
    "x": 560,
    "y": 340,
    "wires": []
  },
  {
    "id": "ui_txt_jk_ble_cells",
    "type": "ui_text",
    "z": "tab_jk_ble_flow",
    "name": "JK Cells",
    "group": "grp_jk_ble_cells",
    "order": 1,
    "width": "12",
    "height": 12,
    "label": "Cells",
    "format": "{{msg.payload}}",
    "layout": "col-center",
    "className": "",
    "x": 560,
    "y": 400,
    "wires": []
  },
  {
    "id": "fn_jk_ble_schedule",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "Auto poll scheduler",
    "func": "var cfg=flow.get('JK_BLE_CFG')||{};\nflow.set('JK_BLE_AUTO', !!cfg.auto);\nflow.set('JK_BLE_RATE', Math.max(1, Number(cfg.rate||3)));\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 540,
    "y": 120,
    "wires": [
      [
        "inject_jk_ble_tick"
      ]
    ],
    "d": true
  },
  {
    "id": "inject_jk_ble_tick",
    "type": "inject",
    "z": "tab_jk_ble_flow",
    "name": "tick",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "1",
    "crontab": "",
    "once": true,
    "onceDelay": "1",
    "topic": "jk_ble/tick",
    "payload": "",
    "payloadType": "date",
    "x": 260,
    "y": 100,
    "wires": [
      [
        "fn_jk_ble_tick"
      ]
    ],
    "d": true
  },
  {
    "id": "fn_jk_ble_tick",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "Tick -> maybe read",
    "func": "var auto=!!flow.get('JK_BLE_AUTO');\nvar rate=Math.max(1, Number(flow.get('JK_BLE_RATE')||3));\nvar now=Date.now();\nvar last=flow.get('JK_BLE_LAST_POLL')||0;\nif(!auto) return null;\nif(now-last < rate*1000) return null;\nflow.set('JK_BLE_LAST_POLL', now);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 520,
    "y": 100,
    "wires": [
      [
        "fn_jk_ble_read_trigger"
      ]
    ],
    "d": true
  },
  {
    "id": "ui_form_jk_ble_write",
    "type": "ui_form",
    "z": "tab_jk_ble_flow",
    "name": "JK Write Settings",
    "label": "Write: JK Settings (Default Dry-Run)",
    "group": "grp_jk_ble_ctrl",
    "order": 4,
    "width": "8",
    "height": 12,
    "options": [
      {
        "label": "Dry-Run (recommended)",
        "value": "dry",
        "type": "switch",
        "required": false
      },
      {
        "label": "Cell UVP (V)",
        "value": "uvp",
        "type": "number",
        "required": false
      },
      {
        "label": "Cell UVPR (V)",
        "value": "uvpr",
        "type": "number",
        "required": false
      },
      {
        "label": "Cell OVP (V)",
        "value": "ovp",
        "type": "number",
        "required": false
      },
      {
        "label": "Cell OVPR (V)",
        "value": "ovpr",
        "type": "number",
        "required": false
      },
      {
        "label": "Balance Trigger (V)",
        "value": "bal_trig",
        "type": "number",
        "required": false
      },
      {
        "label": "Balance Start (V)",
        "value": "bal_start",
        "type": "number",
        "required": false
      },
      {
        "label": "Power Off (V)",
        "value": "pwr_off",
        "type": "number",
        "required": false
      },
      {
        "label": "Max Charge (A)",
        "value": "max_chg",
        "type": "number",
        "required": false
      },
      {
        "label": "Max Discharge (A)",
        "value": "max_dis",
        "type": "number",
        "required": false
      },
      {
        "label": "Max Balance (A)",
        "value": "max_bal",
        "type": "number",
        "required": false
      }
    ],
    "formValue": {
      "dry": true,
      "uvp": 2.6,
      "uvpr": 2.65,
      "ovp": 3.65,
      "ovpr": 3.45,
      "bal_trig": 0.01,
      "bal_start": 3.4,
      "pwr_off": 2.51,
      "max_chg": 200,
      "max_dis": 200,
      "max_bal": 0.3
    },
    "submit": "Send",
    "cancel": "Reset",
    "x": 260,
    "y": 520,
    "wires": [
      [
        "fn_jk_ble_build_write"
      ]
    ]
  },
  {
    "id": "fn_jk_ble_build_write",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "Build write cmd",
    "func": "var cfg=flow.get('JK_BLE_CFG')||{address:'C8:47:80:37:02:E8',adapter:'hci1'};\n// Prevent parallel BLE ops\nvar now=Date.now();\nvar busyUntil=Number(flow.get('JK_BLE_BUSY_UNTIL')||0);\nif(now < busyUntil) return null;\nflow.set('JK_BLE_BUSY_UNTIL', now + 25000);\n\nvar p=msg.payload||{};\nvar unlocked=!!flow.get('JK_BLE_UNLOCK');\nvar dry=(p.dry===undefined)?true:!!p.dry;\nif(!unlocked) dry=true;\n\nvar args='--address '+cfg.address+' --timeout 20';\nif(cfg.adapter) args += ' --adapter '+cfg.adapter;\n\nif(dry) args += ' --dry-run';\nelse args += ' --force';\n\nfunction addNum(flag, val){\n  if(val===undefined||val===null||val==='') return;\n  if(!isFinite(Number(val))) return;\n  args += ' '+flag+' '+String(val);\n}\naddNum('--set-uvp', p.uvp);\naddNum('--set-uvpr', p.uvpr);\naddNum('--set-ovp', p.ovp);\naddNum('--set-ovpr', p.ovpr);\naddNum('--set-balance-trigger', p.bal_trig);\naddNum('--set-balance-start', p.bal_start);\naddNum('--set-power-off', p.pwr_off);\naddNum('--set-max-charge', p.max_chg);\naddNum('--set-max-discharge', p.max_dis);\naddNum('--set-max-balance', p.max_bal);\n\nmsg.payload = args;\nmsg._jk_write={dry:dry,unlocked:unlocked};\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 520,
    "y": 520,
    "wires": [
      [
        "exec_jk_ble_write"
      ]
    ]
  },
  {
    "id": "exec_jk_ble_write",
    "type": "exec",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE write (python)",
    "command": "/home/black/bms-rs485-service-suite/.venv/bin/python -u /home/black/bms-rs485-service-suite/tools/jk_ble_write.py",
    "addpay": true,
    "append": "",
    "useSpawn": "false",
    "timer": "25",
    "winHide": false,
    "oldrc": false,
    "mode": "exec",
    "x": 770,
    "y": 520,
    "wires": [
      [
        "ui_txt_jk_ble_write_out",
        "delay_jk_ble_after_write"
      ],
      [
        "ui_txt_jk_ble_err"
      ],
      [
        "fn_jk_ble_clear_busy",
        "ui_txt_jk_ble_rc"
      ]
    ]
  },
  {
    "id": "ui_txt_jk_ble_write_out",
    "type": "ui_text",
    "z": "tab_jk_ble_flow",
    "name": "JK write out",
    "group": "grp_jk_ble_logs",
    "order": 3,
    "width": "12",
    "height": 3,
    "label": "Write Output",
    "format": "{{msg.payload}}",
    "layout": "col-center",
    "className": "",
    "x": 1040,
    "y": 520,
    "wires": []
  },
  {
    "id": "ui_sw_jk_ble_unlock",
    "type": "ui_switch",
    "z": "tab_jk_ble_flow",
    "name": "Unlock writes",
    "label": "Unlock Writes",
    "group": "grp_jk_ble_ctrl",
    "order": 5,
    "width": "4",
    "height": 1,
    "passthru": true,
    "decouple": "false",
    "topic": "jk_ble/unlock",
    "style": "",
    "onvalue": "true",
    "onvalueType": "bool",
    "onicon": "lock_open",
    "oncolor": "#d62728",
    "offvalue": "false",
    "offvalueType": "bool",
    "officon": "lock",
    "offcolor": "#2ca02c",
    "x": 260,
    "y": 580,
    "wires": [
      [
        "fn_jk_ble_set_unlock"
      ]
    ]
  },
  {
    "id": "fn_jk_ble_set_unlock",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "Set JK unlock",
    "func": "var v=!!msg.payload; flow.set('JK_BLE_UNLOCK', v);\nreturn {payload: v ? 'UNLOCKED: Writes are live' : 'LOCKED: Writes are Dry-Run'};",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 520,
    "y": 580,
    "wires": [
      [
        "ui_txt_jk_ble_unlock"
      ]
    ]
  },
  {
    "id": "ui_txt_jk_ble_unlock",
    "type": "ui_text",
    "z": "tab_jk_ble_flow",
    "name": "Unlock status",
    "group": "grp_jk_ble_ctrl",
    "order": 6,
    "width": "8",
    "height": 1,
    "label": "Write Mode",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "className": "",
    "x": 780,
    "y": 580,
    "wires": []
  },
  {
    "id": "delay_jk_ble_after_write",
    "type": "delay",
    "z": "tab_jk_ble_flow",
    "name": "after write delay",
    "pauseType": "delay",
    "timeout": "0.8",
    "timeoutUnits": "seconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "allowrate": false,
    "x": 770,
    "y": 620,
    "wires": [
      [
        "fn_jk_ble_after_write"
      ]
    ]
  },
  {
    "id": "fn_jk_ble_after_write",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "After write -> maybe read",
    "func": "var s=msg._jk_write||{};\nif(s.dry) return null;\n// Live write: trigger a read-back\nreturn {topic:'jk_ble/readback',payload:Date.now()};",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1010,
    "y": 620,
    "wires": [
      [
        "fn_jk_ble_read_trigger"
      ]
    ]
  },
  {
    "id": "ui_sw_jk_ble_chg",
    "type": "ui_switch",
    "z": "tab_jk_ble_flow",
    "name": "Charging",
    "label": "Charging",
    "group": "grp_jk_ble_ctrl",
    "order": 7,
    "width": "4",
    "height": 1,
    "passthru": true,
    "decouple": "false",
    "topic": "jk_ble/switch/charging",
    "style": "",
    "onvalue": "on",
    "onvalueType": "str",
    "onicon": "toggle_switch",
    "oncolor": "#d62728",
    "offvalue": "off",
    "offvalueType": "str",
    "officon": "toggle_switch_off",
    "offcolor": "#2ca02c",
    "x": 260,
    "y": 660,
    "wires": [
      [
        "fn_jk_ble_build_switch_write"
      ]
    ]
  },
  {
    "id": "ui_sw_jk_ble_dis",
    "type": "ui_switch",
    "z": "tab_jk_ble_flow",
    "name": "Discharging",
    "label": "Discharging",
    "group": "grp_jk_ble_ctrl",
    "order": 8,
    "width": "4",
    "height": 1,
    "passthru": true,
    "decouple": "false",
    "topic": "jk_ble/switch/discharging",
    "style": "",
    "onvalue": "on",
    "onvalueType": "str",
    "onicon": "toggle_switch",
    "oncolor": "#d62728",
    "offvalue": "off",
    "offvalueType": "str",
    "officon": "toggle_switch_off",
    "offcolor": "#2ca02c",
    "x": 260,
    "y": 700,
    "wires": [
      [
        "fn_jk_ble_build_switch_write"
      ]
    ]
  },
  {
    "id": "ui_sw_jk_ble_bal",
    "type": "ui_switch",
    "z": "tab_jk_ble_flow",
    "name": "Balancer",
    "label": "Balancer",
    "group": "grp_jk_ble_ctrl",
    "order": 9,
    "width": "4",
    "height": 1,
    "passthru": true,
    "decouple": "false",
    "topic": "jk_ble/switch/balancer",
    "style": "",
    "onvalue": "on",
    "onvalueType": "str",
    "onicon": "toggle_switch",
    "oncolor": "#d62728",
    "offvalue": "off",
    "offvalueType": "str",
    "officon": "toggle_switch_off",
    "offcolor": "#2ca02c",
    "x": 260,
    "y": 740,
    "wires": [
      [
        "fn_jk_ble_build_switch_write"
      ]
    ]
  },
  {
    "id": "fn_jk_ble_build_switch_write",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "Build switch write",
    "func": "var cfg=flow.get('JK_BLE_CFG')||{address:'C8:47:80:37:02:E8',adapter:'hci1'};\n// Prevent parallel BLE ops\nvar now=Date.now();\nvar busyUntil=Number(flow.get('JK_BLE_BUSY_UNTIL')||0);\nif(now < busyUntil) return null;\nflow.set('JK_BLE_BUSY_UNTIL', now + 25000);\n\nvar unlocked=!!flow.get('JK_BLE_UNLOCK');\nvar desired=String(msg.payload||'').toLowerCase();\nvar topic=String(msg.topic||'');\nvar which=topic.split('/').pop();\nif(!which) return null;\n\nvar dry=!unlocked;\nvar args='--address '+cfg.address+' --timeout 20';\nif(cfg.adapter) args += ' --adapter '+cfg.adapter;\nif(dry) args += ' --dry-run'; else args += ' --force';\n\nif(['charging','discharging','balancer'].indexOf(which)<0) return null;\nargs += ' --'+which+' '+((desired==='on')?'on':'off');\n\nmsg.payload = args;\nmsg._jk_write={dry:dry,unlocked:unlocked};\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 560,
    "y": 700,
    "wires": [
      [
        "exec_jk_ble_write"
      ]
    ]
  },
  {
    "id": "8004a06eec264cdb",
    "type": "mqtt in",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE raw (MQTT)",
    "topic": "bms/jk/jk1/raw",
    "qos": "0",
    "datatype": "auto",
    "broker": "4c520c778e3d4c7d",
    "nl": false,
    "rap": true,
    "rh": 0,
    "inputs": 0,
    "x": 200,
    "y": 520,
    "wires": [
      [
        "fn_jk_ble_stdout_guard"
      ]
    ]
  },
  {
    "id": "0706b3c937bc4707",
    "type": "mqtt in",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE online (MQTT)",
    "topic": "bms/jk/jk1/online",
    "qos": "0",
    "datatype": "auto",
    "broker": "4c520c778e3d4c7d",
    "nl": false,
    "rap": true,
    "rh": 0,
    "inputs": 0,
    "x": 210,
    "y": 560,
    "wires": [
      [
        "31588dad835f4d05"
      ]
    ]
  },
  {
    "id": "31588dad835f4d05",
    "type": "debug",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE MQTT",
    "active": false,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "payload",
    "targetType": "msg",
    "statusVal": "",
    "statusType": "auto",
    "x": 480,
    "y": 560,
    "wires": []
  },
  {
    "id": "377bb784586c4514",
    "type": "mqtt out",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE cmd/read (MQTT)",
    "topic": "bms/jk/jk1/cmd/read",
    "qos": "",
    "retain": "",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "4c520c778e3d4c7d",
    "x": 740,
    "y": 340,
    "wires": []
  },
  {
    "id": "grp_jk_ble_charts48",
    "type": "ui_group",
    "name": "Charts (48h)",
    "tab": "uitab_jk_ble",
    "order": 2,
    "disp": true,
    "width": 12,
    "collapse": false,
    "className": ""
  },
  {
    "id": "fn_jk_ble_metrics_fanout",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "JK metrics -> UI (gauges/charts/table + 48h store)",
    "func": "var o = msg.payload || {};\nvar st = o.status || {};\nvar ci = st.cell_info || {};\n\nfunction num(x){ return (x==null || !isFinite(x)) ? null : Number(x); }\nfunction roundN(x,n){ if(x==null) return null; var f=Math.pow(10,n||3); return Math.round(Number(x)*f)/f; }\n\nvar v = roundN(num(ci.total_voltage),3);\nvar a = roundN(num(ci.current),3);\nvar soc = num(ci.battery_soc);\nif (soc!=null) soc = Math.round(soc);\nvar t1 = roundN(num(ci.temperature_sensor_1),3);\nvar t2 = roundN(num(ci.temperature_sensor_2),3);\nvar tmos = roundN(num(ci.temperature_mos),3);\nvar dv = roundN(num(ci.delta_cell_voltage),3);\nvar pwr = (v!=null && a!=null) ? roundN(v*a,3) : null;\n\n// Store lightweight 48h history in flow context (for REST export / debug).\ntry {\n  var now = Date.now();\n  var win = 48*3600*1000;\n  var arr = flow.get('JK_BLE_TS_48H') || [];\n  arr.push({ts: now, v:v, a:a, soc:soc, t1:t1, t2:t2, tmos:tmos, dv:dv, p:pwr});\n  var cut = now - win;\n  while(arr.length && arr[0].ts < cut) arr.shift();\n  flow.set('JK_BLE_TS_48H', arr);\n  flow.set('JK_BLE_LAST_METRICS', {ts: now, v:v, a:a, soc:soc, t1:t1, t2:t2, tmos:tmos, dv:dv, p:pwr});\n} catch(e) {}\n\nfunction m(val){ return (val==null)?null:{payload:val, topic: msg.topic}; }\n\n// Charts use msg.topic to distinguish series where needed\nvar mv = {payload:v, topic:'Voltage'};\nvar ma = {payload:a, topic:'Current'};\nvar ms = {payload:soc, topic:'SOC'};\n\n// Temps chart: 3 series\nvar temps = [\n  {payload:t1, topic:'T1'},\n  {payload:t2, topic:'T2'},\n  {payload:tmos, topic:'MOS'}\n];\n\n// Cells table\nvar volts = ci.voltages || [];\nvar res = ci.resistances || [];\nvar avg = num(ci.average_cell_voltage);\nvar vmin = null, vmax = null, imin = -1, imax = -1;\nfor (var i=0;i<volts.length;i++){\n  var vv=roundN(num(volts[i]),3);\n  if(vv==null) continue;\n  if(vmin==null || vv<vmin){vmin=vv; imin=i;}\n  if(vmax==null || vv>vmax){vmax=vv; imax=i;}\n}\nvar rows=[];\nfor (var i=0;i<volts.length;i++){\n  var vv=roundN(num(volts[i]),3);\n  var rr=(res && res[i]!=null && isFinite(res[i]))?roundN(Number(res[i]),3):null;\n  var mvavg = (avg!=null && vv!=null) ? Math.round((vv-avg)*1000) : null;\n  var flag = (i===imin)?'MIN':((i===imax)?'MAX':'');\n  rows.push({cell:'C'+String(i+1).padStart(2,'0'), v:(vv==null?'--':vv.toFixed(3)), mv:(mvavg==null?'--':String(mvavg)), r:(rr==null?'--':rr.toFixed(3)), flag:flag});\n}\n\nreturn [\n  m(v),\n  m(a),\n  m(soc),\n  m(pwr),\n  m(t1),\n  m(t2),\n  m(tmos),\n  m(dv),\n  mv,\n  ma,\n  ms,\n  temps,\n  {payload:dv, topic:'DeltaV'},\n  {payload:rows}\n];\n",
    "outputs": 14,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 680,
    "y": 640,
    "wires": [
      [
        "ab0cecd96fb44172"
      ],
      [
        "0bf807b7182a4c20"
      ],
      [
        "3bcf43931bb24193"
      ],
      [
        "ab946fcd74ad4dd1"
      ],
      [
        "b650759efda742f7"
      ],
      [
        "788517c25cfd4f2f"
      ],
      [
        "ea89d018260247c1"
      ],
      [
        "4ae40e6ec2cc4098"
      ],
      [
        "c55a95852fbd47d1"
      ],
      [
        "5e9dd2be38534156"
      ],
      [
        "8407720c30824c58"
      ],
      [
        "d5b91adcf90c48f9"
      ],
      [
        "2ae99e39ec49417c"
      ],
      [
        "c6395e2363a64056"
      ]
    ]
  },
  {
    "id": "3bcf43931bb24193",
    "type": "ui_gauge",
    "z": "tab_jk_ble_flow",
    "name": "SOC",
    "group": "grp_jk_ble_live",
    "order": 2,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "SOC",
    "label": "%",
    "format": "{{value | number:0}}",
    "min": "2",
    "max": "100",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "x": 820,
    "y": 460,
    "wires": []
  },
  {
    "id": "ab0cecd96fb44172",
    "type": "ui_gauge",
    "z": "tab_jk_ble_flow",
    "name": "Voltage",
    "group": "grp_jk_ble_live",
    "order": 3,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Voltage",
    "label": "V",
    "format": "{{value | number:3}}",
    "min": "45",
    "max": "60",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "x": 1040,
    "y": 460,
    "wires": []
  },
  {
    "id": "0bf807b7182a4c20",
    "type": "ui_gauge",
    "z": "tab_jk_ble_flow",
    "name": "Current",
    "group": "grp_jk_ble_live",
    "order": 4,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Current",
    "label": "A",
    "format": "{{value | number:3}}",
    "min": "-200",
    "max": "200",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "x": 1260,
    "y": 460,
    "wires": []
  },
  {
    "id": "ab946fcd74ad4dd1",
    "type": "ui_gauge",
    "z": "tab_jk_ble_flow",
    "name": "Power",
    "group": "grp_jk_ble_live",
    "order": 5,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Power",
    "label": "W",
    "format": "{{value | number:3}}",
    "min": "-10000",
    "max": "10000",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "x": 1480,
    "y": 460,
    "wires": []
  },
  {
    "id": "b650759efda742f7",
    "type": "ui_gauge",
    "z": "tab_jk_ble_flow",
    "name": "Temp T1",
    "group": "grp_jk_ble_live",
    "order": 6,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Temp T1",
    "label": "\u00b0C",
    "format": "{{value | number:3}}",
    "min": "-20",
    "max": "80",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "x": 820,
    "y": 540,
    "wires": []
  },
  {
    "id": "788517c25cfd4f2f",
    "type": "ui_gauge",
    "z": "tab_jk_ble_flow",
    "name": "Temp T2",
    "group": "grp_jk_ble_live",
    "order": 7,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Temp T2",
    "label": "\u00b0C",
    "format": "{{value | number:3}}",
    "min": "-20",
    "max": "80",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "x": 1040,
    "y": 540,
    "wires": []
  },
  {
    "id": "ea89d018260247c1",
    "type": "ui_gauge",
    "z": "tab_jk_ble_flow",
    "name": "Temp MOS",
    "group": "grp_jk_ble_live",
    "order": 8,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "Temp MOS",
    "label": "\u00b0C",
    "format": "{{value | number:3}}",
    "min": "-20",
    "max": "90",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "x": 1260,
    "y": 540,
    "wires": []
  },
  {
    "id": "4ae40e6ec2cc4098",
    "type": "ui_gauge",
    "z": "tab_jk_ble_flow",
    "name": "DeltaV",
    "group": "grp_jk_ble_live",
    "order": 9,
    "width": 3,
    "height": 3,
    "gtype": "gage",
    "title": "DeltaV",
    "label": "V",
    "format": "{{value | number:3}}",
    "min": "0",
    "max": "0.2",
    "colors": [
      "#00b500",
      "#e6e600",
      "#ca3838"
    ],
    "seg1": "",
    "seg2": "",
    "x": 1480,
    "y": 540,
    "wires": []
  },
  {
    "id": "c55a95852fbd47d1",
    "type": "ui_chart",
    "z": "tab_jk_ble_flow",
    "name": "JK Voltage",
    "group": "grp_jk_ble_charts48",
    "order": 0,
    "width": 6,
    "height": 4,
    "label": "Voltage (V)",
    "chartType": "line",
    "legend": true,
    "xformat": "dd HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "40",
    "ymax": "60",
    "removeOlder": "48",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": 0,
    "useOneColor": false,
    "colors": [
      "#1f77b4",
      "#ff7f0e",
      "#2ca02c",
      "#d62728",
      "#9467bd",
      "#8c564b",
      "#e377c2",
      "#7f7f7f",
      "#bcbd22"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 820,
    "y": 760,
    "wires": [
      []
    ]
  },
  {
    "id": "5e9dd2be38534156",
    "type": "ui_chart",
    "z": "tab_jk_ble_flow",
    "name": "JK Current",
    "group": "grp_jk_ble_charts48",
    "order": 1,
    "width": 6,
    "height": 4,
    "label": "Current (A)",
    "chartType": "line",
    "legend": true,
    "xformat": "dd HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "-200",
    "ymax": "200",
    "removeOlder": "48",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": 0,
    "useOneColor": false,
    "colors": [
      "#1f77b4",
      "#ff7f0e",
      "#2ca02c",
      "#d62728",
      "#9467bd",
      "#8c564b",
      "#e377c2",
      "#7f7f7f",
      "#bcbd22"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 1260,
    "y": 760,
    "wires": [
      []
    ]
  },
  {
    "id": "8407720c30824c58",
    "type": "ui_chart",
    "z": "tab_jk_ble_flow",
    "name": "JK SOC",
    "group": "grp_jk_ble_charts48",
    "order": 2,
    "width": 6,
    "height": 4,
    "label": "SOC (%)",
    "chartType": "line",
    "legend": true,
    "xformat": "dd HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "0",
    "ymax": "100",
    "removeOlder": "48",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": 0,
    "useOneColor": false,
    "colors": [
      "#1f77b4",
      "#ff7f0e",
      "#2ca02c",
      "#d62728",
      "#9467bd",
      "#8c564b",
      "#e377c2",
      "#7f7f7f",
      "#bcbd22"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 820,
    "y": 860,
    "wires": [
      []
    ]
  },
  {
    "id": "d5b91adcf90c48f9",
    "type": "ui_chart",
    "z": "tab_jk_ble_flow",
    "name": "JK Temps",
    "group": "grp_jk_ble_charts48",
    "order": 3,
    "width": 6,
    "height": 4,
    "label": "Temps (\u00b0C)",
    "chartType": "line",
    "legend": true,
    "xformat": "dd HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "-20",
    "ymax": "90",
    "removeOlder": "48",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": 0,
    "useOneColor": false,
    "colors": [
      "#1f77b4",
      "#ff7f0e",
      "#2ca02c",
      "#d62728",
      "#9467bd",
      "#8c564b",
      "#e377c2",
      "#7f7f7f",
      "#bcbd22"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 1260,
    "y": 860,
    "wires": [
      []
    ]
  },
  {
    "id": "2ae99e39ec49417c",
    "type": "ui_chart",
    "z": "tab_jk_ble_flow",
    "name": "JK DeltaV",
    "group": "grp_jk_ble_charts48",
    "order": 4,
    "width": 12,
    "height": 4,
    "label": "DeltaV (V)",
    "chartType": "line",
    "legend": true,
    "xformat": "dd HH:mm",
    "interpolate": "linear",
    "nodata": "",
    "dot": false,
    "ymin": "0",
    "ymax": "0.2",
    "removeOlder": "48",
    "removeOlderPoints": "",
    "removeOlderUnit": "3600",
    "cutout": 0,
    "useOneColor": false,
    "colors": [
      "#1f77b4",
      "#ff7f0e",
      "#2ca02c",
      "#d62728",
      "#9467bd",
      "#8c564b",
      "#e377c2",
      "#7f7f7f",
      "#bcbd22"
    ],
    "outputs": 1,
    "useDifferentColor": false,
    "className": "",
    "x": 820,
    "y": 960,
    "wires": [
      []
    ]
  },
  {
    "id": "c6395e2363a64056",
    "type": "ui_table",
    "z": "tab_jk_ble_flow",
    "group": "grp_jk_ble_cells",
    "name": "JK Cells Table",
    "order": 0,
    "width": 12,
    "height": 10,
    "columns": [
      {
        "field": "cell",
        "title": "Cell",
        "width": "60",
        "align": "left",
        "formatter": "plaintext",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "v",
        "title": "V",
        "width": "80",
        "align": "right",
        "formatter": "plaintext",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "mv",
        "title": "mV \u0394avg",
        "width": "90",
        "align": "right",
        "formatter": "plaintext",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "r",
        "title": "R (\u03a9)",
        "width": "90",
        "align": "right",
        "formatter": "plaintext",
        "formatterParams": {
          "target": "_blank"
        }
      },
      {
        "field": "flag",
        "title": "Min/Max",
        "width": "80",
        "align": "center",
        "formatter": "plaintext",
        "formatterParams": {
          "target": "_blank"
        }
      }
    ],
    "outputs": 0,
    "cts": false,
    "x": 1240,
    "y": 1120,
    "wires": []
  },
  {
    "id": "http_in_jk_hist",
    "type": "http in",
    "z": "tab_jk_ble_flow",
    "name": "JK history 48h",
    "url": "/jk/jk1/history48h",
    "method": "get",
    "upload": false,
    "swaggerDoc": "",
    "x": 220,
    "y": 1160,
    "wires": [
      [
        "028a72d9ed884288"
      ]
    ]
  },
  {
    "id": "028a72d9ed884288",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "JK history -> response",
    "func": "var arr = flow.get('JK_BLE_TS_48H') || [];\nmsg.headers = {'Content-Type':'application/json; charset=utf-8'};\nmsg.payload = arr;\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 480,
    "y": 1160,
    "wires": [
      [
        "bc1410b718914935"
      ]
    ]
  },
  {
    "id": "bc1410b718914935",
    "type": "http response",
    "z": "tab_jk_ble_flow",
    "name": "",
    "statusCode": "",
    "headers": {},
    "x": 740,
    "y": 1160,
    "wires": []
  },
  {
    "id": "http_in_jk_last",
    "type": "http in",
    "z": "tab_jk_ble_flow",
    "name": "JK latest",
    "url": "/jk/jk1/latest",
    "method": "get",
    "upload": false,
    "swaggerDoc": "",
    "x": 210,
    "y": 1200,
    "wires": [
      [
        "db5e3432574848d6"
      ]
    ]
  },
  {
    "id": "db5e3432574848d6",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "JK latest -> response",
    "func": "var o = flow.get('JK_BLE_LAST') || null;\nvar m = flow.get('JK_BLE_LAST_METRICS') || null;\nmsg.headers = {'Content-Type':'application/json; charset=utf-8'};\nmsg.payload = {raw:o, metrics:m};\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 480,
    "y": 1200,
    "wires": [
      [
        "60c4d5eb3f6a495e"
      ]
    ]
  },
  {
    "id": "60c4d5eb3f6a495e",
    "type": "http response",
    "z": "tab_jk_ble_flow",
    "name": "",
    "statusCode": "",
    "headers": {},
    "x": 740,
    "y": 1200,
    "wires": []
  },
  {
    "id": "fn_jk_ble_to_influx",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "JK raw -> Influx fields+tags",
    "func": "var o = msg.payload || {};\nvar st = o.status || {};\nvar ci = st.cell_info || {};\nvar di = st.device_info || {};\n\nfunction num(x){ return (x==null || !isFinite(x)) ? null : Number(x); }\nfunction roundN(x,n){ if(x==null) return null; var f=Math.pow(10,n||3); return Math.round(Number(x)*f)/f; }\n\nvar fields = {};\nfields.voltage = roundN(num(ci.total_voltage),3);\nfields.current = roundN(num(ci.current),3);\nfields.soc = (ci.battery_soc==null||!isFinite(ci.battery_soc))?null:Math.round(Number(ci.battery_soc));\nfields.temp1 = roundN(num(ci.temperature_sensor_1),3);\nfields.temp2 = roundN(num(ci.temperature_sensor_2),3);\nfields.temp_mos = roundN(num(ci.temperature_mos),3);\nfields.delta_v = roundN(num(ci.delta_cell_voltage),3);\nfields.power = (fields.voltage!=null && fields.current!=null) ? roundN(fields.voltage*fields.current,3) : null;\nfields.cycle_count = (ci.cycle_count==null||!isFinite(ci.cycle_count))?null:Math.round(Number(ci.cycle_count));\nfields.capacity_remain = roundN(num(ci.capacity_remain),3);\nfields.capacity_nominal = roundN(num(ci.capacity_nominal),3);\n\n// optional: min/max cell volt\nvar volts = ci.voltages || [];\nvar vmin=null, vmax=null;\nfor (var i=0;i<volts.length;i++){\n  var vv = roundN(num(volts[i]),3);\n  if(vv==null) continue;\n  if(vmin==null || vv<vmin) vmin=vv;\n  if(vmax==null || vv>vmax) vmax=vv;\n}\nfields.cell_min_v = vmin;\nfields.cell_max_v = vmax;\n\n// Drop nulls (Influx field values should be present or omitted)\nObject.keys(fields).forEach(function(k){ if(fields[k]==null) delete fields[k]; });\n\n// Influx line protocol forbids empty tag values; always provide something.\nvar vendor = (di.vendor_id || di.production || di.vendor || '').toString();\nif (!vendor) vendor = 'JK';\n\nvar tags = {\n  device: 'jk1',\n  mac: (o.address||'').toString(),\n  vendor: vendor\n};\n\nmsg.measurement = 'jk_ble';\nmsg.retentionPolicy = 'rp48h';\nmsg.payload = [fields, tags];\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 760,
    "y": 700,
    "wires": [
      [
        "influx_out_jk_ble"
      ]
    ]
  },
  {
    "id": "influx_out_jk_ble",
    "type": "influxdb out",
    "z": "tab_jk_ble_flow",
    "influxdb": "63d07bbe2ea52",
    "name": "Influx write jk_ble",
    "measurement": "jk_ble",
    "precision": "",
    "retentionPolicy": "",
    "database": "",
    "precisionV18FluxV20": "ms",
    "retentionPolicyV18Flux": "",
    "org": "",
    "bucket": "",
    "x": 1020,
    "y": 700,
    "wires": []
  },
  {
    "id": "fn_rs485_status_to_influx",
    "type": "function",
    "z": "tab-rs485-poller",
    "name": "RS485 status -> Influx (rs485_status)",
    "func": "var p = msg.payload || {};\nvar t = String(msg.topic||'');\nvar m = t.match(/rs485\\/bms\\/([0-9A-F]{2})\\/status/i);\nvar addr = (m?m[1]:(p.addr||'--')).toString().toUpperCase();\n\nfunction num(x){ return (x==null || !isFinite(x)) ? null : Number(x); }\nfunction roundN(x,n){ if(x==null) return null; var f=Math.pow(10,n||3); return Math.round(Number(x)*f)/f; }\n\nvar v = roundN(num(p.voltage),3);\nvar a = roundN(num(p.current),3);\nvar power = roundN(num(p.power),3);\nif(power==null && v!=null && a!=null) power = roundN(v*a,3);\n\nvar soc = num(p.soc);\nif(soc!=null) soc = roundN(soc,3);\n\nvar temps = Array.isArray(p.temps)?p.temps:[];\nvar tmin=null,tmax=null,tsum=0,tn=0;\nfor (var i=0;i<temps.length;i++){\n  var tv = num(temps[i]);\n  if(tv==null) continue;\n  tv = roundN(tv,3);\n  if(tmin==null||tv<tmin) tmin=tv;\n  if(tmax==null||tv>tmax) tmax=tv;\n  tsum += tv; tn++;\n}\nvar tavg = (tn? roundN(tsum/tn,3): null);\n\nvar cellMinMv = num(p.cell_min_mv);\nvar cellMaxMv = num(p.cell_max_mv);\nvar cellDeltaMv = num(p.cell_delta_mv);\nvar cellMinV = (cellMinMv!=null)? roundN(cellMinMv/1000,3): null;\nvar cellMaxV = (cellMaxMv!=null)? roundN(cellMaxMv/1000,3): null;\nvar cellDeltaV = (cellDeltaMv!=null)? roundN(cellDeltaMv/1000,3): null;\n\nvar cellsGlitch = (p.cells_glitch === true) ? 1 : 0;\n\nvar fields = {};\nif(v!=null) fields.voltage=v;\nif(a!=null) fields.current=a;\nif(power!=null) fields.power=power;\nif(soc!=null) fields.soc=soc;\nif(cellMinV!=null) fields.cell_min_v=cellMinV;\nif(cellMaxV!=null) fields.cell_max_v=cellMaxV;\nif(cellDeltaV!=null) fields.cell_delta_v=cellDeltaV;\nfields.cells_glitch = cellsGlitch;\nfields.cell_count = Array.isArray(p.cells_mv) ? p.cells_mv.length : undefined;\nif(fields.cell_count==null) delete fields.cell_count;\n\nvar capFull = roundN(num(p.capacity_ah_full),3);\nvar capRem = roundN(num(p.capacity_ah_remain),3);\nif(capFull!=null) fields.capacity_full_ah=capFull;\nif(capRem!=null) fields.capacity_remain_ah=capRem;\n\nvar cycles = num(p.cycles);\nif(cycles!=null) fields.cycles = Math.round(cycles);\n\nvar soh = num(p.soh);\nif(soh!=null) fields.soh = roundN(soh,3);\n\nif(tmin!=null) fields.temp_min=tmin;\nif(tmax!=null) fields.temp_max=tmax;\nif(tavg!=null) fields.temp_avg=tavg;\n\n// mode as string field (optional)\nif(typeof p.mode === 'string' && p.mode) fields.mode = p.mode;\n\nif(Object.keys(fields).length===0) return null;\n\nmsg.measurement = 'rs485_status';\nmsg.retentionPolicy = 'rp48h';\nmsg.payload = [fields, {addr: addr, device: 'rs485'}];\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 760,
    "y": 760,
    "wires": [
      [
        "influx_out_rs485_status"
      ]
    ]
  },
  {
    "id": "influx_out_rs485_status",
    "type": "influxdb out",
    "z": "tab-rs485-poller",
    "influxdb": "63d07bbe2ea52",
    "name": "Influx write rs485_status",
    "measurement": "rs485_status",
    "precision": "",
    "retentionPolicy": "",
    "database": "",
    "precisionV18FluxV20": "ms",
    "retentionPolicyV18Flux": "",
    "org": "",
    "bucket": "",
    "x": 1040,
    "y": 760,
    "wires": []
  },
  {
    "id": "fn_rs485_limits_to_influx",
    "type": "function",
    "z": "tab-rs485-poller",
    "name": "RS485 limits(47) -> Influx (rs485_limits)",
    "func": "var pl = msg.payload || {};\nvar t = String(msg.topic||'');\nvar m = t.match(/rs485\\/bms\\/([0-9A-F]{2})\\/params/i);\nvar addr = (m?m[1]:(pl.addr||'--')).toString().toUpperCase();\nif(!pl.limits) return null;\n\nvar L = pl.limits;\nfunction num(x){ return (x==null || !isFinite(x)) ? null : Number(x); }\nfunction roundN(x,n){ if(x==null) return null; var f=Math.pow(10,n||3); return Math.round(Number(x)*f)/f; }\n\n// These should already be scaled correctly by decode47, but keep light normalization.\nfunction normCellV(x){ x=num(x); if(x==null) return null; if(x>=1.5&&x<=5) return x; if(x>100&&x<=10000) return x/1000; return null; }\nfunction normPackV(x){ x=num(x); if(x==null) return null; if(x>=10&&x<=120) return x; if(x>1000&&x<=120000) return x/1000; return null; }\nfunction normAmp(x){ x=num(x); if(x==null) return null; if(Math.abs(x)<=500) return x; if(Math.abs(x)<=50000) return x/100; return null; }\nfunction normTemp(x){ x=num(x); if(x==null) return null; if(x<-100||x>200) return x/10; return x; }\n\nvar cell_hi=roundN(normCellV(L.cell_v_hi),3);\nvar cell_lo=roundN(normCellV(L.cell_v_lo),3);\n\nvar cell_count = (L.cell_count!=null)?Number(L.cell_count):null;\nif(!(cell_count>0 && cell_count<256)) cell_count=null;\n\nvar pack_hi=roundN(normPackV(L.pack_v_hi),3);\nvar pack_lo=roundN(normPackV(L.pack_v_lo),3);\nif((pack_hi==null||pack_hi<10) && cell_hi!=null && cell_count!=null) pack_hi=roundN(cell_hi*cell_count,2);\nif((pack_lo==null||pack_lo<10) && cell_lo!=null && cell_count!=null) pack_lo=roundN(cell_lo*cell_count,2);\n\nvar ichg=roundN(normAmp(L.chg_i_lim),2);\nvar ichg_upper=roundN(normAmp(L.chg_i_upper),2);\nvar tchg_hi=roundN(normTemp(L.chg_t_hi),1);\nvar tchg_lo=roundN(normTemp(L.chg_t_lo),1);\nvar cap_design=roundN(num(L.design_capacity_ah),2);\n\nvar fields={};\nif(cell_hi!=null) fields.cell_v_hi=cell_hi;\nif(cell_lo!=null) fields.cell_v_lo=cell_lo;\nif(pack_hi!=null) fields.pack_v_hi=pack_hi;\nif(pack_lo!=null) fields.pack_v_lo=pack_lo;\nif(ichg!=null) fields.chg_i_lim=ichg;\nif(ichg_upper!=null) fields.chg_i_upper=ichg_upper;\nif(tchg_hi!=null) fields.chg_t_hi=tchg_hi;\nif(tchg_lo!=null) fields.chg_t_lo=tchg_lo;\nif(cell_count!=null) fields.cell_count=cell_count;\nif(cap_design!=null) fields.design_capacity_ah=cap_design;\nif(L.interval_min!=null && isFinite(L.interval_min)) fields.interval_min=Number(L.interval_min);\nif(L.balance_mode!=null && isFinite(L.balance_mode)) fields.balance_mode=Number(L.balance_mode);\n\nif(Object.keys(fields).length===0) return null;\nmsg.measurement='rs485_limits';\nmsg.retentionPolicy='rp48h';\nmsg.payload=[fields,{addr:addr, device:'rs485'}];\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 740,
    "y": 820,
    "wires": [
      [
        "influx_out_rs485_limits"
      ]
    ]
  },
  {
    "id": "influx_out_rs485_limits",
    "type": "influxdb out",
    "z": "tab-rs485-poller",
    "influxdb": "63d07bbe2ea52",
    "name": "Influx write rs485_limits",
    "measurement": "rs485_limits",
    "precision": "",
    "retentionPolicy": "",
    "database": "",
    "precisionV18FluxV20": "ms",
    "retentionPolicyV18Flux": "",
    "org": "",
    "bucket": "",
    "x": 1040,
    "y": 820,
    "wires": []
  },
  {
    "id": "mqtt_in_daly_raw",
    "type": "mqtt in",
    "z": "tab_jk_ble_flow",
    "name": "DALY raw (MQTT)",
    "topic": "bms/daly/+/raw",
    "qos": "0",
    "datatype": "auto",
    "broker": "4c520c778e3d4c7d",
    "nl": false,
    "rap": true,
    "rh": 0,
    "inputs": 0,
    "x": 220,
    "y": 760,
    "wires": [
      [
        "fn_daly_to_influx"
      ]
    ]
  },
  {
    "id": "fn_daly_to_influx",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "DALY raw -> Influx points",
    "func": "var o = msg.payload;\nif (typeof o === 'string') { try { o = JSON.parse(o); } catch(e){} }\nif (!o || typeof o !== 'object') return null;\n\nvar topic = String(msg.topic||'');\nvar parts = topic.split('/');\nvar dev = (parts.length>=3)?parts[2]:'daly';\n\nvar st = o.status || {};\nvar p90 = st.pack_90 || {};\nvar mm91 = st.cell_minmax_91 || {};\nvar t92 = st.temp_minmax_92 || {};\nvar t96 = st.temps_96 || {};\nvar c95 = st.cells_95 || {};\n\nfunction num(x){ return (x==null||!isFinite(x))?null:Number(x); }\nfunction roundN(x,n){ if(x==null) return null; var f=Math.pow(10,n||3); return Math.round(Number(x)*f)/f; }\n\nvar fields = {};\nfields.voltage = roundN(num(p90.voltage_total_v),3);\nfields.current = roundN(num(p90.current_a),3);\nfields.soc = (num(p90.soc_pct)==null)?null:roundN(num(p90.soc_pct),1);\nfields.cell_min_v = roundN(num(mm91.cell_min_v),3);\nfields.cell_max_v = roundN(num(mm91.cell_max_v),3);\nfields.cell_delta_v = roundN(num(mm91.cell_delta_v),3);\n\n// temperature: prefer temps_96 first element, else temp_minmax_92\nvar t = null;\nif (t96 && Array.isArray(t96.temps_c) && t96.temps_c.length) t = num(t96.temps_c[0]);\nif (t==null && t92) t = num(t92.temp_max_c);\nif (t!=null) fields.temp = roundN(t,3);\n\n// keep only non-null\nObject.keys(fields).forEach(function(k){ if(fields[k]==null) delete fields[k]; });\nif (!Object.keys(fields).length) return null;\n\nvar tags = { device: dev, mac: String(o.address||''), src: 'daly_ble' };\n\nvar m1 = { measurement: 'daly_ble', retentionPolicy: 'rp48h', payload: [fields, tags] };\n\n// cells point: cell01..cellXX as fields (avoid nulls)\nvar cells = (c95 && Array.isArray(c95.cells_v)) ? c95.cells_v : [];\nvar f2 = {};\nfor (var i=0;i<cells.length;i++) {\n  var v = num(cells[i]);\n  if (v==null) continue;\n  var k = 'cell' + String(i+1).padStart(2,'0');\n  f2[k] = roundN(v,3);\n}\nvar m2 = null;\nif (Object.keys(f2).length) {\n  m2 = { measurement: 'daly_ble_cells', retentionPolicy: 'rp48h', payload: [f2, tags] };\n}\n\nvar out = [m1];\nif (m2) out.push(m2);\nreturn [out[0], out[1]||null];\n",
    "outputs": 2,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 500,
    "y": 760,
    "wires": [
      [
        "influx_out_daly_ble"
      ],
      [
        "influx_out_daly_ble_cells"
      ]
    ]
  },
  {
    "id": "influx_out_daly_ble",
    "type": "influxdb out",
    "z": "tab_jk_ble_flow",
    "influxdb": "63d07bbe2ea52",
    "name": "Influx write daly_ble",
    "measurement": "daly_ble",
    "precision": "",
    "retentionPolicy": "",
    "database": "",
    "precisionV18FluxV20": "ms",
    "retentionPolicyV18Flux": "",
    "org": "",
    "bucket": "",
    "x": 760,
    "y": 740,
    "wires": []
  },
  {
    "id": "influx_out_daly_ble_cells",
    "type": "influxdb out",
    "z": "tab_jk_ble_flow",
    "influxdb": "63d07bbe2ea52",
    "name": "Influx write daly_ble_cells",
    "measurement": "daly_ble_cells",
    "precision": "",
    "retentionPolicy": "",
    "database": "",
    "precisionV18FluxV20": "ms",
    "retentionPolicyV18Flux": "",
    "org": "",
    "bucket": "",
    "x": 810,
    "y": 780,
    "wires": []
  },
  {
    "id": "f64eb535b4c94221",
    "type": "mqtt in",
    "z": "f1180e03d0981a44",
    "name": "DALY UI raw (MQTT)",
    "topic": "bms/daly/+/raw",
    "qos": "0",
    "datatype": "auto",
    "broker": "4c520c778e3d4c7d",
    "nl": false,
    "rap": true,
    "rh": 0,
    "inputs": 0,
    "x": 3120,
    "y": 1120,
    "wires": [
      [
        "99e260551c8e4922"
      ]
    ]
  },
  {
    "id": "99e260551c8e4922",
    "type": "function",
    "z": "f1180e03d0981a44",
    "name": "DALY UI fanout (Akku2/Akku3)",
    "func": "var o = msg.payload;\nif (typeof o === 'string') { try { o = JSON.parse(o); } catch(e){} }\nif (!o || typeof o !== 'object') return [null,null,null,null,null,null];\n\nvar topic = String(msg.topic||'');\nvar parts = topic.split('/');\nvar dev = (parts.length>=3)?parts[2]:'daly';\n\nvar st = o.status || {};\nvar p90 = st.pack_90 || {};\nvar mm91 = st.cell_minmax_91 || {};\nvar t92 = st.temp_minmax_92 || {};\nvar t96 = st.temps_96 || {};\nvar c95 = st.cells_95 || {};\n\nfunction num(x){ return (x==null||!isFinite(x))?null:Number(x); }\nfunction roundN(x,n){ if(x==null) return null; var f=Math.pow(10,n||3); return Math.round(Number(x)*f)/f; }\n\nvar temp = null;\nif (t96 && Array.isArray(t96.temps_c) && t96.temps_c.length) temp = num(t96.temps_c[0]);\nif (temp==null && t92) temp = num(t92.temp_max_c);\n\nvar cells = (c95 && Array.isArray(c95.cells_v)) ? c95.cells_v : [];\nvar cellsList = [];\nfor (var i=0;i<cells.length;i++) {\n  var v = num(cells[i]);\n  if (v==null) continue;\n  cellsList.push({ idx: i+1, v: roundN(v,3) });\n}\n\nvar payload = {\n  device: dev,\n  mac: String(o.address||''),\n  voltage: roundN(num(p90.voltage_total_v),3),\n  current: roundN(num(p90.current_a),3),\n  soc: roundN(num(p90.soc_pct),1),\n  temp: roundN(temp,1),\n  cell_min_v: roundN(num(mm91.cell_min_v),3),\n  cell_max_v: roundN(num(mm91.cell_max_v),3),\n  cell_delta_v: roundN(num(mm91.cell_delta_v),3),\n  cells: cellsList\n};\n\nvar tplMsg = { payload: payload };\n\nvar tMsgs = null;\nif (payload.temp != null) {\n  tMsgs = [ { topic: 'T', payload: payload.temp } ];\n}\n\nvar cMsgs = null;\nif (cellsList.length) {\n  cMsgs = [];\n  for (var j=0;j<cellsList.length;j++) {\n    var k = 'C' + String(cellsList[j].idx).padStart(2,'0');\n    cMsgs.push({ topic: k, payload: cellsList[j].v });\n  }\n}\n\nif (dev === 'akku2') return [tplMsg, null, tMsgs, null, cMsgs, null];\nif (dev === 'akku3') return [null, tplMsg, null, tMsgs, null, cMsgs];\nreturn [null,null,null,null,null,null];\n",
    "outputs": 6,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3410,
    "y": 1120,
    "wires": [
      [
        "c2887c047a394d05"
      ],
      [
        "59ec6f24a0e94aaf"
      ],
      [
        "72e540713a05632e"
      ],
      [
        "b1fc8d03cb9a154a"
      ],
      [
        "fc7590f53dfa2ccf"
      ],
      [
        "90f92dc69e34c4a8"
      ]
    ]
  },
  {
    "id": "c2887c047a394d05",
    "type": "ui_template",
    "z": "f1180e03d0981a44",
    "group": "7f4586c8b01659db",
    "name": "DALY Status",
    "order": 1,
    "width": 12,
    "height": 6,
    "format": "<div style=\\\"padding:14px;border:1px solid #33414b;border-radius:14px;background:linear-gradient(180deg,#101820,#0d141b);\\\">\n  <div style=\\\"display:flex;align-items:baseline;justify-content:space-between;gap:10px;\\\">\n    <div style=\\\"font-size:18px;font-weight:700;letter-spacing:0.2px;\\\">DALY {{msg.payload.device}}</div>\n    <div style=\\\"font-size:12px;opacity:0.75;\\\">{{msg.payload.mac}}</div>\n  </div>\n\n  <div style=\\\"display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:10px;\\\">\n    <div><div style=\\\"font-size:12px;opacity:0.7\\\">U</div><div style=\\\"font-size:20px;font-weight:700\\\">{{msg.payload.voltage | number:3}} V</div></div>\n    <div><div style=\\\"font-size:12px;opacity:0.7\\\">I</div><div style=\\\"font-size:20px;font-weight:700\\\">{{msg.payload.current | number:3}} A</div></div>\n    <div><div style=\\\"font-size:12px;opacity:0.7\\\">Temp</div><div style=\\\"font-size:20px;font-weight:700\\\">{{msg.payload.temp | number:1}} C</div></div>\n    <div><div style=\\\"font-size:12px;opacity:0.7\\\">Delta</div><div style=\\\"font-size:20px;font-weight:700\\\">{{msg.payload.cell_delta_v | number:3}} V</div></div>\n  </div>\n\n  <div style=\\\"margin-top:12px;display:flex;gap:14px;flex-wrap:wrap;opacity:0.9\\\">\n    <div>Cell min/max: <b>{{msg.payload.cell_min_v | number:3}}</b> / <b>{{msg.payload.cell_max_v | number:3}}</b> V</div>\n    <div>SOC: <b>{{msg.payload.soc | number:1}}</b> %</div>\n  </div>\n\n  <div style=\\\"margin-top:12px;max-height:180px;overflow:auto;border-top:1px solid #22303a;padding-top:10px;\\\">\n    <table style=\\\"width:100%;border-collapse:collapse;font-size:13px;\\\">\n      <tr ng-repeat=\\\"c in msg.payload.cells\\\" style=\\\"border-bottom:1px solid #1c2730\\\">\n        <td style=\\\"padding:4px 6px;opacity:0.8\\\">C{{c.idx}}</td>\n        <td style=\\\"padding:4px 6px;text-align:right;font-variant-numeric:tabular-nums\\\">{{c.v | number:3}} V</td>\n      </tr>\n    </table>\n  </div>\n</div>",
    "storeOutMessages": true,
    "fwdInMessages": true,
    "resendOnRefresh": true,
    "templateScope": "local",
    "className": "",
    "x": 3720,
    "y": 1080,
    "wires": [
      []
    ]
  },
  {
    "id": "59ec6f24a0e94aaf",
    "type": "ui_template",
    "z": "f1180e03d0981a44",
    "group": "0d4c236839cc0498",
    "name": "DALY Status",
    "order": 1,
    "width": 12,
    "height": 6,
    "format": "<div style=\\\"padding:14px;border:1px solid #33414b;border-radius:14px;background:linear-gradient(180deg,#101820,#0d141b);\\\">\n  <div style=\\\"display:flex;align-items:baseline;justify-content:space-between;gap:10px;\\\">\n    <div style=\\\"font-size:18px;font-weight:700;letter-spacing:0.2px;\\\">DALY {{msg.payload.device}}</div>\n    <div style=\\\"font-size:12px;opacity:0.75;\\\">{{msg.payload.mac}}</div>\n  </div>\n\n  <div style=\\\"display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:10px;\\\">\n    <div><div style=\\\"font-size:12px;opacity:0.7\\\">U</div><div style=\\\"font-size:20px;font-weight:700\\\">{{msg.payload.voltage | number:3}} V</div></div>\n    <div><div style=\\\"font-size:12px;opacity:0.7\\\">I</div><div style=\\\"font-size:20px;font-weight:700\\\">{{msg.payload.current | number:3}} A</div></div>\n    <div><div style=\\\"font-size:12px;opacity:0.7\\\">Temp</div><div style=\\\"font-size:20px;font-weight:700\\\">{{msg.payload.temp | number:1}} C</div></div>\n    <div><div style=\\\"font-size:12px;opacity:0.7\\\">Delta</div><div style=\\\"font-size:20px;font-weight:700\\\">{{msg.payload.cell_delta_v | number:3}} V</div></div>\n  </div>\n\n  <div style=\\\"margin-top:12px;display:flex;gap:14px;flex-wrap:wrap;opacity:0.9\\\">\n    <div>Cell min/max: <b>{{msg.payload.cell_min_v | number:3}}</b> / <b>{{msg.payload.cell_max_v | number:3}}</b> V</div>\n    <div>SOC: <b>{{msg.payload.soc | number:1}}</b> %</div>\n  </div>\n\n  <div style=\\\"margin-top:12px;max-height:180px;overflow:auto;border-top:1px solid #22303a;padding-top:10px;\\\">\n    <table style=\\\"width:100%;border-collapse:collapse;font-size:13px;\\\">\n      <tr ng-repeat=\\\"c in msg.payload.cells\\\" style=\\\"border-bottom:1px solid #1c2730\\\">\n        <td style=\\\"padding:4px 6px;opacity:0.8\\\">C{{c.idx}}</td>\n        <td style=\\\"padding:4px 6px;text-align:right;font-variant-numeric:tabular-nums\\\">{{c.v | number:3}} V</td>\n      </tr>\n    </table>\n  </div>\n</div>",
    "storeOutMessages": true,
    "fwdInMessages": true,
    "resendOnRefresh": true,
    "templateScope": "local",
    "className": "",
    "x": 3720,
    "y": 1160,
    "wires": [
      []
    ]
  },
  {
    "id": "9e72060e01ac4f1c",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "JK cfg -> cmd/config",
    "func": "var c = msg.payload || {};\nvar out = {\n  address: (c.address||'').toString().trim(),\n  adapter: (c.adapter==null?null:(c.adapter||'').toString().trim()) || null,\n  poll_interval_s: Number(c.rate||10),\n  timeout_s: 20,\n  scan_timeout_s: 5\n};\nif(!isFinite(out.poll_interval_s) || out.poll_interval_s<1) out.poll_interval_s = 10;\nmsg.payload = JSON.stringify(out);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 730,
    "y": 200,
    "wires": [
      [
        "b19dea00d8a542f5"
      ]
    ]
  },
  {
    "id": "b19dea00d8a542f5",
    "type": "mqtt out",
    "z": "tab_jk_ble_flow",
    "name": "JK BLE cmd/config (MQTT)",
    "topic": "bms/jk/jk1/cmd/config",
    "qos": "",
    "retain": "",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "4c520c778e3d4c7d",
    "x": 980,
    "y": 200,
    "wires": []
  },
  {
    "id": "adaf6692448a489f",
    "type": "ui_form",
    "z": "tab_jk_ble_flow",
    "name": "DALY BLE Config",
    "label": "DALY BLE Verbindung",
    "group": "grp_jk_ble_ctrl",
    "order": 4,
    "width": "12",
    "height": 6,
    "options": [
      {
        "label": "Device Name (akku2/akku3)",
        "value": "name",
        "type": "text",
        "required": true
      },
      {
        "label": "BMS Address (MAC)",
        "value": "address",
        "type": "text",
        "required": true
      },
      {
        "label": "Adapter (hciX)",
        "value": "adapter",
        "type": "text",
        "required": false
      },
      {
        "label": "Poll Interval (s)",
        "value": "poll",
        "type": "number",
        "required": false
      }
    ],
    "formValue": {
      "name": "akku2",
      "address": "40:17:10:01:06:C7",
      "adapter": "hci1",
      "poll": 10
    },
    "submit": "Apply",
    "cancel": "Reset",
    "x": 260,
    "y": 300,
    "wires": [
      [
        "e73d6c84294a4b49"
      ]
    ]
  },
  {
    "id": "e73d6c84294a4b49",
    "type": "function",
    "z": "tab_jk_ble_flow",
    "name": "DALY cfg -> cmd/config",
    "func": "var p=(msg&&msg.payload)||{};\nvar name=String(p.name||'').trim()||'akku2';\nvar poll=Number(p.poll||10); if(!isFinite(poll)||poll<1) poll=10;\nvar out={address:String(p.address||'').trim(), adapter:String(p.adapter||'').trim()||null, poll_interval_s:poll, timeout_s:20, scan_timeout_s:15};\nmsg.topic='bms/daly/'+name+'/cmd/config';\nmsg.payload=JSON.stringify(out);\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 540,
    "y": 300,
    "wires": [
      [
        "802aa987a0cf4b99"
      ]
    ]
  },
  {
    "id": "802aa987a0cf4b99",
    "type": "mqtt out",
    "z": "tab_jk_ble_flow",
    "name": "DALY cmd/config (MQTT)",
    "topic": "",
    "qos": "",
    "retain": "",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "4c520c778e3d4c7d",
    "x": 800,
    "y": 300,
    "wires": []
  },
  {
    "id": "cdaaa47a0ef44101",
    "type": "function",
    "z": "tab-rs485-poller",
    "name": "RS485 raw47 -> Influx",
    "func": "var pl = msg.payload || {};\n// only service 0x47 params\nif (String(pl.svc||'') !== '47') return null;\nvar addr = (pl.addr || (String(msg.topic||'').match(/rs485\\/bms\\/([0-9A-F]{2})\\/params/i)||[])[1] || '--').toString().toUpperCase();\n\n// Influx node can be picky with string fields; store raw telegram as numeric words/bytes.\nvar hex = (pl.data_hex==null) ? '' : String(pl.data_hex).trim();\nhex = hex.replace(/[^0-9a-fA-F]/g, '').toUpperCase();\n\nvar fields = {\n  lenId: Number(pl.lenId||0),\n  crc_ok: !!pl.crc_ok,\n  len_ok: !!pl.len_ok,\n  n_hex: hex.length,\n  n_bytes: Math.floor(hex.length/2)\n};\n\n// Store u16 words (big-endian, same as rU16 on 4 hex chars)\nvar widx = 0;\nfor (var i=0; i+4<=hex.length && widx<80; i+=4){\n  var w = parseInt(hex.substr(i,4), 16);\n  if (!isFinite(w)) w = 0;\n  var k = 'w' + String(widx).padStart(2,'0');\n  fields[k] = w;\n  widx++;\n}\n\n// Also store first N bytes for quick alignment checks\nvar bidx = 0;\nfor (var j=0; j+2<=hex.length && bidx<64; j+=2){\n  var b = parseInt(hex.substr(j,2), 16);\n  if (!isFinite(b)) b = 0;\n  var kk = 'b' + String(bidx).padStart(2,'0');\n  fields[kk] = b;\n  bidx++;\n}\n\nmsg.measurement='rs485_raw47';\nmsg.retentionPolicy='rp48h';\nmsg.payload=[fields,{addr:addr, device:'rs485'}];\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 760,
    "y": 900,
    "wires": [
      [
        "4fc82566d3624a0d"
      ]
    ]
  },
  {
    "id": "4fc82566d3624a0d",
    "type": "influxdb out",
    "z": "tab-rs485-poller",
    "influxdb": "63d07bbe2ea52",
    "name": "Influx write rs485_raw47",
    "measurement": "rs485_raw47",
    "precision": "",
    "retentionPolicy": "",
    "database": "",
    "precisionV18FluxV20": "ms",
    "retentionPolicyV18Flux": "",
    "org": "",
    "bucket": "",
    "x": 1050,
    "y": 900,
    "wires": []
  },
  {
    "id": "51ddf1a8a75e4371",
    "type": "http in",
    "z": "tab_a3412f46",
    "name": "RS485 GET 47 (debug)",
    "url": "/rs485/debug/47/:addr",
    "method": "get",
    "upload": false,
    "swaggerDoc": "",
    "x": 220,
    "y": 1040,
    "wires": [
      [
        "8b7daab19e9a4bec"
      ]
    ]
  },
  {
    "id": "8b7daab19e9a4bec",
    "type": "function",
    "z": "tab_a3412f46",
    "name": "HTTP -> BuildSend 47",
    "func": "var addr = (msg.req && msg.req.params && msg.req.params.addr) ? String(msg.req.params.addr) : (msg.payload||'03');\naddr = addr.toUpperCase().replace(/[^0-9A-F]/g,'').padStart(2,'0').slice(-2);\nmsg.payload = {addr: addr, cid2: '47', dry: false};\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 460,
    "y": 1040,
    "wires": [
      [
        "fn_rs485_service_buildsend"
      ]
    ]
  },
  {
    "id": "42fff8bc8b544025",
    "type": "function",
    "z": "tab_a3412f46",
    "name": "BuildSend status -> HTTP",
    "func": "msg.headers={'Content-Type':'application/json; charset=utf-8'};\nmsg.payload={ok:true, sent:true, status: msg.payload, ts: Date.now()};\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 760,
    "y": 1060,
    "wires": [
      [
        "6dceb0bf1eec40c0"
      ]
    ]
  },
  {
    "id": "6dceb0bf1eec40c0",
    "type": "http response",
    "z": "tab_a3412f46",
    "name": "RS485 debug response",
    "statusCode": "",
    "headers": {},
    "x": 1020,
    "y": 1060,
    "wires": []
  },
  {
    "id": "5834f31419504261",
    "type": "function",
    "z": "tab_a3412f46",
    "name": "RS485 debug sent -> HTTP",
    "func": "// Output1 from Build+Send contains original msg with req/res.\nmsg.headers={'Content-Type':'application/json; charset=utf-8'};\nmsg.payload={ok:true, sent:true, addr: msg.addr||null, service: msg.service||null, frame: (msg.payload||'').toString().trim(), ts: Date.now()};\nreturn msg;",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 760,
    "y": 1020,
    "wires": [
      [
        "6dceb0bf1eec40c0"
      ]
    ]
  },
  {
    "id": "inj_42_addr01_5s",
    "type": "inject",
    "z": "tab-rs485-poller",
    "name": "Status 0x42 addr 01 (5s)",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "5",
    "crontab": "",
    "once": true,
    "onceDelay": "0.5",
    "topic": "force42",
    "payload": "01",
    "payloadType": "str",
    "x": 130,
    "y": 140,
    "wires": [
      [
        "fn-scheduler"
      ]
    ]
  },
  {
    "id": "inj_42_addr03_5s",
    "type": "inject",
    "z": "tab-rs485-poller",
    "name": "Status 0x42 addr 03 (5s)",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "5",
    "crontab": "",
    "once": true,
    "onceDelay": "3.0",
    "topic": "force42",
    "payload": "03",
    "payloadType": "str",
    "x": 130,
    "y": 180,
    "wires": [
      [
        "fn-scheduler"
      ]
    ]
  }
]